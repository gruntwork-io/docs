---
hide_table_of_contents: true
hide_title: true
custom_edit_url: null
---

import CenterLayout from "/src/components/CenterLayout"
import GitHub from "/src/components/GitHub"

<CenterLayout>
<span class="title">Knowledge Base</span>
<h1>OpenVPN Request for Certificate timing out</h1>
<GitHub json={{"id":"D_kwDOF8slf84AQlg1","number":547,"author":{"login":"zackproser"},"title":"OpenVPN Request for Certificate timing out","body":"\r\nA customer asked: \r\n> afternoon everyone....hoping someone has a few minutes to answer some questions about deploying openvpn in multi-account\r\nwe are currently building the openvpn server in the shared account (using packer variables file applied to the packer file in aws-service-catalog module)\r\ndeploying the openvpn server into the dev account...everything appears to stand up correctly\r\nwhen running openvpn-admin to request certificate for user....the request hits SQS...but the openvpn-admin eventually just times out\r\n\r\nr:terraform-aws-openvpn\r\n---\r\n\r\n<ins datetime=\"2022-08-30T17:05:36Z\">\r\n  <p><a href=\"https://support.gruntwork.io/hc/requests/109184\">Tracked in ticket #109184</a></p>\r\n</ins>\r\n","bodyHTML":"<p dir=\"auto\">A customer asked:</p>\n<blockquote>\n<p dir=\"auto\">afternoon everyone....hoping someone has a few minutes to answer some questions about deploying openvpn in multi-account<br>\nwe are currently building the openvpn server in the shared account (using packer variables file applied to the packer file in aws-service-catalog module)<br>\ndeploying the openvpn server into the dev account...everything appears to stand up correctly<br>\nwhen running openvpn-admin to request certificate for user....the request hits SQS...but the openvpn-admin eventually just times out</p>\n</blockquote>\n<h2 dir=\"auto\">r:terraform-aws-openvpn</h2>\n<ins datetime=\"2022-08-30T17:05:36Z\">\n  <p dir=\"auto\"><a href=\"https://support.gruntwork.io/hc/requests/109184\" rel=\"nofollow\">Tracked in ticket #109184</a></p>\n</ins>","answer":{"body":"We’ve seen this happen a few times when you use a small instance (e.g., `t3.micro`) for the OpenVPN server, where it struggles to initialize the TLS certificates due to lack of compute + memory.\r\nTypically, you can detect this happening by looking at the the system logs for the EC2 instance (either by using the AWS web console or the CLI - https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/instance-console.html#instance-console-console-output), where the last log entry is a really long string of `…..++--- .`\r\n\r\nIf this is indeed the cause, you can typically resolve this by relaunching the instance using a larger type (e.g., c4.large), and then rotating it to the smaller size once it successfully initializes.","bodyHTML":"<p dir=\"auto\">We’ve seen this happen a few times when you use a small instance (e.g., <code class=\"notranslate\">t3.micro</code>) for the OpenVPN server, where it struggles to initialize the TLS certificates due to lack of compute + memory.<br>\nTypically, you can detect this happening by looking at the the system logs for the EC2 instance (either by using the AWS web console or the CLI - <a href=\"https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/instance-console.html#instance-console-console-output\" rel=\"nofollow\">https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/instance-console.html#instance-console-console-output</a>), where the last log entry is a really long string of <code class=\"notranslate\">…..++--- .</code></p>\n<p dir=\"auto\">If this is indeed the cause, you can typically resolve this by relaunching the instance using a larger type (e.g., c4.large), and then rotating it to the smaller size once it successfully initializes.</p>"},"comments":{"edges":[{"node":{"author":{"login":"zackproser"},"body":"We’ve seen this happen a few times when you use a small instance (e.g., `t3.micro`) for the OpenVPN server, where it struggles to initialize the TLS certificates due to lack of compute + memory.\r\nTypically, you can detect this happening by looking at the the system logs for the EC2 instance (either by using the AWS web console or the CLI - https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/instance-console.html#instance-console-console-output), where the last log entry is a really long string of `…..++--- .`\r\n\r\nIf this is indeed the cause, you can typically resolve this by relaunching the instance using a larger type (e.g., c4.large), and then rotating it to the smaller size once it successfully initializes."}},{"node":{"author":{"login":"zackproser"},"body":"A customer replied: \r\n> well...may have found another issue...because I don't think it's even getting to that point\r\nfrom /var/log/user-data.log\r\nInitializing PKI and Copying OpenVPN config into place...\r\n2021-04-27 18:27:09 [ERROR] [init-openvpn] The value for '--vpn-route' cannot be empty.\r\n\r\n> we are deploying into the single VPC that is in dev account...should vpn_route_cidr_blocks just be set to the CIDR of the entire VPC?\r\n\r\n> ok...that appears to have kicked off ca cert generation...now to up the instance size\r\n\r\n> and just my own clarification\r\non initial deploy...use a c4.large to support ca cert generation...once that's complete and the certs are in the s3 bucket....can update the terraform to t3.medium (or whatever)...and apply...on boot, the new instance will just pull in the certs from the s3 bucket?"}},{"node":{"author":{"login":"zackproser"},"body":"Yup that is correct. With that said, you should only do that if you see the instance struggling. I’ve seen that for about 95% of cases the OpenVPN server comes up just fine on a t2.micro."}},{"node":{"author":{"login":"zackproser"},"body":"A customer replied: \r\n> making progress...server is up...able to send request with openvpn-admin...but the MTU resolution step gets through 30 iterations and fails out (abbreviated here) with no response from [google.com](http://google.com/)\r\n\r\n> aws-vault exec dev-from-security -- openvpn-admin request --aws-region us-east-1 --username `REDACTED`\r\nEnter passphrase to unlock /home/vscode/.awsvault/keys/: \r\n[openvpn-admin] INFO[2021-04-27T19:45:07Z] Looking up AWS username                      \r\n[openvpn-admin] INFO[2021-04-27T19:45:07Z] Looking up SQS queue                         \r\n[openvpn-admin] INFO[2021-04-27T19:45:08Z] Submitting request for new certificate to https://sqs.us-east-1.amazonaws.com/`REDACTED`/openvpn-response-`REDACTED` \r\n[openvpn-admin] INFO[2021-04-27T19:45:08Z] Waiting for response from OpenVPN server     \r\n[openvpn-admin] INFO[2021-04-27T19:45:08Z] Response received from OpenVPN server        \r\n[openvpn-admin] INFO[2021-04-27T19:45:08Z] Identifying correct MTU                      \r\n[] INFO[2021-04-27T19:45:08Z] Running command: ping -M do -s 1500 -W 2 -c 1 google.com \r\nPING google.com (172.217.6.238) 1500(1528) bytes of data.\r\nping: local error: Message too long, mtu=1500\r\n\r\n"}},{"node":{"author":{"login":"zackproser"},"body":"You can run the ping test yourself to identify the mssfix value (See https://www.sonassi.com/help/troubleshooting/setting-correct-mtu-for-openvpn) and then manually provide it to the openvpn-admin command using the --mssfix option to the request call."}},{"node":{"author":{"login":"zackproser"},"body":"A customer replied: \r\n> so it looks like '[google.com](http://google.com/)'...swapped out with another site and worked fine...with that said, [google.com](http://google.com/) seems to be sporadic in returning responses at correct MTU\r\n\r\n> may be worth investigating updating to cloudflare dns (1.1.1.1) as it seems to be very responsive\r\nI could look at submitting PR if that would help\r\n\r\n> everything is working!  able to request config...server downgraded to t2.micro...thanks for all of your help\r\nalso, I see the three spots that '[google.com](http://google.com/)' would have to be updated to '1.1.1.1' if there is interest in submitting PR\r\n\r\n"}},{"node":{"author":{"login":"zackproser"},"body":"PR to swap that out would be great!\r\n\r\n"}},{"node":{"author":{"login":"zackproser"},"body":"A customer replied: \r\n> this should be a pretty easy review...tested linux build and ran for a few certs with no issues\r\nhttps://github.com/gruntwork-io/terraform-aws-openvpn/pull/129"}}]}}} />

</CenterLayout>
  

<!-- ##DOCS-SOURCER-START
{
  "sourcePlugin": "github-discussions",
  "hash": "c3b917b2cc9c01bb15e090c908f0be6c"
}
##DOCS-SOURCER-END -->

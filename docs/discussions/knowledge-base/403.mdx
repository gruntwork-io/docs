---
hide_table_of_contents: true
hide_title: true
custom_edit_url: null
---

import CenterLayout from "/src/components/CenterLayout"
import GitHub from "/src/components/GitHub"

<head>
  <link rel="canonical" href="https://github.com/gruntwork-io/knowledge-base/discussions/403" />
</head>

<CenterLayout>
<span className="searchCategory">Knowledge Base</span>
<h1>Avoid push on certain condition</h1>
<GitHub discussion={{"id":"D_kwDOF8slf84APcxw","number":403,"author":{"login":"liashukvladyslav"},"title":"Avoid push on certain condition","body":"Is it possible to skip pushing prepared docker image to ECR? \r\n\r\nWe're using `build-docker-image` shell script from reference architecture (which on it's turn rely on `infrastucture-deployer`). \r\nDuring building application's docker images we would like to avoid them under certain conditions (example: builds on unmerged PRs) to be pushed to Amazon ECR. \r\n\r\nDeployment of application is performed only during merging PR. \r\n\r\n For sure, kaniko has option `--no-push`, which doing is exactly what is needed - build image, but do not upload it to container's registry.\r\n \r\n`build-docker-image` helper itself has also corresponding option `--skip-push`\r\n \r\n From what I've tried - simple appending `--skip-push` does not working.\r\n Example:\r\n\r\n```\r\nfunction build_docker_image {\r\n  local -r region=\"$1\"\r\n  local -r sha=\"$2\"\r\n  local -r docker_tag=\"$3\"\r\n  local -r github_action=\"$4\"\r\n\r\n  local assume_role_exports\r\n  assume_role_exports=\"$(assume_autodeploy_role)\"\r\n\r\n  local -a build_args=(--aws-region \"$region\" --)\r\n  build_args+=(docker-image-builder build-docker-image)\r\n  build_args+=(--repo \"$REPO_HTTP\")\r\n  build_args+=(--sha \"$sha\")\r\n  build_args+=(--context-path \"$DOCKER_CONTEXT_PATH\")\r\n  build_args+=(--docker-image-tag \"$DOCKER_REPO_URL:$docker_tag\")\r\n  if [[ ${github_action} == \"pull_request\" ]]; then\r\n    build_args+=(--skip-push)\r\n  fi\r\n  (eval \"$assume_role_exports\" && infrastructure-deployer \"${build_args[@]}\")\r\n}\r\n\r\n```\r\n\r\nWhich during execution converts to \r\n ```\r\n `+ infrastructure-deployer --aws-region us-east-1 -- docker-image-builder build-docker-image --repo https://github.com/***/***.git --sha 7c6c704dad11fc2b86de61e1d4ff349163780b55 --context-path . --docker-image-tag *****.dkr.ecr.us-east-1.amazonaws.com/****:7c6c704dad11fc2b86de61e1d4ff349163780b55 --skip-push\r\n ```\r\n and appears to be useless, as not accepted by `infrastructure-deployer`\r\n \r\n ```\r\n [infrastructure-deployer] INFO[2022-05-03T20:08:03+03:00] Invoking Lambda function ecs-deploy-runner-invoker to trigger deployment.\r\nERROR: OptionNotInAllowedOptionsError: Option --skip-push is not in the provided list of allowed options for the script.\r\n ```\r\n \r\n What's meant way here to skip docker push properly?","bodyHTML":"<p dir=\"auto\">Is it possible to skip pushing prepared docker image to ECR?</p>\n<p dir=\"auto\">We're using <code class=\"notranslate\">build-docker-image</code> shell script from reference architecture (which on it's turn rely on <code class=\"notranslate\">infrastucture-deployer</code>).<br>\nDuring building application's docker images we would like to avoid them under certain conditions (example: builds on unmerged PRs) to be pushed to Amazon ECR.</p>\n<p dir=\"auto\">Deployment of application is performed only during merging PR.</p>\n<p dir=\"auto\">For sure, kaniko has option <code class=\"notranslate\">--no-push</code>, which doing is exactly what is needed - build image, but do not upload it to container's registry.</p>\n<p dir=\"auto\"><code class=\"notranslate\">build-docker-image</code> helper itself has also corresponding option <code class=\"notranslate\">--skip-push</code></p>\n<p dir=\"auto\">From what I've tried - simple appending <code class=\"notranslate\">--skip-push</code> does not working.<br>\nExample:</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"function build_docker_image {\n  local -r region=&quot;$1&quot;\n  local -r sha=&quot;$2&quot;\n  local -r docker_tag=&quot;$3&quot;\n  local -r github_action=&quot;$4&quot;\n\n  local assume_role_exports\n  assume_role_exports=&quot;$(assume_autodeploy_role)&quot;\n\n  local -a build_args=(--aws-region &quot;$region&quot; --)\n  build_args+=(docker-image-builder build-docker-image)\n  build_args+=(--repo &quot;$REPO_HTTP&quot;)\n  build_args+=(--sha &quot;$sha&quot;)\n  build_args+=(--context-path &quot;$DOCKER_CONTEXT_PATH&quot;)\n  build_args+=(--docker-image-tag &quot;$DOCKER_REPO_URL:$docker_tag&quot;)\n  if [[ ${github_action} == &quot;pull_request&quot; ]]; then\n    build_args+=(--skip-push)\n  fi\n  (eval &quot;$assume_role_exports&quot; &amp;&amp; infrastructure-deployer &quot;${build_args[@]}&quot;)\n}\n\"><pre class=\"notranslate\"><code>function build_docker_image {\n  local -r region=\"$1\"\n  local -r sha=\"$2\"\n  local -r docker_tag=\"$3\"\n  local -r github_action=\"$4\"\n\n  local assume_role_exports\n  assume_role_exports=\"$(assume_autodeploy_role)\"\n\n  local -a build_args=(--aws-region \"$region\" --)\n  build_args+=(docker-image-builder build-docker-image)\n  build_args+=(--repo \"$REPO_HTTP\")\n  build_args+=(--sha \"$sha\")\n  build_args+=(--context-path \"$DOCKER_CONTEXT_PATH\")\n  build_args+=(--docker-image-tag \"$DOCKER_REPO_URL:$docker_tag\")\n  if [[ ${github_action} == \"pull_request\" ]]; then\n    build_args+=(--skip-push)\n  fi\n  (eval \"$assume_role_exports\" &amp;&amp; infrastructure-deployer \"${build_args[@]}\")\n}\n\n</code></pre></div>\n<p dir=\"auto\">Which during execution converts to</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"`+ infrastructure-deployer --aws-region us-east-1 -- docker-image-builder build-docker-image --repo https://github.com/***/***.git --sha 7c6c704dad11fc2b86de61e1d4ff349163780b55 --context-path . --docker-image-tag *****.dkr.ecr.us-east-1.amazonaws.com/****:7c6c704dad11fc2b86de61e1d4ff349163780b55 --skip-push\"><pre class=\"notranslate\"><code>`+ infrastructure-deployer --aws-region us-east-1 -- docker-image-builder build-docker-image --repo https://github.com/***/***.git --sha 7c6c704dad11fc2b86de61e1d4ff349163780b55 --context-path . --docker-image-tag *****.dkr.ecr.us-east-1.amazonaws.com/****:7c6c704dad11fc2b86de61e1d4ff349163780b55 --skip-push\n</code></pre></div>\n<p dir=\"auto\">and appears to be useless, as not accepted by <code class=\"notranslate\">infrastructure-deployer</code></p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"[infrastructure-deployer] INFO[2022-05-03T20:08:03+03:00] Invoking Lambda function ecs-deploy-runner-invoker to trigger deployment.\nERROR: OptionNotInAllowedOptionsError: Option --skip-push is not in the provided list of allowed options for the script.\"><pre class=\"notranslate\"><code>[infrastructure-deployer] INFO[2022-05-03T20:08:03+03:00] Invoking Lambda function ecs-deploy-runner-invoker to trigger deployment.\nERROR: OptionNotInAllowedOptionsError: Option --skip-push is not in the provided list of allowed options for the script.\n</code></pre></div>\n<p dir=\"auto\">What's meant way here to skip docker push properly?</p>","answer":{"body":"This is currently not supported. The `build-docker-image` helper you are pointing to is different from the trigger command used by the ECS Deploy Runner (whose source is [here](https://github.com/gruntwork-io/terraform-aws-ci/blob/master/modules/ecs-deploy-runner/docker/kaniko/build_docker_image.go)).\r\n\r\nIf you are looking to do only the build step without pushing, then the recommendation is to build the docker image directly in your CI server rather than going through the ECS Deploy Runner. The goal of the ECS Deploy Runner is to prevent arbitrary pushes of images to different ECR repos, so it is not necessary to go through the ECS Deploy Runner if you are not intending to push.\r\n\r\nWith that said, I filed https://github.com/gruntwork-io/terraform-aws-ci/issues/439 to track this feature request. Please follow that ticket to be notified when this feature is implemented.","bodyHTML":"<p dir=\"auto\">This is currently not supported. The <code class=\"notranslate\">build-docker-image</code> helper you are pointing to is different from the trigger command used by the ECS Deploy Runner (whose source is <a href=\"https://github.com/gruntwork-io/terraform-aws-ci/blob/master/modules/ecs-deploy-runner/docker/kaniko/build_docker_image.go\">here</a>).</p>\n<p dir=\"auto\">If you are looking to do only the build step without pushing, then the recommendation is to build the docker image directly in your CI server rather than going through the ECS Deploy Runner. The goal of the ECS Deploy Runner is to prevent arbitrary pushes of images to different ECR repos, so it is not necessary to go through the ECS Deploy Runner if you are not intending to push.</p>\n<p dir=\"auto\">With that said, I filed <a href=\"https://github.com/gruntwork-io/terraform-aws-ci/issues/439\">https://github.com/gruntwork-io/terraform-aws-ci/issues/439</a> to track this feature request. Please follow that ticket to be notified when this feature is implemented.</p>"}}} />

</CenterLayout>
  

<!-- ##DOCS-SOURCER-START
{
  "sourcePlugin": "github-discussions",
  "hash": "d48a2fd931eecc8edba13eafe87a7415"
}
##DOCS-SOURCER-END -->

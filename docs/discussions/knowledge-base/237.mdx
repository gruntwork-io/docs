---
hide_table_of_contents: true
hide_title: true
custom_edit_url: null
---

import CenterLayout from "/src/components/CenterLayout"
import GitHub from "/src/components/GitHub"

<CenterLayout>
<span className="searchCategory">Knowledge Base</span>
<h1>What&apos;s the correct way of merging bucket policy inputs?</h1>
<GitHub discussion={{"id":"D_kwDOF8slf84AO6Nc","number":237,"author":{"login":"umm0n"},"title":"What's the correct way of merging bucket policy inputs?","body":"Hello! We have an s3 module in envcommon with the following policy:\r\n\r\n  ```\r\nbucket_policy_statements = {\r\n    DenyUnEncryptedObjectUploads = {\r\n      effect  = \"Deny\"\r\n      actions = [\"s3:PutObject\"]\r\n      keys    = [\r\n        \"\",\r\n        \"/*\"\r\n      ]\r\n      principals = {\r\n        AWS = [\"*\"]\r\n      }\r\n      condition = {\r\n        RequireSSE = {\r\n          test     = \"StringNotEquals\"\r\n          variable = \"aws:kms\"\r\n          values   = [\"s3:x-amz-server-side-encryption\"]\r\n        }\r\n      }\r\n    }\r\n  }\r\n```\r\nThen we have modules in each env for different S3 buckets. The thing is, whenever we specify additional values for `bucket_policy_statements` in these modules, the policy statement in envcommon is overwritten. Ideally, we'd like to merge the global, \"all buckets must have this\" envcommon policy with whatever custom policy each individual bucket requires. What's the correct way of doing this?\r\n\r\n\r\n[r:terraform-aws-data-storage](https://github.com/gruntwork-io/terraform-aws-data-storage)","bodyHTML":"<p dir=\"auto\">Hello! We have an s3 module in envcommon with the following policy:</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"bucket_policy_statements = {\n  DenyUnEncryptedObjectUploads = {\n    effect  = &quot;Deny&quot;\n    actions = [&quot;s3:PutObject&quot;]\n    keys    = [\n      &quot;&quot;,\n      &quot;/*&quot;\n    ]\n    principals = {\n      AWS = [&quot;*&quot;]\n    }\n    condition = {\n      RequireSSE = {\n        test     = &quot;StringNotEquals&quot;\n        variable = &quot;aws:kms&quot;\n        values   = [&quot;s3:x-amz-server-side-encryption&quot;]\n      }\n    }\n  }\n}\"><pre class=\"notranslate\"><code>bucket_policy_statements = {\n  DenyUnEncryptedObjectUploads = {\n    effect  = \"Deny\"\n    actions = [\"s3:PutObject\"]\n    keys    = [\n      \"\",\n      \"/*\"\n    ]\n    principals = {\n      AWS = [\"*\"]\n    }\n    condition = {\n      RequireSSE = {\n        test     = \"StringNotEquals\"\n        variable = \"aws:kms\"\n        values   = [\"s3:x-amz-server-side-encryption\"]\n      }\n    }\n  }\n}\n</code></pre></div>\n<p dir=\"auto\">Then we have modules in each env for different S3 buckets. The thing is, whenever we specify additional values for <code class=\"notranslate\">bucket_policy_statements</code> in these modules, the policy statement in envcommon is overwritten. Ideally, we'd like to merge the global, \"all buckets must have this\" envcommon policy with whatever custom policy each individual bucket requires. What's the correct way of doing this?</p>\n<p dir=\"auto\"><a href=\"https://github.com/gruntwork-io/terraform-aws-data-storage\">r:terraform-aws-data-storage</a></p>","answer":{"body":"Hi,\r\nI was thinking that extraction in common file and include with `merge_strategy=deep` should help\r\n\r\n```\r\n# common.hcl\r\ninputs = {\r\n  bucket_policy_statements = {\r\n    DenyUnEncryptedObjectUploads = {\r\n      effect     = \"Deny\"\r\n      actions    = [\"s3:PutObject\"]\r\n      keys       = [\r\n        \"\",\r\n        \"/*\"\r\n      ]\r\n      principals = {\r\n        AWS = [\"*\"]\r\n      }\r\n      condition  = {\r\n        RequireSSE = {\r\n          test     = \"StringNotEquals\"\r\n          variable = \"aws:kms\"\r\n          values   = [\"s3:x-amz-server-side-encryption\"]\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n# app1/terragrunt.hcl\r\ninclude \"inputs\" {\r\n  path           = find_in_parent_folders(\"common.hcl\")\r\n  merge_strategy = \"deep\"\r\n}\r\n\r\ninputs = {\r\n  bucket_policy_statements = {\r\n    aaa = \"bbb\"\r\n  }\r\n}\r\n\r\n# app1/main.tf\r\n\r\nvariable \"bucket_policy_statements\" {}\r\n\r\nresource \"local_file\" \"foo\" {\r\n  content     = var.bucket_policy_statements\r\n  filename = \"${path.module}/file.json\"\r\n}\r\n```\r\n\r\nTest:\r\n```\r\n$ cd app1\r\n$ terragrunt apply\r\n$ cat file.json\r\n{\r\n  \"DenyUnEncryptedObjectUploads\": {\r\n    \"actions\": [\r\n...\r\n  },\r\n  \"aaa\": \"bbb\"\r\n}\r\n```\r\n\r\nFull example:\r\nhttps://github.com/denis256/terragrunt-tests/tree/master/dependency-merge\r\n","bodyHTML":"<p dir=\"auto\">Hi,<br>\nI was thinking that extraction in common file and include with <code class=\"notranslate\">merge_strategy=deep</code> should help</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"# common.hcl\ninputs = {\n  bucket_policy_statements = {\n    DenyUnEncryptedObjectUploads = {\n      effect     = &quot;Deny&quot;\n      actions    = [&quot;s3:PutObject&quot;]\n      keys       = [\n        &quot;&quot;,\n        &quot;/*&quot;\n      ]\n      principals = {\n        AWS = [&quot;*&quot;]\n      }\n      condition  = {\n        RequireSSE = {\n          test     = &quot;StringNotEquals&quot;\n          variable = &quot;aws:kms&quot;\n          values   = [&quot;s3:x-amz-server-side-encryption&quot;]\n        }\n      }\n    }\n  }\n}\n\n# app1/terragrunt.hcl\ninclude &quot;inputs&quot; {\n  path           = find_in_parent_folders(&quot;common.hcl&quot;)\n  merge_strategy = &quot;deep&quot;\n}\n\ninputs = {\n  bucket_policy_statements = {\n    aaa = &quot;bbb&quot;\n  }\n}\n\n# app1/main.tf\n\nvariable &quot;bucket_policy_statements&quot; {}\n\nresource &quot;local_file&quot; &quot;foo&quot; {\n  content     = var.bucket_policy_statements\n  filename = &quot;${path.module}/file.json&quot;\n}\"><pre class=\"notranslate\"><code># common.hcl\ninputs = {\n  bucket_policy_statements = {\n    DenyUnEncryptedObjectUploads = {\n      effect     = \"Deny\"\n      actions    = [\"s3:PutObject\"]\n      keys       = [\n        \"\",\n        \"/*\"\n      ]\n      principals = {\n        AWS = [\"*\"]\n      }\n      condition  = {\n        RequireSSE = {\n          test     = \"StringNotEquals\"\n          variable = \"aws:kms\"\n          values   = [\"s3:x-amz-server-side-encryption\"]\n        }\n      }\n    }\n  }\n}\n\n# app1/terragrunt.hcl\ninclude \"inputs\" {\n  path           = find_in_parent_folders(\"common.hcl\")\n  merge_strategy = \"deep\"\n}\n\ninputs = {\n  bucket_policy_statements = {\n    aaa = \"bbb\"\n  }\n}\n\n# app1/main.tf\n\nvariable \"bucket_policy_statements\" {}\n\nresource \"local_file\" \"foo\" {\n  content     = var.bucket_policy_statements\n  filename = \"${path.module}/file.json\"\n}\n</code></pre></div>\n<p dir=\"auto\">Test:</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"$ cd app1\n$ terragrunt apply\n$ cat file.json\n{\n  &quot;DenyUnEncryptedObjectUploads&quot;: {\n    &quot;actions&quot;: [\n...\n  },\n  &quot;aaa&quot;: &quot;bbb&quot;\n}\"><pre class=\"notranslate\"><code>$ cd app1\n$ terragrunt apply\n$ cat file.json\n{\n  \"DenyUnEncryptedObjectUploads\": {\n    \"actions\": [\n...\n  },\n  \"aaa\": \"bbb\"\n}\n</code></pre></div>\n<p dir=\"auto\">Full example:<br>\n<a href=\"https://github.com/denis256/terragrunt-tests/tree/master/dependency-merge\">https://github.com/denis256/terragrunt-tests/tree/master/dependency-merge</a></p>"}}} />

</CenterLayout>
  

<!-- ##DOCS-SOURCER-START
{
  "sourcePlugin": "github-discussions",
  "hash": "6a12613d1cd29ed867f8a953e502b689"
}
##DOCS-SOURCER-END -->

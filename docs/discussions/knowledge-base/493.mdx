---
hide_table_of_contents: true
hide_title: true
custom_edit_url: null
---

import CenterLayout from "/src/components/CenterLayout"
import GitHub from "/src/components/GitHub"

<head>
  <link rel="canonical" href="https://github.com/gruntwork-io/knowledge-base/discussions/493" />
</head>

<CenterLayout>
<span className="searchCategory">Knowledge Base</span>
<h1>ALB Controller Auth Annotations</h1>
<GitHub discussion={{"id":"D_kwDOF8slf84AQBG6","number":493,"author":{"login":"bluelight-dixon"},"title":"ALB Controller Auth Annotations","body":"I am experiencing a permissions issue with the `aws-alb-ingress-controller` when adding ingress annotations to my k8s service.\r\n\r\nI want to apply [auth annotations](https://kubernetes-sigs.github.io/aws-load-balancer-controller/v2.2/guide/ingress/annotations/#authentication) to the ingress so the ALB will perform auth with OIDC.\r\n\r\nI've verified the ingress and service is in the same namespace and have configured the annotations like so:\r\n\r\n```\r\ningress_annotations = {\r\n    \"alb.ingress.kubernetes.io/auth-type\"   = \"oidc\",\r\n    \"alb.ingress.kubernetes.io/auth-idp-oidc\" = jsonencode({\r\n      \"issuer\"                = \"https://auth.example.com/\",\r\n      \"authorizationEndpoint\" = \"https://auth.example.com/authorize\",\r\n      \"tokenEndpoint\"         = \"https://auth.example.com/oauth/token\",\r\n      \"userInfoEndpoint\"      = \"https://auth.example.com/userinfo\",\r\n      \"secretName\"            = \"auth0-example\"\r\n    }),\r\n    \"alb.ingress.kubernetes.io/auth-scope\" : \"openid profile email\"\r\n  }\r\n```\r\n\r\nYet I get the following error message when I inspect the controller logs:\r\n\r\n```\r\n{\r\n  \"level\":\"error\",\r\n  \"ts\":1657149857.8069274,\r\n  \"logger\":\"controller-runtime.manager.controller.ingress\",\r\n  \"msg\":\"Reconciler error\",\r\n  \"name\":\"sample-app-frontend-example-env\",\r\n  \"namespace\":\"app\",\r\n  \"error\":\"ingress: app/sample-app-frontend-example-env: secrets \\\"auth0-example\\\" is forbidden: User \\\"system:serviceaccount:kube-system:aws-alb-ingress-controller\\\" cannot get resource \\\"secrets\\\" in API group \\\"\\\" in the namespace \\\"app\\\"\"\r\n}\r\n```\r\n\r\nHow can I get the ingress controller to pick up the secret needed to configure auth on the ALB?\r\n\r\n[r:terraform-aws-service-catalog](https://github.com/gruntwork-io/terraform-aws-service-catalog)\r\n[r:helm-kubernetes-services](https://github.com/gruntwork-io/helm-kubernetes-services)","bodyHTML":"<p dir=\"auto\">I am experiencing a permissions issue with the <code class=\"notranslate\">aws-alb-ingress-controller</code> when adding ingress annotations to my k8s service.</p>\n<p dir=\"auto\">I want to apply <a href=\"https://kubernetes-sigs.github.io/aws-load-balancer-controller/v2.2/guide/ingress/annotations/#authentication\" rel=\"nofollow\">auth annotations</a> to the ingress so the ALB will perform auth with OIDC.</p>\n<p dir=\"auto\">I've verified the ingress and service is in the same namespace and have configured the annotations like so:</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"ingress_annotations = {\n    &quot;alb.ingress.kubernetes.io/auth-type&quot;   = &quot;oidc&quot;,\n    &quot;alb.ingress.kubernetes.io/auth-idp-oidc&quot; = jsonencode({\n      &quot;issuer&quot;                = &quot;https://auth.example.com/&quot;,\n      &quot;authorizationEndpoint&quot; = &quot;https://auth.example.com/authorize&quot;,\n      &quot;tokenEndpoint&quot;         = &quot;https://auth.example.com/oauth/token&quot;,\n      &quot;userInfoEndpoint&quot;      = &quot;https://auth.example.com/userinfo&quot;,\n      &quot;secretName&quot;            = &quot;auth0-example&quot;\n    }),\n    &quot;alb.ingress.kubernetes.io/auth-scope&quot; : &quot;openid profile email&quot;\n  }\"><pre class=\"notranslate\"><code class=\"notranslate\">ingress_annotations = {\n    \"alb.ingress.kubernetes.io/auth-type\"   = \"oidc\",\n    \"alb.ingress.kubernetes.io/auth-idp-oidc\" = jsonencode({\n      \"issuer\"                = \"https://auth.example.com/\",\n      \"authorizationEndpoint\" = \"https://auth.example.com/authorize\",\n      \"tokenEndpoint\"         = \"https://auth.example.com/oauth/token\",\n      \"userInfoEndpoint\"      = \"https://auth.example.com/userinfo\",\n      \"secretName\"            = \"auth0-example\"\n    }),\n    \"alb.ingress.kubernetes.io/auth-scope\" : \"openid profile email\"\n  }\n</code></pre></div>\n<p dir=\"auto\">Yet I get the following error message when I inspect the controller logs:</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"{\n  &quot;level&quot;:&quot;error&quot;,\n  &quot;ts&quot;:1657149857.8069274,\n  &quot;logger&quot;:&quot;controller-runtime.manager.controller.ingress&quot;,\n  &quot;msg&quot;:&quot;Reconciler error&quot;,\n  &quot;name&quot;:&quot;sample-app-frontend-example-env&quot;,\n  &quot;namespace&quot;:&quot;app&quot;,\n  &quot;error&quot;:&quot;ingress: app/sample-app-frontend-example-env: secrets \\&quot;auth0-example\\&quot; is forbidden: User \\&quot;system:serviceaccount:kube-system:aws-alb-ingress-controller\\&quot; cannot get resource \\&quot;secrets\\&quot; in API group \\&quot;\\&quot; in the namespace \\&quot;app\\&quot;&quot;\n}\"><pre class=\"notranslate\"><code class=\"notranslate\">{\n  \"level\":\"error\",\n  \"ts\":1657149857.8069274,\n  \"logger\":\"controller-runtime.manager.controller.ingress\",\n  \"msg\":\"Reconciler error\",\n  \"name\":\"sample-app-frontend-example-env\",\n  \"namespace\":\"app\",\n  \"error\":\"ingress: app/sample-app-frontend-example-env: secrets \\\"auth0-example\\\" is forbidden: User \\\"system:serviceaccount:kube-system:aws-alb-ingress-controller\\\" cannot get resource \\\"secrets\\\" in API group \\\"\\\" in the namespace \\\"app\\\"\"\n}\n</code></pre></div>\n<p dir=\"auto\">How can I get the ingress controller to pick up the secret needed to configure auth on the ALB?</p>\n<p dir=\"auto\"><a href=\"https://github.com/gruntwork-io/terraform-aws-service-catalog\">r:terraform-aws-service-catalog</a><br>\n<a href=\"https://github.com/gruntwork-io/helm-kubernetes-services\">r:helm-kubernetes-services</a></p>","answer":{"body":"We don't have explicit support for this in the modules, but a workaround would be to directly create an RBAC role that allows access to secrets in that namespace, and bind it to the ingress controller service account. You can do this by either creating a Kubernetes manifest file and using `kubectl apply -f`, or a Terraform module that uses the `kubernetes` provider.\r\n\r\nSeparately, I have filed https://github.com/gruntwork-io/terraform-aws-service-catalog/issues/1596 to track the feature enhancement to support doing this through our modules.","bodyHTML":"<p dir=\"auto\">We don't have explicit support for this in the modules, but a workaround would be to directly create an RBAC role that allows access to secrets in that namespace, and bind it to the ingress controller service account. You can do this by either creating a Kubernetes manifest file and using <code class=\"notranslate\">kubectl apply -f</code>, or a Terraform module that uses the <code class=\"notranslate\">kubernetes</code> provider.</p>\n<p dir=\"auto\">Separately, I have filed <a href=\"https://github.com/gruntwork-io/terraform-aws-service-catalog/issues/1596\">https://github.com/gruntwork-io/terraform-aws-service-catalog/issues/1596</a> to track the feature enhancement to support doing this through our modules.</p>"}}} />

</CenterLayout>

<!-- ##DOCS-SOURCER-START
{
  "sourcePlugin": "github-discussions",
  "hash": "8e0fc8324330072374d1ca87d7c16939"
}
##DOCS-SOURCER-END -->

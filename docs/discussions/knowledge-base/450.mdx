---
hide_table_of_contents: true
hide_title: true
custom_edit_url: null
---

import CenterLayout from "/src/components/CenterLayout"
import GitHub from "/src/components/GitHub"

<head>
  <link rel="canonical" href="https://github.com/gruntwork-io/knowledge-base/discussions/450" />
</head>

<CenterLayout>
<span className="searchCategory">Knowledge Base</span>
<h1>How to link dependencies across modules to work around Terraform limitations?</h1>
<GitHub discussion={{"id":"D_kwDOF8slf84APwFf","number":450,"author":{"login":"yorinasub17"},"title":"How to link dependencies across modules to work around Terraform limitations?","body":"\nI am working on deploying some new lambdas using gruntworks. At our company, we always deploy our go lambdas via an s3_bucket, so I thought it would be nice if i made my own module which used the s3 service module and the lambda service module. The `main.tf` of that composite module looks roughly like this:\r\n\r\n```\r\nmodule \"s3\" {\r\n  source = \"git::git@github.com:gruntwork-io/terraform-aws-service-catalog.git//modules/data-stores/s3-bucket?ref=v0.63.0\"\r\n  primary_bucket = \"${var.lambda_name}-${var.account_name}\"\r\n  enable_versioning = true\r\n}\r\n\r\nmodule \"lambda\" {\r\n  source = \"git::git@github.com:gruntwork-io/terraform-aws-service-catalog.git//modules/services/lambda?ref=v0.63.0\"\r\n\r\n  name = var.lambda_name\r\n  timeout = var.timeout\r\n  memory_size = var.memory_size\r\n  s3_bucket = module.s3.primary_bucket_arn\r\n  s3_key = var.s3_key\r\n  s3_object_version = var.tag\r\n  runtime = var.runtime\r\n  handler = var.handler\r\n  description = var.description\r\n  alarm_sns_topic_arns = var.alarm_sns_topic_arns\r\n  run_in_vpc = var.run_in_vpc\r\n  vpc_id = var.vpc_id\r\n  subnet_ids = var.subnet_ids\r\n  should_create_outbound_rule = var.should_create_outbound_rule\r\n}\r\n```\r\n\r\nthe problem is that I receive this error when trying to run an initial `terragrunt plan`:\r\n\r\n```╷\r\n│ Error: Invalid count argument\r\n│\r\n│   on .terraform/modules/lambda.lambda_function/modules/lambda/main.tf line 115, in resource \"null_resource\" \"assert_exactly_one_of\":\r\n│  115:   count = length(compact([var.image_uri, var.source_path, var.s3_bucket])) == 1 ? 0 : \"ERROR: exactly one of image_uri, source_path, or s3_bucket must be specified.\"\r\n│\r\n│ The \"count\" value depends on resource attributes that cannot be determined\r\n│ until apply, so Terraform cannot predict how many instances will be\r\n│ created. To work around this, use the -target argument to first apply only\r\n│ the resources that the count depends on.\r\n╵\r\n```\r\n\r\nHow do I workaround this?\n\n---\n\n<ins datetime=\"2022-06-08T19:40:40Z\">\n  <p><a href=\"https://support.gruntwork.io/hc/requests/108726\">Tracked in ticket #108726</a></p>\n</ins>\n","bodyHTML":"<p dir=\"auto\">I am working on deploying some new lambdas using gruntworks. At our company, we always deploy our go lambdas via an s3_bucket, so I thought it would be nice if i made my own module which used the s3 service module and the lambda service module. The <code class=\"notranslate\">main.tf</code> of that composite module looks roughly like this:</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"module &quot;s3&quot; {\n  source = &quot;git::git@github.com:gruntwork-io/terraform-aws-service-catalog.git//modules/data-stores/s3-bucket?ref=v0.63.0&quot;\n  primary_bucket = &quot;${var.lambda_name}-${var.account_name}&quot;\n  enable_versioning = true\n}\n\nmodule &quot;lambda&quot; {\n  source = &quot;git::git@github.com:gruntwork-io/terraform-aws-service-catalog.git//modules/services/lambda?ref=v0.63.0&quot;\n\n  name = var.lambda_name\n  timeout = var.timeout\n  memory_size = var.memory_size\n  s3_bucket = module.s3.primary_bucket_arn\n  s3_key = var.s3_key\n  s3_object_version = var.tag\n  runtime = var.runtime\n  handler = var.handler\n  description = var.description\n  alarm_sns_topic_arns = var.alarm_sns_topic_arns\n  run_in_vpc = var.run_in_vpc\n  vpc_id = var.vpc_id\n  subnet_ids = var.subnet_ids\n  should_create_outbound_rule = var.should_create_outbound_rule\n}\"><pre class=\"notranslate\"><code>module \"s3\" {\n  source = \"git::git@github.com:gruntwork-io/terraform-aws-service-catalog.git//modules/data-stores/s3-bucket?ref=v0.63.0\"\n  primary_bucket = \"${var.lambda_name}-${var.account_name}\"\n  enable_versioning = true\n}\n\nmodule \"lambda\" {\n  source = \"git::git@github.com:gruntwork-io/terraform-aws-service-catalog.git//modules/services/lambda?ref=v0.63.0\"\n\n  name = var.lambda_name\n  timeout = var.timeout\n  memory_size = var.memory_size\n  s3_bucket = module.s3.primary_bucket_arn\n  s3_key = var.s3_key\n  s3_object_version = var.tag\n  runtime = var.runtime\n  handler = var.handler\n  description = var.description\n  alarm_sns_topic_arns = var.alarm_sns_topic_arns\n  run_in_vpc = var.run_in_vpc\n  vpc_id = var.vpc_id\n  subnet_ids = var.subnet_ids\n  should_create_outbound_rule = var.should_create_outbound_rule\n}\n</code></pre></div>\n<p dir=\"auto\">the problem is that I receive this error when trying to run an initial <code class=\"notranslate\">terragrunt plan</code>:</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"│ Error: Invalid count argument\n│\n│   on .terraform/modules/lambda.lambda_function/modules/lambda/main.tf line 115, in resource &quot;null_resource&quot; &quot;assert_exactly_one_of&quot;:\n│  115:   count = length(compact([var.image_uri, var.source_path, var.s3_bucket])) == 1 ? 0 : &quot;ERROR: exactly one of image_uri, source_path, or s3_bucket must be specified.&quot;\n│\n│ The &quot;count&quot; value depends on resource attributes that cannot be determined\n│ until apply, so Terraform cannot predict how many instances will be\n│ created. To work around this, use the -target argument to first apply only\n│ the resources that the count depends on.\n╵\"><pre lang=\"╷\" class=\"notranslate\"><code>│ Error: Invalid count argument\n│\n│   on .terraform/modules/lambda.lambda_function/modules/lambda/main.tf line 115, in resource \"null_resource\" \"assert_exactly_one_of\":\n│  115:   count = length(compact([var.image_uri, var.source_path, var.s3_bucket])) == 1 ? 0 : \"ERROR: exactly one of image_uri, source_path, or s3_bucket must be specified.\"\n│\n│ The \"count\" value depends on resource attributes that cannot be determined\n│ until apply, so Terraform cannot predict how many instances will be\n│ created. To work around this, use the -target argument to first apply only\n│ the resources that the count depends on.\n╵\n</code></pre></div>\n<p dir=\"auto\">How do I workaround this?</p>\n<hr>\n<ins datetime=\"2022-06-08T19:40:40Z\">\n  <p dir=\"auto\"><a href=\"https://support.gruntwork.io/hc/requests/108726\" rel=\"nofollow\">Tracked in ticket #108726</a></p>\n</ins>","answer":{"body":"You can set the offending input variable to the plan computable value and then link the dependency in a different way. For this example, you can set the `s3_bucket` input to the same value as the `primary_bucket` field you are passing in to the `s3-bucket` module (`\"${var.lambda_name}-${var.account_name}\"`), and then you can link the two dependencies by either:\r\n\r\n- Using `depends_on` at the module level, so you have a `depends_on = [module.s3_bucket]` on the `lambda` module call.\r\n- Using a tautology to force a dependency on just the lambda function resource by setting the name to be dependent on the s3 bucket. E.g.:\r\n``` \r\nmodule \"lambda\" {\r\n  # ... other args omitted ...\r\n\r\n  name = (\r\n    module.s3.primary_bucket_arn != null\r\n    ? var.lambda_name\r\n    : var.lambda_name\r\n  )\r\n}\r\n```\r\n\r\nNote that the first option is cleaner, but will lead to a perpetual diff due to a terraform issue where data sources in a module with `depends_on` get automatically deferred to `apply` time, so terraform never gets the full picture at `plan` time.","bodyHTML":"<p dir=\"auto\">You can set the offending input variable to the plan computable value and then link the dependency in a different way. For this example, you can set the <code class=\"notranslate\">s3_bucket</code> input to the same value as the <code class=\"notranslate\">primary_bucket</code> field you are passing in to the <code class=\"notranslate\">s3-bucket</code> module (<code class=\"notranslate\">\"${var.lambda_name}-${var.account_name}\"</code>), and then you can link the two dependencies by either:</p>\n<ul dir=\"auto\">\n<li>Using <code class=\"notranslate\">depends_on</code> at the module level, so you have a <code class=\"notranslate\">depends_on = [module.s3_bucket]</code> on the <code class=\"notranslate\">lambda</code> module call.</li>\n<li>Using a tautology to force a dependency on just the lambda function resource by setting the name to be dependent on the s3 bucket. E.g.:</li>\n</ul>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"module &quot;lambda&quot; {\n  # ... other args omitted ...\n\n  name = (\n    module.s3.primary_bucket_arn != null\n    ? var.lambda_name\n    : var.lambda_name\n  )\n}\"><pre class=\"notranslate\"><code>module \"lambda\" {\n  # ... other args omitted ...\n\n  name = (\n    module.s3.primary_bucket_arn != null\n    ? var.lambda_name\n    : var.lambda_name\n  )\n}\n</code></pre></div>\n<p dir=\"auto\">Note that the first option is cleaner, but will lead to a perpetual diff due to a terraform issue where data sources in a module with <code class=\"notranslate\">depends_on</code> get automatically deferred to <code class=\"notranslate\">apply</code> time, so terraform never gets the full picture at <code class=\"notranslate\">plan</code> time.</p>"}}} />

</CenterLayout>
  

<!-- ##DOCS-SOURCER-START
{
  "sourcePlugin": "github-discussions",
  "hash": "0e25979c73620f6bab895c3529dd5195"
}
##DOCS-SOURCER-END -->

---
hide_table_of_contents: true
hide_title: true
custom_edit_url: null
---

import CenterLayout from "/src/components/CenterLayout"
import GitHub from "/src/components/GitHub"

<head>
  <link rel="canonical" href="https://github.com/gruntwork-io/knowledge-base/discussions/6" />
</head>

<CenterLayout>
<span className="searchCategory">Knowledge Base</span>
<h1>Error assuming role `allow-ops-admin-access-from-other-accounts`.</h1>
<GitHub discussion={{"id":"MDEwOkRpc2N1c3Npb24zNTM5MjUx","number":6,"author":{"login":"zackproser"},"title":"Error assuming role `allow-ops-admin-access-from-other-accounts`.","body":"A customer asked:\r\n\r\n> We are trying to assume a role allow-ops-admin-access-from-other-accounts using the IAM user from security account that is in the group access-all-external-account . The group has permission for various roles including allow-ops-admin-access-from-other-accounts\r\nWe executed aws-auth --role-arn \"arn:aws:iam::XXXXXXXXXXXX:role/allow-ops-admin-access-from-other-accounts\" --role-duration-seconds 3600  but we are getting  User: arn:aws:iam::XXXXXXXXXXXX:user/XXXXXXXX not authorized to perform: sts:AssumeRole on resource: arn:aws:iam::XXXXXXXXXXXX:role/allow-ops-admin-access-from-other-accounts\r\nBut when we assume the other role allow-auto-deploy-from-other-accounts which is also an existing permission within the group, we can assume it successfully.\r\nAny thought on this? Do we miss something?","bodyHTML":"<p dir=\"auto\">A customer asked:</p>\n<blockquote>\n<p dir=\"auto\">We are trying to assume a role allow-ops-admin-access-from-other-accounts using the IAM user from security account that is in the group access-all-external-account . The group has permission for various roles including allow-ops-admin-access-from-other-accounts<br>\nWe executed aws-auth --role-arn \"arn:aws:iam::XXXXXXXXXXXX:role/allow-ops-admin-access-from-other-accounts\" --role-duration-seconds 3600  but we are getting  User: arn:aws:iam::XXXXXXXXXXXX:user/XXXXXXXX not authorized to perform: sts:AssumeRole on resource: arn:aws:iam::XXXXXXXXXXXX:role/allow-ops-admin-access-from-other-accounts<br>\nBut when we assume the other role allow-auto-deploy-from-other-accounts which is also an existing permission within the group, we can assume it successfully.<br>\nAny thought on this? Do we miss something?</p>\n</blockquote>","answer":{"body":"## Debug log\r\n\r\n### Confirming the IAM user, groups and permissions in question\r\n\r\nIn diagnosing the issue, we first ensured that we understood which group the IAM user that the customer was referencing was in. We confirmed it was the `-access-all-external-accounts` group that was defined in both `vars/autogen/common_vars.yml`: \r\n\r\n```\r\n... \r\ncreate_access_keys: false\r\ncreate_login_profile: true \r\ngroups: \r\n       - access-all-external-accounts\r\n...\r\n```\r\nand `security/_global/account-baseline/users.yml`\r\n```\r\n{customer-user-name}: \r\n  create_access_keys: false\r\n  create_login_profile: true \r\n  groups: \r\n  - access-all-external-accounts\r\n  - iam-admin\r\n  - ssh-grunt-sudo-users\r\n  pgp_key: keybase:{customer-user-name}\r\n...\r\n```\r\nAt this point we knew that the user wanted to assumed `allow-ops-admin-access-from-other-accounts` which is defined in their `cross_account_groups.yml` and that their intended IAM user _should_ be able to assume it (because it is a part of the `access-all-external-accounts` group), however the error encountered suggested the user did _not_ have sufficient access to assume the role. \r\n\r\nNext, we double-checked the `access-all-external-accounts` IAM policy, which is attached to the `access-all-external-accounts` group and found there all of the expected permissions to assume the various roles defined in each of the various AWS accounts. \r\n\r\n### Reproducing the users's error with aws-auth\r\n\r\nNext, we [installed `aws-auth`](https://github.com/gruntwork-io/terraform-aws-security/tree/master/modules/aws-auth#aws-auth-helper) and rolled new security credentials for the intended IAM user who was attempting to assume the role. We then issued the following command on behalf of the target IAM user to attempt to reproduce the reported problem: \r\n\r\n```\r\naws-auth --role-arn \"arn:aws:iam::XXXXXXXXXXXX:role/allow-ops-admin-access-from-other-accounts\" --role-duration-seconds 3600\r\n2021-08-19 12:24:04 [INFO] [aws-auth] Assuming role arn:aws:iam::XXXXXXXXXXXX:role/allow-ops-admin-access-from-other-accounts. These creds will expire after 3600 seconds.)\r\n```\r\nand we were able to reproduce the reported issue: \r\n```\r\nAn error occurred (AccessDenied) when calling the AssumeRole operation: User: arn:aws:iam::XXXXXXXXXXXX:user/{customer-iam-user} is not authorized to perform: sts:AssumeRole on resource: arn:aws:iam::XXXXXXXXXXXX:role/allow-ops-admin-access-from-other-accounts\r\n```\r\n\r\n### Confirming trust relationships and MFA settings\r\n\r\nWe also confirmed that the target account (dev) had a valid trust relationship configured with the security account. At this point we also saw the MFA setting: \r\n\r\n```\r\nCondition \tKey \tValue\r\nBool \taws:MultiFactorAuthPresent \t\r\n\r\ntrue \r\n```\r\n### Discovering the root cause\r\n\r\n This means that the successful assumption of the target IAM role would require presenting a valid MFA token!\r\n \r\n Next, we configured virtual MFA using Google Authenticator within the security account for the target IAM user and retried our same `aws-auth` call again, this time passing both the `--serial-number` from the IAM user (same as their user ID) and the `--token-code` flag with the One Time Password (OTP) from Google Authenticator :\r\n \r\n ```\r\naws-auth --role-arn \"arn:aws:iam::XXXXXXXXXXXX:role/allow-ops-admin-access-from-other-accounts\" --role-duration-seconds 3600 --serial-number arn:aws:iam::123456789011:mfa/jondoe --token-code 123456\r\n...\r\nSuccess!\r\n ``` \r\n \r\n ","bodyHTML":"<h2 dir=\"auto\">Debug log</h2>\n<h3 dir=\"auto\">Confirming the IAM user, groups and permissions in question</h3>\n<p dir=\"auto\">In diagnosing the issue, we first ensured that we understood which group the IAM user that the customer was referencing was in. We confirmed it was the <code class=\"notranslate\">-access-all-external-accounts</code> group that was defined in both <code class=\"notranslate\">vars/autogen/common_vars.yml</code>:</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"... \ncreate_access_keys: false\ncreate_login_profile: true \ngroups: \n       - access-all-external-accounts\n...\"><pre class=\"notranslate\"><code class=\"notranslate\">... \ncreate_access_keys: false\ncreate_login_profile: true \ngroups: \n       - access-all-external-accounts\n...\n</code></pre></div>\n<p dir=\"auto\">and <code class=\"notranslate\">security/_global/account-baseline/users.yml</code></p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"{customer-user-name}: \n  create_access_keys: false\n  create_login_profile: true \n  groups: \n  - access-all-external-accounts\n  - iam-admin\n  - ssh-grunt-sudo-users\n  pgp_key: keybase:{customer-user-name}\n...\"><pre class=\"notranslate\"><code class=\"notranslate\">{customer-user-name}: \n  create_access_keys: false\n  create_login_profile: true \n  groups: \n  - access-all-external-accounts\n  - iam-admin\n  - ssh-grunt-sudo-users\n  pgp_key: keybase:{customer-user-name}\n...\n</code></pre></div>\n<p dir=\"auto\">At this point we knew that the user wanted to assumed <code class=\"notranslate\">allow-ops-admin-access-from-other-accounts</code> which is defined in their <code class=\"notranslate\">cross_account_groups.yml</code> and that their intended IAM user <em>should</em> be able to assume it (because it is a part of the <code class=\"notranslate\">access-all-external-accounts</code> group), however the error encountered suggested the user did <em>not</em> have sufficient access to assume the role.</p>\n<p dir=\"auto\">Next, we double-checked the <code class=\"notranslate\">access-all-external-accounts</code> IAM policy, which is attached to the <code class=\"notranslate\">access-all-external-accounts</code> group and found there all of the expected permissions to assume the various roles defined in each of the various AWS accounts.</p>\n<h3 dir=\"auto\">Reproducing the users's error with aws-auth</h3>\n<p dir=\"auto\">Next, we <a href=\"https://github.com/gruntwork-io/terraform-aws-security/tree/master/modules/aws-auth#aws-auth-helper\">installed <code class=\"notranslate\">aws-auth</code></a> and rolled new security credentials for the intended IAM user who was attempting to assume the role. We then issued the following command on behalf of the target IAM user to attempt to reproduce the reported problem:</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"aws-auth --role-arn &quot;arn:aws:iam::XXXXXXXXXXXX:role/allow-ops-admin-access-from-other-accounts&quot; --role-duration-seconds 3600\n2021-08-19 12:24:04 [INFO] [aws-auth] Assuming role arn:aws:iam::XXXXXXXXXXXX:role/allow-ops-admin-access-from-other-accounts. These creds will expire after 3600 seconds.)\"><pre class=\"notranslate\"><code class=\"notranslate\">aws-auth --role-arn \"arn:aws:iam::XXXXXXXXXXXX:role/allow-ops-admin-access-from-other-accounts\" --role-duration-seconds 3600\n2021-08-19 12:24:04 [INFO] [aws-auth] Assuming role arn:aws:iam::XXXXXXXXXXXX:role/allow-ops-admin-access-from-other-accounts. These creds will expire after 3600 seconds.)\n</code></pre></div>\n<p dir=\"auto\">and we were able to reproduce the reported issue:</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"An error occurred (AccessDenied) when calling the AssumeRole operation: User: arn:aws:iam::XXXXXXXXXXXX:user/{customer-iam-user} is not authorized to perform: sts:AssumeRole on resource: arn:aws:iam::XXXXXXXXXXXX:role/allow-ops-admin-access-from-other-accounts\"><pre class=\"notranslate\"><code class=\"notranslate\">An error occurred (AccessDenied) when calling the AssumeRole operation: User: arn:aws:iam::XXXXXXXXXXXX:user/{customer-iam-user} is not authorized to perform: sts:AssumeRole on resource: arn:aws:iam::XXXXXXXXXXXX:role/allow-ops-admin-access-from-other-accounts\n</code></pre></div>\n<h3 dir=\"auto\">Confirming trust relationships and MFA settings</h3>\n<p dir=\"auto\">We also confirmed that the target account (dev) had a valid trust relationship configured with the security account. At this point we also saw the MFA setting:</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"Condition \tKey \tValue\nBool \taws:MultiFactorAuthPresent \t\n\ntrue \"><pre class=\"notranslate\"><code class=\"notranslate\">Condition \tKey \tValue\nBool \taws:MultiFactorAuthPresent \t\n\ntrue \n</code></pre></div>\n<h3 dir=\"auto\">Discovering the root cause</h3>\n<p dir=\"auto\">This means that the successful assumption of the target IAM role would require presenting a valid MFA token!</p>\n<p dir=\"auto\">Next, we configured virtual MFA using Google Authenticator within the security account for the target IAM user and retried our same <code class=\"notranslate\">aws-auth</code> call again, this time passing both the <code class=\"notranslate\">--serial-number</code> from the IAM user (same as their user ID) and the <code class=\"notranslate\">--token-code</code> flag with the One Time Password (OTP) from Google Authenticator :</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"aws-auth --role-arn &quot;arn:aws:iam::XXXXXXXXXXXX:role/allow-ops-admin-access-from-other-accounts&quot; --role-duration-seconds 3600 --serial-number arn:aws:iam::123456789011:mfa/jondoe --token-code 123456\n...\nSuccess!\"><pre class=\"notranslate\"><code class=\"notranslate\">aws-auth --role-arn \"arn:aws:iam::XXXXXXXXXXXX:role/allow-ops-admin-access-from-other-accounts\" --role-duration-seconds 3600 --serial-number arn:aws:iam::123456789011:mfa/jondoe --token-code 123456\n...\nSuccess!\n</code></pre></div>"}}} />

</CenterLayout>

<!-- ##DOCS-SOURCER-START
{
  "sourcePlugin": "github-discussions",
  "hash": "967d63942fb930d811dacce5020bb975"
}
##DOCS-SOURCER-END -->

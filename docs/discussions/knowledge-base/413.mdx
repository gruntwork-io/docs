---
hide_table_of_contents: true
hide_title: true
custom_edit_url: null
---

import CenterLayout from "/src/components/CenterLayout"
import GitHub from "/src/components/GitHub"

<head>
  <link rel="canonical" href="https://github.com/gruntwork-io/knowledge-base/discussions/413" />
</head>

<CenterLayout>
<span className="searchCategory">Knowledge Base</span>
<h1>Using for_each to call a module multiple times</h1>
<GitHub discussion={{"id":"D_kwDOF8slf84APhCc","number":413,"author":{"login":"ulankford"},"title":"Using for_each to call a module multiple times","body":"\nSo I am a little bit confused on using for_each with terragrunt, as there appears to be some documentation regarding it, but much of it is not really relevant for terragrunt as it's implied to be used for terraform.\r\n\r\nSo, for example, if I wanted to create multiple ec2 instances using terragrunt, I would have to create a separate directory for each instance and within that directory would be a terragrunt.hcl file\r\n\r\n```\r\n├── environments\r\n│   ├── dev\r\n│   │   ├── instance01\r\n|   |    |  └────terragrunt.hcl\r\n│   │   ├── instance02\r\n|   |    | └────terragrunt.hcl\r\n│   │   ├── instance03\r\n|   |    | └────terragrunt.hcl\r\n```\r\n\r\n\r\nThis works but is not the most efficient. So onto for_each...\r\n\r\nI tried the following code in to see if I can use for_each to create multiple instances within the same terragrunt.hcl file, but it won't work.\r\n\r\n\r\n```\r\nlocals {\r\n  environment_vars = read_terragrunt_config(find_in_parent_folders(\"env.hcl\"))\r\n  env              = local.environment_vars.locals.environment\r\n\r\n  project_vars = read_terragrunt_config(find_in_parent_folders(\"project.hcl\"))\r\n  project      = local.project_vars.locals.project_name\r\n  application  = local.project_vars.locals.application_name\r\n}\r\n\r\ninclude {\r\n  path = find_in_parent_folders()\r\n}\r\n\r\nterraform {\r\n  source = \"git::https://github.com/terraform-aws-modules/terraform-aws-ec2-instance.git?ref=v4.0.0\"\r\n\r\n  for_each = toset([\"one\", \"two\", \"three\"])\r\n}\r\n\r\ninputs = {\r\n\r\n\r\n  name        = \"${local.project}-${local.application}-${local.env}-${each.key}\"\r\n.\r\n.\r\n.\r\n```\r\n\r\n\r\nThe aws module above does support using for_each.\r\nSo, is the only way to use for_each with terragrunt at the moment is to write a local wrapper module which then calls the underlying was module multiple times, and reference the local module in your terragrunt.hcl file?\r\n\r\nAnton Babenko has a video doing similar here.\r\nhttps://www.youtube.com/watch?v=j4qoL0B-yIY\r\nCode here\r\nhttps://github.com/terraform-aws-modules/terraform-aws-s3-bucket/tree/master/wrappers#usage-with-terragrunt\r\n\r\nOr is there some other way I can call a module multiple times from within a terragrunt.hcl file?\n\n---\n\n<ins datetime=\"2022-05-11T18:08:59Z\">\n  <p><a href=\"https://support.gruntwork.io/hc/requests/108579\">Tracked in ticket #108579</a></p>\n</ins>\n","bodyHTML":"<p dir=\"auto\">So I am a little bit confused on using for_each with terragrunt, as there appears to be some documentation regarding it, but much of it is not really relevant for terragrunt as it's implied to be used for terraform.</p>\n<p dir=\"auto\">So, for example, if I wanted to create multiple ec2 instances using terragrunt, I would have to create a separate directory for each instance and within that directory would be a terragrunt.hcl file</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"├── environments\n│   ├── dev\n│   │   ├── instance01\n|   |    |  └────terragrunt.hcl\n│   │   ├── instance02\n|   |    | └────terragrunt.hcl\n│   │   ├── instance03\n|   |    | └────terragrunt.hcl\"><pre class=\"notranslate\"><code class=\"notranslate\">├── environments\n│   ├── dev\n│   │   ├── instance01\n|   |    |  └────terragrunt.hcl\n│   │   ├── instance02\n|   |    | └────terragrunt.hcl\n│   │   ├── instance03\n|   |    | └────terragrunt.hcl\n</code></pre></div>\n<p dir=\"auto\">This works but is not the most efficient. So onto for_each...</p>\n<p dir=\"auto\">I tried the following code in to see if I can use for_each to create multiple instances within the same terragrunt.hcl file, but it won't work.</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"locals {\n  environment_vars = read_terragrunt_config(find_in_parent_folders(&quot;env.hcl&quot;))\n  env              = local.environment_vars.locals.environment\n\n  project_vars = read_terragrunt_config(find_in_parent_folders(&quot;project.hcl&quot;))\n  project      = local.project_vars.locals.project_name\n  application  = local.project_vars.locals.application_name\n}\n\ninclude {\n  path = find_in_parent_folders()\n}\n\nterraform {\n  source = &quot;git::https://github.com/terraform-aws-modules/terraform-aws-ec2-instance.git?ref=v4.0.0&quot;\n\n  for_each = toset([&quot;one&quot;, &quot;two&quot;, &quot;three&quot;])\n}\n\ninputs = {\n\n\n  name        = &quot;${local.project}-${local.application}-${local.env}-${each.key}&quot;\n.\n.\n.\"><pre class=\"notranslate\"><code class=\"notranslate\">locals {\n  environment_vars = read_terragrunt_config(find_in_parent_folders(\"env.hcl\"))\n  env              = local.environment_vars.locals.environment\n\n  project_vars = read_terragrunt_config(find_in_parent_folders(\"project.hcl\"))\n  project      = local.project_vars.locals.project_name\n  application  = local.project_vars.locals.application_name\n}\n\ninclude {\n  path = find_in_parent_folders()\n}\n\nterraform {\n  source = \"git::https://github.com/terraform-aws-modules/terraform-aws-ec2-instance.git?ref=v4.0.0\"\n\n  for_each = toset([\"one\", \"two\", \"three\"])\n}\n\ninputs = {\n\n\n  name        = \"${local.project}-${local.application}-${local.env}-${each.key}\"\n.\n.\n.\n</code></pre></div>\n<p dir=\"auto\">The aws module above does support using for_each.<br>\nSo, is the only way to use for_each with terragrunt at the moment is to write a local wrapper module which then calls the underlying was module multiple times, and reference the local module in your terragrunt.hcl file?</p>\n<p dir=\"auto\">Anton Babenko has a video doing similar here.<br>\n<a href=\"https://www.youtube.com/watch?v=j4qoL0B-yIY\" rel=\"nofollow\">https://www.youtube.com/watch?v=j4qoL0B-yIY</a><br>\nCode here<br>\n<a href=\"https://github.com/terraform-aws-modules/terraform-aws-s3-bucket/tree/master/wrappers#usage-with-terragrunt\">https://github.com/terraform-aws-modules/terraform-aws-s3-bucket/tree/master/wrappers#usage-with-terragrunt</a></p>\n<p dir=\"auto\">Or is there some other way I can call a module multiple times from within a terragrunt.hcl file?</p>\n<hr>\n<ins datetime=\"2022-05-11T18:08:59Z\">\n  <p dir=\"auto\"><a href=\"https://support.gruntwork.io/hc/requests/108579\" rel=\"nofollow\">Tracked in ticket #108579</a></p>\n</ins>","answer":{"body":"This is unfortunately not supported in `terragrunt`. The only way to do this is to create a `terraform` module that implements the `for_each` call on the module, and have Terragrunt call that root Terraform module.\r\n\r\nAnton's example is actually using [a wrapper script](https://gist.github.com/antonbabenko/d77f8cf8bf891e589a6b5b0ab0e773ae) that generates this wrapper Terraform module that implements the `for_each` call.","bodyHTML":"<p dir=\"auto\">This is unfortunately not supported in <code class=\"notranslate\">terragrunt</code>. The only way to do this is to create a <code class=\"notranslate\">terraform</code> module that implements the <code class=\"notranslate\">for_each</code> call on the module, and have Terragrunt call that root Terraform module.</p>\n<p dir=\"auto\">Anton's example is actually using <a href=\"https://gist.github.com/antonbabenko/d77f8cf8bf891e589a6b5b0ab0e773ae\">a wrapper script</a> that generates this wrapper Terraform module that implements the <code class=\"notranslate\">for_each</code> call.</p>"}}} />

</CenterLayout>

<!-- ##DOCS-SOURCER-START
{
  "sourcePlugin": "github-discussions",
  "hash": "cffce9ff20ca9304f94dbbcb8fbf27be"
}
##DOCS-SOURCER-END -->

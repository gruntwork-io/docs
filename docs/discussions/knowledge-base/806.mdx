---
hide_table_of_contents: true
hide_title: true
custom_edit_url: null
---

import CenterLayout from "/src/components/CenterLayout"
import GitHub from "/src/components/GitHub"

<head>
  <link rel="canonical" href="https://github.com/gruntwork-io/knowledge-base/discussions/806" />
</head>

<CenterLayout>
<span className="searchCategory">Knowledge Base</span>
<h1>Using Terraform Modules with provider.tf</h1>
<GitHub discussion={{"id":"D_kwDOF8slf84AYKkz","number":806,"author":{"login":"Conzar"},"title":"Using Terraform Modules with provider.tf","body":"\r\nI am working on modularising a monolithic structured terraform environment.  1 provider.tf is included per module.  The modules are uploaded into a private terraform cloud registry.  The terragrunt.hcl that uses the module references it like below:\r\n\r\n```\r\nterraform {\r\n  source  = \"tfr://app.terraform.io/<WORKSPACE>/<FUNCTION>/<NAME>?version=x.x.x\"\r\n}\r\n```\r\n\r\nStructure:\r\n\r\n```\r\ncode\r\n  |\r\n  --> root.hcl\r\n  --> linux_user\r\n    |\r\n    --> terragrunt.hcl \r\n  --> bucket\r\n    |\r\n    --> terragrunt.hcl\r\n   ...\r\n```\r\n\r\nThe module linux_user has a provider.tf which requires 2 additional providers (publically available).\r\n\r\nSo dependency looks like this:\r\n\r\n* terragrent -- REQUIRES --> linux_user\r\n* linux_user -- REQUIRES --> aws & system\r\n\r\nThe problem is that I use a root.hcl that creates the provider.tf which is especially needed for localstack integration and keeping my code dry.\r\n\r\n```\r\ngenerate \"provider\" {\r\n  path = \"provider.tf\"\r\n  if_exists = \"overwrite_terragrunt\"\r\n  #if_exists = \"overwrite\"\r\n  contents = <<EOF\r\nprovider \"aws\" {\r\n  access_key                  = \"${local.settings.inputs.access_key}\"\r\n  secret_key                  = \"${local.settings.inputs.secret_key}\"\r\n  region                      = \"${local.settings.inputs.aws_region}\"\r\n  s3_use_path_style           = true\r\n  skip_credentials_validation = true\r\n  skip_metadata_api_check     = true\r\n  skip_requesting_account_id  = true\r\n\r\n\r\n  endpoints {\r\n    acm            = \"http://${local.settings.inputs.host}:${local.settings.inputs.port}\"\r\n    apigateway     = \"http://${local.settings.inputs.host}:${local.settings.inputs.port}\"\r\n   ...\r\n```\r\n\r\nWhat is the best practices for creating modules and specifying required providers?  Shouldn't this be included in the module?\r\nHow should Terragrunt handle dependencies inside of modules?\r\n\r\nAlso note, that I don't want to put all of the providers in the root.hcl because some of the providers have specific requirements [neuspaces/system](https://registry.terraform.io/providers/neuspaces/system/latest) where the provider needs additional configuration.  \r\n\r\nShouldn't the module dictate the versions of providers needed?  Terragrunt should just dictate the version of the root module and not its dependencies?\r\n\r\n---\r\n\r\n<ins datetime=\"2024-03-07T03:16:24Z\">\r\n  <p><a href=\"https://support.gruntwork.io/hc/requests/110814\">Tracked in ticket #110814</a></p>\r\n</ins>\r\n","bodyHTML":"<p dir=\"auto\">I am working on modularising a monolithic structured terraform environment.  1 provider.tf is included per module.  The modules are uploaded into a private terraform cloud registry.  The terragrunt.hcl that uses the module references it like below:</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"terraform {\n  source  = &quot;tfr://app.terraform.io/&lt;WORKSPACE&gt;/&lt;FUNCTION&gt;/&lt;NAME&gt;?version=x.x.x&quot;\n}\"><pre class=\"notranslate\"><code class=\"notranslate\">terraform {\n  source  = \"tfr://app.terraform.io/&lt;WORKSPACE&gt;/&lt;FUNCTION&gt;/&lt;NAME&gt;?version=x.x.x\"\n}\n</code></pre></div>\n<p dir=\"auto\">Structure:</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"code\n  |\n  --&gt; root.hcl\n  --&gt; linux_user\n    |\n    --&gt; terragrunt.hcl \n  --&gt; bucket\n    |\n    --&gt; terragrunt.hcl\n   ...\"><pre class=\"notranslate\"><code class=\"notranslate\">code\n  |\n  --&gt; root.hcl\n  --&gt; linux_user\n    |\n    --&gt; terragrunt.hcl \n  --&gt; bucket\n    |\n    --&gt; terragrunt.hcl\n   ...\n</code></pre></div>\n<p dir=\"auto\">The module linux_user has a provider.tf which requires 2 additional providers (publically available).</p>\n<p dir=\"auto\">So dependency looks like this:</p>\n<ul dir=\"auto\">\n<li>terragrent -- REQUIRES --&gt; linux_user</li>\n<li>linux_user -- REQUIRES --&gt; aws &amp; system</li>\n</ul>\n<p dir=\"auto\">The problem is that I use a root.hcl that creates the provider.tf which is especially needed for localstack integration and keeping my code dry.</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"generate &quot;provider&quot; {\n  path = &quot;provider.tf&quot;\n  if_exists = &quot;overwrite_terragrunt&quot;\n  #if_exists = &quot;overwrite&quot;\n  contents = &lt;&lt;EOF\nprovider &quot;aws&quot; {\n  access_key                  = &quot;${local.settings.inputs.access_key}&quot;\n  secret_key                  = &quot;${local.settings.inputs.secret_key}&quot;\n  region                      = &quot;${local.settings.inputs.aws_region}&quot;\n  s3_use_path_style           = true\n  skip_credentials_validation = true\n  skip_metadata_api_check     = true\n  skip_requesting_account_id  = true\n\n\n  endpoints {\n    acm            = &quot;http://${local.settings.inputs.host}:${local.settings.inputs.port}&quot;\n    apigateway     = &quot;http://${local.settings.inputs.host}:${local.settings.inputs.port}&quot;\n   ...\"><pre class=\"notranslate\"><code class=\"notranslate\">generate \"provider\" {\n  path = \"provider.tf\"\n  if_exists = \"overwrite_terragrunt\"\n  #if_exists = \"overwrite\"\n  contents = &lt;&lt;EOF\nprovider \"aws\" {\n  access_key                  = \"${local.settings.inputs.access_key}\"\n  secret_key                  = \"${local.settings.inputs.secret_key}\"\n  region                      = \"${local.settings.inputs.aws_region}\"\n  s3_use_path_style           = true\n  skip_credentials_validation = true\n  skip_metadata_api_check     = true\n  skip_requesting_account_id  = true\n\n\n  endpoints {\n    acm            = \"http://${local.settings.inputs.host}:${local.settings.inputs.port}\"\n    apigateway     = \"http://${local.settings.inputs.host}:${local.settings.inputs.port}\"\n   ...\n</code></pre></div>\n<p dir=\"auto\">What is the best practices for creating modules and specifying required providers?  Shouldn't this be included in the module?<br>\nHow should Terragrunt handle dependencies inside of modules?</p>\n<p dir=\"auto\">Also note, that I don't want to put all of the providers in the root.hcl because some of the providers have specific requirements <a href=\"https://registry.terraform.io/providers/neuspaces/system/latest\" rel=\"nofollow\">neuspaces/system</a> where the provider needs additional configuration.</p>\n<p dir=\"auto\">Shouldn't the module dictate the versions of providers needed?  Terragrunt should just dictate the version of the root module and not its dependencies?</p>\n<hr>\n<ins datetime=\"2024-03-07T03:16:24Z\">\n  <p dir=\"auto\"><a href=\"https://support.gruntwork.io/hc/requests/110814\" rel=\"nofollow\">Tracked in ticket #110814</a></p>\n</ins>","answer":{"body":"I found a solution:\r\n\r\n* Add required_providers block into root.hcl\r\n* Add a stub block in root.hcl that dynamically applies stubs for all providers that require configuration.\r\n  * Terragrunt folders that use Modules that configure the providers block will turn off the stubs.\r\n* Create a separate file for managing private registry module versions.\r\n\r\nThis way, all module versions & provider versions are in the same place.  \r\nIt will be the responsiblity of the terraform_control repository for managing the versions of everything (which is similar to other orchestration tools like Puppetfile for Puppet).\r\n\r\n### stub block in root.hcl\r\nThis section shows an example of auto-generating the stub block from per folder configuration.  You can add additional %{if VARIABLE} blocks as needed.\r\n\r\n```hcl\r\nlocals {\r\n  stubs            = read_terragrunt_config(\"stubs.hcl\")\r\n}\r\n\r\ngenerate \"stub_block\" {\r\n  path      = \"stub.tf\"\r\n  if_exists = \"overwrite_terragrunt\"\r\n  contents  = <<EOF\r\n  %{if local.stubs.inputs.use_system_stub}\r\nprovider \"system\" {\r\n  sudo = false\r\n  ssh {\r\n    host        = localhost\r\n    port        = 22\r\n    user        = user\r\n    private_key = empty\r\n  }\r\n}\r\n  %{endif}\r\nEOF\r\n}\r\n```\r\n\r\n### example of stubs.hcl\r\nNote, each terragrunt.hcl folder should also have a stub.hcl.\r\n\r\n```hcl\r\ninputs = {\r\n  use_system_stub = true\r\n}\r\n```\r\n","bodyHTML":"<p dir=\"auto\">I found a solution:</p>\n<ul dir=\"auto\">\n<li>Add required_providers block into root.hcl</li>\n<li>Add a stub block in root.hcl that dynamically applies stubs for all providers that require configuration.\n<ul dir=\"auto\">\n<li>Terragrunt folders that use Modules that configure the providers block will turn off the stubs.</li>\n</ul>\n</li>\n<li>Create a separate file for managing private registry module versions.</li>\n</ul>\n<p dir=\"auto\">This way, all module versions &amp; provider versions are in the same place.<br>\nIt will be the responsiblity of the terraform_control repository for managing the versions of everything (which is similar to other orchestration tools like Puppetfile for Puppet).</p>\n<h3 dir=\"auto\">stub block in root.hcl</h3>\n<p dir=\"auto\">This section shows an example of auto-generating the stub block from per folder configuration.  You can add additional %{if VARIABLE} blocks as needed.</p>\n<div class=\"highlight highlight-source-hcl notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"locals {\n  stubs            = read_terragrunt_config(&quot;stubs.hcl&quot;)\n}\n\ngenerate &quot;stub_block&quot; {\n  path      = &quot;stub.tf&quot;\n  if_exists = &quot;overwrite_terragrunt&quot;\n  contents  = &lt;&lt;EOF\n  %{if local.stubs.inputs.use_system_stub}\nprovider &quot;system&quot; {\n  sudo = false\n  ssh {\n    host        = localhost\n    port        = 22\n    user        = user\n    private_key = empty\n  }\n}\n  %{endif}\nEOF\n}\"><pre class=\"notranslate\"><span class=\"pl-en\">locals</span> {\n  <span class=\"pl-v\"><span class=\"pl-smi\">stubs</span>            <span class=\"pl-k\">=</span> </span><span class=\"pl-c1\">read_terragrunt_config</span>(<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>stubs.hcl<span class=\"pl-pds\">\"</span></span>)\n}\n\n<span class=\"pl-en\">generate</span> <span class=\"pl-smi\">\"stub_block\"</span> {\n  <span class=\"pl-v\"><span class=\"pl-smi\">path</span>      <span class=\"pl-k\">=</span> </span><span class=\"pl-s\"><span class=\"pl-pds\">\"</span>stub.tf<span class=\"pl-pds\">\"</span></span>\n  <span class=\"pl-v\"><span class=\"pl-smi\">if_exists</span> <span class=\"pl-k\">=</span> </span><span class=\"pl-s\"><span class=\"pl-pds\">\"</span>overwrite_terragrunt<span class=\"pl-pds\">\"</span></span>\n  <span class=\"pl-v\"><span class=\"pl-smi\">contents</span>  <span class=\"pl-k\">=</span> </span><span class=\"pl-s\"><span class=\"pl-k\">&lt;&lt;</span><span class=\"pl-k\">EOF</span></span>\n<span class=\"pl-s\">  <span class=\"pl-k\">%{</span><span class=\"pl-k\">if</span> <span class=\"pl-smi\">local</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">stubs</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">inputs</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">use_system_stub</span><span class=\"pl-k\">}</span></span>\n<span class=\"pl-s\">provider \"system\" {</span>\n<span class=\"pl-s\">  sudo = false</span>\n<span class=\"pl-s\">  ssh {</span>\n<span class=\"pl-s\">    host        = localhost</span>\n<span class=\"pl-s\">    port        = 22</span>\n<span class=\"pl-s\">    user        = user</span>\n<span class=\"pl-s\">    private_key = empty</span>\n<span class=\"pl-s\">  }</span>\n<span class=\"pl-s\">}</span>\n<span class=\"pl-s\">  <span class=\"pl-k\">%{</span><span class=\"pl-k\">endif</span><span class=\"pl-k\">}</span></span>\n<span class=\"pl-s\"><span class=\"pl-k\">EOF</span></span>\n}</pre></div>\n<h3 dir=\"auto\">example of stubs.hcl</h3>\n<p dir=\"auto\">Note, each terragrunt.hcl folder should also have a stub.hcl.</p>\n<div class=\"highlight highlight-source-hcl notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"inputs = {\n  use_system_stub = true\n}\"><pre class=\"notranslate\"><span class=\"pl-v\"><span class=\"pl-smi\">inputs</span> <span class=\"pl-k\">=</span> </span>{\n  use_system_stub <span class=\"pl-k\">=</span> <span class=\"pl-c1\">true</span>\n}</pre></div>"}}} />

</CenterLayout>

<!-- ##DOCS-SOURCER-START
{
  "sourcePlugin": "github-discussions",
  "hash": "c08277e6b815b3ffe219512cb3b89bab"
}
##DOCS-SOURCER-END -->

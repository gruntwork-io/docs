---
hide_table_of_contents: true
hide_title: true
custom_edit_url: null
---

import CenterLayout from "/src/components/CenterLayout"
import GitHub from "/src/components/GitHub"

<head>
  <link rel="canonical" href="https://github.com/gruntwork-io/knowledge-base/discussions/186" />
</head>

<CenterLayout>
<span className="searchCategory">Knowledge Base</span>
<h1>Dependency errors during undeploy process</h1>
<GitHub discussion={{"id":"D_kwDOF8slf84AOwi7","number":186,"author":{"login":"rhoboat"},"title":"Dependency errors during undeploy process","body":"Hi, \r\n\r\nWe are working on moving our resources to a new region (region-A) and removing the ones created in the old one (region-B).\r\n\r\nAs part of this process we’re destroying the resources from CLI using terragrunt destroy and then deleting the folders/files and creating a PR and merging it using GW Ref Arch pipeline.\r\n\r\nEverything was working as expected until we went to remove the sample-app folders, since we had removed other resources used by the sample-app like the load balancers, now we’re getting a dependency error like this one:\r\n```\r\n[ecs-deploy-runner][2022-02-10T11:41:37+0000] [INFO] [infrastructure-deploy-script] 2022-02-10 11:41:37  Successfully\r\n checked out origin/master\r\n[ecs-deploy-runner][2022-02-10T11:41:37+0000] [INFO] [infrastructure-deploy-script] 2022-02-10 11:41:37  Running \r\ncommand \"terragrunt plan -input=false -destroy\"\r\n[ecs-deploy-runner][2022-02-10T11:41:39+0000] time=2022-02-10T11:41:39Z level=error msg=Could not convert include\r\n to the execution context to evaluate additional locals\r\n[ecs-deploy-runner][2022-02-10T11:41:39+0000] time=2022-02-10T11:41:39Z level=error msg=Encountered error while\r\n evaluating locals.\r\n[ecs-deploy-runner][2022-02-10T11:41:39+0000] time=2022-02-10T11:41:39Z level=error msg=Error reading file at path\r\n /tmp/tmp9vl1acw3/dev/us-east-2/dev/networking/alb: open \r\n/tmp/tmp9vl1acw3/dev/us-east-2/dev/networking/alb: no such file or directory\r\n```\r\nWe already deleted these resources from the CLI (`sample-app` and `ecs-cluster`), but now we can’t push the changes to master using the pipeline. Is there are a recommended way to fix this issue?\r\n\r\nThanks","bodyHTML":"<p dir=\"auto\">Hi,</p>\n<p dir=\"auto\">We are working on moving our resources to a new region (region-A) and removing the ones created in the old one (region-B).</p>\n<p dir=\"auto\">As part of this process we’re destroying the resources from CLI using terragrunt destroy and then deleting the folders/files and creating a PR and merging it using GW Ref Arch pipeline.</p>\n<p dir=\"auto\">Everything was working as expected until we went to remove the sample-app folders, since we had removed other resources used by the sample-app like the load balancers, now we’re getting a dependency error like this one:</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"[ecs-deploy-runner][2022-02-10T11:41:37+0000] [INFO] [infrastructure-deploy-script] 2022-02-10 11:41:37  Successfully\n checked out origin/master\n[ecs-deploy-runner][2022-02-10T11:41:37+0000] [INFO] [infrastructure-deploy-script] 2022-02-10 11:41:37  Running \ncommand &quot;terragrunt plan -input=false -destroy&quot;\n[ecs-deploy-runner][2022-02-10T11:41:39+0000] time=2022-02-10T11:41:39Z level=error msg=Could not convert include\n to the execution context to evaluate additional locals\n[ecs-deploy-runner][2022-02-10T11:41:39+0000] time=2022-02-10T11:41:39Z level=error msg=Encountered error while\n evaluating locals.\n[ecs-deploy-runner][2022-02-10T11:41:39+0000] time=2022-02-10T11:41:39Z level=error msg=Error reading file at path\n /tmp/tmp9vl1acw3/dev/us-east-2/dev/networking/alb: open \n/tmp/tmp9vl1acw3/dev/us-east-2/dev/networking/alb: no such file or directory\"><pre class=\"notranslate\"><code class=\"notranslate\">[ecs-deploy-runner][2022-02-10T11:41:37+0000] [INFO] [infrastructure-deploy-script] 2022-02-10 11:41:37  Successfully\n checked out origin/master\n[ecs-deploy-runner][2022-02-10T11:41:37+0000] [INFO] [infrastructure-deploy-script] 2022-02-10 11:41:37  Running \ncommand \"terragrunt plan -input=false -destroy\"\n[ecs-deploy-runner][2022-02-10T11:41:39+0000] time=2022-02-10T11:41:39Z level=error msg=Could not convert include\n to the execution context to evaluate additional locals\n[ecs-deploy-runner][2022-02-10T11:41:39+0000] time=2022-02-10T11:41:39Z level=error msg=Encountered error while\n evaluating locals.\n[ecs-deploy-runner][2022-02-10T11:41:39+0000] time=2022-02-10T11:41:39Z level=error msg=Error reading file at path\n /tmp/tmp9vl1acw3/dev/us-east-2/dev/networking/alb: open \n/tmp/tmp9vl1acw3/dev/us-east-2/dev/networking/alb: no such file or directory\n</code></pre></div>\n<p dir=\"auto\">We already deleted these resources from the CLI (<code class=\"notranslate\">sample-app</code> and <code class=\"notranslate\">ecs-cluster</code>), but now we can’t push the changes to master using the pipeline. Is there are a recommended way to fix this issue?</p>\n<p dir=\"auto\">Thanks</p>","answer":{"body":"The Reference Architecture can be destroyed/undeployed following reverse dependency order, to avoid this issue where existing modules depend on already destroyed resources.\r\n\r\nHere's an [example undeploy documentation](https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/master/examples/for-production/infrastructure-live/docs/07-undeploy.md) that you would have received in your Ref Arch deployment (look under /docs).\r\n\r\nFirst recommendation, if you still have the code in your version control for the old region (region-B), restore the already deleted module and redeploy. Then undeploy using the reverse dependency order in that undeploy doc. This is a known path.\r\n\r\nIf that's not feasible because there's too many to restore, you can use the [`skip_outputs` flag](https://terragrunt.gruntwork.io/docs/reference/config-blocks-and-attributes/) in the `dependency` blocks for the resources that have already been destroyed. Also you'll need to update the `mock_outputs_allowed_terraform_commands` to include `plan` and `apply`. By default we only specify `validate`. If you then run `terragrunt plan -destroy` or `terragrunt apply -destroy`, those dependencies will be ignored and you should be able to complete the destroy. I was able to test this out on a real Ref Arch to confirm this, but please let me know if this doesn't work.","bodyHTML":"<p dir=\"auto\">The Reference Architecture can be destroyed/undeployed following reverse dependency order, to avoid this issue where existing modules depend on already destroyed resources.</p>\n<p dir=\"auto\">Here's an <a href=\"https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/master/examples/for-production/infrastructure-live/docs/07-undeploy.md\">example undeploy documentation</a> that you would have received in your Ref Arch deployment (look under /docs).</p>\n<p dir=\"auto\">First recommendation, if you still have the code in your version control for the old region (region-B), restore the already deleted module and redeploy. Then undeploy using the reverse dependency order in that undeploy doc. This is a known path.</p>\n<p dir=\"auto\">If that's not feasible because there's too many to restore, you can use the <a href=\"https://terragrunt.gruntwork.io/docs/reference/config-blocks-and-attributes/\" rel=\"nofollow\"><code class=\"notranslate\">skip_outputs</code> flag</a> in the <code class=\"notranslate\">dependency</code> blocks for the resources that have already been destroyed. Also you'll need to update the <code class=\"notranslate\">mock_outputs_allowed_terraform_commands</code> to include <code class=\"notranslate\">plan</code> and <code class=\"notranslate\">apply</code>. By default we only specify <code class=\"notranslate\">validate</code>. If you then run <code class=\"notranslate\">terragrunt plan -destroy</code> or <code class=\"notranslate\">terragrunt apply -destroy</code>, those dependencies will be ignored and you should be able to complete the destroy. I was able to test this out on a real Ref Arch to confirm this, but please let me know if this doesn't work.</p>"}}} />

</CenterLayout>

<!-- ##DOCS-SOURCER-START
{
  "sourcePlugin": "github-discussions",
  "hash": "e5bee8a9fd7992b24ade28ba1415735b"
}
##DOCS-SOURCER-END -->

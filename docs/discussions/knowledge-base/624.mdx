---
hide_table_of_contents: true
hide_title: true
custom_edit_url: null
---

import CenterLayout from "/src/components/CenterLayout"
import GitHub from "/src/components/GitHub"

<head>
  <link rel="canonical" href="https://github.com/gruntwork-io/knowledge-base/discussions/624" />
</head>

<CenterLayout>
<span className="searchCategory">Knowledge Base</span>
<h1>How do I incorporate a forward web proxy in the gruntwork RA</h1>
<GitHub discussion={{"id":"D_kwDOF8slf84AR8uj","number":624,"author":{"login":"hammondr"},"title":"How do I incorporate a forward web proxy in the gruntwork RA","body":"\nOur customers want to manage/block/allow outbound web traffic via squid (or similar) forward web proxy.  I can think of two primary ways to do this:\r\n1. Add a squid EC2 node as a _transparent forward/outbound proxy_\r\n- Add a squid EC2 node.  Use a persistent ENI, e.g. one provided by the [ASG server-group module](https://github.com/gruntwork-io/terraform-aws-asg/tree/main/modules/server-group)\r\n- update the relevant route table(s) to route 0.0.0.0 traffic to this ENI\r\n- add a route table for this node that routes 0.0.0.0 traffic to the RA NAT instance \r\n- no internal node/app configuration needed\r\n2. Add a squid EC2 node as an _explicit forward/outbound proxy_\r\n- Add a squid EC2 node.  Use a persistent ENI, e.g. one provided by the [ASG server-group module](https://github.com/gruntwork-io/terraform-aws-asg/tree/main/modules/server-group)\r\n- set the proxy URL environment vars `http_proxy` and `https_proxy` for _all the Linux Ec2 instances in the architecture_ to point to the squid interface/port\r\n- configure internal apps to use the same proxy URL\r\n- no route table work\r\n\r\nMethod 2 is easier to implement but is a \"weak/soft\" control on outbound web traffic. (A malicious or misconfigured app could just communicate outbound without using the proxy.\r\n\r\nMethod 1 would be much stronger but I would expect the gruntwork [vpc module](https://github.com/gruntwork-io/terraform-aws-vpc/tree/main/modules/vpc-app) to \"fight\" over the routes in the route tables.\r\n\r\nHow have gruntwork customers provided this kind of outbound traffic inspection/filtering?\n\n---\n\n<ins datetime=\"2022-12-30T13:01:32Z\">\n  <p><a href=\"https://support.gruntwork.io/hc/requests/109753\">Tracked in ticket #109753</a></p>\n</ins>\n","bodyHTML":"<p dir=\"auto\">Our customers want to manage/block/allow outbound web traffic via squid (or similar) forward web proxy.  I can think of two primary ways to do this:</p>\n<ol dir=\"auto\">\n<li>Add a squid EC2 node as a <em>transparent forward/outbound proxy</em></li>\n</ol>\n<ul dir=\"auto\">\n<li>Add a squid EC2 node.  Use a persistent ENI, e.g. one provided by the <a href=\"https://github.com/gruntwork-io/terraform-aws-asg/tree/main/modules/server-group\">ASG server-group module</a></li>\n<li>update the relevant route table(s) to route 0.0.0.0 traffic to this ENI</li>\n<li>add a route table for this node that routes 0.0.0.0 traffic to the RA NAT instance</li>\n<li>no internal node/app configuration needed</li>\n</ul>\n<ol start=\"2\" dir=\"auto\">\n<li>Add a squid EC2 node as an <em>explicit forward/outbound proxy</em></li>\n</ol>\n<ul dir=\"auto\">\n<li>Add a squid EC2 node.  Use a persistent ENI, e.g. one provided by the <a href=\"https://github.com/gruntwork-io/terraform-aws-asg/tree/main/modules/server-group\">ASG server-group module</a></li>\n<li>set the proxy URL environment vars <code class=\"notranslate\">http_proxy</code> and <code class=\"notranslate\">https_proxy</code> for <em>all the Linux Ec2 instances in the architecture</em> to point to the squid interface/port</li>\n<li>configure internal apps to use the same proxy URL</li>\n<li>no route table work</li>\n</ul>\n<p dir=\"auto\">Method 2 is easier to implement but is a \"weak/soft\" control on outbound web traffic. (A malicious or misconfigured app could just communicate outbound without using the proxy.</p>\n<p dir=\"auto\">Method 1 would be much stronger but I would expect the gruntwork <a href=\"https://github.com/gruntwork-io/terraform-aws-vpc/tree/main/modules/vpc-app\">vpc module</a> to \"fight\" over the routes in the route tables.</p>\n<p dir=\"auto\">How have gruntwork customers provided this kind of outbound traffic inspection/filtering?</p>\n<hr>\n<ins datetime=\"2022-12-30T13:01:32Z\">\n  <p dir=\"auto\"><a href=\"https://support.gruntwork.io/hc/requests/109753\" rel=\"nofollow\">Tracked in ticket #109753</a></p>\n</ins>","answer":{"body":"Hi @hammondr, we don’t currently have a pre-made module to address this kind of proxy. An option would be using AWS Network Firewall, and we had started work to add support for it in our vpc module (https://github.com/gruntwork-io/terraform-aws-vpc/pull/210). However, this PR is currently paused while we scale our team, but maybe the progress made so far can offer some insight into how one could adopt this kind of solution?\r\n\r\n  Regarding your options, I would lean torwards the first approach. About the `vpc_module` “fighting” this setup, you might have to disable some features in it and create some resources externally to the module, but it could work. For example, you could disable the creation of the internet gateway through the variable `var.create_igw` or some flags involved in the creation of the routes that could conflict with your intended setup. For example: https://github.com/gruntwork-io/terraform-aws-vpc/blob/main/modules/vpc-app/main.tf#L404.\r\n\r\nConcerning more general solutions for Squid proxy, this post has some interesting suggestions, such as putting the Squid node in an ASG of size 1: https://aws.amazon.com/blogs/security/how-to-add-dns-filtering-to-your-nat-instance-with-squid/","bodyHTML":"<p dir=\"auto\">Hi <a class=\"user-mention notranslate\" data-hovercard-type=\"user\" data-hovercard-url=\"/users/hammondr/hovercard\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/hammondr\">@hammondr</a>, we don’t currently have a pre-made module to address this kind of proxy. An option would be using AWS Network Firewall, and we had started work to add support for it in our vpc module (<a href=\"https://github.com/gruntwork-io/terraform-aws-vpc/pull/210\">https://github.com/gruntwork-io/terraform-aws-vpc/pull/210</a>). However, this PR is currently paused while we scale our team, but maybe the progress made so far can offer some insight into how one could adopt this kind of solution?</p>\n<p dir=\"auto\">  Regarding your options, I would lean torwards the first approach. About the <code class=\"notranslate\">vpc_module</code> “fighting” this setup, you might have to disable some features in it and create some resources externally to the module, but it could work. For example, you could disable the creation of the internet gateway through the variable <code class=\"notranslate\">var.create_igw</code> or some flags involved in the creation of the routes that could conflict with your intended setup. For example: <a href=\"https://github.com/gruntwork-io/terraform-aws-vpc/blob/main/modules/vpc-app/main.tf#L404\">https://github.com/gruntwork-io/terraform-aws-vpc/blob/main/modules/vpc-app/main.tf#L404</a>.</p>\n<p dir=\"auto\">Concerning more general solutions for Squid proxy, this post has some interesting suggestions, such as putting the Squid node in an ASG of size 1: <a href=\"https://aws.amazon.com/blogs/security/how-to-add-dns-filtering-to-your-nat-instance-with-squid/\" rel=\"nofollow\">https://aws.amazon.com/blogs/security/how-to-add-dns-filtering-to-your-nat-instance-with-squid/</a></p>"}}} />

</CenterLayout>

<!-- ##DOCS-SOURCER-START
{
  "sourcePlugin": "github-discussions",
  "hash": "d46331bf107c0355c556ad35e1d41173"
}
##DOCS-SOURCER-END -->

---
hide_table_of_contents: true
hide_title: true
custom_edit_url: null
---

import CenterLayout from "/src/components/CenterLayout"
import GitHub from "/src/components/GitHub"

<head>
  <link rel="canonical" href="https://github.com/gruntwork-io/knowledge-base/discussions/76" />
</head>

<CenterLayout>
<span className="searchCategory">Knowledge Base</span>
<h1>IAM errors when extending ECS Deploy Runner with AWS Systems Manager permissions</h1>
<GitHub discussion={{"id":"D_kwDOF8slf84AOOKu","number":76,"author":{"login":"zackproser"},"title":"IAM errors when extending ECS Deploy Runner with AWS Systems Manager permissions","body":"A customer asked: \r\n\r\n> We attached the following policy to our `allow-ops-admin-access-from-other-accounts` role, since this is the role we assume when accessing other accounts. \r\n\r\n```\r\n... other permissions omitted for brevity ... \r\n {\r\n            \"Sid\": \"SSM\",\r\n            \"Effect\": \"Allow\",\r\n            \"Action\": [\r\n                \"ssm:AddTagsToResource\",\r\n                \"ssm:GetParameter\",\r\n                \"ssm:GetParameters\",\r\n                \"ssm:PutParameter\",\r\n                \"ssm:DeleteParameter\",\r\n                \"ssm:RemoveTagsFromResource\"\r\n            ],\r\n            \"Resource\": \"*\"\r\n        },\r\n```\r\n\r\nThe error we receive when attempting to launch `sysdig` into our account is: \r\n\r\n```\r\n│ Error: error creating SSM parameter (sysdig-api-token): AccessDeniedException: User: arn:aws:sts::[hidden]:assumed-role/allow-ops-admin-access-from-other-accounts/[hiddent] is not authorized to perform: ssm:PutParameter on resource: arn:aws:ssm:us-west-2:[hidden]:parameter/sysdig-api-token because no identity-based policy allows the ssm:PutParameter action\r\n│     status code: 400, request id: [hidden]\r\n```","bodyHTML":"<p dir=\"auto\">A customer asked:</p>\n<blockquote>\n<p dir=\"auto\">We attached the following policy to our <code class=\"notranslate\">allow-ops-admin-access-from-other-accounts</code> role, since this is the role we assume when accessing other accounts.</p>\n</blockquote>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"... other permissions omitted for brevity ... \n {\n            &quot;Sid&quot;: &quot;SSM&quot;,\n            &quot;Effect&quot;: &quot;Allow&quot;,\n            &quot;Action&quot;: [\n                &quot;ssm:AddTagsToResource&quot;,\n                &quot;ssm:GetParameter&quot;,\n                &quot;ssm:GetParameters&quot;,\n                &quot;ssm:PutParameter&quot;,\n                &quot;ssm:DeleteParameter&quot;,\n                &quot;ssm:RemoveTagsFromResource&quot;\n            ],\n            &quot;Resource&quot;: &quot;*&quot;\n        },\"><pre class=\"notranslate\"><code class=\"notranslate\">... other permissions omitted for brevity ... \n {\n            \"Sid\": \"SSM\",\n            \"Effect\": \"Allow\",\n            \"Action\": [\n                \"ssm:AddTagsToResource\",\n                \"ssm:GetParameter\",\n                \"ssm:GetParameters\",\n                \"ssm:PutParameter\",\n                \"ssm:DeleteParameter\",\n                \"ssm:RemoveTagsFromResource\"\n            ],\n            \"Resource\": \"*\"\n        },\n</code></pre></div>\n<p dir=\"auto\">The error we receive when attempting to launch <code class=\"notranslate\">sysdig</code> into our account is:</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"│ Error: error creating SSM parameter (sysdig-api-token): AccessDeniedException: User: arn:aws:sts::[hidden]:assumed-role/allow-ops-admin-access-from-other-accounts/[hiddent] is not authorized to perform: ssm:PutParameter on resource: arn:aws:ssm:us-west-2:[hidden]:parameter/sysdig-api-token because no identity-based policy allows the ssm:PutParameter action\n│     status code: 400, request id: [hidden]\"><pre class=\"notranslate\"><code class=\"notranslate\">│ Error: error creating SSM parameter (sysdig-api-token): AccessDeniedException: User: arn:aws:sts::[hidden]:assumed-role/allow-ops-admin-access-from-other-accounts/[hiddent] is not authorized to perform: ssm:PutParameter on resource: arn:aws:ssm:us-west-2:[hidden]:parameter/sysdig-api-token because no identity-based policy allows the ssm:PutParameter action\n│     status code: 400, request id: [hidden]\n</code></pre></div>","answer":{"body":"It looks like the `allow-ops-admin-access-from-other-accounts` role, by default, is configured with the same permissions that our Elastic Deploy Runner in the security account's mgmt folder shows in the `deploy_permissions.yml` file. \r\n\r\nIn most cases, this includes `KMS:*`, which would in turn include actions such as `KMS:Decrypt` and `KMS:Encrypt`. Why are the KMS permissions relevant?\r\n\r\nIn a couple of cases, even if you have sufficient permissions to take an action in IAM, but that action (say, `ssm:PutParameter` in this case) will end up making use of a KMS key, whether it be customer managed or a default one managed by AWS, then you still need sufficient permissions for that KMS key, too. \r\n\r\nOtherwise, you get these really opaque and confusing access denied exceptions. Your policy above doesn't include the `KMS:Decrypt` or `KMS:Encrypt` actions, for example. I can see you do have the `ssm:PutParameter` action, hence I understand why you'd expect the action to be allowed. But if you [have a look at the System Manager docs for the parameter store](https://docs.aws.amazon.com/kms/latest/developerguide/services-parameter-store.html), you'll see you are going to require both of those permissions:\r\n- SSM calls out to a KMS key to encrypt your secret\r\n- SSM calls out to the same KMS key to decrypt your secret when you (or an AWS service) retrieve it\r\n\r\nOne other tip for debugging these kinds of things in the future: You can always check in your account's CloudTrail event history and see  if there are any API calls around KMS, grants, etc that failed due to permissions issues.\r\n\r\nSo, **tldr**, please try adding `KMS:Encrypt` and `KMS:Decrypt` permissions to your inline policy and try your apply again. ","bodyHTML":"<p dir=\"auto\">It looks like the <code class=\"notranslate\">allow-ops-admin-access-from-other-accounts</code> role, by default, is configured with the same permissions that our Elastic Deploy Runner in the security account's mgmt folder shows in the <code class=\"notranslate\">deploy_permissions.yml</code> file.</p>\n<p dir=\"auto\">In most cases, this includes <code class=\"notranslate\">KMS:*</code>, which would in turn include actions such as <code class=\"notranslate\">KMS:Decrypt</code> and <code class=\"notranslate\">KMS:Encrypt</code>. Why are the KMS permissions relevant?</p>\n<p dir=\"auto\">In a couple of cases, even if you have sufficient permissions to take an action in IAM, but that action (say, <code class=\"notranslate\">ssm:PutParameter</code> in this case) will end up making use of a KMS key, whether it be customer managed or a default one managed by AWS, then you still need sufficient permissions for that KMS key, too.</p>\n<p dir=\"auto\">Otherwise, you get these really opaque and confusing access denied exceptions. Your policy above doesn't include the <code class=\"notranslate\">KMS:Decrypt</code> or <code class=\"notranslate\">KMS:Encrypt</code> actions, for example. I can see you do have the <code class=\"notranslate\">ssm:PutParameter</code> action, hence I understand why you'd expect the action to be allowed. But if you <a href=\"https://docs.aws.amazon.com/kms/latest/developerguide/services-parameter-store.html\" rel=\"nofollow\">have a look at the System Manager docs for the parameter store</a>, you'll see you are going to require both of those permissions:</p>\n<ul dir=\"auto\">\n<li>SSM calls out to a KMS key to encrypt your secret</li>\n<li>SSM calls out to the same KMS key to decrypt your secret when you (or an AWS service) retrieve it</li>\n</ul>\n<p dir=\"auto\">One other tip for debugging these kinds of things in the future: You can always check in your account's CloudTrail event history and see  if there are any API calls around KMS, grants, etc that failed due to permissions issues.</p>\n<p dir=\"auto\">So, <strong>tldr</strong>, please try adding <code class=\"notranslate\">KMS:Encrypt</code> and <code class=\"notranslate\">KMS:Decrypt</code> permissions to your inline policy and try your apply again.</p>"}}} />

</CenterLayout>

<!-- ##DOCS-SOURCER-START
{
  "sourcePlugin": "github-discussions",
  "hash": "8835525c41d76f3fe34a0e2cad960dd7"
}
##DOCS-SOURCER-END -->

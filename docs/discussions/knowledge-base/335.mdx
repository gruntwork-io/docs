---
hide_table_of_contents: true
hide_title: true
custom_edit_url: null
---

import CenterLayout from "/src/components/CenterLayout"
import GitHub from "/src/components/GitHub"

<head>
  <link rel="canonical" href="https://github.com/gruntwork-io/knowledge-base/discussions/335" />
</head>

<CenterLayout>
<span className="searchCategory">Knowledge Base</span>
<h1>Replacing intermediate-variable in ECS Service</h1>
<GitHub discussion={{"id":"D_kwDOF8slf84APNxn","number":335,"author":{"login":"pete0emerson"},"title":"Replacing intermediate-variable in ECS Service","body":"I am wondering if you could help me out with the upgrade from the intermediate-variable module? I currently upgraded to terraform 0.12 and figured out that the intermediate-variable module is no longer available. How can I replace it in my ecs service? \r\n\r\n```\r\n# ------------------------------------------------------------------------------\r\n# CREATE AN ECS TASK TO RUN THE DOCKER CONTAINER\r\n# ------------------------------------------------------------------------------\r\n \r\n# This template_file defines the Docker containers we want to run in our ECS Task\r\ndata \"template_file\" \"ecs_task_container_definitions\" {\r\n  template = file(\r\n    \"${path.module}/container-definition/container-definition.json\",\r\n  )\r\n \r\n  vars = {\r\n    container_name    = var.service_name\r\n    image             = var.image\r\n    main_version      = var.main_version\r\n    cpu               = var.cpu\r\n    memory            = var.memory\r\n    memoryReservation = var.memoryReservation\r\n    env_vars          = \"[${join(\",\", data.template_file.all_env_vars.*.rendered)}]\"\r\n  }\r\n}\r\n \r\n# Create default map of env vars in the JSON format used by ECS container\r\n# definitions. Note that we use the intermediate-variable module here to store\r\n# this map in a \"variable\" we can use elsewhere.\r\nmodule \"default_env_vars\" {\r\n  source = \"git::git@github.com:gruntwork-io/package-terraform-utilities.git//modules/intermediate-variable?ref=v0.0.6\"\r\n \r\n  # If you add to this list, BE SURE to bump the explicitly specified value\r\n  # below in data.template_file.all_env_vars.\r\n  map_value = {\r\n    var.vpc_env_var_name        = var.vpc_name\r\n    var.aws_region_env_var_name = var.aws_region\r\n    var.db_url_env_var_name     = data.terraform_remote_state.db.outputs.primary_endpoint\r\n    var.redis_url_env_var_name  = data.terraform_remote_state.redis.outputs.primary_endpoint\r\n  }\r\n}\r\n \r\n# Merge the default env vars with any extra env vars passed in by the user into\r\n# a single map\r\nmodule \"all_env_vars\" {\r\n  source    = \"git::git@github.com:gruntwork-io/package-terraform-utilities.git//modules/intermediate-variable?ref=v0.0.6\"\r\n  map_value = merge(module.default_env_vars.map_value, var.extra_env_vars)\r\n}\r\n \r\n# Convert the env vars into a JSON format used by ECS container definitions.\r\ndata \"template_file\" \"all_env_vars\" {\r\n  # where 5 is the number of default_env_vars\r\n  count = var.extra_env_vars_count + 4\r\n \r\n  template = <<EOF\r\n{\r\n  \"name\": \"${element(keys(module.all_env_vars.map_value), count.index)}\",\r\n  \"value\": \"${module.all_env_vars.map_value[element(keys(module.all_env_vars.map_value), count.index)]}\"\r\n}\r\nEOF\r\n \r\n}\r\n```","bodyHTML":"<p dir=\"auto\">I am wondering if you could help me out with the upgrade from the intermediate-variable module? I currently upgraded to terraform 0.12 and figured out that the intermediate-variable module is no longer available. How can I replace it in my ecs service?</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"# ------------------------------------------------------------------------------\n# CREATE AN ECS TASK TO RUN THE DOCKER CONTAINER\n# ------------------------------------------------------------------------------\n \n# This template_file defines the Docker containers we want to run in our ECS Task\ndata &quot;template_file&quot; &quot;ecs_task_container_definitions&quot; {\n  template = file(\n    &quot;${path.module}/container-definition/container-definition.json&quot;,\n  )\n \n  vars = {\n    container_name    = var.service_name\n    image             = var.image\n    main_version      = var.main_version\n    cpu               = var.cpu\n    memory            = var.memory\n    memoryReservation = var.memoryReservation\n    env_vars          = &quot;[${join(&quot;,&quot;, data.template_file.all_env_vars.*.rendered)}]&quot;\n  }\n}\n \n# Create default map of env vars in the JSON format used by ECS container\n# definitions. Note that we use the intermediate-variable module here to store\n# this map in a &quot;variable&quot; we can use elsewhere.\nmodule &quot;default_env_vars&quot; {\n  source = &quot;git::git@github.com:gruntwork-io/package-terraform-utilities.git//modules/intermediate-variable?ref=v0.0.6&quot;\n \n  # If you add to this list, BE SURE to bump the explicitly specified value\n  # below in data.template_file.all_env_vars.\n  map_value = {\n    var.vpc_env_var_name        = var.vpc_name\n    var.aws_region_env_var_name = var.aws_region\n    var.db_url_env_var_name     = data.terraform_remote_state.db.outputs.primary_endpoint\n    var.redis_url_env_var_name  = data.terraform_remote_state.redis.outputs.primary_endpoint\n  }\n}\n \n# Merge the default env vars with any extra env vars passed in by the user into\n# a single map\nmodule &quot;all_env_vars&quot; {\n  source    = &quot;git::git@github.com:gruntwork-io/package-terraform-utilities.git//modules/intermediate-variable?ref=v0.0.6&quot;\n  map_value = merge(module.default_env_vars.map_value, var.extra_env_vars)\n}\n \n# Convert the env vars into a JSON format used by ECS container definitions.\ndata &quot;template_file&quot; &quot;all_env_vars&quot; {\n  # where 5 is the number of default_env_vars\n  count = var.extra_env_vars_count + 4\n \n  template = &lt;&lt;EOF\n{\n  &quot;name&quot;: &quot;${element(keys(module.all_env_vars.map_value), count.index)}&quot;,\n  &quot;value&quot;: &quot;${module.all_env_vars.map_value[element(keys(module.all_env_vars.map_value), count.index)]}&quot;\n}\nEOF\n \n}\"><pre class=\"notranslate\"><code class=\"notranslate\"># ------------------------------------------------------------------------------\n# CREATE AN ECS TASK TO RUN THE DOCKER CONTAINER\n# ------------------------------------------------------------------------------\n \n# This template_file defines the Docker containers we want to run in our ECS Task\ndata \"template_file\" \"ecs_task_container_definitions\" {\n  template = file(\n    \"${path.module}/container-definition/container-definition.json\",\n  )\n \n  vars = {\n    container_name    = var.service_name\n    image             = var.image\n    main_version      = var.main_version\n    cpu               = var.cpu\n    memory            = var.memory\n    memoryReservation = var.memoryReservation\n    env_vars          = \"[${join(\",\", data.template_file.all_env_vars.*.rendered)}]\"\n  }\n}\n \n# Create default map of env vars in the JSON format used by ECS container\n# definitions. Note that we use the intermediate-variable module here to store\n# this map in a \"variable\" we can use elsewhere.\nmodule \"default_env_vars\" {\n  source = \"git::git@github.com:gruntwork-io/package-terraform-utilities.git//modules/intermediate-variable?ref=v0.0.6\"\n \n  # If you add to this list, BE SURE to bump the explicitly specified value\n  # below in data.template_file.all_env_vars.\n  map_value = {\n    var.vpc_env_var_name        = var.vpc_name\n    var.aws_region_env_var_name = var.aws_region\n    var.db_url_env_var_name     = data.terraform_remote_state.db.outputs.primary_endpoint\n    var.redis_url_env_var_name  = data.terraform_remote_state.redis.outputs.primary_endpoint\n  }\n}\n \n# Merge the default env vars with any extra env vars passed in by the user into\n# a single map\nmodule \"all_env_vars\" {\n  source    = \"git::git@github.com:gruntwork-io/package-terraform-utilities.git//modules/intermediate-variable?ref=v0.0.6\"\n  map_value = merge(module.default_env_vars.map_value, var.extra_env_vars)\n}\n \n# Convert the env vars into a JSON format used by ECS container definitions.\ndata \"template_file\" \"all_env_vars\" {\n  # where 5 is the number of default_env_vars\n  count = var.extra_env_vars_count + 4\n \n  template = &lt;&lt;EOF\n{\n  \"name\": \"${element(keys(module.all_env_vars.map_value), count.index)}\",\n  \"value\": \"${module.all_env_vars.map_value[element(keys(module.all_env_vars.map_value), count.index)]}\"\n}\nEOF\n \n}\n</code></pre></div>","answer":{"body":"The customer used code from https://github.com/gruntwork-io/infrastructure-modules-acme/blob/master/services/ecs-service-with-alb/main.tf as a reference point.","bodyHTML":"<p dir=\"auto\">The customer used code from <a href=\"https://github.com/gruntwork-io/infrastructure-modules-acme/blob/master/services/ecs-service-with-alb/main.tf\">https://github.com/gruntwork-io/infrastructure-modules-acme/blob/master/services/ecs-service-with-alb/main.tf</a> as a reference point.</p>"}}} />

</CenterLayout>

<!-- ##DOCS-SOURCER-START
{
  "sourcePlugin": "github-discussions",
  "hash": "f33543a859e55428b0db60614f10ce1d"
}
##DOCS-SOURCER-END -->

---
hide_table_of_contents: true
hide_title: true
custom_edit_url: null
---

import CenterLayout from "/src/components/CenterLayout"
import GitHub from "/src/components/GitHub"

<head>
  <link rel="canonical" href="https://github.com/gruntwork-io/knowledge-base/discussions/678" />
</head>

<CenterLayout>
<span className="searchCategory">Knowledge Base</span>
<h1>Verify the shape of terraform output</h1>
<GitHub discussion={{"id":"D_kwDOF8slf84AS3-L","number":678,"author":{"login":"niksheridan"},"title":"Verify the shape of terraform output","body":"Hi Forum. I have pretty much hit a block on this.  I am very much in the process of learning go and terratest :smiley_cat:\r\n\r\nI wanted to test terraform output, as it often the thing I find problematic when passing output to other loops though locals and failing on missing indexes/ attributes and so on.  \r\n\r\nI have looked at [this example](https://github.com/gruntwork-io/terratest/blob/master/test/terraform_hello_world_example_test.go) which looked pretty straightforward but rather than test for a string or absolute value I was looking to generalise for a type and potentially with a view to move on to perhaps writing functions later to test the value, e.g. regex or integer ranges and so on.\r\n\r\nStruct looked highly suitable - arguably perfect for what I am trying to achieve in my first step - so much perhaps, this may have me in a rabbit hole:\r\n\r\n```go\r\ntype NsgEntry struct {\r\n\taccess                     string\r\n\tdestination_address_prefix string\r\n\tdestination_port_range     []string\r\n\tdirection                  string\r\n\tname                       string\r\n\tpriority                   int\r\n\tprotocol                   string\r\n\tsource_address_prefix      string\r\n\tsource_port_range          string\r\n}\r\n```\r\n\r\nI was naively hoping the output from terraform (which in my case creates a list of logical objects) could be compared against this struct and verified to have the right 'shape'. For instance in the loop at the bottom here:\r\n\r\n```go\r\nfunc TestTerraformNsgMap(t *testing.T) {\r\n\tt.Parallel()\r\n\r\n\tterraformOptions := terraform.WithDefaultRetryableErrors(t, &terraform.Options{\r\n\t\tTerraformDir: \"../examples/terraform-nsg-map-example\",\r\n\t\tVarFiles:     []string{\"nsg.tfvars\"},\r\n\t\tNoColor:      false,\r\n\t})\r\n\tdefer terraform.Destroy(t, terraformOptions)\r\n\tterraform.InitAndApply(t, terraformOptions)\r\n\r\n\tactualTfOutput := terraform.OutputMap(t, terraformOptions, \"nsg\")\r\n\r\n\tfor _, value := range actualTfOutput {\r\n\t\tassert.IsType(t, value, NsgEntry)\r\n\t}\r\n\r\n}\r\n```\r\n\r\nThe assert is where I run into problems.  Also the way that terratest is 'presenting the output' to go is confusing me as it is almost as it if requires unmarshalling from JSON, despite the OutputMap method being used.  \r\n\r\nI have written more go using the struct directly (based on a book I am reading) and the behaviour of go is very different.  In this instance I can access attributes of the object created from the struct like I would do in a python object, which is more familiar to me.\r\n\r\nI have searched for similar use cases, but I haven't really found anything suitable which is making wonder if my approach if fundamentally wrong.\r\n\r\nWould very much appreciate any guidance on the above if possible.\r\n\r\nThanks in advance.","bodyHTML":"<p dir=\"auto\">Hi Forum. I have pretty much hit a block on this.  I am very much in the process of learning go and terratest ðŸ˜º</p>\n<p dir=\"auto\">I wanted to test terraform output, as it often the thing I find problematic when passing output to other loops though locals and failing on missing indexes/ attributes and so on.</p>\n<p dir=\"auto\">I have looked at <a href=\"https://github.com/gruntwork-io/terratest/blob/master/test/terraform_hello_world_example_test.go\">this example</a> which looked pretty straightforward but rather than test for a string or absolute value I was looking to generalise for a type and potentially with a view to move on to perhaps writing functions later to test the value, e.g. regex or integer ranges and so on.</p>\n<p dir=\"auto\">Struct looked highly suitable - arguably perfect for what I am trying to achieve in my first step - so much perhaps, this may have me in a rabbit hole:</p>\n<div class=\"highlight highlight-source-go notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"type NsgEntry struct {\n\taccess                     string\n\tdestination_address_prefix string\n\tdestination_port_range     []string\n\tdirection                  string\n\tname                       string\n\tpriority                   int\n\tprotocol                   string\n\tsource_address_prefix      string\n\tsource_port_range          string\n}\"><pre class=\"notranslate\"><span class=\"pl-k\">type</span> <span class=\"pl-smi\">NsgEntry</span> <span class=\"pl-k\">struct</span> {\n\t<span class=\"pl-c1\">access</span>                     <span class=\"pl-smi\">string</span>\n\t<span class=\"pl-c1\">destination_address_prefix</span> <span class=\"pl-smi\">string</span>\n\t<span class=\"pl-c1\">destination_port_range</span>     []<span class=\"pl-smi\">string</span>\n\t<span class=\"pl-c1\">direction</span>                  <span class=\"pl-smi\">string</span>\n\t<span class=\"pl-c1\">name</span>                       <span class=\"pl-smi\">string</span>\n\t<span class=\"pl-c1\">priority</span>                   <span class=\"pl-smi\">int</span>\n\t<span class=\"pl-c1\">protocol</span>                   <span class=\"pl-smi\">string</span>\n\t<span class=\"pl-c1\">source_address_prefix</span>      <span class=\"pl-smi\">string</span>\n\t<span class=\"pl-c1\">source_port_range</span>          <span class=\"pl-smi\">string</span>\n}</pre></div>\n<p dir=\"auto\">I was naively hoping the output from terraform (which in my case creates a list of logical objects) could be compared against this struct and verified to have the right 'shape'. For instance in the loop at the bottom here:</p>\n<div class=\"highlight highlight-source-go notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"func TestTerraformNsgMap(t *testing.T) {\n\tt.Parallel()\n\n\tterraformOptions := terraform.WithDefaultRetryableErrors(t, &amp;terraform.Options{\n\t\tTerraformDir: &quot;../examples/terraform-nsg-map-example&quot;,\n\t\tVarFiles:     []string{&quot;nsg.tfvars&quot;},\n\t\tNoColor:      false,\n\t})\n\tdefer terraform.Destroy(t, terraformOptions)\n\tterraform.InitAndApply(t, terraformOptions)\n\n\tactualTfOutput := terraform.OutputMap(t, terraformOptions, &quot;nsg&quot;)\n\n\tfor _, value := range actualTfOutput {\n\t\tassert.IsType(t, value, NsgEntry)\n\t}\n\n}\"><pre class=\"notranslate\"><span class=\"pl-k\">func</span> <span class=\"pl-en\">TestTerraformNsgMap</span>(<span class=\"pl-s1\">t</span> <span class=\"pl-c1\">*</span>testing.<span class=\"pl-smi\">T</span>) {\n\t<span class=\"pl-s1\">t</span>.<span class=\"pl-en\">Parallel</span>()\n\n\t<span class=\"pl-s1\">terraformOptions</span> <span class=\"pl-c1\">:=</span> <span class=\"pl-s1\">terraform</span>.<span class=\"pl-en\">WithDefaultRetryableErrors</span>(<span class=\"pl-s1\">t</span>, <span class=\"pl-c1\">&amp;</span>terraform.<span class=\"pl-smi\">Options</span>{\n\t\t<span class=\"pl-s1\">TerraformDir</span>: <span class=\"pl-s\">\"../examples/terraform-nsg-map-example\"</span>,\n\t\t<span class=\"pl-s1\">VarFiles</span>:     []<span class=\"pl-smi\">string</span>{<span class=\"pl-s\">\"nsg.tfvars\"</span>},\n\t\t<span class=\"pl-s1\">NoColor</span>:      <span class=\"pl-c1\">false</span>,\n\t})\n\t<span class=\"pl-k\">defer</span> <span class=\"pl-s1\">terraform</span>.<span class=\"pl-en\">Destroy</span>(<span class=\"pl-s1\">t</span>, <span class=\"pl-s1\">terraformOptions</span>)\n\t<span class=\"pl-s1\">terraform</span>.<span class=\"pl-en\">InitAndApply</span>(<span class=\"pl-s1\">t</span>, <span class=\"pl-s1\">terraformOptions</span>)\n\n\t<span class=\"pl-s1\">actualTfOutput</span> <span class=\"pl-c1\">:=</span> <span class=\"pl-s1\">terraform</span>.<span class=\"pl-en\">OutputMap</span>(<span class=\"pl-s1\">t</span>, <span class=\"pl-s1\">terraformOptions</span>, <span class=\"pl-s\">\"nsg\"</span>)\n\n\t<span class=\"pl-k\">for</span> <span class=\"pl-s1\">_</span>, <span class=\"pl-s1\">value</span> <span class=\"pl-c1\">:=</span> <span class=\"pl-k\">range</span> <span class=\"pl-s1\">actualTfOutput</span> {\n\t\t<span class=\"pl-s1\">assert</span>.<span class=\"pl-en\">IsType</span>(<span class=\"pl-s1\">t</span>, <span class=\"pl-s1\">value</span>, <span class=\"pl-s1\">NsgEntry</span>)\n\t}\n\n}</pre></div>\n<p dir=\"auto\">The assert is where I run into problems.  Also the way that terratest is 'presenting the output' to go is confusing me as it is almost as it if requires unmarshalling from JSON, despite the OutputMap method being used.</p>\n<p dir=\"auto\">I have written more go using the struct directly (based on a book I am reading) and the behaviour of go is very different.  In this instance I can access attributes of the object created from the struct like I would do in a python object, which is more familiar to me.</p>\n<p dir=\"auto\">I have searched for similar use cases, but I haven't really found anything suitable which is making wonder if my approach if fundamentally wrong.</p>\n<p dir=\"auto\">Would very much appreciate any guidance on the above if possible.</p>\n<p dir=\"auto\">Thanks in advance.</p>","answer":{"body":"Hello @niksheridan! It seems like your approach to use a struct to represent the expected shape of Terraform output is reasonable. I believe the issue you are encountering is likely due to how Terraform output is returned as type `map[string]string` (via [OutputMap](https://github.com/gruntwork-io/terratest/blob/master/modules/terraform/output.go#L230-L254)).\r\n\r\nIn your test function, you're using the `IsType` function to assert that the value retrieved from the map is of type `NsgEntry`. This will most likely always fail since the values in the actualTfOutput are of type `map[string]string` instead of `NsgEntry`. If you modify the logic so that it performs a type assertion to convert the values of actualTfOutput to `NsgEntry` structs, then you should be able to perform a proper comparison. ","bodyHTML":"<p dir=\"auto\">Hello <a class=\"user-mention notranslate\" data-hovercard-type=\"user\" data-hovercard-url=\"/users/niksheridan/hovercard\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/niksheridan\">@niksheridan</a>! It seems like your approach to use a struct to represent the expected shape of Terraform output is reasonable. I believe the issue you are encountering is likely due to how Terraform output is returned as type <code class=\"notranslate\">map[string]string</code> (via <a href=\"https://github.com/gruntwork-io/terratest/blob/master/modules/terraform/output.go#L230-L254\">OutputMap</a>).</p>\n<p dir=\"auto\">In your test function, you're using the <code class=\"notranslate\">IsType</code> function to assert that the value retrieved from the map is of type <code class=\"notranslate\">NsgEntry</code>. This will most likely always fail since the values in the actualTfOutput are of type <code class=\"notranslate\">map[string]string</code> instead of <code class=\"notranslate\">NsgEntry</code>. If you modify the logic so that it performs a type assertion to convert the values of actualTfOutput to <code class=\"notranslate\">NsgEntry</code> structs, then you should be able to perform a proper comparison.</p>"}}} />

</CenterLayout>
  

<!-- ##DOCS-SOURCER-START
{
  "sourcePlugin": "github-discussions",
  "hash": "938cdd38b22224f4f7b5e851ab435128"
}
##DOCS-SOURCER-END -->

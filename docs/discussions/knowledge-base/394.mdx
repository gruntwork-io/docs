---
hide_table_of_contents: true
hide_title: true
custom_edit_url: null
---

import CenterLayout from "/src/components/CenterLayout"
import GitHub from "/src/components/GitHub"

<head>
  <link rel="canonical" href="https://github.com/gruntwork-io/knowledge-base/discussions/394" />
</head>

<CenterLayout>
<span className="searchCategory">Knowledge Base</span>
<h1>Reference Architecture - Application CI/CD with Kubernetes</h1>
<GitHub discussion={{"id":"D_kwDOF8slf84APYxl","number":394,"author":{"login":"gorkemgoknar"},"title":"Reference Architecture - Application CI/CD with Kubernetes","body":"\nOn reference architecture, trying to build out a \"CI/CD\" based application flow using Git repo as source.\r\n\r\nWe are using Kubernetes based installation, ECR repositories are set and deploying simple app or making application pointing out to docker image on ECR works fine.\r\n\r\nWe have noticed that aws-sample-app is got pulled from gruntworks docker hub, so it is not actually pulled via CI/CD.\r\n\r\n**1-** What we are trying to do is deploy \"multiple\" K8S services using same application code that Environment variables can configure running service, yet how can Infrastruce code \"tag\" applications on the ECR docker repo on PR on infrastructure? \r\nFor example instead of showing ECR  containers can't we just show Git repository and build and push image on Infrastruce build time?\r\n\r\n**2-** I could not properly understand  [ Infrastructure /  CI / CD pipeline for app code instructions](https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/5ec2974eed8883f0289a7c4b7a917fdc04c7a19a/examples/for-production/infrastructure-live/docs/04-configure-gw-pipelines.md?plain=1#L208), which seems unclear for me. \r\n\r\nIt suggests copying _ci scripts to repository, yet Dockerfile context path is unclear and it is not \"similar\" to aws-sample-web-app,  but I assume that there should be only 1 Dockerfile and path is actually if Dockerfile is in docker/Dockerfile Context_path is \"docker\".  Can I deploy with support of docker-compose yml files? \r\n\r\n**3-** I am able to make a simple Github Actions pipeline and it is triggered  as I copied  _ci/app-templates/scripts  to my app repo, still having trouble on GITHUB_OAUTH_TOKEN  even I set GH_TOKEN on repository. \r\nI tried debugging with  `gruntwork-install --binary-name \"infrastructure-deployer\" --repo \"https:/URL_OF_MY_PRIVATE_GIT\" --tag \"GIT_RELEASE_TAG\"`  but gave Not Found even I have permission to repo and set` export GITHUB_OAUTH_TOKEN=XXX`\r\n\n\n---\n\n<ins datetime=\"2022-04-25T20:27:02Z\">\n  <p><a href=\"https://gruntwork.zendesk.com/agent/tickets/108497\">Tracked in ticket #108497</a></p>\n</ins>\n","bodyHTML":"<p dir=\"auto\">On reference architecture, trying to build out a \"CI/CD\" based application flow using Git repo as source.</p>\n<p dir=\"auto\">We are using Kubernetes based installation, ECR repositories are set and deploying simple app or making application pointing out to docker image on ECR works fine.</p>\n<p dir=\"auto\">We have noticed that aws-sample-app is got pulled from gruntworks docker hub, so it is not actually pulled via CI/CD.</p>\n<p dir=\"auto\"><strong>1-</strong> What we are trying to do is deploy \"multiple\" K8S services using same application code that Environment variables can configure running service, yet how can Infrastruce code \"tag\" applications on the ECR docker repo on PR on infrastructure?<br>\nFor example instead of showing ECR  containers can't we just show Git repository and build and push image on Infrastruce build time?</p>\n<p dir=\"auto\"><strong>2-</strong> I could not properly understand  <a href=\"https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/5ec2974eed8883f0289a7c4b7a917fdc04c7a19a/examples/for-production/infrastructure-live/docs/04-configure-gw-pipelines.md?plain=1#L208\"> Infrastructure /  CI / CD pipeline for app code instructions</a>, which seems unclear for me.</p>\n<p dir=\"auto\">It suggests copying _ci scripts to repository, yet Dockerfile context path is unclear and it is not \"similar\" to aws-sample-web-app,  but I assume that there should be only 1 Dockerfile and path is actually if Dockerfile is in docker/Dockerfile Context_path is \"docker\".  Can I deploy with support of docker-compose yml files?</p>\n<p dir=\"auto\"><strong>3-</strong> I am able to make a simple Github Actions pipeline and it is triggered  as I copied  _ci/app-templates/scripts  to my app repo, still having trouble on GITHUB_OAUTH_TOKEN  even I set GH_TOKEN on repository.<br>\nI tried debugging with  <code class=\"notranslate\">gruntwork-install --binary-name \"infrastructure-deployer\" --repo \"https:/URL_OF_MY_PRIVATE_GIT\" --tag \"GIT_RELEASE_TAG\"</code>  but gave Not Found even I have permission to repo and set<code class=\"notranslate\"> export GITHUB_OAUTH_TOKEN=XXX</code></p>\n<hr>\n<ins datetime=\"2022-04-25T20:27:02Z\">\n  <p dir=\"auto\"><a href=\"https://gruntwork.zendesk.com/agent/tickets/108497\" rel=\"nofollow\">Tracked in ticket #108497</a></p>\n</ins>","answer":{"body":"> 1- What we are trying to do is deploy \"multiple\" K8S services using same application code that Environment variables can configure running service, yet how can Infrastruce code \"tag\" applications on the ECR docker repo on PR on infrastructure?\r\nFor example instead of showing ECR containers can't we just show Git repository and build and push image on Infrastruce build time?\r\n\r\nThe core idea behind the pipeline in the Reference Architecture is as follows:\r\n\r\n- When a release tag is cut on the application repo, use the `infrastructure-deployer` CLI to build a new docker image in the ECS Deploy Runner and push to the corresponding ECR repo under the release tag for the application. This is what happens in the [build-docker-image.sh](https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/master/examples/for-production/infrastructure-live/_ci/app-templates/scripts/build-docker-image.sh) CI script packaged with the Ref Arch.\r\n- Once a new image is built in ECR, you can then immediately deploy that to whatever environment you want it in by making an edit to the corresponding `terragrunt.hcl` file to use the new ECR tag. This step is handled by [the deploy-docker-image.sh](https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/master/examples/for-production/infrastructure-live/_ci/app-templates/scripts/deploy-docker-image.sh) script of the Reference Architecture, which will make the edit and commit to `main` branch of `infrastructure-live`, triggering the deploy pipeline.\r\n\r\n> It suggests copying _ci scripts to repository, yet Dockerfile context path is unclear and it is not \"similar\" to aws-sample-web-app, but I assume that there should be only 1 Dockerfile and path is actually if Dockerfile is in docker/Dockerfile Context_path is \"docker\".\r\n\r\nI think what might be confusing you is that there are two `Dockerfile`s at play here:\r\n\r\n- One is for your application, which is presumably in the `docker` folder of your repo.\r\n- Another is for the CI server to get an image that has everything it needs setup. This is only needed if you are using Jenkins, and should be at the root of the repo if you want to use the `Jenkinsfile` directly.\r\n\r\nSo the context path in the `constants.sh` script should point to the path to the application docker file.\r\n\r\n> Can I deploy with support of docker-compose yml files?\r\n\r\nWe do not support `docker-compose.yml` files, nor does Kubernetes natively. At some point, you need to translate the `docker-compose.yml` file to Kubernetes manifests. That's what the `terragrunt.hcl` files in `infrastructure-live` correspond to, and the reason our pipeline in the Ref Arch work by making commits to `infrastructure-live`.\r\n\r\n> I am able to make a simple Github Actions pipeline and it is triggered as I copied _ci/app-templates/scripts to my app repo, still having trouble on GITHUB_OAUTH_TOKEN even I set GH_TOKEN on repository.\r\nI tried debugging with gruntwork-install --binary-name \"infrastructure-deployer\" --repo \"https:/URL_OF_MY_PRIVATE_GIT\" --tag \"GIT_RELEASE_TAG\" but gave Not Found even I have permission to repo and set export GITHUB_OAUTH_TOKEN=XXX\r\n\r\nThe repo URL should be `https://github.com/gruntwork-io/terraform-aws-ci.git`. This code is downloading the `infrastructure-deployer` binary in our `terraform-aws-ci` repository. I'd need the full error logs to be sure, but on the surface based on the information you shared, I believe the `Not Found` is because the private git URL you are using doesn't have the `infrastructure-deployer` binary available on the release tag.","bodyHTML":"<blockquote>\n<p dir=\"auto\">1- What we are trying to do is deploy \"multiple\" K8S services using same application code that Environment variables can configure running service, yet how can Infrastruce code \"tag\" applications on the ECR docker repo on PR on infrastructure?<br>\nFor example instead of showing ECR containers can't we just show Git repository and build and push image on Infrastruce build time?</p>\n</blockquote>\n<p dir=\"auto\">The core idea behind the pipeline in the Reference Architecture is as follows:</p>\n<ul dir=\"auto\">\n<li>When a release tag is cut on the application repo, use the <code class=\"notranslate\">infrastructure-deployer</code> CLI to build a new docker image in the ECS Deploy Runner and push to the corresponding ECR repo under the release tag for the application. This is what happens in the <a href=\"https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/master/examples/for-production/infrastructure-live/_ci/app-templates/scripts/build-docker-image.sh\">build-docker-image.sh</a> CI script packaged with the Ref Arch.</li>\n<li>Once a new image is built in ECR, you can then immediately deploy that to whatever environment you want it in by making an edit to the corresponding <code class=\"notranslate\">terragrunt.hcl</code> file to use the new ECR tag. This step is handled by <a href=\"https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/master/examples/for-production/infrastructure-live/_ci/app-templates/scripts/deploy-docker-image.sh\">the deploy-docker-image.sh</a> script of the Reference Architecture, which will make the edit and commit to <code class=\"notranslate\">main</code> branch of <code class=\"notranslate\">infrastructure-live</code>, triggering the deploy pipeline.</li>\n</ul>\n<blockquote>\n<p dir=\"auto\">It suggests copying _ci scripts to repository, yet Dockerfile context path is unclear and it is not \"similar\" to aws-sample-web-app, but I assume that there should be only 1 Dockerfile and path is actually if Dockerfile is in docker/Dockerfile Context_path is \"docker\".</p>\n</blockquote>\n<p dir=\"auto\">I think what might be confusing you is that there are two <code class=\"notranslate\">Dockerfile</code>s at play here:</p>\n<ul dir=\"auto\">\n<li>One is for your application, which is presumably in the <code class=\"notranslate\">docker</code> folder of your repo.</li>\n<li>Another is for the CI server to get an image that has everything it needs setup. This is only needed if you are using Jenkins, and should be at the root of the repo if you want to use the <code class=\"notranslate\">Jenkinsfile</code> directly.</li>\n</ul>\n<p dir=\"auto\">So the context path in the <code class=\"notranslate\">constants.sh</code> script should point to the path to the application docker file.</p>\n<blockquote>\n<p dir=\"auto\">Can I deploy with support of docker-compose yml files?</p>\n</blockquote>\n<p dir=\"auto\">We do not support <code class=\"notranslate\">docker-compose.yml</code> files, nor does Kubernetes natively. At some point, you need to translate the <code class=\"notranslate\">docker-compose.yml</code> file to Kubernetes manifests. That's what the <code class=\"notranslate\">terragrunt.hcl</code> files in <code class=\"notranslate\">infrastructure-live</code> correspond to, and the reason our pipeline in the Ref Arch work by making commits to <code class=\"notranslate\">infrastructure-live</code>.</p>\n<blockquote>\n<p dir=\"auto\">I am able to make a simple Github Actions pipeline and it is triggered as I copied _ci/app-templates/scripts to my app repo, still having trouble on GITHUB_OAUTH_TOKEN even I set GH_TOKEN on repository.<br>\nI tried debugging with gruntwork-install --binary-name \"infrastructure-deployer\" --repo \"https:/URL_OF_MY_PRIVATE_GIT\" --tag \"GIT_RELEASE_TAG\" but gave Not Found even I have permission to repo and set export GITHUB_OAUTH_TOKEN=XXX</p>\n</blockquote>\n<p dir=\"auto\">The repo URL should be <code class=\"notranslate\">https://github.com/gruntwork-io/terraform-aws-ci.git</code>. This code is downloading the <code class=\"notranslate\">infrastructure-deployer</code> binary in our <code class=\"notranslate\">terraform-aws-ci</code> repository. I'd need the full error logs to be sure, but on the surface based on the information you shared, I believe the <code class=\"notranslate\">Not Found</code> is because the private git URL you are using doesn't have the <code class=\"notranslate\">infrastructure-deployer</code> binary available on the release tag.</p>"}}} />

</CenterLayout>

<!-- ##DOCS-SOURCER-START
{
  "sourcePlugin": "github-discussions",
  "hash": "f1502af517d928ea69cde63e8a6105d4"
}
##DOCS-SOURCER-END -->

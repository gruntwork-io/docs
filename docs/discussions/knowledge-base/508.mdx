---
hide_table_of_contents: true
hide_title: true
custom_edit_url: null
---

import CenterLayout from "/src/components/CenterLayout"
import GitHub from "/src/components/GitHub"

<head>
  <link rel="canonical" href="https://github.com/gruntwork-io/knowledge-base/discussions/508" />
</head>

<CenterLayout>
<span className="searchCategory">Knowledge Base</span>
<h1>S3 bucket lifecycle configuration gets alternately removed or added with no config changes</h1>
<GitHub discussion={{"id":"D_kwDOF8slf84AQGS9","number":508,"author":{"login":"erictompkins"},"title":"S3 bucket lifecycle configuration gets alternately removed or added with no config changes","body":"\r\nWe are having an issue where if we run `terragrunt apply` on our module then either a `lifecycle_rule` on the s3 bucket will get removed or the `aws_s3_bucket_lifecycle_configuration` resource will get added. This happens when we have no changes to our configuration at all.\r\n\r\nWe have the following configuration for an S3 bucket:\r\n\r\n```\r\nresource \"aws_s3_bucket\" \"main\" {\r\n  bucket = var.bucket_name\r\n}\r\n\r\nresource \"aws_s3_bucket_acl\" \"main_acl\" {\r\n  bucket = aws_s3_bucket.main.id\r\n  acl    = \"private\"\r\n}\r\n\r\nresource \"aws_s3_bucket_lifecycle_configuration\" \"main_lifecycle_config\" {\r\n  bucket = aws_s3_bucket.main.id\r\n\r\n  rule {\r\n    id = \"expiration\"\r\n    abort_incomplete_multipart_upload {\r\n      days_after_initiation = 1\r\n    }\r\n    expiration {\r\n      days = 30\r\n    }\r\n    status = \"Enabled\"\r\n  }\r\n}\r\n```\r\n\r\nIf the `aws_s3_bucket_lifecycle_configuration` resource is in the terraform state then we get this result from running `terrform apply`:\r\n\r\n```\r\nTerraform will perform the following actions:\r\n\r\n  # aws_s3_bucket.main will be updated in-place\r\n  ~ resource \"aws_s3_bucket\" \"main\" {\r\n        id                          = \"branchcms-dev-lambda-sources\"\r\n        tags                        = {}\r\n        # (11 unchanged attributes hidden)\r\n\r\n      - lifecycle_rule {\r\n          - abort_incomplete_multipart_upload_days = 1 -> null\r\n          - enabled                                = true -> null\r\n          - id                                     = \"expiration\" -> null\r\n          - tags                                   = {} -> null\r\n\r\n          - expiration {\r\n              - days                         = 30 -> null\r\n              - expired_object_delete_marker = false -> null\r\n            }\r\n        }\r\n\r\n        # (1 unchanged block hidden)\r\n    }\r\n\r\nPlan: 0 to add, 1 to change, 0 to destroy.\r\n```\r\n\r\nIf we say \"yes\" to that change then if we run `terraform apply` again with no changes to our Terraform code then we get the following response:\r\n\r\n```\r\nNote: Objects have changed outside of Terraform\r\n\r\nTerraform detected the following changes made outside of Terraform since the\r\nlast \"terraform apply\":\r\n\r\n  # aws_s3_bucket_lifecycle_configuration.main_lifecycle_config has been deleted\r\n  - resource \"aws_s3_bucket_lifecycle_configuration\" \"main_lifecycle_config\" {\r\n      - bucket = \"branchcms-dev-lambda-sources\" -> null\r\n      - id     = \"branchcms-dev-lambda-sources\" -> null\r\n\r\n      - rule {\r\n          - id     = \"expiration\" -> null\r\n          - status = \"Enabled\" -> null\r\n\r\n          - abort_incomplete_multipart_upload {\r\n              - days_after_initiation = 1 -> null\r\n            }\r\n\r\n          - expiration {\r\n              - days                         = 30 -> null\r\n              - expired_object_delete_marker = false -> null\r\n            }\r\n\r\n          - filter {\r\n            }\r\n        }\r\n    }\r\n\r\n\r\nUnless you have made equivalent changes to your configuration, or ignored the\r\nrelevant attributes using ignore_changes, the following plan may include\r\nactions to undo or respond to these changes.\r\n\r\n─────────────────────────────────────────────────────────────────────────────\r\n\r\nTerraform used the selected providers to generate the following execution\r\nplan. Resource actions are indicated with the following symbols:\r\n  + create\r\n\r\nTerraform will perform the following actions:\r\n\r\n  # aws_s3_bucket_lifecycle_configuration.main_lifecycle_config will be created\r\n  + resource \"aws_s3_bucket_lifecycle_configuration\" \"main_lifecycle_config\" {\r\n      + bucket = \"branchcms-dev-lambda-sources\"\r\n      + id     = (known after apply)\r\n\r\n      + rule {\r\n          + id     = \"expiration\"\r\n          + status = \"Enabled\"\r\n\r\n          + abort_incomplete_multipart_upload {\r\n              + days_after_initiation = 1\r\n            }\r\n\r\n          + expiration {\r\n              + days                         = 30\r\n              + expired_object_delete_marker = (known after apply)\r\n            }\r\n        }\r\n    }\r\n\r\nPlan: 1 to add, 0 to change, 0 to destroy.\r\n```\r\n\r\nIt seems to go in a cycle of destroying and adding the lifecycle configuration. Do you see anything wrong with our Terraform code?\r\n\r\nWe are on Terraform 1.1.9 and Terragrunt 0.38.5.\r\n\r\nWe are also using `registry.terraform.io/hashicorp/aws`:\r\n```\r\n  version     = \"3.75.2\"\r\n  constraints = \"~> 3.7\"\r\n```\r\n\r\n---\r\n\r\n<ins datetime=\"2022-07-15T16:48:11Z\">\r\n  <p><a href=\"https://support.gruntwork.io/hc/requests/108993\">Tracked in ticket #108993</a></p>\r\n</ins>\r\n","bodyHTML":"<p dir=\"auto\">We are having an issue where if we run <code class=\"notranslate\">terragrunt apply</code> on our module then either a <code class=\"notranslate\">lifecycle_rule</code> on the s3 bucket will get removed or the <code class=\"notranslate\">aws_s3_bucket_lifecycle_configuration</code> resource will get added. This happens when we have no changes to our configuration at all.</p>\n<p dir=\"auto\">We have the following configuration for an S3 bucket:</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"resource &quot;aws_s3_bucket&quot; &quot;main&quot; {\n  bucket = var.bucket_name\n}\n\nresource &quot;aws_s3_bucket_acl&quot; &quot;main_acl&quot; {\n  bucket = aws_s3_bucket.main.id\n  acl    = &quot;private&quot;\n}\n\nresource &quot;aws_s3_bucket_lifecycle_configuration&quot; &quot;main_lifecycle_config&quot; {\n  bucket = aws_s3_bucket.main.id\n\n  rule {\n    id = &quot;expiration&quot;\n    abort_incomplete_multipart_upload {\n      days_after_initiation = 1\n    }\n    expiration {\n      days = 30\n    }\n    status = &quot;Enabled&quot;\n  }\n}\"><pre class=\"notranslate\"><code class=\"notranslate\">resource \"aws_s3_bucket\" \"main\" {\n  bucket = var.bucket_name\n}\n\nresource \"aws_s3_bucket_acl\" \"main_acl\" {\n  bucket = aws_s3_bucket.main.id\n  acl    = \"private\"\n}\n\nresource \"aws_s3_bucket_lifecycle_configuration\" \"main_lifecycle_config\" {\n  bucket = aws_s3_bucket.main.id\n\n  rule {\n    id = \"expiration\"\n    abort_incomplete_multipart_upload {\n      days_after_initiation = 1\n    }\n    expiration {\n      days = 30\n    }\n    status = \"Enabled\"\n  }\n}\n</code></pre></div>\n<p dir=\"auto\">If the <code class=\"notranslate\">aws_s3_bucket_lifecycle_configuration</code> resource is in the terraform state then we get this result from running <code class=\"notranslate\">terrform apply</code>:</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"Terraform will perform the following actions:\n\n  # aws_s3_bucket.main will be updated in-place\n  ~ resource &quot;aws_s3_bucket&quot; &quot;main&quot; {\n        id                          = &quot;branchcms-dev-lambda-sources&quot;\n        tags                        = {}\n        # (11 unchanged attributes hidden)\n\n      - lifecycle_rule {\n          - abort_incomplete_multipart_upload_days = 1 -&gt; null\n          - enabled                                = true -&gt; null\n          - id                                     = &quot;expiration&quot; -&gt; null\n          - tags                                   = {} -&gt; null\n\n          - expiration {\n              - days                         = 30 -&gt; null\n              - expired_object_delete_marker = false -&gt; null\n            }\n        }\n\n        # (1 unchanged block hidden)\n    }\n\nPlan: 0 to add, 1 to change, 0 to destroy.\"><pre class=\"notranslate\"><code class=\"notranslate\">Terraform will perform the following actions:\n\n  # aws_s3_bucket.main will be updated in-place\n  ~ resource \"aws_s3_bucket\" \"main\" {\n        id                          = \"branchcms-dev-lambda-sources\"\n        tags                        = {}\n        # (11 unchanged attributes hidden)\n\n      - lifecycle_rule {\n          - abort_incomplete_multipart_upload_days = 1 -&gt; null\n          - enabled                                = true -&gt; null\n          - id                                     = \"expiration\" -&gt; null\n          - tags                                   = {} -&gt; null\n\n          - expiration {\n              - days                         = 30 -&gt; null\n              - expired_object_delete_marker = false -&gt; null\n            }\n        }\n\n        # (1 unchanged block hidden)\n    }\n\nPlan: 0 to add, 1 to change, 0 to destroy.\n</code></pre></div>\n<p dir=\"auto\">If we say \"yes\" to that change then if we run <code class=\"notranslate\">terraform apply</code> again with no changes to our Terraform code then we get the following response:</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"Note: Objects have changed outside of Terraform\n\nTerraform detected the following changes made outside of Terraform since the\nlast &quot;terraform apply&quot;:\n\n  # aws_s3_bucket_lifecycle_configuration.main_lifecycle_config has been deleted\n  - resource &quot;aws_s3_bucket_lifecycle_configuration&quot; &quot;main_lifecycle_config&quot; {\n      - bucket = &quot;branchcms-dev-lambda-sources&quot; -&gt; null\n      - id     = &quot;branchcms-dev-lambda-sources&quot; -&gt; null\n\n      - rule {\n          - id     = &quot;expiration&quot; -&gt; null\n          - status = &quot;Enabled&quot; -&gt; null\n\n          - abort_incomplete_multipart_upload {\n              - days_after_initiation = 1 -&gt; null\n            }\n\n          - expiration {\n              - days                         = 30 -&gt; null\n              - expired_object_delete_marker = false -&gt; null\n            }\n\n          - filter {\n            }\n        }\n    }\n\n\nUnless you have made equivalent changes to your configuration, or ignored the\nrelevant attributes using ignore_changes, the following plan may include\nactions to undo or respond to these changes.\n\n─────────────────────────────────────────────────────────────────────────────\n\nTerraform used the selected providers to generate the following execution\nplan. Resource actions are indicated with the following symbols:\n  + create\n\nTerraform will perform the following actions:\n\n  # aws_s3_bucket_lifecycle_configuration.main_lifecycle_config will be created\n  + resource &quot;aws_s3_bucket_lifecycle_configuration&quot; &quot;main_lifecycle_config&quot; {\n      + bucket = &quot;branchcms-dev-lambda-sources&quot;\n      + id     = (known after apply)\n\n      + rule {\n          + id     = &quot;expiration&quot;\n          + status = &quot;Enabled&quot;\n\n          + abort_incomplete_multipart_upload {\n              + days_after_initiation = 1\n            }\n\n          + expiration {\n              + days                         = 30\n              + expired_object_delete_marker = (known after apply)\n            }\n        }\n    }\n\nPlan: 1 to add, 0 to change, 0 to destroy.\"><pre class=\"notranslate\"><code class=\"notranslate\">Note: Objects have changed outside of Terraform\n\nTerraform detected the following changes made outside of Terraform since the\nlast \"terraform apply\":\n\n  # aws_s3_bucket_lifecycle_configuration.main_lifecycle_config has been deleted\n  - resource \"aws_s3_bucket_lifecycle_configuration\" \"main_lifecycle_config\" {\n      - bucket = \"branchcms-dev-lambda-sources\" -&gt; null\n      - id     = \"branchcms-dev-lambda-sources\" -&gt; null\n\n      - rule {\n          - id     = \"expiration\" -&gt; null\n          - status = \"Enabled\" -&gt; null\n\n          - abort_incomplete_multipart_upload {\n              - days_after_initiation = 1 -&gt; null\n            }\n\n          - expiration {\n              - days                         = 30 -&gt; null\n              - expired_object_delete_marker = false -&gt; null\n            }\n\n          - filter {\n            }\n        }\n    }\n\n\nUnless you have made equivalent changes to your configuration, or ignored the\nrelevant attributes using ignore_changes, the following plan may include\nactions to undo or respond to these changes.\n\n─────────────────────────────────────────────────────────────────────────────\n\nTerraform used the selected providers to generate the following execution\nplan. Resource actions are indicated with the following symbols:\n  + create\n\nTerraform will perform the following actions:\n\n  # aws_s3_bucket_lifecycle_configuration.main_lifecycle_config will be created\n  + resource \"aws_s3_bucket_lifecycle_configuration\" \"main_lifecycle_config\" {\n      + bucket = \"branchcms-dev-lambda-sources\"\n      + id     = (known after apply)\n\n      + rule {\n          + id     = \"expiration\"\n          + status = \"Enabled\"\n\n          + abort_incomplete_multipart_upload {\n              + days_after_initiation = 1\n            }\n\n          + expiration {\n              + days                         = 30\n              + expired_object_delete_marker = (known after apply)\n            }\n        }\n    }\n\nPlan: 1 to add, 0 to change, 0 to destroy.\n</code></pre></div>\n<p dir=\"auto\">It seems to go in a cycle of destroying and adding the lifecycle configuration. Do you see anything wrong with our Terraform code?</p>\n<p dir=\"auto\">We are on Terraform 1.1.9 and Terragrunt 0.38.5.</p>\n<p dir=\"auto\">We are also using <code class=\"notranslate\">registry.terraform.io/hashicorp/aws</code>:</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"  version     = &quot;3.75.2&quot;\n  constraints = &quot;~&gt; 3.7&quot;\"><pre class=\"notranslate\"><code class=\"notranslate\">  version     = \"3.75.2\"\n  constraints = \"~&gt; 3.7\"\n</code></pre></div>\n<hr>\n<ins datetime=\"2022-07-15T16:48:11Z\">\n  <p dir=\"auto\"><a href=\"https://support.gruntwork.io/hc/requests/108993\" rel=\"nofollow\">Tracked in ticket #108993</a></p>\n</ins>","answer":{"body":"This is a known issue with the new configuration blocks in the `aws` provider. To handle this, you need to add an `ignore_changes` lifecycle config on `aws_s3_bucket`, as [recommended here](https://github.com/hashicorp/terraform-provider-aws/issues/23758) by the terraform provider team. E.g.,\r\n\r\n```hcl\r\nresource \"aws_s3_bucket\" \"main\" {\r\n  bucket = var.bucket_name\r\n\r\n  lifecycle {\r\n    ignore_changes = [lifecycle_rule]\r\n  }\r\n}\r\n```","bodyHTML":"<p dir=\"auto\">This is a known issue with the new configuration blocks in the <code class=\"notranslate\">aws</code> provider. To handle this, you need to add an <code class=\"notranslate\">ignore_changes</code> lifecycle config on <code class=\"notranslate\">aws_s3_bucket</code>, as <a href=\"https://github.com/hashicorp/terraform-provider-aws/issues/23758\" data-hovercard-type=\"issue\" data-hovercard-url=\"/hashicorp/terraform-provider-aws/issues/23758/hovercard\">recommended here</a> by the terraform provider team. E.g.,</p>\n<div class=\"highlight highlight-source-hcl notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"resource &quot;aws_s3_bucket&quot; &quot;main&quot; {\n  bucket = var.bucket_name\n\n  lifecycle {\n    ignore_changes = [lifecycle_rule]\n  }\n}\"><pre class=\"notranslate\"><span class=\"pl-en\">resource</span> <span class=\"pl-smi\">\"aws_s3_bucket\"</span> <span class=\"pl-smi\">\"main\"</span> {\n  <span class=\"pl-v\"><span class=\"pl-smi\">bucket</span> <span class=\"pl-k\">=</span> </span>var<span class=\"pl-k\">.</span><span class=\"pl-smi\">bucket_name</span>\n\n  <span class=\"pl-en\">lifecycle</span> {\n    <span class=\"pl-v\"><span class=\"pl-smi\">ignore_changes</span> <span class=\"pl-k\">=</span> </span>[<span class=\"pl-smi\">lifecycle_rule</span>]\n  }\n}</pre></div>"}}} />

</CenterLayout>
  

<!-- ##DOCS-SOURCER-START
{
  "sourcePlugin": "github-discussions",
  "hash": "daa1bc6af43ad8ef355e5e2d3c9eb9f1"
}
##DOCS-SOURCER-END -->

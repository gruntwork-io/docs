---
hide_table_of_contents: true
hide_title: true
custom_edit_url: null
---

import CenterLayout from "/src/components/CenterLayout"
import GitHub from "/src/components/GitHub"

<head>
  <link rel="canonical" href="https://github.com/gruntwork-io/knowledge-base/discussions/622" />
</head>

<CenterLayout>
<span className="searchCategory">Knowledge Base</span>
<h1>Updating ECS Deploy Runner (Github)</h1>
<GitHub discussion={{"id":"D_kwDOF8slf84AR36g","number":622,"author":{"login":"mcrlc"},"title":"Updating ECS Deploy Runner (Github)","body":"\nWe recently tried to update the ECS Deploy Runner image in our reference architecture.\r\nWe started by running the following script:\r\n```\r\naws-vault exec shared-admin -- shared/us-east-2/_regional/container_images/build_deploy_runner_image.sh\r\n```\r\nAnd got the following error:\r\n```\r\ncmd: /bin/sh\r\n--\r\nargs: [-c if [ -z \"$(cat /kaniko/secrets/github-token)\" ]; then echo \"ERROR: You must pass a GitHub PAT as an environment variable named GITHUB_OAUTH_TOKEN.\"; exit 1; fi]\r\nRunning: [/bin/sh -c if [ -z \"$(cat /kaniko/secrets/github-token)\" ]; then echo \"ERROR: You must pass a GitHub PAT as an environment variable named GITHUB_OAUTH_TOKEN.\"; exit 1; fi]\r\ncat: can't open '/kaniko/secrets/github-token': No such file or directory\r\nERROR: You must pass a GitHub PAT as an environment variable named GITHUB_OAUTH_TOKEN.\r\nerror building image: error building stage: failed to execute command: waiting for process to exit: exit status 1\r\nERROR: exit status 1\r\nexit status 1\r\nERROR: exit status 1\r\n```\r\nI thought it had something to do with the recent buildkit change (https://github.com/gruntwork-io/terraform-aws-ci/pull/495), so I added `--secret 'id=github-token,env=GITHUB_OAUTH_TOKEN'` to the script and got the following error:\r\n```\r\n[infrastructure-deployer] INFO[2022-12-22T13:41:41+02:00] Invoking Lambda function ecs-deploy-runner-invoker to trigger deployment.\r\nERROR: OptionNotInAllowedOptionsError: Option --secret is not in the provided list of allowed options for the script.\r\n```\r\n\r\nThen, we tried to update our `ecs-deploy-runner` module in the `shared` account adding the following:\r\n```\r\ndocker_image_builder_hardcoded_options = {\r\n    \"--secret\" = [\"'id=github-token,env=GITHUB_OAUTH_TOKEN'\"]\r\n  }\r\n```\r\n\r\nFinally we tried running the script again and it failed, and while looking in the ECS logs we saw:\r\n```\r\nRunning command: /opt/ecs-deploy-runner/scripts/build-docker-image (args redacted)\r\n--\r\nIncorrect Usage. flag provided but not defined: -secret\r\nUsage: build-docker-image [--repo] [--ref] [--sha] [--idempotent] [--context-path] [--dockerfile-path]\r\n[--docker-image-tag] [--build-arg] [--env-secret] [--iam-role] [--no-push] [--help] command [options] [args]\r\nCommand to trigger a docker build using kaniko. The intention of the script is to simplify the args so that it reflects\r\nthe specific use case of the ECS deploy runner.\r\nCommands:\r\nhelp, h  Shows a list of commands or help for one command\r\nERROR: flag provided but not defined: -secret\r\nexit status 1\r\nERROR: exit status 1\r\n```\r\n\r\nIt looks like we can't update the image. Are we missing something?\n\n---\n\n<ins datetime=\"2022-12-22T11:45:00Z\">\n  <p><a href=\"https://support.gruntwork.io/hc/requests/109746\">Tracked in ticket #109746</a></p>\n</ins>\n","bodyHTML":"<p dir=\"auto\">We recently tried to update the ECS Deploy Runner image in our reference architecture.<br>\nWe started by running the following script:</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"aws-vault exec shared-admin -- shared/us-east-2/_regional/container_images/build_deploy_runner_image.sh\"><pre class=\"notranslate\"><code class=\"notranslate\">aws-vault exec shared-admin -- shared/us-east-2/_regional/container_images/build_deploy_runner_image.sh\n</code></pre></div>\n<p dir=\"auto\">And got the following error:</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"cmd: /bin/sh\n--\nargs: [-c if [ -z &quot;$(cat /kaniko/secrets/github-token)&quot; ]; then echo &quot;ERROR: You must pass a GitHub PAT as an environment variable named GITHUB_OAUTH_TOKEN.&quot;; exit 1; fi]\nRunning: [/bin/sh -c if [ -z &quot;$(cat /kaniko/secrets/github-token)&quot; ]; then echo &quot;ERROR: You must pass a GitHub PAT as an environment variable named GITHUB_OAUTH_TOKEN.&quot;; exit 1; fi]\ncat: can't open '/kaniko/secrets/github-token': No such file or directory\nERROR: You must pass a GitHub PAT as an environment variable named GITHUB_OAUTH_TOKEN.\nerror building image: error building stage: failed to execute command: waiting for process to exit: exit status 1\nERROR: exit status 1\nexit status 1\nERROR: exit status 1\"><pre class=\"notranslate\"><code class=\"notranslate\">cmd: /bin/sh\n--\nargs: [-c if [ -z \"$(cat /kaniko/secrets/github-token)\" ]; then echo \"ERROR: You must pass a GitHub PAT as an environment variable named GITHUB_OAUTH_TOKEN.\"; exit 1; fi]\nRunning: [/bin/sh -c if [ -z \"$(cat /kaniko/secrets/github-token)\" ]; then echo \"ERROR: You must pass a GitHub PAT as an environment variable named GITHUB_OAUTH_TOKEN.\"; exit 1; fi]\ncat: can't open '/kaniko/secrets/github-token': No such file or directory\nERROR: You must pass a GitHub PAT as an environment variable named GITHUB_OAUTH_TOKEN.\nerror building image: error building stage: failed to execute command: waiting for process to exit: exit status 1\nERROR: exit status 1\nexit status 1\nERROR: exit status 1\n</code></pre></div>\n<p dir=\"auto\">I thought it had something to do with the recent buildkit change (<a href=\"https://github.com/gruntwork-io/terraform-aws-ci/pull/495\">https://github.com/gruntwork-io/terraform-aws-ci/pull/495</a>), so I added <code class=\"notranslate\">--secret 'id=github-token,env=GITHUB_OAUTH_TOKEN'</code> to the script and got the following error:</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"[infrastructure-deployer] INFO[2022-12-22T13:41:41+02:00] Invoking Lambda function ecs-deploy-runner-invoker to trigger deployment.\nERROR: OptionNotInAllowedOptionsError: Option --secret is not in the provided list of allowed options for the script.\"><pre class=\"notranslate\"><code class=\"notranslate\">[infrastructure-deployer] INFO[2022-12-22T13:41:41+02:00] Invoking Lambda function ecs-deploy-runner-invoker to trigger deployment.\nERROR: OptionNotInAllowedOptionsError: Option --secret is not in the provided list of allowed options for the script.\n</code></pre></div>\n<p dir=\"auto\">Then, we tried to update our <code class=\"notranslate\">ecs-deploy-runner</code> module in the <code class=\"notranslate\">shared</code> account adding the following:</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"docker_image_builder_hardcoded_options = {\n    &quot;--secret&quot; = [&quot;'id=github-token,env=GITHUB_OAUTH_TOKEN'&quot;]\n  }\"><pre class=\"notranslate\"><code class=\"notranslate\">docker_image_builder_hardcoded_options = {\n    \"--secret\" = [\"'id=github-token,env=GITHUB_OAUTH_TOKEN'\"]\n  }\n</code></pre></div>\n<p dir=\"auto\">Finally we tried running the script again and it failed, and while looking in the ECS logs we saw:</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"Running command: /opt/ecs-deploy-runner/scripts/build-docker-image (args redacted)\n--\nIncorrect Usage. flag provided but not defined: -secret\nUsage: build-docker-image [--repo] [--ref] [--sha] [--idempotent] [--context-path] [--dockerfile-path]\n[--docker-image-tag] [--build-arg] [--env-secret] [--iam-role] [--no-push] [--help] command [options] [args]\nCommand to trigger a docker build using kaniko. The intention of the script is to simplify the args so that it reflects\nthe specific use case of the ECS deploy runner.\nCommands:\nhelp, h  Shows a list of commands or help for one command\nERROR: flag provided but not defined: -secret\nexit status 1\nERROR: exit status 1\"><pre class=\"notranslate\"><code class=\"notranslate\">Running command: /opt/ecs-deploy-runner/scripts/build-docker-image (args redacted)\n--\nIncorrect Usage. flag provided but not defined: -secret\nUsage: build-docker-image [--repo] [--ref] [--sha] [--idempotent] [--context-path] [--dockerfile-path]\n[--docker-image-tag] [--build-arg] [--env-secret] [--iam-role] [--no-push] [--help] command [options] [args]\nCommand to trigger a docker build using kaniko. The intention of the script is to simplify the args so that it reflects\nthe specific use case of the ECS deploy runner.\nCommands:\nhelp, h  Shows a list of commands or help for one command\nERROR: flag provided but not defined: -secret\nexit status 1\nERROR: exit status 1\n</code></pre></div>\n<p dir=\"auto\">It looks like we can't update the image. Are we missing something?</p>\n<hr>\n<ins datetime=\"2022-12-22T11:45:00Z\">\n  <p dir=\"auto\"><a href=\"https://support.gruntwork.io/hc/requests/109746\" rel=\"nofollow\">Tracked in ticket #109746</a></p>\n</ins>","answer":{"body":"Here is a complete upgrade guide for moving past the breaking buildkit change in terraform-aws-ci.  This change was introduced in v0.50.12.\r\n\r\n### Prerequisites\r\n\r\n- Docker must be installed on your machine at version 18.09 or later\r\n- You have a [Github OAuth Token](https://docs.github.com/en/enterprise-server@3.4/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token) available with access to the gruntwork-io github organization\r\n- You have access to\r\n    - Push images to ECR in your Shared AWS account\r\n    - Perform CRUD actions on ECS in all relevant AWS accounts\r\n    - Perform CRUD actions on Lambda in all relevant AWS accounts\r\n\r\n---\r\n\r\n### Guide\r\n\r\nWe will need to build two docker images locally. Starting with Kaniko:\r\n\r\n1. **Checkout terraform-aws-ci** at version v0.50.12 or later (we recommend the [latest release](https://github.com/gruntwork-io/terraform-aws-ci/releases)): [https://github.com/gruntwork-io/terraform-aws-ci](https://github.com/gruntwork-io/terraform-aws-ci/releases)\r\n    \r\n    ```bash\r\n    cd terraform-aws-ci/modules/ecs-deploy-runner/docker/kaniko\r\n    ```\r\n    \r\n2. **Make your github token available to the build system.**  We recommend using [bitwarden](https://medium.com/gruntwork/how-to-securely-store-secrets-in-bitwarden-cli-and-load-them-into-your-zsh-shell-when-needed-f12d4d040df) or [pass](https://blog.gruntwork.io/a-comprehensive-guide-to-managing-secrets-in-your-terraform-code-1d586955ace1#4df5) for security, but the command below can work in a pinch\r\n    \r\n    ```bash\r\n    export GITHUB_OAUTH_TOKEN=your_token\r\n    ```\r\n    \r\n3. **Build the Kaniko Image** Run the docker build tagged to your kaniko ECR repo in your Shared AWS account with a version matching the terraform-aws-ci version you chose in step 1.  Your repo tag should have the following format: \r\n    \r\n    ```bash\r\n    # Replace the following variables with the values for your account and Reference Architecture\r\n    ${account-id}.dkr.ecr.${primary-region}.amazonaws.com/kaniko:${terraform-aws-ci-version}\r\n    \r\n    # For example: \r\n    [1234123412.dkr.ecr.us-east-1.amazonaws.com/kaniko:v0.50.12](http://1234123412.dkr.ecr.us-east-1.amazonaws.com/kaniko:v0.50.12)\r\n    \r\n    # where the first 12 digits are the account ID of your shared AWS account and the us-east-1 is the PrimaryRegion you selected when your Reference Architecture was deployed. \r\n    ```\r\n    \r\n    Build the Kaniko docker image. Pass the `--tag` value that you constructed\r\n    \r\n    ```bash\r\n    DOCKER_BUILDKIT=1 docker build \\\r\n      --secret id=github-token,env=GITHUB_OAUTH_TOKEN \\\r\n      --build-arg module_ci_tag=\"v0.50.12\" \\\r\n      --tag $shared_account_id.dkr.ecr.$ecr_repo_region.amazonaws.com/kaniko:v0.50.12 \\\r\n      --platform linux/amd64 .\r\n    ```\r\n    \r\n4. **Sign in to your ECR repo.**  We use AWS vault, but any method of exposing credentials is valid\r\n    \r\n    ```bash\r\n    aws-vault exec shared -- aws ecr get-login-password --region us-east-1 \\\r\n      | docker login -u AWS --password-stdin $shared_account_id.dkr.ecr.$ecr_repo_region.amazonaws.com\r\n    ```\r\n    \r\n5. **Push the docker image** to your shared repo\r\n    \r\n    ```bash\r\n    docker push $shared_account_id.dkr.ecr.$ecr_repo_region.amazonaws.com/kaniko:v0.50.12\r\n    ```\r\n    \r\n6. **Repeat for the ecs-deploy-runner image**\r\n    \r\n    ```bash\r\n    #navigate to terraform-aws-ci/modules/ecs-deploy-runner/docker/deploy-runner\r\n    cd ../deploy-runner\r\n    \r\n    #build\r\n    DOCKER_BUILDKIT=1 docker build \\\r\n      --secret id=github-token,env=GITHUB_OAUTH_TOKEN \\\r\n      --build-arg module_ci_tag\"v0.50.12\" \\\r\n      --tag $shared_account_id.dkr.ecr.$ecr_repo_region.amazonaws.com/deploy-runner:v0.50.12 \\\r\n      --platform linux/amd64 .\r\n    \r\n    #docker login\r\n    aws-vault exec shared -- aws ecr get-login-password --region us-east-1 \\\r\n      | docker login -u AWS --password-stdin $shared_account_id.dkr.ecr.$ecr_repo_region.amazonaws.com\r\n    \r\n    #push the tag\r\n    docker push $shared_account_id.dkr.ecr.$ecr_repo_region.amazonaws.com/deploy-runner:v0.50.12\r\n    ```\r\n    \r\n7. **Update your Terraform to point at the new images**\r\n    1. In your infrastructure-live repo find `common.hcl` at the repo root and replace `kaniko_container_image_tag` and `deploy_runner_container_image_tag` with the new image tags we just pushed.\r\n        \r\n        ```bash\r\n        #On line 21\r\n        deploy_runner_container_image_tag = \"v0.50.12\"\r\n        \r\n        #On line 25\r\n        kaniko_container_image_tag = \"v0.50.12\"\r\n        ```\r\n        \r\n    2. In `_envcommon/mgmt/ecs-deploy-runner.hcl` ensure that the version ref is at least `v0.96.3` and no local environment (dev, stage, prod, shared, security, or logs) is overriding it\r\n    3. Run `terragrunt apply` in all impacted modules (this can be done using your usual CI/CD process or manually in each `env/us-east-1/mgmt/ecs-deploy-runner` directory)\r\n8. **Update the build scripts to use docker buildkit for next time you update.** Change `build_deploy_runner_image.sh` and `build_kaniko_image.sh` in `shared/us-east-1/_regional/container_images/` to use the updated versions and buildkit syntax: \r\n    \r\n    ```bash\r\n    #On line 15, replace:\r\n    readonly DOCKERFILE_REPO_REF=\"v0.50.6\"\r\n    #With:\r\n    readonly DOCKERFILE_REPO_REF=\"v0.50.12\"\r\n    \r\n    #On line 43, replace:\r\n    --build-arg 'GITHUB_OAUTH_TOKEN' \\\r\n    #With:\r\n    --env-secret 'github-token=GITHUB_OAUTH_TOKEN' \\\r\n    ```","bodyHTML":"<p dir=\"auto\">Here is a complete upgrade guide for moving past the breaking buildkit change in terraform-aws-ci.  This change was introduced in v0.50.12.</p>\n<h3 dir=\"auto\">Prerequisites</h3>\n<ul dir=\"auto\">\n<li>Docker must be installed on your machine at version 18.09 or later</li>\n<li>You have a <a href=\"https://docs.github.com/en/enterprise-server@3.4/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token\">Github OAuth Token</a> available with access to the gruntwork-io github organization</li>\n<li>You have access to\n<ul dir=\"auto\">\n<li>Push images to ECR in your Shared AWS account</li>\n<li>Perform CRUD actions on ECS in all relevant AWS accounts</li>\n<li>Perform CRUD actions on Lambda in all relevant AWS accounts</li>\n</ul>\n</li>\n</ul>\n<hr>\n<h3 dir=\"auto\">Guide</h3>\n<p dir=\"auto\">We will need to build two docker images locally. Starting with Kaniko:</p>\n<ol dir=\"auto\">\n<li>\n<p dir=\"auto\"><strong>Checkout terraform-aws-ci</strong> at version v0.50.12 or later (we recommend the <a href=\"https://github.com/gruntwork-io/terraform-aws-ci/releases\">latest release</a>): <a href=\"https://github.com/gruntwork-io/terraform-aws-ci/releases\">https://github.com/gruntwork-io/terraform-aws-ci</a></p>\n<div class=\"highlight highlight-source-shell notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"cd terraform-aws-ci/modules/ecs-deploy-runner/docker/kaniko\"><pre class=\"notranslate\"><span class=\"pl-c1\">cd</span> terraform-aws-ci/modules/ecs-deploy-runner/docker/kaniko</pre></div>\n</li>\n<li>\n<p dir=\"auto\"><strong>Make your github token available to the build system.</strong>  We recommend using <a href=\"https://medium.com/gruntwork/how-to-securely-store-secrets-in-bitwarden-cli-and-load-them-into-your-zsh-shell-when-needed-f12d4d040df\" rel=\"nofollow\">bitwarden</a> or <a href=\"https://blog.gruntwork.io/a-comprehensive-guide-to-managing-secrets-in-your-terraform-code-1d586955ace1#4df5\" rel=\"nofollow\">pass</a> for security, but the command below can work in a pinch</p>\n<div class=\"highlight highlight-source-shell notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"export GITHUB_OAUTH_TOKEN=your_token\"><pre class=\"notranslate\"><span class=\"pl-k\">export</span> GITHUB_OAUTH_TOKEN=your_token</pre></div>\n</li>\n<li>\n<p dir=\"auto\"><strong>Build the Kaniko Image</strong> Run the docker build tagged to your kaniko ECR repo in your Shared AWS account with a version matching the terraform-aws-ci version you chose in step 1.  Your repo tag should have the following format:</p>\n<div class=\"highlight highlight-source-shell notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"# Replace the following variables with the values for your account and Reference Architecture\n${account-id}.dkr.ecr.${primary-region}.amazonaws.com/kaniko:${terraform-aws-ci-version}\n\n# For example: \n[1234123412.dkr.ecr.us-east-1.amazonaws.com/kaniko:v0.50.12](http://1234123412.dkr.ecr.us-east-1.amazonaws.com/kaniko:v0.50.12)\n\n# where the first 12 digits are the account ID of your shared AWS account and the us-east-1 is the PrimaryRegion you selected when your Reference Architecture was deployed. \"><pre class=\"notranslate\"><span class=\"pl-c\"><span class=\"pl-c\">#</span> Replace the following variables with the values for your account and Reference Architecture</span>\n<span class=\"pl-smi\">${account-id}</span>.dkr.ecr.<span class=\"pl-smi\">${primary-region}</span>.amazonaws.com/kaniko:<span class=\"pl-smi\">${terraform-aws-ci-version}</span>\n\n<span class=\"pl-c\"><span class=\"pl-c\">#</span> For example: </span>\n[1234123412.dkr.ecr.us-east-1.amazonaws.com/kaniko:v0.50.12](http://1234123412.dkr.ecr.us-east-1.amazonaws.com/kaniko:v0.50.12)\n\n<span class=\"pl-c\"><span class=\"pl-c\">#</span> where the first 12 digits are the account ID of your shared AWS account and the us-east-1 is the PrimaryRegion you selected when your Reference Architecture was deployed. </span></pre></div>\n<p dir=\"auto\">Build the Kaniko docker image. Pass the <code class=\"notranslate\">--tag</code> value that you constructed</p>\n<div class=\"highlight highlight-source-shell notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"DOCKER_BUILDKIT=1 docker build \\\n  --secret id=github-token,env=GITHUB_OAUTH_TOKEN \\\n  --build-arg module_ci_tag=&quot;v0.50.12&quot; \\\n  --tag $shared_account_id.dkr.ecr.$ecr_repo_region.amazonaws.com/kaniko:v0.50.12 \\\n  --platform linux/amd64 .\"><pre class=\"notranslate\">DOCKER_BUILDKIT=1 docker build \\\n  --secret id=github-token,env=GITHUB_OAUTH_TOKEN \\\n  --build-arg module_ci_tag=<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>v0.50.12<span class=\"pl-pds\">\"</span></span> \\\n  --tag <span class=\"pl-smi\">$shared_account_id</span>.dkr.ecr.<span class=\"pl-smi\">$ecr_repo_region</span>.amazonaws.com/kaniko:v0.50.12 \\\n  --platform linux/amd64 <span class=\"pl-c1\">.</span></pre></div>\n</li>\n<li>\n<p dir=\"auto\"><strong>Sign in to your ECR repo.</strong>  We use AWS vault, but any method of exposing credentials is valid</p>\n<div class=\"highlight highlight-source-shell notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"aws-vault exec shared -- aws ecr get-login-password --region us-east-1 \\\n  | docker login -u AWS --password-stdin $shared_account_id.dkr.ecr.$ecr_repo_region.amazonaws.com\"><pre class=\"notranslate\">aws-vault <span class=\"pl-c1\">exec</span> shared -- aws ecr get-login-password --region us-east-1 \\\n  <span class=\"pl-k\">|</span> docker login -u AWS --password-stdin <span class=\"pl-smi\">$shared_account_id</span>.dkr.ecr.<span class=\"pl-smi\">$ecr_repo_region</span>.amazonaws.com</pre></div>\n</li>\n<li>\n<p dir=\"auto\"><strong>Push the docker image</strong> to your shared repo</p>\n<div class=\"highlight highlight-source-shell notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"docker push $shared_account_id.dkr.ecr.$ecr_repo_region.amazonaws.com/kaniko:v0.50.12\"><pre class=\"notranslate\">docker push <span class=\"pl-smi\">$shared_account_id</span>.dkr.ecr.<span class=\"pl-smi\">$ecr_repo_region</span>.amazonaws.com/kaniko:v0.50.12</pre></div>\n</li>\n<li>\n<p dir=\"auto\"><strong>Repeat for the ecs-deploy-runner image</strong></p>\n<div class=\"highlight highlight-source-shell notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"#navigate to terraform-aws-ci/modules/ecs-deploy-runner/docker/deploy-runner\ncd ../deploy-runner\n\n#build\nDOCKER_BUILDKIT=1 docker build \\\n  --secret id=github-token,env=GITHUB_OAUTH_TOKEN \\\n  --build-arg module_ci_tag&quot;v0.50.12&quot; \\\n  --tag $shared_account_id.dkr.ecr.$ecr_repo_region.amazonaws.com/deploy-runner:v0.50.12 \\\n  --platform linux/amd64 .\n\n#docker login\naws-vault exec shared -- aws ecr get-login-password --region us-east-1 \\\n  | docker login -u AWS --password-stdin $shared_account_id.dkr.ecr.$ecr_repo_region.amazonaws.com\n\n#push the tag\ndocker push $shared_account_id.dkr.ecr.$ecr_repo_region.amazonaws.com/deploy-runner:v0.50.12\"><pre class=\"notranslate\"><span class=\"pl-c\"><span class=\"pl-c\">#</span>navigate to terraform-aws-ci/modules/ecs-deploy-runner/docker/deploy-runner</span>\n<span class=\"pl-c1\">cd</span> ../deploy-runner\n\n<span class=\"pl-c\"><span class=\"pl-c\">#</span>build</span>\nDOCKER_BUILDKIT=1 docker build \\\n  --secret id=github-token,env=GITHUB_OAUTH_TOKEN \\\n  --build-arg module_ci_tag<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>v0.50.12<span class=\"pl-pds\">\"</span></span> \\\n  --tag <span class=\"pl-smi\">$shared_account_id</span>.dkr.ecr.<span class=\"pl-smi\">$ecr_repo_region</span>.amazonaws.com/deploy-runner:v0.50.12 \\\n  --platform linux/amd64 <span class=\"pl-c1\">.</span>\n\n<span class=\"pl-c\"><span class=\"pl-c\">#</span>docker login</span>\naws-vault <span class=\"pl-c1\">exec</span> shared -- aws ecr get-login-password --region us-east-1 \\\n  <span class=\"pl-k\">|</span> docker login -u AWS --password-stdin <span class=\"pl-smi\">$shared_account_id</span>.dkr.ecr.<span class=\"pl-smi\">$ecr_repo_region</span>.amazonaws.com\n\n<span class=\"pl-c\"><span class=\"pl-c\">#</span>push the tag</span>\ndocker push <span class=\"pl-smi\">$shared_account_id</span>.dkr.ecr.<span class=\"pl-smi\">$ecr_repo_region</span>.amazonaws.com/deploy-runner:v0.50.12</pre></div>\n</li>\n<li>\n<p dir=\"auto\"><strong>Update your Terraform to point at the new images</strong></p>\n<ol dir=\"auto\">\n<li>\n<p dir=\"auto\">In your infrastructure-live repo find <code class=\"notranslate\">common.hcl</code> at the repo root and replace <code class=\"notranslate\">kaniko_container_image_tag</code> and <code class=\"notranslate\">deploy_runner_container_image_tag</code> with the new image tags we just pushed.</p>\n<div class=\"highlight highlight-source-shell notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"#On line 21\ndeploy_runner_container_image_tag = &quot;v0.50.12&quot;\n\n#On line 25\nkaniko_container_image_tag = &quot;v0.50.12&quot;\"><pre class=\"notranslate\"><span class=\"pl-c\"><span class=\"pl-c\">#</span>On line 21</span>\ndeploy_runner_container_image_tag = <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>v0.50.12<span class=\"pl-pds\">\"</span></span>\n\n<span class=\"pl-c\"><span class=\"pl-c\">#</span>On line 25</span>\nkaniko_container_image_tag = <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>v0.50.12<span class=\"pl-pds\">\"</span></span></pre></div>\n</li>\n<li>\n<p dir=\"auto\">In <code class=\"notranslate\">_envcommon/mgmt/ecs-deploy-runner.hcl</code> ensure that the version ref is at least <code class=\"notranslate\">v0.96.3</code> and no local environment (dev, stage, prod, shared, security, or logs) is overriding it</p>\n</li>\n<li>\n<p dir=\"auto\">Run <code class=\"notranslate\">terragrunt apply</code> in all impacted modules (this can be done using your usual CI/CD process or manually in each <code class=\"notranslate\">env/us-east-1/mgmt/ecs-deploy-runner</code> directory)</p>\n</li>\n</ol>\n</li>\n<li>\n<p dir=\"auto\"><strong>Update the build scripts to use docker buildkit for next time you update.</strong> Change <code class=\"notranslate\">build_deploy_runner_image.sh</code> and <code class=\"notranslate\">build_kaniko_image.sh</code> in <code class=\"notranslate\">shared/us-east-1/_regional/container_images/</code> to use the updated versions and buildkit syntax:</p>\n<div class=\"highlight highlight-source-shell notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"#On line 15, replace:\nreadonly DOCKERFILE_REPO_REF=&quot;v0.50.6&quot;\n#With:\nreadonly DOCKERFILE_REPO_REF=&quot;v0.50.12&quot;\n\n#On line 43, replace:\n--build-arg 'GITHUB_OAUTH_TOKEN' \\\n#With:\n--env-secret 'github-token=GITHUB_OAUTH_TOKEN' \\\"><pre class=\"notranslate\"><span class=\"pl-c\"><span class=\"pl-c\">#</span>On line 15, replace:</span>\n<span class=\"pl-k\">readonly</span> DOCKERFILE_REPO_REF=<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>v0.50.6<span class=\"pl-pds\">\"</span></span>\n<span class=\"pl-c\"><span class=\"pl-c\">#</span>With:</span>\n<span class=\"pl-k\">readonly</span> DOCKERFILE_REPO_REF=<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>v0.50.12<span class=\"pl-pds\">\"</span></span>\n\n<span class=\"pl-c\"><span class=\"pl-c\">#</span>On line 43, replace:</span>\n--build-arg <span class=\"pl-s\"><span class=\"pl-pds\">'</span>GITHUB_OAUTH_TOKEN<span class=\"pl-pds\">'</span></span> \\\n<span class=\"pl-c\"><span class=\"pl-c\">#</span>With:</span>\n--env-secret <span class=\"pl-s\"><span class=\"pl-pds\">'</span>github-token=GITHUB_OAUTH_TOKEN<span class=\"pl-pds\">'</span></span> \\</pre></div>\n</li>\n</ol>"}}} />

</CenterLayout>

<!-- ##DOCS-SOURCER-START
{
  "sourcePlugin": "github-discussions",
  "hash": "032314865df4efe32a62903d472c3be7"
}
##DOCS-SOURCER-END -->

---
hide_table_of_contents: true
hide_title: true
custom_edit_url: null
---

import CenterLayout from "/src/components/CenterLayout"
import GitHub from "/src/components/GitHub"

<head>
  <link rel="canonical" href="https://github.com/gruntwork-io/knowledge-base/discussions/347" />
</head>

<CenterLayout>
<span className="searchCategory">Knowledge Base</span>
<h1>Help understanding how ecs-deploy-runners clones repos inside _envcommon</h1>
<GitHub discussion={{"id":"D_kwDOF8slf84APPrF","number":347,"author":{"login":"pete0emerson"},"title":"Help understanding how ecs-deploy-runners clones repos inside _envcommon","body":"I'm a little confused regarding the service catalog around the _[envcommon source](https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/master/examples/for-production/infrastructure-live/_envcommon/services/ecs-cluster.hcl#L15) cloning source repos\r\n\r\nWhen the ecs-deploy-runner is grabbing the source, how is it cloning the repo?\r\n\r\n`git::git@github.com:gruntwork-io/terraform-aws-service-catalog.git//modules/services/ecs-cluster?ref=v0.82.0`\r\n\r\nThat makes me believe it's ssh just by looking at it...\r\n\r\nBut when looking at the [regional/container_images](https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/master/examples/for-production/infrastructure-live/shared/us-west-2/_regional/container_images/build_deploy_runner_image.sh) build process, it's only putting in a [GITHUB_OAUTH_TOKEN](https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/master/examples/for-production/infrastructure-live/shared/us-west-2/_regional/container_images/build_deploy_runner_image.sh#L43) which means it's doing https cloning and I do remember there are parts where the code is forcing https clones instead of ssh clones. And that's only initially allowed by cloud based source repos because of some embedded telling whenever cloning bitbucket/gitlab.com/github.com, use https...\r\n\r\nBut there's the secrets manager to put in a private ssh key for git... So I'm just kinda spinning in circles a bit.\r\n\r\nThe reason why i'm bringing this up is because I made changes to instead of using a cloud based source repo, im using an internal only one. I got passed the host key adding with the ecs-deploy-runner and adding in our host key so it feels like it's trying to do ssh clones. But I get errors like this now:\r\n```\r\n[ecs-deploy-runner][2022-04-07T01:10:42+0000] \t* error downloading 'ssh://redacated/iac/packer.git?ref=v0.0.6': /usr/bin/git exited with 128: Cloning into '/tmp/tmp9u8kcimr/dev/us-west-2/dev/ec2-instance/nginx/.terragrunt-cache/uJVUnMadxFV_mFg5T5Q4w1NIoBI/sifUfbkg2MEiCFB7ugmhdKj3uQk'...\r\n[ecs-deploy-runner][2022-04-07T01:10:42+0000] git@REDACATED: Permission denied (publickey,gssapi-keyex,gssapi-with-mic).\r\n[ecs-deploy-runner][2022-04-07T01:10:42+0000] fatal: Could not read from remote repository.\r\n[ecs-deploy-runner][2022-04-07T01:10:42+0000] Please make sure you have the correct access rights\r\n[ecs-deploy-runner][2022-04-07T01:10:42+0000] and the repository exists. \r\n```\r\n\r\nI'm gonna keep digging into my issue, but understanding how ecs-deploy-runners does clones inside _envcommon for the source in the terraform blocks would help out.\r\n\r\n---\r\n\r\nwow i think it's the chicken vs the egg problem, mainly stemming from the fact that in our implementation, we have an internal gitlab and we don't use the kaniko container builds at all, which means that our deploy runner is based off whatever we build it with the first time....\r\n\r\nWhich means the ecs-deploy-runner container gets a github_oauth_token, but then never gets updated with kaniko and the docker_image_builder, which then would load in the SSH key from secrets manager.\r\n\r\nI could either get around it by:\r\n\r\n1. forking the infrastructre-deploy-script to add in our internal gitlab to force the HTTPS global url. https://ourgitlab.com/.insteadOf [git@OURGITLAB.com](mailto:git@OURGITLAB.com) so it would use a PAT... but I would also have to add in another argument for that PAT in the future.\r\n2.  Or by figuring out how to add in the private ssh key to the ecs-deploy-runner image when I first make it, so it can use SSH clones\r\n\r\nSince its a private source repo and I can lockdown my vpcs with network ACLs for ssh traffic and that our resource is internal only, and I can log those connections, i think it would still pass CIS benchmarks in the future.","bodyHTML":"<p dir=\"auto\">I'm a little confused regarding the service catalog around the _<a href=\"https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/master/examples/for-production/infrastructure-live/_envcommon/services/ecs-cluster.hcl#L15\">envcommon source</a> cloning source repos</p>\n<p dir=\"auto\">When the ecs-deploy-runner is grabbing the source, how is it cloning the repo?</p>\n<p dir=\"auto\"><code class=\"notranslate\">git::git@github.com:gruntwork-io/terraform-aws-service-catalog.git//modules/services/ecs-cluster?ref=v0.82.0</code></p>\n<p dir=\"auto\">That makes me believe it's ssh just by looking at it...</p>\n<p dir=\"auto\">But when looking at the <a href=\"https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/master/examples/for-production/infrastructure-live/shared/us-west-2/_regional/container_images/build_deploy_runner_image.sh\">regional/container_images</a> build process, it's only putting in a <a href=\"https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/master/examples/for-production/infrastructure-live/shared/us-west-2/_regional/container_images/build_deploy_runner_image.sh#L43\">GITHUB_OAUTH_TOKEN</a> which means it's doing https cloning and I do remember there are parts where the code is forcing https clones instead of ssh clones. And that's only initially allowed by cloud based source repos because of some embedded telling whenever cloning bitbucket/gitlab.com/github.com, use https...</p>\n<p dir=\"auto\">But there's the secrets manager to put in a private ssh key for git... So I'm just kinda spinning in circles a bit.</p>\n<p dir=\"auto\">The reason why i'm bringing this up is because I made changes to instead of using a cloud based source repo, im using an internal only one. I got passed the host key adding with the ecs-deploy-runner and adding in our host key so it feels like it's trying to do ssh clones. But I get errors like this now:</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"[ecs-deploy-runner][2022-04-07T01:10:42+0000] \t* error downloading 'ssh://redacated/iac/packer.git?ref=v0.0.6': /usr/bin/git exited with 128: Cloning into '/tmp/tmp9u8kcimr/dev/us-west-2/dev/ec2-instance/nginx/.terragrunt-cache/uJVUnMadxFV_mFg5T5Q4w1NIoBI/sifUfbkg2MEiCFB7ugmhdKj3uQk'...\n[ecs-deploy-runner][2022-04-07T01:10:42+0000] git@REDACATED: Permission denied (publickey,gssapi-keyex,gssapi-with-mic).\n[ecs-deploy-runner][2022-04-07T01:10:42+0000] fatal: Could not read from remote repository.\n[ecs-deploy-runner][2022-04-07T01:10:42+0000] Please make sure you have the correct access rights\n[ecs-deploy-runner][2022-04-07T01:10:42+0000] and the repository exists. \"><pre class=\"notranslate\"><code class=\"notranslate\">[ecs-deploy-runner][2022-04-07T01:10:42+0000] \t* error downloading 'ssh://redacated/iac/packer.git?ref=v0.0.6': /usr/bin/git exited with 128: Cloning into '/tmp/tmp9u8kcimr/dev/us-west-2/dev/ec2-instance/nginx/.terragrunt-cache/uJVUnMadxFV_mFg5T5Q4w1NIoBI/sifUfbkg2MEiCFB7ugmhdKj3uQk'...\n[ecs-deploy-runner][2022-04-07T01:10:42+0000] git@REDACATED: Permission denied (publickey,gssapi-keyex,gssapi-with-mic).\n[ecs-deploy-runner][2022-04-07T01:10:42+0000] fatal: Could not read from remote repository.\n[ecs-deploy-runner][2022-04-07T01:10:42+0000] Please make sure you have the correct access rights\n[ecs-deploy-runner][2022-04-07T01:10:42+0000] and the repository exists. \n</code></pre></div>\n<p dir=\"auto\">I'm gonna keep digging into my issue, but understanding how ecs-deploy-runners does clones inside _envcommon for the source in the terraform blocks would help out.</p>\n<hr>\n<p dir=\"auto\">wow i think it's the chicken vs the egg problem, mainly stemming from the fact that in our implementation, we have an internal gitlab and we don't use the kaniko container builds at all, which means that our deploy runner is based off whatever we build it with the first time....</p>\n<p dir=\"auto\">Which means the ecs-deploy-runner container gets a github_oauth_token, but then never gets updated with kaniko and the docker_image_builder, which then would load in the SSH key from secrets manager.</p>\n<p dir=\"auto\">I could either get around it by:</p>\n<ol dir=\"auto\">\n<li>forking the infrastructre-deploy-script to add in our internal gitlab to force the HTTPS global url. <a href=\"https://ourgitlab.com/.insteadOf\" rel=\"nofollow\">https://ourgitlab.com/.insteadOf</a> <a href=\"mailto:git@OURGITLAB.com\">git@OURGITLAB.com</a> so it would use a PAT... but I would also have to add in another argument for that PAT in the future.</li>\n<li>Or by figuring out how to add in the private ssh key to the ecs-deploy-runner image when I first make it, so it can use SSH clones</li>\n</ol>\n<p dir=\"auto\">Since its a private source repo and I can lockdown my vpcs with network ACLs for ssh traffic and that our resource is internal only, and I can log those connections, i think it would still pass CIS benchmarks in the future.</p>","answer":{"body":"The `ecs-deploy-runner` can also support SSH-key based clones via the [repo_access_ssh_key_secrets_manager_arn](https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/master/modules/mgmt/ecs-deploy-runner/variables.tf#L217) arg in the `terraform_planner_config` and `terraform_applier_config` objects. This secrets manager entry should contain the contents of a passwordless SSH private key, which then gets loaded at runtime into an `ssh-agent` prior to calling `git clone`. This would be option (2) in your list of workarounds, which is probably the path of least resistance (since you won't have to maintain a fork).\r\n\r\nNote that this only applies to the infrastructure deployment scripts (`terragrunt`/`terraform` calls) of the pipeline, and does not work with the AMI builder or the docker builders, as those only support HTTPS based clones.","bodyHTML":"<p dir=\"auto\">The <code class=\"notranslate\">ecs-deploy-runner</code> can also support SSH-key based clones via the <a href=\"https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/master/modules/mgmt/ecs-deploy-runner/variables.tf#L217\">repo_access_ssh_key_secrets_manager_arn</a> arg in the <code class=\"notranslate\">terraform_planner_config</code> and <code class=\"notranslate\">terraform_applier_config</code> objects. This secrets manager entry should contain the contents of a passwordless SSH private key, which then gets loaded at runtime into an <code class=\"notranslate\">ssh-agent</code> prior to calling <code class=\"notranslate\">git clone</code>. This would be option (2) in your list of workarounds, which is probably the path of least resistance (since you won't have to maintain a fork).</p>\n<p dir=\"auto\">Note that this only applies to the infrastructure deployment scripts (<code class=\"notranslate\">terragrunt</code>/<code class=\"notranslate\">terraform</code> calls) of the pipeline, and does not work with the AMI builder or the docker builders, as those only support HTTPS based clones.</p>"}}} />

</CenterLayout>

<!-- ##DOCS-SOURCER-START
{
  "sourcePlugin": "github-discussions",
  "hash": "58d28ebcd0a96874eca03473b781994c"
}
##DOCS-SOURCER-END -->

---
hide_table_of_contents: true
hide_title: true
custom_edit_url: null
---

import CenterLayout from "/src/components/CenterLayout"
import GitHub from "/src/components/GitHub"

<CenterLayout>
<span className="searchCategory">Knowledge Base</span>
<h1>How do I deploy the Steampipe Runner into an existing Gruntwork Reference Architecture?</h1>
<GitHub discussion={{"id":"D_kwDOF8slf84AQNsY","number":521,"author":{"login":"yorinasub17"},"title":"How do I deploy the Steampipe Runner into an existing Gruntwork Reference Architecture?","body":"\nHi, I am using the Gruntwork Reference Architecture with CIS, and I would like to use the Steampipe Runner. What is the best way to get this accomplished?\n\n---\n\n<ins datetime=\"2022-07-26T18:24:52Z\">\n  <p><a href=\"https://support.gruntwork.io/hc/requests/109060\">Tracked in ticket #109060</a></p>\n</ins>\n","bodyHTML":"<p dir=\"auto\">Hi, I am using the Gruntwork Reference Architecture with CIS, and I would like to use the Steampipe Runner. What is the best way to get this accomplished?</p>\n<hr>\n<ins datetime=\"2022-07-26T18:24:52Z\">\n  <p dir=\"auto\"><a href=\"https://support.gruntwork.io/hc/requests/109060\" rel=\"nofollow\">Tracked in ticket #109060</a></p>\n</ins>","answer":{"body":"You can migrate the existing `ecs-deploy-runner` from the Service Catalog to the `ecs-deploy-runner-with-steampipe-runner` module from the [terraform-aws-ci-steampipe](https://github.com/gruntwork-io/terraform-aws-ci-steampipe/) repo using the following steps:\r\n\r\n1. Make sure you have updated the `ecs-deploy-runner` module to version `v0.92.0` of the Service Catalog.\r\n2. Add a new ECR repo in the shared account to hold the steampipe runner docker image.\r\n1. Create a new build script for building [the steampipe-runner docker image](https://github.com/gruntwork-io/terraform-aws-ci-steampipe/tree/main/modules/steampipe-runner).\r\n    - Use the [build_deploy_runner_image.sh](https://github.com/gruntwork-io/terraform-aws-cis-service-catalog/blob/master/examples/for-production/infrastructure-live/shared/us-west-2/_regional/container_images/build_deploy_runner_image.sh) script as a starting point.\r\n1. Build the steampipe runner docker image by invoking the build script.\r\n1. Replace the module source to point to the `ecs-deploy-runner-with-steampipe-runner` module. We recommend doing this in the `_envcommon/mgmt/ecs-deploy-runner.hcl` file.\r\n1. Add [the configuration inputs for the steampipe runner](https://github.com/gruntwork-io/terraform-aws-ci-steampipe/blob/main/modules/ecs-deploy-runner-with-steampipe-runner/variables.tf#L16-L96) in the envcommon file.\r\n3. Add an invoke schedule for periodically invoking steampipe runner to run the checks. You can use the following as a starting point:\r\n    ```\r\n    invoke_schedule = {\r\n      run_cis_checks = {\r\n        container_name      = \"steampipe-runner\"\r\n        script              = \"run-steampipe-mod-check\"\r\n        args                = \"--repo https://github.com/turbot/steampipe-mod-aws-compliance.git --ref v0.42 --check-selector benchmark.cis_v140 --output none --publish-to-securityhub\"\r\n        schedule_expression = \"cron(0 0,6,12,18 * * ? *)\"\r\n      }\r\n    }\r\n    ```\r\n4. In each ECS Deploy Runner deployment:\r\n    - Migrate the state of the standard ECS Deploy Runner to fit the steampipe runner state:\r\n        ```\r\n        terragrunt state mv module.ecs_deploy_runner module.tmp\r\n        terragrunt state mv module.tmp module.standard_ecs_deploy_runner.module.ecs_deploy_runner\r\n        terragrunt state mv module.shared_secrets_kms_grants module.standard_ecs_deploy_runner.module.shared_secrets_kms_grants\r\n        ```\r\n    - Run `terragrunt plan` and make sure there are no destroy actions.\r\n    - Run `terragrunt apply`","bodyHTML":"<p dir=\"auto\">You can migrate the existing <code class=\"notranslate\">ecs-deploy-runner</code> from the Service Catalog to the <code class=\"notranslate\">ecs-deploy-runner-with-steampipe-runner</code> module from the <a href=\"https://github.com/gruntwork-io/terraform-aws-ci-steampipe/\">terraform-aws-ci-steampipe</a> repo using the following steps:</p>\n<ol dir=\"auto\">\n<li>Make sure you have updated the <code class=\"notranslate\">ecs-deploy-runner</code> module to version <code class=\"notranslate\">v0.92.0</code> of the Service Catalog.</li>\n<li>Add a new ECR repo in the shared account to hold the steampipe runner docker image.</li>\n<li>Create a new build script for building <a href=\"https://github.com/gruntwork-io/terraform-aws-ci-steampipe/tree/main/modules/steampipe-runner\">the steampipe-runner docker image</a>.\n<ul dir=\"auto\">\n<li>Use the <a href=\"https://github.com/gruntwork-io/terraform-aws-cis-service-catalog/blob/master/examples/for-production/infrastructure-live/shared/us-west-2/_regional/container_images/build_deploy_runner_image.sh\">build_deploy_runner_image.sh</a> script as a starting point.</li>\n</ul>\n</li>\n<li>Build the steampipe runner docker image by invoking the build script.</li>\n<li>Replace the module source to point to the <code class=\"notranslate\">ecs-deploy-runner-with-steampipe-runner</code> module. We recommend doing this in the <code class=\"notranslate\">_envcommon/mgmt/ecs-deploy-runner.hcl</code> file.</li>\n<li>Add <a href=\"https://github.com/gruntwork-io/terraform-aws-ci-steampipe/blob/main/modules/ecs-deploy-runner-with-steampipe-runner/variables.tf#L16-L96\">the configuration inputs for the steampipe runner</a> in the envcommon file.</li>\n<li>Add an invoke schedule for periodically invoking steampipe runner to run the checks. You can use the following as a starting point:\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"invoke_schedule = {\n  run_cis_checks = {\n    container_name      = &quot;steampipe-runner&quot;\n    script              = &quot;run-steampipe-mod-check&quot;\n    args                = &quot;--repo https://github.com/turbot/steampipe-mod-aws-compliance.git --ref v0.42 --check-selector benchmark.cis_v140 --output none --publish-to-securityhub&quot;\n    schedule_expression = &quot;cron(0 0,6,12,18 * * ? *)&quot;\n  }\n}\"><pre class=\"notranslate\"><code>invoke_schedule = {\n  run_cis_checks = {\n    container_name      = \"steampipe-runner\"\n    script              = \"run-steampipe-mod-check\"\n    args                = \"--repo https://github.com/turbot/steampipe-mod-aws-compliance.git --ref v0.42 --check-selector benchmark.cis_v140 --output none --publish-to-securityhub\"\n    schedule_expression = \"cron(0 0,6,12,18 * * ? *)\"\n  }\n}\n</code></pre></div>\n</li>\n<li>In each ECS Deploy Runner deployment:\n<ul dir=\"auto\">\n<li>Migrate the state of the standard ECS Deploy Runner to fit the steampipe runner state:\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"terragrunt state mv module.ecs_deploy_runner module.tmp\nterragrunt state mv module.tmp module.standard_ecs_deploy_runner.module.ecs_deploy_runner\nterragrunt state mv module.shared_secrets_kms_grants module.standard_ecs_deploy_runner.module.shared_secrets_kms_grants\"><pre class=\"notranslate\"><code>terragrunt state mv module.ecs_deploy_runner module.tmp\nterragrunt state mv module.tmp module.standard_ecs_deploy_runner.module.ecs_deploy_runner\nterragrunt state mv module.shared_secrets_kms_grants module.standard_ecs_deploy_runner.module.shared_secrets_kms_grants\n</code></pre></div>\n</li>\n<li>Run <code class=\"notranslate\">terragrunt plan</code> and make sure there are no destroy actions.</li>\n<li>Run <code class=\"notranslate\">terragrunt apply</code></li>\n</ul>\n</li>\n</ol>"}}} />

</CenterLayout>
  

<!-- ##DOCS-SOURCER-START
{
  "sourcePlugin": "github-discussions",
  "hash": "7fbed68e277886c7dcd1b60eaeb0a79e"
}
##DOCS-SOURCER-END -->

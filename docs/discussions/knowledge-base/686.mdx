---
hide_table_of_contents: true
hide_title: true
custom_edit_url: null
---

import CenterLayout from "/src/components/CenterLayout"
import GitHub from "/src/components/GitHub"

<head>
  <link rel="canonical" href="https://github.com/gruntwork-io/knowledge-base/discussions/686" />
</head>

<CenterLayout>
<span className="searchCategory">Knowledge Base</span>
<h1>How do I use self-hosted gitlab with `terraform-aws-ci` repo</h1>
<GitHub discussion={{"id":"D_kwDOF8slf84ATAQI","number":686,"author":{"login":"pras111gw"},"title":"How do I use self-hosted gitlab with `terraform-aws-ci` repo","body":"\nGruntwork code shows examples of using hosted github, bitbucket and gitlab. I have a self-hosted gitlab instance within my organization, and I need step-by-step guidance.\n\n---\n\n<ins datetime=\"2023-03-19T23:50:23Z\">\n  <p><a href=\"https://support.gruntwork.io/hc/requests/110001\">Tracked in ticket #110001</a></p>\n</ins>\n","bodyHTML":"<p dir=\"auto\">Gruntwork code shows examples of using hosted github, bitbucket and gitlab. I have a self-hosted gitlab instance within my organization, and I need step-by-step guidance.</p>\n<hr>\n<ins datetime=\"2023-03-19T23:50:23Z\">\n  <p dir=\"auto\"><a href=\"https://support.gruntwork.io/hc/requests/110001\" rel=\"nofollow\">Tracked in ticket #110001</a></p>\n</ins>","answer":{"body":"# Using self-hosted gitlab\r\n\r\nIn this article, we cover steps necessary to use a self-hosted gitlab instance with Gruntwork's `terraform-aws-ci` repo.\r\n\r\n## Obtain and store Gitlab Personal Access Token\r\nWe will use gitlab PAT to authenticate with gitlab. Instructions for creating PAT are here: https://docs.gitlab.com/ee/user/profile/personal_access_tokens.html\r\n\r\nAWS Secrets Manager is ideal for storing the token, as it offers encryption, granular access policies, ability to rotate secrets, audit trail and versioning.\r\n\r\nCreate a secret and copy the secret's ARN.\r\n\r\n## Add gitlab settings to terraform-helper module\r\nIn [terraform-update-variable](https://github.com/gruntwork-io/terraform-aws-ci/blob/main/modules/terraform-helpers/bin/terraform-update-variable) script, start with the variable declarations section in `run_update` function. Add the secret ARN from step above.\r\n\r\n```\r\nlocal self_hosted_gitlab_token_secrets_manager_arn=\"\"\r\n```\r\n\r\nIn the case block just below declarations, add the parameter\r\n```asciidoc\r\n      --self-hosted-gitlab-token-secrets-manager-arn)\r\n        self_hosted_gitlab_token_secrets_manager_arn=\"$2\"\r\n        shift\r\n        ;;\r\n```\r\n\r\nLittle further down in the module, add gitlab authentication\r\n```asciidoc\r\n    config_https_auth_from_secrets_manager '[mygitlab.example.com](http://mygitlab.example.com/)' 'oauth2' \"$self_hosted_gitlab_token_secrets_manager_arn\"\r\n```\r\n\r\n## Add token to infrastructure-deploy-script\r\n### In the main function, add a new environment variable to hold the PAT\r\nhttps://github.com/gruntwork-io/terraform-aws-ci/blob/ba3b1a284c251faea326b3efb646c5f75a89a57d/modules/infrastructure-deploy-script/scripts/infrastructure-deploy-script#L183\r\n```asciidoc\r\nself_hosted_gitlab_auth_token = os.environ.get(f'{ENVVAR_PREFIX}_SELF_HOSTED_GITLAB_TOKEN', None)\r\n```\r\n\r\n### In the token block, add the token\r\nhttps://github.com/gruntwork-io/terraform-aws-ci/blob/ba3b1a284c251faea326b3efb646c5f75a89a57d/modules/infrastructure-deploy-script/scripts/infrastructure-deploy-script#L193-L200\r\n\r\n```asciidoc\r\n        if self_hosted_gitlab_auth_token is not None:\r\n            git.configure_https_auth('oauth2', self_hosted_gitlab_auth_token, '[mygitlab.example.com](http://mygitlab.example.com/)')\r\n```\r\n\r\n### In the configure_force_https function, add gitlab url\r\n\r\nhttps://github.com/gruntwork-io/terraform-aws-ci/blob/ba3b1a284c251faea326b3efb646c5f75a89a57d/modules/infrastructure-deploy-script/infrastructure_deploy_script/git.py#L63-L81\r\n\r\n```asciidoc\r\nfor host in ['[github.com](http://github.com/)', '[gitlab.com](http://gitlab.com/)', '[bitbucket.org](http://bitbucket.org/)', '[mygitlab.example.com](http://mygitlab.example.com/)]:\r\n```","bodyHTML":"<h1 dir=\"auto\">Using self-hosted gitlab</h1>\n<p dir=\"auto\">In this article, we cover steps necessary to use a self-hosted gitlab instance with Gruntwork's <code class=\"notranslate\">terraform-aws-ci</code> repo.</p>\n<h2 dir=\"auto\">Obtain and store Gitlab Personal Access Token</h2>\n<p dir=\"auto\">We will use gitlab PAT to authenticate with gitlab. Instructions for creating PAT are here: <a href=\"https://docs.gitlab.com/ee/user/profile/personal_access_tokens.html\" rel=\"nofollow\">https://docs.gitlab.com/ee/user/profile/personal_access_tokens.html</a></p>\n<p dir=\"auto\">AWS Secrets Manager is ideal for storing the token, as it offers encryption, granular access policies, ability to rotate secrets, audit trail and versioning.</p>\n<p dir=\"auto\">Create a secret and copy the secret's ARN.</p>\n<h2 dir=\"auto\">Add gitlab settings to terraform-helper module</h2>\n<p dir=\"auto\">In <a href=\"https://github.com/gruntwork-io/terraform-aws-ci/blob/main/modules/terraform-helpers/bin/terraform-update-variable\">terraform-update-variable</a> script, start with the variable declarations section in <code class=\"notranslate\">run_update</code> function. Add the secret ARN from step above.</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"local self_hosted_gitlab_token_secrets_manager_arn=&quot;&quot;\"><pre class=\"notranslate\"><code class=\"notranslate\">local self_hosted_gitlab_token_secrets_manager_arn=\"\"\n</code></pre></div>\n<p dir=\"auto\">In the case block just below declarations, add the parameter</p>\n<div class=\"highlight highlight-text-html-asciidoc notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"      --self-hosted-gitlab-token-secrets-manager-arn)\n        self_hosted_gitlab_token_secrets_manager_arn=&quot;$2&quot;\n        shift\n        ;;\"><pre class=\"notranslate\"><span class=\"pl-c1\">      --self-hosted-gitlab-token-secrets-manager-arn)</span>\n        self_hosted_gitlab_token_secrets_manager_arn=\"$2\"\n        shift\n        ;;</pre></div>\n<p dir=\"auto\">Little further down in the module, add gitlab authentication</p>\n<div class=\"highlight highlight-text-html-asciidoc notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"    config_https_auth_from_secrets_manager '[mygitlab.example.com](http://mygitlab.example.com/)' 'oauth2' &quot;$self_hosted_gitlab_token_secrets_manager_arn&quot;\"><pre class=\"notranslate\"><span class=\"pl-c1\">    config_https_auth_from_secrets_manager '[mygitlab.example.com](http://mygitlab.example.com/)' 'oauth2' \"$self_hosted_gitlab_token_secrets_manager_arn\"</span></pre></div>\n<h2 dir=\"auto\">Add token to infrastructure-deploy-script</h2>\n<h3 dir=\"auto\">In the main function, add a new environment variable to hold the PAT</h3>\n<p dir=\"auto\"><a href=\"https://github.com/gruntwork-io/terraform-aws-ci/blob/ba3b1a284c251faea326b3efb646c5f75a89a57d/modules/infrastructure-deploy-script/scripts/infrastructure-deploy-script#L183\">https://github.com/gruntwork-io/terraform-aws-ci/blob/ba3b1a284c251faea326b3efb646c5f75a89a57d/modules/infrastructure-deploy-script/scripts/infrastructure-deploy-script#L183</a></p>\n<div class=\"highlight highlight-text-html-asciidoc notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"self_hosted_gitlab_auth_token = os.environ.get(f'{ENVVAR_PREFIX}_SELF_HOSTED_GITLAB_TOKEN', None)\"><pre class=\"notranslate\">self_hosted_gitlab_auth_token = os.environ.get(f'<span class=\"pl-smi\">{ENVVAR_PREFIX}</span><span class=\"pl-mi\">_SELF_HOSTED_GITLAB_TOKEN', None)</span></pre></div>\n<h3 dir=\"auto\">In the token block, add the token</h3>\n<p dir=\"auto\"><a href=\"https://github.com/gruntwork-io/terraform-aws-ci/blob/ba3b1a284c251faea326b3efb646c5f75a89a57d/modules/infrastructure-deploy-script/scripts/infrastructure-deploy-script#L193-L200\">https://github.com/gruntwork-io/terraform-aws-ci/blob/ba3b1a284c251faea326b3efb646c5f75a89a57d/modules/infrastructure-deploy-script/scripts/infrastructure-deploy-script#L193-L200</a></p>\n<div class=\"highlight highlight-text-html-asciidoc notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"        if self_hosted_gitlab_auth_token is not None:\n            git.configure_https_auth('oauth2', self_hosted_gitlab_auth_token, '[mygitlab.example.com](http://mygitlab.example.com/)')\"><pre class=\"notranslate\"><span class=\"pl-c1\">        if self_hosted_gitlab_auth_token is not None:</span>\n            git.configure_https_auth('oauth2', self_hosted_gitlab_auth_token, '[mygitlab.example.com](http://mygitlab.example.com/)')</pre></div>\n<h3 dir=\"auto\">In the configure_force_https function, add gitlab url</h3>\n<p dir=\"auto\"><a href=\"https://github.com/gruntwork-io/terraform-aws-ci/blob/ba3b1a284c251faea326b3efb646c5f75a89a57d/modules/infrastructure-deploy-script/infrastructure_deploy_script/git.py#L63-L81\">https://github.com/gruntwork-io/terraform-aws-ci/blob/ba3b1a284c251faea326b3efb646c5f75a89a57d/modules/infrastructure-deploy-script/infrastructure_deploy_script/git.py#L63-L81</a></p>\n<div class=\"highlight highlight-text-html-asciidoc notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"for host in ['[github.com](http://github.com/)', '[gitlab.com](http://gitlab.com/)', '[bitbucket.org](http://bitbucket.org/)', '[mygitlab.example.com](http://mygitlab.example.com/)]:\"><pre class=\"notranslate\">for host in [<span class=\"pl-mi\">'[github.com](http://github.com/)'</span>, <span class=\"pl-mi\">'[gitlab.com](http://gitlab.com/)'</span>, <span class=\"pl-mi\">'[bitbucket.org](http://bitbucket.org/)'</span>, <span class=\"pl-mi\">'[mygitlab.example.com](http://mygitlab.example.com/)]:</span></pre></div>"}}} />

</CenterLayout>

<!-- ##DOCS-SOURCER-START
{
  "sourcePlugin": "github-discussions",
  "hash": "e828d977b5a12b6ab57ca9da73a4de96"
}
##DOCS-SOURCER-END -->

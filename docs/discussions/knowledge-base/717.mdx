---
hide_table_of_contents: true
hide_title: true
custom_edit_url: null
---

import CenterLayout from "/src/components/CenterLayout"
import GitHub from "/src/components/GitHub"

<head>
  <link rel="canonical" href="https://github.com/gruntwork-io/knowledge-base/discussions/717" />
</head>

<CenterLayout>
<span className="searchCategory">Knowledge Base</span>
<h1>CIS Reference Architecture - GuardDuty being recreated with v0.38.0</h1>
<GitHub discussion={{"id":"D_kwDOF8slf84AT4kk","number":717,"author":{"login":"iangrunt"},"title":"CIS Reference Architecture - GuardDuty being recreated with v0.38.0","body":"\nI bumped my CIS Service Catalog version to v0.38.0 and have been presented with many recreations. The release notes have an example, but how does this look with the Reference Architecture? \r\n\r\n```hcl\r\n// ...\r\n  # module.security_baseline.module.guardduty[0].module.guardduty_sa_east_1.aws_guardduty_detector.guardduty[0] will be created\r\n  + resource \"aws_guardduty_detector\" \"guardduty\" {\r\n      + account_id                   = (known after apply)\r\n      + arn                          = (known after apply)\r\n      + enable                       = true\r\n      + finding_publishing_frequency = (known after apply)\r\n      + id                           = (known after apply)\r\n      + tags_all                     = (known after apply)\r\n\r\n      + datasources {\r\n          + s3_logs {\r\n              + enable = (known after apply)\r\n            }\r\n        }\r\n    }\r\n\r\n  # module.security_baseline.module.guardduty[0].module.guardduty_us_east_1.aws_guardduty_detector.guardduty[0] will be created\r\n  + resource \"aws_guardduty_detector\" \"guardduty\" {\r\n      + account_id                   = (known after apply)\r\n      + arn                          = (known after apply)\r\n      + enable                       = true\r\n      + finding_publishing_frequency = (known after apply)\r\n      + id                           = (known after apply)\r\n      + tags_all                     = (known after apply)\r\n\r\n      + datasources {\r\n          + s3_logs {\r\n              + enable = (known after apply)\r\n            }\r\n        }\r\n    }\r\n\r\n  # module.security_baseline.module.guardduty[0].module.guardduty_us_east_2.aws_guardduty_detector.guardduty[0] will be created\r\n  + resource \"aws_guardduty_detector\" \"guardduty\" {\r\n      + account_id                   = (known after apply)\r\n      + arn                          = (known after apply)\r\n      + enable                       = true\r\n      + finding_publishing_frequency = (known after apply)\r\n      + id                           = (known after apply)\r\n      + tags_all                     = (known after apply)\r\n\r\n      + datasources {\r\n          + s3_logs {\r\n              + enable = (known after apply)\r\n            }\r\n        }\r\n    }\r\n\r\n  # module.security_baseline.module.guardduty[0].module.guardduty_us_west_1.aws_guardduty_detector.guardduty[0] will be created\r\n  + resource \"aws_guardduty_detector\" \"guardduty\" {\r\n      + account_id                   = (known after apply)\r\n      + arn                          = (known after apply)\r\n      + enable                       = true\r\n      + finding_publishing_frequency = (known after apply)\r\n      + id                           = (known after apply)\r\n      + tags_all                     = (known after apply)\r\n\r\n      + datasources {\r\n          + s3_logs {\r\n              + enable = (known after apply)\r\n            }\r\n        }\r\n    }\r\n\r\n  # module.security_baseline.module.guardduty[0].module.guardduty_us_west_2.aws_guardduty_detector.guardduty[0] will be created\r\n  + resource \"aws_guardduty_detector\" \"guardduty\" {\r\n      + account_id                   = (known after apply)\r\n      + arn                          = (known after apply)\r\n      + enable                       = true\r\n      + finding_publishing_frequency = (known after apply)\r\n      + id                           = (known after apply)\r\n      + tags_all                     = (known after apply)\r\n\r\n      + datasources {\r\n          + s3_logs {\r\n              + enable = (known after apply)\r\n            }\r\n        }\r\n    }\r\n  // ...\r\n```\n\n---\n\n<ins datetime=\"2023-05-19T12:35:04Z\">\n  <p><a href=\"https://support.gruntwork.io/hc/requests/110188\">Tracked in ticket #110188</a></p>\n</ins>\n","bodyHTML":"<p dir=\"auto\">I bumped my CIS Service Catalog version to v0.38.0 and have been presented with many recreations. The release notes have an example, but how does this look with the Reference Architecture?</p>\n<div class=\"highlight highlight-source-terraform notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"// ...\n  # module.security_baseline.module.guardduty[0].module.guardduty_sa_east_1.aws_guardduty_detector.guardduty[0] will be created\n  + resource &quot;aws_guardduty_detector&quot; &quot;guardduty&quot; {\n      + account_id                   = (known after apply)\n      + arn                          = (known after apply)\n      + enable                       = true\n      + finding_publishing_frequency = (known after apply)\n      + id                           = (known after apply)\n      + tags_all                     = (known after apply)\n\n      + datasources {\n          + s3_logs {\n              + enable = (known after apply)\n            }\n        }\n    }\n\n  # module.security_baseline.module.guardduty[0].module.guardduty_us_east_1.aws_guardduty_detector.guardduty[0] will be created\n  + resource &quot;aws_guardduty_detector&quot; &quot;guardduty&quot; {\n      + account_id                   = (known after apply)\n      + arn                          = (known after apply)\n      + enable                       = true\n      + finding_publishing_frequency = (known after apply)\n      + id                           = (known after apply)\n      + tags_all                     = (known after apply)\n\n      + datasources {\n          + s3_logs {\n              + enable = (known after apply)\n            }\n        }\n    }\n\n  # module.security_baseline.module.guardduty[0].module.guardduty_us_east_2.aws_guardduty_detector.guardduty[0] will be created\n  + resource &quot;aws_guardduty_detector&quot; &quot;guardduty&quot; {\n      + account_id                   = (known after apply)\n      + arn                          = (known after apply)\n      + enable                       = true\n      + finding_publishing_frequency = (known after apply)\n      + id                           = (known after apply)\n      + tags_all                     = (known after apply)\n\n      + datasources {\n          + s3_logs {\n              + enable = (known after apply)\n            }\n        }\n    }\n\n  # module.security_baseline.module.guardduty[0].module.guardduty_us_west_1.aws_guardduty_detector.guardduty[0] will be created\n  + resource &quot;aws_guardduty_detector&quot; &quot;guardduty&quot; {\n      + account_id                   = (known after apply)\n      + arn                          = (known after apply)\n      + enable                       = true\n      + finding_publishing_frequency = (known after apply)\n      + id                           = (known after apply)\n      + tags_all                     = (known after apply)\n\n      + datasources {\n          + s3_logs {\n              + enable = (known after apply)\n            }\n        }\n    }\n\n  # module.security_baseline.module.guardduty[0].module.guardduty_us_west_2.aws_guardduty_detector.guardduty[0] will be created\n  + resource &quot;aws_guardduty_detector&quot; &quot;guardduty&quot; {\n      + account_id                   = (known after apply)\n      + arn                          = (known after apply)\n      + enable                       = true\n      + finding_publishing_frequency = (known after apply)\n      + id                           = (known after apply)\n      + tags_all                     = (known after apply)\n\n      + datasources {\n          + s3_logs {\n              + enable = (known after apply)\n            }\n        }\n    }\n  // ...\"><pre class=\"notranslate\"><span class=\"pl-c\"><span class=\"pl-c\">//</span> ...</span>\n  <span class=\"pl-c\"><span class=\"pl-c\">#</span> module.security_baseline.module.guardduty[0].module.guardduty_sa_east_1.aws_guardduty_detector.guardduty[0] will be created</span>\n  <span class=\"pl-k\">+</span> <span class=\"pl-k\">resource</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>aws_guardduty_detector<span class=\"pl-pds\">\"</span></span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>guardduty<span class=\"pl-pds\">\"</span></span> {\n      <span class=\"pl-k\">+</span> account_id                   <span class=\"pl-k\">=</span> (<span class=\"pl-smi\">known</span> <span class=\"pl-smi\">after</span> <span class=\"pl-smi\">apply</span>)\n      <span class=\"pl-k\">+</span> arn                          <span class=\"pl-k\">=</span> (<span class=\"pl-smi\">known</span> <span class=\"pl-smi\">after</span> <span class=\"pl-smi\">apply</span>)\n      <span class=\"pl-k\">+</span> enable                       <span class=\"pl-k\">=</span> <span class=\"pl-c1\">true</span>\n      <span class=\"pl-k\">+</span> finding_publishing_frequency <span class=\"pl-k\">=</span> (<span class=\"pl-smi\">known</span> <span class=\"pl-smi\">after</span> <span class=\"pl-smi\">apply</span>)\n      <span class=\"pl-k\">+</span> id                           <span class=\"pl-k\">=</span> (<span class=\"pl-smi\">known</span> <span class=\"pl-smi\">after</span> <span class=\"pl-smi\">apply</span>)\n      <span class=\"pl-k\">+</span> tags_all                     <span class=\"pl-k\">=</span> (<span class=\"pl-smi\">known</span> <span class=\"pl-smi\">after</span> <span class=\"pl-smi\">apply</span>)\n\n      <span class=\"pl-k\">+</span> <span class=\"pl-en\">datasources</span> {\n          <span class=\"pl-k\">+</span> <span class=\"pl-en\">s3_logs</span> {\n              <span class=\"pl-k\">+</span> enable <span class=\"pl-k\">=</span> (<span class=\"pl-smi\">known</span> <span class=\"pl-smi\">after</span> <span class=\"pl-smi\">apply</span>)\n            }\n        }\n    }\n\n  <span class=\"pl-c\"><span class=\"pl-c\">#</span> module.security_baseline.module.guardduty[0].module.guardduty_us_east_1.aws_guardduty_detector.guardduty[0] will be created</span>\n  <span class=\"pl-k\">+</span> <span class=\"pl-k\">resource</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>aws_guardduty_detector<span class=\"pl-pds\">\"</span></span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>guardduty<span class=\"pl-pds\">\"</span></span> {\n      <span class=\"pl-k\">+</span> account_id                   <span class=\"pl-k\">=</span> (<span class=\"pl-smi\">known</span> <span class=\"pl-smi\">after</span> <span class=\"pl-smi\">apply</span>)\n      <span class=\"pl-k\">+</span> arn                          <span class=\"pl-k\">=</span> (<span class=\"pl-smi\">known</span> <span class=\"pl-smi\">after</span> <span class=\"pl-smi\">apply</span>)\n      <span class=\"pl-k\">+</span> enable                       <span class=\"pl-k\">=</span> <span class=\"pl-c1\">true</span>\n      <span class=\"pl-k\">+</span> finding_publishing_frequency <span class=\"pl-k\">=</span> (<span class=\"pl-smi\">known</span> <span class=\"pl-smi\">after</span> <span class=\"pl-smi\">apply</span>)\n      <span class=\"pl-k\">+</span> id                           <span class=\"pl-k\">=</span> (<span class=\"pl-smi\">known</span> <span class=\"pl-smi\">after</span> <span class=\"pl-smi\">apply</span>)\n      <span class=\"pl-k\">+</span> tags_all                     <span class=\"pl-k\">=</span> (<span class=\"pl-smi\">known</span> <span class=\"pl-smi\">after</span> <span class=\"pl-smi\">apply</span>)\n\n      <span class=\"pl-k\">+</span> <span class=\"pl-en\">datasources</span> {\n          <span class=\"pl-k\">+</span> <span class=\"pl-en\">s3_logs</span> {\n              <span class=\"pl-k\">+</span> enable <span class=\"pl-k\">=</span> (<span class=\"pl-smi\">known</span> <span class=\"pl-smi\">after</span> <span class=\"pl-smi\">apply</span>)\n            }\n        }\n    }\n\n  <span class=\"pl-c\"><span class=\"pl-c\">#</span> module.security_baseline.module.guardduty[0].module.guardduty_us_east_2.aws_guardduty_detector.guardduty[0] will be created</span>\n  <span class=\"pl-k\">+</span> <span class=\"pl-k\">resource</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>aws_guardduty_detector<span class=\"pl-pds\">\"</span></span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>guardduty<span class=\"pl-pds\">\"</span></span> {\n      <span class=\"pl-k\">+</span> account_id                   <span class=\"pl-k\">=</span> (<span class=\"pl-smi\">known</span> <span class=\"pl-smi\">after</span> <span class=\"pl-smi\">apply</span>)\n      <span class=\"pl-k\">+</span> arn                          <span class=\"pl-k\">=</span> (<span class=\"pl-smi\">known</span> <span class=\"pl-smi\">after</span> <span class=\"pl-smi\">apply</span>)\n      <span class=\"pl-k\">+</span> enable                       <span class=\"pl-k\">=</span> <span class=\"pl-c1\">true</span>\n      <span class=\"pl-k\">+</span> finding_publishing_frequency <span class=\"pl-k\">=</span> (<span class=\"pl-smi\">known</span> <span class=\"pl-smi\">after</span> <span class=\"pl-smi\">apply</span>)\n      <span class=\"pl-k\">+</span> id                           <span class=\"pl-k\">=</span> (<span class=\"pl-smi\">known</span> <span class=\"pl-smi\">after</span> <span class=\"pl-smi\">apply</span>)\n      <span class=\"pl-k\">+</span> tags_all                     <span class=\"pl-k\">=</span> (<span class=\"pl-smi\">known</span> <span class=\"pl-smi\">after</span> <span class=\"pl-smi\">apply</span>)\n\n      <span class=\"pl-k\">+</span> <span class=\"pl-en\">datasources</span> {\n          <span class=\"pl-k\">+</span> <span class=\"pl-en\">s3_logs</span> {\n              <span class=\"pl-k\">+</span> enable <span class=\"pl-k\">=</span> (<span class=\"pl-smi\">known</span> <span class=\"pl-smi\">after</span> <span class=\"pl-smi\">apply</span>)\n            }\n        }\n    }\n\n  <span class=\"pl-c\"><span class=\"pl-c\">#</span> module.security_baseline.module.guardduty[0].module.guardduty_us_west_1.aws_guardduty_detector.guardduty[0] will be created</span>\n  <span class=\"pl-k\">+</span> <span class=\"pl-k\">resource</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>aws_guardduty_detector<span class=\"pl-pds\">\"</span></span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>guardduty<span class=\"pl-pds\">\"</span></span> {\n      <span class=\"pl-k\">+</span> account_id                   <span class=\"pl-k\">=</span> (<span class=\"pl-smi\">known</span> <span class=\"pl-smi\">after</span> <span class=\"pl-smi\">apply</span>)\n      <span class=\"pl-k\">+</span> arn                          <span class=\"pl-k\">=</span> (<span class=\"pl-smi\">known</span> <span class=\"pl-smi\">after</span> <span class=\"pl-smi\">apply</span>)\n      <span class=\"pl-k\">+</span> enable                       <span class=\"pl-k\">=</span> <span class=\"pl-c1\">true</span>\n      <span class=\"pl-k\">+</span> finding_publishing_frequency <span class=\"pl-k\">=</span> (<span class=\"pl-smi\">known</span> <span class=\"pl-smi\">after</span> <span class=\"pl-smi\">apply</span>)\n      <span class=\"pl-k\">+</span> id                           <span class=\"pl-k\">=</span> (<span class=\"pl-smi\">known</span> <span class=\"pl-smi\">after</span> <span class=\"pl-smi\">apply</span>)\n      <span class=\"pl-k\">+</span> tags_all                     <span class=\"pl-k\">=</span> (<span class=\"pl-smi\">known</span> <span class=\"pl-smi\">after</span> <span class=\"pl-smi\">apply</span>)\n\n      <span class=\"pl-k\">+</span> <span class=\"pl-en\">datasources</span> {\n          <span class=\"pl-k\">+</span> <span class=\"pl-en\">s3_logs</span> {\n              <span class=\"pl-k\">+</span> enable <span class=\"pl-k\">=</span> (<span class=\"pl-smi\">known</span> <span class=\"pl-smi\">after</span> <span class=\"pl-smi\">apply</span>)\n            }\n        }\n    }\n\n  <span class=\"pl-c\"><span class=\"pl-c\">#</span> module.security_baseline.module.guardduty[0].module.guardduty_us_west_2.aws_guardduty_detector.guardduty[0] will be created</span>\n  <span class=\"pl-k\">+</span> <span class=\"pl-k\">resource</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>aws_guardduty_detector<span class=\"pl-pds\">\"</span></span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>guardduty<span class=\"pl-pds\">\"</span></span> {\n      <span class=\"pl-k\">+</span> account_id                   <span class=\"pl-k\">=</span> (<span class=\"pl-smi\">known</span> <span class=\"pl-smi\">after</span> <span class=\"pl-smi\">apply</span>)\n      <span class=\"pl-k\">+</span> arn                          <span class=\"pl-k\">=</span> (<span class=\"pl-smi\">known</span> <span class=\"pl-smi\">after</span> <span class=\"pl-smi\">apply</span>)\n      <span class=\"pl-k\">+</span> enable                       <span class=\"pl-k\">=</span> <span class=\"pl-c1\">true</span>\n      <span class=\"pl-k\">+</span> finding_publishing_frequency <span class=\"pl-k\">=</span> (<span class=\"pl-smi\">known</span> <span class=\"pl-smi\">after</span> <span class=\"pl-smi\">apply</span>)\n      <span class=\"pl-k\">+</span> id                           <span class=\"pl-k\">=</span> (<span class=\"pl-smi\">known</span> <span class=\"pl-smi\">after</span> <span class=\"pl-smi\">apply</span>)\n      <span class=\"pl-k\">+</span> tags_all                     <span class=\"pl-k\">=</span> (<span class=\"pl-smi\">known</span> <span class=\"pl-smi\">after</span> <span class=\"pl-smi\">apply</span>)\n\n      <span class=\"pl-k\">+</span> <span class=\"pl-en\">datasources</span> {\n          <span class=\"pl-k\">+</span> <span class=\"pl-en\">s3_logs</span> {\n              <span class=\"pl-k\">+</span> enable <span class=\"pl-k\">=</span> (<span class=\"pl-smi\">known</span> <span class=\"pl-smi\">after</span> <span class=\"pl-smi\">apply</span>)\n            }\n        }\n    }\n  <span class=\"pl-c\"><span class=\"pl-c\">//</span> ...</span></pre></div>\n<hr>\n<ins datetime=\"2023-05-19T12:35:04Z\">\n  <p dir=\"auto\"><a href=\"https://support.gruntwork.io/hc/requests/110188\" rel=\"nofollow\">Tracked in ticket #110188</a></p>\n</ins>","answer":{"body":"### Background\r\nIf we check the release notes, https://github.com/gruntwork-io/terraform-aws-cis-service-catalog/releases/tag/v0.38.0, we see we need to do some `terraform state mv` work:\r\n\r\n>The Guardduty module call has been adjusted to be a count based module. This requires state migrations to avoid a recreation of the Guardduty resources.\r\n...\r\n**account-baseline-security**\r\n>```hcl\r\n>terragrunt state mv module.security_baseline.module.guardduty 'module.security_baseline.module.guardduty[0]'\r\n>```\r\n\r\n## How to apply this to the Reference Architecture \r\n### Generate a list of current resources represented in the remote state\r\nI took a list of all the resources to find out what the GuardDuty addresses looked like in the `terraform state` file:\r\n\r\n```sh\r\ninfrastructure-live-ian/security/_global/account-baseline $ aws-vault exec gruntwork-sales-security-02-admin -- terragrunt state list > 1.tmp\r\n```\r\n\r\nI see all my GuardDuty resources look something like this:\r\n```hcl\r\n// ...\r\nmodule.security_baseline.module.guardduty.module.guardduty_eu_west_2.aws_guardduty_detector.guardduty[0]\r\nmodule.security_baseline.module.guardduty.module.guardduty_eu_west_3.aws_guardduty_detector.guardduty[0]\r\nmodule.security_baseline.module.guardduty.module.guardduty_sa_east_1.aws_guardduty_detector.guardduty[0]\r\nmodule.security_baseline.module.guardduty.module.guardduty_us_east_1.aws_guardduty_detector.guardduty[0]\r\nmodule.security_baseline.module.guardduty.module.guardduty_us_east_2.aws_guardduty_detector.guardduty[0]\r\nmodule.security_baseline.module.guardduty.module.guardduty_us_west_1.aws_guardduty_detector.guardduty[0]\r\nmodule.security_baseline.module.guardduty.module.guardduty_us_west_2.aws_guardduty_detector.guardduty[0]\r\n// ...\r\n```\r\n\r\n### Note what needs to change\r\nThe release notes imply this:\r\n```hcl\r\nmodule.security_baseline.module.guardduty.module.guardduty_eu_west_2.aws_guardduty_detector.guardduty[0]\r\n```\r\n\r\nShould look like this (a `[0]` after the first mention of `guardduty`):\r\n```\r\nmodule.security_baseline.module.guardduty[0].module.guardduty_eu_west_2.aws_guardduty_detector.guardduty[0]\r\n````\r\n\r\n### Note the total number of resources to be recreated \r\nIn my case, it was `29` when I first ran my `terragrunt plan` after changing my CIS Service Catalog version to `v0.38.0`. \r\n\r\n### Resolving the issue\r\nThis is easy to write a small script for, but I picked the first region in the list I generated and did the `terragrunt state mv` manually to confirm it behaves as expected, and checked to see that my `terragrunt plan` once I've finished the `mv` shows only `28 to add`. The reason I want it to be `28` and not `29` is because that verifies I have successfully fixed the issue with GuardDuty detectors being needlessly recreated in every region I have listed in my `opt_in_regions` list, located here: https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/master/examples/for-production/infrastructure-live/multi_region_common.hcl#L43. \r\n\r\nHere is the actual command I ran to do the `state mv` manually (note the quotes and needing to authenticate to AWS still):\r\n\r\n```\r\n(base) ~/tmp/infrastructure-live-ian/security/_global/account-baseline 127 $ aws-vault exec gruntwork-sales-security-02-admin -- terragrunt state mv 'module.security_baseline.module.guardduty.module.guardduty_ap_northeast_1.aws_guardduty_detector.guardduty[0]' 'module.security_baseline.module.guardduty[0].module.guardduty_ap_northeast_1.aws_guardduty_detector.guardduty[0]'\r\n```\r\n\r\nOnce that is done, run a `terragrunt plan` and confirm the number of new resources to be created has decreased by one, and then double check the plan to ensure that the region you selected, `guardduty_ap_northeast_1`, in my case, does not show up. \r\n\r\n### Additional \r\nIf you're particularly paranoid, you could do a `terraform state pull` (which still requires authenticating to AWS) and point to a local copy first to test `plan` against, but that is probably overkill and would require more potentially dodgy hand-work. \r\n\r\n","bodyHTML":"<h3 dir=\"auto\">Background</h3>\n<p dir=\"auto\">If we check the release notes, <a href=\"https://github.com/gruntwork-io/terraform-aws-cis-service-catalog/releases/tag/v0.38.0\">https://github.com/gruntwork-io/terraform-aws-cis-service-catalog/releases/tag/v0.38.0</a>, we see we need to do some <code class=\"notranslate\">terraform state mv</code> work:</p>\n<blockquote>\n<p dir=\"auto\">The Guardduty module call has been adjusted to be a count based module. This requires state migrations to avoid a recreation of the Guardduty resources.<br>\n...<br>\n<strong>account-baseline-security</strong></p>\n<div class=\"highlight highlight-source-terraform notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"terragrunt state mv module.security_baseline.module.guardduty 'module.security_baseline.module.guardduty[0]'\"><pre class=\"notranslate\">terragrunt state mv <span class=\"pl-c1\">module</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">security_baseline</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">module</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">guardduty</span> '<span class=\"pl-c1\">module</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">security_baseline</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">module</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">guardduty</span>[<span class=\"pl-c1\">0</span>]'</pre></div>\n</blockquote>\n<h2 dir=\"auto\">How to apply this to the Reference Architecture</h2>\n<h3 dir=\"auto\">Generate a list of current resources represented in the remote state</h3>\n<p dir=\"auto\">I took a list of all the resources to find out what the GuardDuty addresses looked like in the <code class=\"notranslate\">terraform state</code> file:</p>\n<div class=\"highlight highlight-source-shell notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"infrastructure-live-ian/security/_global/account-baseline $ aws-vault exec gruntwork-sales-security-02-admin -- terragrunt state list &gt; 1.tmp\"><pre class=\"notranslate\">infrastructure-live-ian/security/_global/account-baseline $ aws-vault <span class=\"pl-c1\">exec</span> gruntwork-sales-security-02-admin -- terragrunt state list <span class=\"pl-k\">&gt;</span> 1.tmp</pre></div>\n<p dir=\"auto\">I see all my GuardDuty resources look something like this:</p>\n<div class=\"highlight highlight-source-terraform notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"// ...\nmodule.security_baseline.module.guardduty.module.guardduty_eu_west_2.aws_guardduty_detector.guardduty[0]\nmodule.security_baseline.module.guardduty.module.guardduty_eu_west_3.aws_guardduty_detector.guardduty[0]\nmodule.security_baseline.module.guardduty.module.guardduty_sa_east_1.aws_guardduty_detector.guardduty[0]\nmodule.security_baseline.module.guardduty.module.guardduty_us_east_1.aws_guardduty_detector.guardduty[0]\nmodule.security_baseline.module.guardduty.module.guardduty_us_east_2.aws_guardduty_detector.guardduty[0]\nmodule.security_baseline.module.guardduty.module.guardduty_us_west_1.aws_guardduty_detector.guardduty[0]\nmodule.security_baseline.module.guardduty.module.guardduty_us_west_2.aws_guardduty_detector.guardduty[0]\n// ...\"><pre class=\"notranslate\"><span class=\"pl-c\"><span class=\"pl-c\">//</span> ...</span>\n<span class=\"pl-c1\">module</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">security_baseline</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">module</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">guardduty</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">module</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">guardduty_eu_west_2</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">aws_guardduty_detector</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">guardduty</span>[<span class=\"pl-c1\">0</span>]\n<span class=\"pl-c1\">module</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">security_baseline</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">module</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">guardduty</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">module</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">guardduty_eu_west_3</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">aws_guardduty_detector</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">guardduty</span>[<span class=\"pl-c1\">0</span>]\n<span class=\"pl-c1\">module</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">security_baseline</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">module</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">guardduty</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">module</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">guardduty_sa_east_1</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">aws_guardduty_detector</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">guardduty</span>[<span class=\"pl-c1\">0</span>]\n<span class=\"pl-c1\">module</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">security_baseline</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">module</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">guardduty</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">module</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">guardduty_us_east_1</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">aws_guardduty_detector</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">guardduty</span>[<span class=\"pl-c1\">0</span>]\n<span class=\"pl-c1\">module</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">security_baseline</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">module</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">guardduty</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">module</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">guardduty_us_east_2</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">aws_guardduty_detector</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">guardduty</span>[<span class=\"pl-c1\">0</span>]\n<span class=\"pl-c1\">module</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">security_baseline</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">module</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">guardduty</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">module</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">guardduty_us_west_1</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">aws_guardduty_detector</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">guardduty</span>[<span class=\"pl-c1\">0</span>]\n<span class=\"pl-c1\">module</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">security_baseline</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">module</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">guardduty</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">module</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">guardduty_us_west_2</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">aws_guardduty_detector</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">guardduty</span>[<span class=\"pl-c1\">0</span>]\n<span class=\"pl-c\"><span class=\"pl-c\">//</span> ...</span></pre></div>\n<h3 dir=\"auto\">Note what needs to change</h3>\n<p dir=\"auto\">The release notes imply this:</p>\n<div class=\"highlight highlight-source-terraform notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"module.security_baseline.module.guardduty.module.guardduty_eu_west_2.aws_guardduty_detector.guardduty[0]\"><pre class=\"notranslate\"><span class=\"pl-c1\">module</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">security_baseline</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">module</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">guardduty</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">module</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">guardduty_eu_west_2</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">aws_guardduty_detector</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">guardduty</span>[<span class=\"pl-c1\">0</span>]</pre></div>\n<p dir=\"auto\">Should look like this (a <code class=\"notranslate\">[0]</code> after the first mention of <code class=\"notranslate\">guardduty</code>):</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"module.security_baseline.module.guardduty[0].module.guardduty_eu_west_2.aws_guardduty_detector.guardduty[0]\"><pre class=\"notranslate\"><code class=\"notranslate\">module.security_baseline.module.guardduty[0].module.guardduty_eu_west_2.aws_guardduty_detector.guardduty[0]\n</code></pre></div>\n<h3 dir=\"auto\">Note the total number of resources to be recreated</h3>\n<p dir=\"auto\">In my case, it was <code class=\"notranslate\">29</code> when I first ran my <code class=\"notranslate\">terragrunt plan</code> after changing my CIS Service Catalog version to <code class=\"notranslate\">v0.38.0</code>.</p>\n<h3 dir=\"auto\">Resolving the issue</h3>\n<p dir=\"auto\">This is easy to write a small script for, but I picked the first region in the list I generated and did the <code class=\"notranslate\">terragrunt state mv</code> manually to confirm it behaves as expected, and checked to see that my <code class=\"notranslate\">terragrunt plan</code> once I've finished the <code class=\"notranslate\">mv</code> shows only <code class=\"notranslate\">28 to add</code>. The reason I want it to be <code class=\"notranslate\">28</code> and not <code class=\"notranslate\">29</code> is because that verifies I have successfully fixed the issue with GuardDuty detectors being needlessly recreated in every region I have listed in my <code class=\"notranslate\">opt_in_regions</code> list, located here: <a href=\"https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/master/examples/for-production/infrastructure-live/multi_region_common.hcl#L43\">https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/master/examples/for-production/infrastructure-live/multi_region_common.hcl#L43</a>.</p>\n<p dir=\"auto\">Here is the actual command I ran to do the <code class=\"notranslate\">state mv</code> manually (note the quotes and needing to authenticate to AWS still):</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"(base) ~/tmp/infrastructure-live-ian/security/_global/account-baseline 127 $ aws-vault exec gruntwork-sales-security-02-admin -- terragrunt state mv 'module.security_baseline.module.guardduty.module.guardduty_ap_northeast_1.aws_guardduty_detector.guardduty[0]' 'module.security_baseline.module.guardduty[0].module.guardduty_ap_northeast_1.aws_guardduty_detector.guardduty[0]'\"><pre class=\"notranslate\"><code class=\"notranslate\">(base) ~/tmp/infrastructure-live-ian/security/_global/account-baseline 127 $ aws-vault exec gruntwork-sales-security-02-admin -- terragrunt state mv 'module.security_baseline.module.guardduty.module.guardduty_ap_northeast_1.aws_guardduty_detector.guardduty[0]' 'module.security_baseline.module.guardduty[0].module.guardduty_ap_northeast_1.aws_guardduty_detector.guardduty[0]'\n</code></pre></div>\n<p dir=\"auto\">Once that is done, run a <code class=\"notranslate\">terragrunt plan</code> and confirm the number of new resources to be created has decreased by one, and then double check the plan to ensure that the region you selected, <code class=\"notranslate\">guardduty_ap_northeast_1</code>, in my case, does not show up.</p>\n<h3 dir=\"auto\">Additional</h3>\n<p dir=\"auto\">If you're particularly paranoid, you could do a <code class=\"notranslate\">terraform state pull</code> (which still requires authenticating to AWS) and point to a local copy first to test <code class=\"notranslate\">plan</code> against, but that is probably overkill and would require more potentially dodgy hand-work.</p>"}}} />

</CenterLayout>
  

<!-- ##DOCS-SOURCER-START
{
  "sourcePlugin": "github-discussions",
  "hash": "651398ddb66671bede6edfe0d7937c63"
}
##DOCS-SOURCER-END -->

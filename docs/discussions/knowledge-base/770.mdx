---
hide_table_of_contents: true
hide_title: true
custom_edit_url: null
---

import CenterLayout from "/src/components/CenterLayout"
import GitHub from "/src/components/GitHub"

<head>
  <link rel="canonical" href="https://github.com/gruntwork-io/knowledge-base/discussions/770" />
</head>

<CenterLayout>
<span className="searchCategory">Knowledge Base</span>
<h1>OpenVPN enable MFA</h1>
<GitHub discussion={{"id":"D_kwDOF8slf84AVfru","number":770,"author":{"login":"lev-ok"},"title":"OpenVPN enable MFA","body":"\r\nA customer asked:\r\n\r\n> I created the duo account and the ami with `--duo-version`.\r\n> But I do not understand where put the variables:\r\n> ```\r\n> duoIkey\r\n> duoSkey\r\n> duoHost \r\n> ```\r\n\r\nr:terraform-aws-openvpn\r\n---\r\n\r\n<ins datetime=\"2023-09-15T22:26:05Z\">\r\n  <p><a href=\"https://support.gruntwork.io/hc/requests/110453\">Tracked in ticket #110453</a></p>\r\n</ins>\r\n","bodyHTML":"<p dir=\"auto\">A customer asked:</p>\n<blockquote>\n<p dir=\"auto\">I created the duo account and the ami with <code class=\"notranslate\">--duo-version</code>.<br>\nBut I do not understand where put the variables:</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"duoIkey\nduoSkey\nduoHost \"><pre class=\"notranslate\"><code class=\"notranslate\">duoIkey\nduoSkey\nduoHost \n</code></pre></div>\n</blockquote>\n<h2 dir=\"auto\">r:terraform-aws-openvpn</h2>\n<ins datetime=\"2023-09-15T22:26:05Z\">\n  <p dir=\"auto\"><a href=\"https://support.gruntwork.io/hc/requests/110453\" rel=\"nofollow\">Tracked in ticket #110453</a></p>\n</ins>","answer":{"body":"These parameters are used by [`install-openvpn`](https://github.com/gruntwork-io/terraform-aws-openvpn/tree/main/modules/install-openvpn) module to install the OpenVPN package and related template files onto a server.\r\n\r\n```shell\r\nsudo init-openvpn  \\\r\n...\r\n --duo-ikey \"${duo_ikey}\" \\\r\n --duo-skey \"${duo_skey}\" \\\r\n --duo-host \"${duo_host}\" \\\r\n...\r\n```\r\n\r\nThe [terraform-aws-openvpn](https://github.com/gruntwork-io/terraform-aws-openvpn) contains out-of-the-box [example](https://github.com/gruntwork-io/terraform-aws-openvpn/blob/92e519be6ee9f6f984efadf9f5fc8067ceb706c2/examples/openvpn-host-duo/user-data/user-data.sh#L38-L55).\r\n\r\n---\r\n\r\n### The fastest way to deploy a test instance with duo MFA\r\n\r\n1. Download `openvpn-admin` binary for AMI\r\n```shell\r\nGITHUB_OAUTH_TOKEN=<token> fetch \\\r\n\t--repo=\"https://github.com/gruntwork-io/terraform-aws-openvpn\" \r\n\t--tag=\"v0.26.6\" \r\n\t--release-asset=\"openvpn-admin_linux_amd64\"\r\n\t/tmp\r\n```\r\n\r\n2. Build an AMI (Amazon Machine Image)\r\n```shell\r\npacker build \\\r\n\t-var aws_region=us-east-1 \\\r\n\t-var openvpn_admin_binary=/tmp/openvpn-admin_linux_amd64 \\\r\n\t-var active_git_branch=main \\\r\n\t-var github_oauth_token=${GITHUB_OAUTH_TOKEN} \\\r\n\t-only=ubuntu-20-build \\\r\n\t./examples/packer/build.json\r\n```\r\n\r\n3. Create a DUO account (if it doesn't already exist), from there we need three values: _Integration key_, _Secret key_, _API hostname_.  Create OpenVPN application, make sure that `Duo Mobile passcodes` is checked in the application policy.\r\n\r\n5. Using [terragrunt](https://github.com/gruntwork-io/terragrunt), deploy AWS infrastructure. Create `terragrunt.hcl` config and fill `inputs` with your values. After that, run `terragrunt apply`\r\n\r\n```shell\r\nterraform {\r\n  source = \"git@github.com:gruntwork-io/terraform-aws-openvpn.git//examples/openvpn-host-duo\"\r\n}\r\n\r\ninputs = {\r\n  aws_account_id = \"\"\r\n  ami_id = \"\"\r\n  aws_region = \"us-east-1\"\r\n  backup_bucket_name = \"openvpn-backups\"\r\n  keypair_name = \"\"\r\n\r\n  duo_ikey = \"\"  # Integration key\r\n  duo_skey = \"\" # Secret key\r\n  duo_host = \"\" # API hostname.\r\n}\r\n```\r\n\r\n6. Install `openvpn-admin` on your computer.\r\n```shell\r\nGITHUB_OAUTH_TOKEN=<token> gruntwork-install \\\r\n\t--binary-name openvpn-admin \\\r\n\t--repo https://github.com/gruntwork-io/terraform-aws-openvpn \\\r\n\t--tag v0.26.6\r\n```\r\n\r\n7. Create OpenVPN accounts:\r\n`openvpn-admin request --aws-region us-east-1 --username foo`\r\n\r\n8. To authenticate, pass _passcode_ from DUO Mobile in the password prompt. Note that in order for 2FA to work, the certificate username (the value for --username when running openvpn-admin request) should exactly match the duo username.\r\n\r\n","bodyHTML":"<p dir=\"auto\">These parameters are used by <a href=\"https://github.com/gruntwork-io/terraform-aws-openvpn/tree/main/modules/install-openvpn\"><code class=\"notranslate\">install-openvpn</code></a> module to install the OpenVPN package and related template files onto a server.</p>\n<div class=\"highlight highlight-source-shell notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"sudo init-openvpn  \\\n...\n --duo-ikey &quot;${duo_ikey}&quot; \\\n --duo-skey &quot;${duo_skey}&quot; \\\n --duo-host &quot;${duo_host}&quot; \\\n...\"><pre class=\"notranslate\">sudo init-openvpn  \\\n...\n --duo-ikey <span class=\"pl-s\"><span class=\"pl-pds\">\"</span><span class=\"pl-smi\">${duo_ikey}</span><span class=\"pl-pds\">\"</span></span> \\\n --duo-skey <span class=\"pl-s\"><span class=\"pl-pds\">\"</span><span class=\"pl-smi\">${duo_skey}</span><span class=\"pl-pds\">\"</span></span> \\\n --duo-host <span class=\"pl-s\"><span class=\"pl-pds\">\"</span><span class=\"pl-smi\">${duo_host}</span><span class=\"pl-pds\">\"</span></span> \\\n...</pre></div>\n<p dir=\"auto\">The <a href=\"https://github.com/gruntwork-io/terraform-aws-openvpn\">terraform-aws-openvpn</a> contains out-of-the-box <a href=\"https://github.com/gruntwork-io/terraform-aws-openvpn/blob/92e519be6ee9f6f984efadf9f5fc8067ceb706c2/examples/openvpn-host-duo/user-data/user-data.sh#L38-L55\">example</a>.</p>\n<hr>\n<h3 dir=\"auto\">The fastest way to deploy a test instance with duo MFA</h3>\n<ol dir=\"auto\">\n<li>Download <code class=\"notranslate\">openvpn-admin</code> binary for AMI</li>\n</ol>\n<div class=\"highlight highlight-source-shell notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"GITHUB_OAUTH_TOKEN=&lt;token&gt; fetch \\\n\t--repo=&quot;https://github.com/gruntwork-io/terraform-aws-openvpn&quot; \n\t--tag=&quot;v0.26.6&quot; \n\t--release-asset=&quot;openvpn-admin_linux_amd64&quot;\n\t/tmp\"><pre class=\"notranslate\">GITHUB_OAUTH_TOKEN=<span class=\"pl-k\">&lt;</span>token<span class=\"pl-k\">&gt;</span> fetch \\\n\t--repo=<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>https://github.com/gruntwork-io/terraform-aws-openvpn<span class=\"pl-pds\">\"</span></span> \n\t--tag=<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>v0.26.6<span class=\"pl-pds\">\"</span></span> \n\t--release-asset=<span class=\"pl-s\"><span class=\"pl-pds\">\"</span>openvpn-admin_linux_amd64<span class=\"pl-pds\">\"</span></span>\n\t/tmp</pre></div>\n<ol start=\"2\" dir=\"auto\">\n<li>Build an AMI (Amazon Machine Image)</li>\n</ol>\n<div class=\"highlight highlight-source-shell notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"packer build \\\n\t-var aws_region=us-east-1 \\\n\t-var openvpn_admin_binary=/tmp/openvpn-admin_linux_amd64 \\\n\t-var active_git_branch=main \\\n\t-var github_oauth_token=${GITHUB_OAUTH_TOKEN} \\\n\t-only=ubuntu-20-build \\\n\t./examples/packer/build.json\"><pre class=\"notranslate\">packer build \\\n\t-var aws_region=us-east-1 \\\n\t-var openvpn_admin_binary=/tmp/openvpn-admin_linux_amd64 \\\n\t-var active_git_branch=main \\\n\t-var github_oauth_token=<span class=\"pl-smi\">${GITHUB_OAUTH_TOKEN}</span> \\\n\t-only=ubuntu-20-build \\\n\t./examples/packer/build.json</pre></div>\n<ol start=\"3\" dir=\"auto\">\n<li>\n<p dir=\"auto\">Create a DUO account (if it doesn't already exist), from there we need three values: <em>Integration key</em>, <em>Secret key</em>, <em>API hostname</em>.  Create OpenVPN application, make sure that <code class=\"notranslate\">Duo Mobile passcodes</code> is checked in the application policy.</p>\n</li>\n<li>\n<p dir=\"auto\">Using <a href=\"https://github.com/gruntwork-io/terragrunt\">terragrunt</a>, deploy AWS infrastructure. Create <code class=\"notranslate\">terragrunt.hcl</code> config and fill <code class=\"notranslate\">inputs</code> with your values. After that, run <code class=\"notranslate\">terragrunt apply</code></p>\n</li>\n</ol>\n<div class=\"highlight highlight-source-shell notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"terraform {\n  source = &quot;git@github.com:gruntwork-io/terraform-aws-openvpn.git//examples/openvpn-host-duo&quot;\n}\n\ninputs = {\n  aws_account_id = &quot;&quot;\n  ami_id = &quot;&quot;\n  aws_region = &quot;us-east-1&quot;\n  backup_bucket_name = &quot;openvpn-backups&quot;\n  keypair_name = &quot;&quot;\n\n  duo_ikey = &quot;&quot;  # Integration key\n  duo_skey = &quot;&quot; # Secret key\n  duo_host = &quot;&quot; # API hostname.\n}\"><pre class=\"notranslate\">terraform {\n  <span class=\"pl-c1\">source</span> = <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>git@github.com:gruntwork-io/terraform-aws-openvpn.git//examples/openvpn-host-duo<span class=\"pl-pds\">\"</span></span>\n}\n\ninputs = {\n  aws_account_id = <span class=\"pl-s\"><span class=\"pl-pds\">\"</span><span class=\"pl-pds\">\"</span></span>\n  ami_id = <span class=\"pl-s\"><span class=\"pl-pds\">\"</span><span class=\"pl-pds\">\"</span></span>\n  aws_region = <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>us-east-1<span class=\"pl-pds\">\"</span></span>\n  backup_bucket_name = <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>openvpn-backups<span class=\"pl-pds\">\"</span></span>\n  keypair_name = <span class=\"pl-s\"><span class=\"pl-pds\">\"</span><span class=\"pl-pds\">\"</span></span>\n\n  duo_ikey = <span class=\"pl-s\"><span class=\"pl-pds\">\"</span><span class=\"pl-pds\">\"</span></span>  <span class=\"pl-c\"><span class=\"pl-c\">#</span> Integration key</span>\n  duo_skey = <span class=\"pl-s\"><span class=\"pl-pds\">\"</span><span class=\"pl-pds\">\"</span></span> <span class=\"pl-c\"><span class=\"pl-c\">#</span> Secret key</span>\n  duo_host = <span class=\"pl-s\"><span class=\"pl-pds\">\"</span><span class=\"pl-pds\">\"</span></span> <span class=\"pl-c\"><span class=\"pl-c\">#</span> API hostname.</span>\n}</pre></div>\n<ol start=\"6\" dir=\"auto\">\n<li>Install <code class=\"notranslate\">openvpn-admin</code> on your computer.</li>\n</ol>\n<div class=\"highlight highlight-source-shell notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"GITHUB_OAUTH_TOKEN=&lt;token&gt; gruntwork-install \\\n\t--binary-name openvpn-admin \\\n\t--repo https://github.com/gruntwork-io/terraform-aws-openvpn \\\n\t--tag v0.26.6\"><pre class=\"notranslate\">GITHUB_OAUTH_TOKEN=<span class=\"pl-k\">&lt;</span>token<span class=\"pl-k\">&gt;</span> gruntwork-install \\\n\t--binary-name openvpn-admin \\\n\t--repo https://github.com/gruntwork-io/terraform-aws-openvpn \\\n\t--tag v0.26.6</pre></div>\n<ol start=\"7\" dir=\"auto\">\n<li>\n<p dir=\"auto\">Create OpenVPN accounts:<br>\n<code class=\"notranslate\">openvpn-admin request --aws-region us-east-1 --username foo</code></p>\n</li>\n<li>\n<p dir=\"auto\">To authenticate, pass <em>passcode</em> from DUO Mobile in the password prompt. Note that in order for 2FA to work, the certificate username (the value for --username when running openvpn-admin request) should exactly match the duo username.</p>\n</li>\n</ol>"}}} />

</CenterLayout>

<!-- ##DOCS-SOURCER-START
{
  "sourcePlugin": "github-discussions",
  "hash": "e2a45987785621357b8b03474c4fb212"
}
##DOCS-SOURCER-END -->

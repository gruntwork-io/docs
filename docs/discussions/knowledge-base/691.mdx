---
hide_table_of_contents: true
hide_title: true
custom_edit_url: null
---

import CenterLayout from "/src/components/CenterLayout"
import GitHub from "/src/components/GitHub"

<head>
  <link rel="canonical" href="https://github.com/gruntwork-io/knowledge-base/discussions/691" />
</head>

<CenterLayout>
<span className="searchCategory">Knowledge Base</span>
<h1>Getting LimitExceeded error when adding new accounts to infrastructure-live repository</h1>
<GitHub discussion={{"id":"D_kwDOF8slf84ATKoC","number":691,"author":{"login":"gabrielanavarrorsid"},"title":"Getting LimitExceeded error when adding new accounts to infrastructure-live repository","body":"\nI’m looking for help to figure out what is the best approach to fix the following issue:\r\n\r\n```\r\n│ Error: putting IAM group policy _all-accounts: LimitExceeded: Maximum policy size of 5120 bytes exceeded for group _all-accounts\r\n```\r\nWe hit this issue after adding multiple accounts to our repository and applying the module `landingzone/account-baseline-security` module from `terraform-aws-service-catalog`\r\n\r\nSo my questions are:\r\n\r\n1. Is there a limit of accounts that we can add to a given repository that we should be aware of?\r\n1. Would it mean that we need to break the _all-accounts IAM group in two? do we have a list of the necessary `aws_iam_group_policy` that we need to have in order to have a repo that was based off the `examples/for-production/infrastructure-live` folder? I know the `arn:aws:iam::${id}:role/allow-auto-deploy-from-other-accounts` are used by the ECS deploy runners, but does any of the others from this [list](https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/master/examples/for-production/infrastructure-live/security/_global/account-baseline/cross_account_groups.yml) is needed?\n\n---\n\n<ins datetime=\"2023-03-30T19:22:40Z\">\n  <p><a href=\"https://support.gruntwork.io/hc/requests/110040\">Tracked in ticket #110040</a></p>\n</ins>\n","bodyHTML":"<p dir=\"auto\">I’m looking for help to figure out what is the best approach to fix the following issue:</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"│ Error: putting IAM group policy _all-accounts: LimitExceeded: Maximum policy size of 5120 bytes exceeded for group _all-accounts\"><pre class=\"notranslate\"><code class=\"notranslate\">│ Error: putting IAM group policy _all-accounts: LimitExceeded: Maximum policy size of 5120 bytes exceeded for group _all-accounts\n</code></pre></div>\n<p dir=\"auto\">We hit this issue after adding multiple accounts to our repository and applying the module <code class=\"notranslate\">landingzone/account-baseline-security</code> module from <code class=\"notranslate\">terraform-aws-service-catalog</code></p>\n<p dir=\"auto\">So my questions are:</p>\n<ol dir=\"auto\">\n<li>Is there a limit of accounts that we can add to a given repository that we should be aware of?</li>\n<li>Would it mean that we need to break the _all-accounts IAM group in two? do we have a list of the necessary <code class=\"notranslate\">aws_iam_group_policy</code> that we need to have in order to have a repo that was based off the <code class=\"notranslate\">examples/for-production/infrastructure-live</code> folder? I know the <code class=\"notranslate\">arn:aws:iam::${id}:role/allow-auto-deploy-from-other-accounts</code> are used by the ECS deploy runners, but does any of the others from this <a href=\"https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/master/examples/for-production/infrastructure-live/security/_global/account-baseline/cross_account_groups.yml\">list</a> is needed?</li>\n</ol>\n<hr>\n<ins datetime=\"2023-03-30T19:22:40Z\">\n  <p dir=\"auto\"><a href=\"https://support.gruntwork.io/hc/requests/110040\" rel=\"nofollow\">Tracked in ticket #110040</a></p>\n</ins>","answer":{"body":"After some time debugging this I think I possibly found a way to solve the issues of having too many accounts in the same `infrastructure-live`\r\n\r\nThe solution is based on the following assumption. if this is not true, please let me know.\r\n- I'm assuming the `aws_iam_group` `_all-accounts` is informational only. I couldn't find anywhere in `ECS Deploy Runner` if that's used and couldn't find anything. \r\n\r\nSo to fix it, this is what was changed.\r\n\r\n- Because we don't need `_all-accounts` AWS IAM group, in our setup I defined the following variable: `should_create_iam_group_cross_account_access_all = false` in our `security/_global/account-baseline/terragrunt.hcl`\r\n- With the previous variable defined, the LimitExceeded error should be fixed, the next problem I believe it will happen is that I'll need to define all the different auto-deploy groups to the `ci-machine-user` under `security/_global/account-baseline/users.yml` and I'll hit the limit of how many groups it can be attached. Because of that I'm creating a group called `_accounts.all-auto-deploy` and defining the iam_role_arns to be for all of the accounts using the `security/_global/account-baseline/cross_account_groups.yml` file (not sure if we will still have the issue of LimitExceeded, but if so I can break into different groups still. the `security/_global/account-baseline/cross_account_groups.yml`  looks like this:  \r\n```\r\ncross_account_groups:\r\n# NOTE: we have to comment out the directives so that the python based data\r\n# merger (see the `merge-data` hook under blueprints in this repository) can\r\n# parse this yaml file (we expect to apply the data merger to this module in\r\n# the future). This still works when feeding through templatefile, as it will\r\n# interleave blank comments with the list items, which yaml handles gracefully.\r\n  - group_name: \"_accounts.all-auto-deploy\"\r\n    iam_role_arns:\r\n#%{~ for name, id in account_ids }\r\n      - \"arn:aws:iam::${id}:role/allow-auto-deploy-from-other-accounts\"\r\n#%{ endfor ~}\r\n\r\n#%{~ for name, id in account_ids }\r\n  - group_name: \"_account.${name}-full-access\"\r\n    iam_role_arns:\r\n      - \"arn:aws:iam::${id}:role/allow-full-access-from-other-accounts\"\r\n  - group_name: \"_account.${name}-read-only\"\r\n    iam_role_arns:\r\n      - \"arn:aws:iam::${id}:role/allow-read-only-access-from-other-accounts\"\r\n  - group_name: \"_account.${name}-auto-deploy\"\r\n    iam_role_arns:\r\n      - \"arn:aws:iam::${id}:role/allow-auto-deploy-from-other-accounts\"\r\n  - group_name: \"_account.${name}-dev\"\r\n    iam_role_arns:\r\n      - \"arn:aws:iam::${id}:role/allow-dev-access-from-other-accounts\"\r\n  - group_name: \"_account.${name}-billing\"\r\n    iam_role_arns:\r\n      - \"arn:aws:iam::${id}:role/allow-billing-only-access-from-other-accounts\"\r\n  - group_name: \"_account.${name}-support\"\r\n    iam_role_arns:\r\n      - \"arn:aws:iam::${id}:role/allow-support-access-from-other-accounts\"\r\n#%{ endfor ~}\r\n```\r\n\r\n- and finally the `security/_global/account-baseline/users.yml` looks like:\r\n\r\n```\r\nci-machine-user:\r\n  create_access_keys: false\r\n  create_login_profile: false\r\n  groups:\r\n  - _accounts.all-auto-deploy\r\n```\r\n","bodyHTML":"<p dir=\"auto\">After some time debugging this I think I possibly found a way to solve the issues of having too many accounts in the same <code class=\"notranslate\">infrastructure-live</code></p>\n<p dir=\"auto\">The solution is based on the following assumption. if this is not true, please let me know.</p>\n<ul dir=\"auto\">\n<li>I'm assuming the <code class=\"notranslate\">aws_iam_group</code> <code class=\"notranslate\">_all-accounts</code> is informational only. I couldn't find anywhere in <code class=\"notranslate\">ECS Deploy Runner</code> if that's used and couldn't find anything.</li>\n</ul>\n<p dir=\"auto\">So to fix it, this is what was changed.</p>\n<ul dir=\"auto\">\n<li>Because we don't need <code class=\"notranslate\">_all-accounts</code> AWS IAM group, in our setup I defined the following variable: <code class=\"notranslate\">should_create_iam_group_cross_account_access_all = false</code> in our <code class=\"notranslate\">security/_global/account-baseline/terragrunt.hcl</code></li>\n<li>With the previous variable defined, the LimitExceeded error should be fixed, the next problem I believe it will happen is that I'll need to define all the different auto-deploy groups to the <code class=\"notranslate\">ci-machine-user</code> under <code class=\"notranslate\">security/_global/account-baseline/users.yml</code> and I'll hit the limit of how many groups it can be attached. Because of that I'm creating a group called <code class=\"notranslate\">_accounts.all-auto-deploy</code> and defining the iam_role_arns to be for all of the accounts using the <code class=\"notranslate\">security/_global/account-baseline/cross_account_groups.yml</code> file (not sure if we will still have the issue of LimitExceeded, but if so I can break into different groups still. the <code class=\"notranslate\">security/_global/account-baseline/cross_account_groups.yml</code>  looks like this:</li>\n</ul>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"cross_account_groups:\n# NOTE: we have to comment out the directives so that the python based data\n# merger (see the `merge-data` hook under blueprints in this repository) can\n# parse this yaml file (we expect to apply the data merger to this module in\n# the future). This still works when feeding through templatefile, as it will\n# interleave blank comments with the list items, which yaml handles gracefully.\n  - group_name: &quot;_accounts.all-auto-deploy&quot;\n    iam_role_arns:\n#%{~ for name, id in account_ids }\n      - &quot;arn:aws:iam::${id}:role/allow-auto-deploy-from-other-accounts&quot;\n#%{ endfor ~}\n\n#%{~ for name, id in account_ids }\n  - group_name: &quot;_account.${name}-full-access&quot;\n    iam_role_arns:\n      - &quot;arn:aws:iam::${id}:role/allow-full-access-from-other-accounts&quot;\n  - group_name: &quot;_account.${name}-read-only&quot;\n    iam_role_arns:\n      - &quot;arn:aws:iam::${id}:role/allow-read-only-access-from-other-accounts&quot;\n  - group_name: &quot;_account.${name}-auto-deploy&quot;\n    iam_role_arns:\n      - &quot;arn:aws:iam::${id}:role/allow-auto-deploy-from-other-accounts&quot;\n  - group_name: &quot;_account.${name}-dev&quot;\n    iam_role_arns:\n      - &quot;arn:aws:iam::${id}:role/allow-dev-access-from-other-accounts&quot;\n  - group_name: &quot;_account.${name}-billing&quot;\n    iam_role_arns:\n      - &quot;arn:aws:iam::${id}:role/allow-billing-only-access-from-other-accounts&quot;\n  - group_name: &quot;_account.${name}-support&quot;\n    iam_role_arns:\n      - &quot;arn:aws:iam::${id}:role/allow-support-access-from-other-accounts&quot;\n#%{ endfor ~}\"><pre class=\"notranslate\"><code class=\"notranslate\">cross_account_groups:\n# NOTE: we have to comment out the directives so that the python based data\n# merger (see the `merge-data` hook under blueprints in this repository) can\n# parse this yaml file (we expect to apply the data merger to this module in\n# the future). This still works when feeding through templatefile, as it will\n# interleave blank comments with the list items, which yaml handles gracefully.\n  - group_name: \"_accounts.all-auto-deploy\"\n    iam_role_arns:\n#%{~ for name, id in account_ids }\n      - \"arn:aws:iam::${id}:role/allow-auto-deploy-from-other-accounts\"\n#%{ endfor ~}\n\n#%{~ for name, id in account_ids }\n  - group_name: \"_account.${name}-full-access\"\n    iam_role_arns:\n      - \"arn:aws:iam::${id}:role/allow-full-access-from-other-accounts\"\n  - group_name: \"_account.${name}-read-only\"\n    iam_role_arns:\n      - \"arn:aws:iam::${id}:role/allow-read-only-access-from-other-accounts\"\n  - group_name: \"_account.${name}-auto-deploy\"\n    iam_role_arns:\n      - \"arn:aws:iam::${id}:role/allow-auto-deploy-from-other-accounts\"\n  - group_name: \"_account.${name}-dev\"\n    iam_role_arns:\n      - \"arn:aws:iam::${id}:role/allow-dev-access-from-other-accounts\"\n  - group_name: \"_account.${name}-billing\"\n    iam_role_arns:\n      - \"arn:aws:iam::${id}:role/allow-billing-only-access-from-other-accounts\"\n  - group_name: \"_account.${name}-support\"\n    iam_role_arns:\n      - \"arn:aws:iam::${id}:role/allow-support-access-from-other-accounts\"\n#%{ endfor ~}\n</code></pre></div>\n<ul dir=\"auto\">\n<li>and finally the <code class=\"notranslate\">security/_global/account-baseline/users.yml</code> looks like:</li>\n</ul>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"ci-machine-user:\n  create_access_keys: false\n  create_login_profile: false\n  groups:\n  - _accounts.all-auto-deploy\"><pre class=\"notranslate\"><code class=\"notranslate\">ci-machine-user:\n  create_access_keys: false\n  create_login_profile: false\n  groups:\n  - _accounts.all-auto-deploy\n</code></pre></div>"}}} />

</CenterLayout>

<!-- ##DOCS-SOURCER-START
{
  "sourcePlugin": "github-discussions",
  "hash": "c33d11a2f409bc16ba7862fb847d1c8f"
}
##DOCS-SOURCER-END -->

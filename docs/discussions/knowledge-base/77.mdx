---
hide_table_of_contents: true
hide_title: true
custom_edit_url: null
---

import CenterLayout from "/src/components/CenterLayout"
import GitHub from "/src/components/GitHub"

<head>
  <link rel="canonical" href="https://github.com/gruntwork-io/knowledge-base/discussions/77" />
</head>

<CenterLayout>
<span className="searchCategory">Knowledge Base</span>
<h1>How to pass userdata when creating an ec2-instance with the service catalog?</h1>
<GitHub discussion={{"id":"D_kwDOF8slf84AOOqW","number":77,"author":{"login":"zackproser"},"title":"How to pass userdata when creating an ec2-instance with the service catalog?","body":"A customer asked: \r\n\r\n>  Could you please share the option to pass our userdata while creating an ec2-instance using the below the terragrunt module?\r\n> https://github.com/gruntwork-io/terraform-aws-service-catalog/tree/master/modules/services/ec2-instance which calls this module under the hood: https://github.com/gruntwork-io/terraform-aws-server/tree/v0.13.7/modules/single-server","bodyHTML":"<p dir=\"auto\">A customer asked:</p>\n<blockquote>\n<p dir=\"auto\">Could you please share the option to pass our userdata while creating an ec2-instance using the below the terragrunt module?<br>\n<a href=\"https://github.com/gruntwork-io/terraform-aws-service-catalog/tree/master/modules/services/ec2-instance\">https://github.com/gruntwork-io/terraform-aws-service-catalog/tree/master/modules/services/ec2-instance</a> which calls this module under the hood: <a href=\"https://github.com/gruntwork-io/terraform-aws-server/tree/v0.13.7/modules/single-server\">https://github.com/gruntwork-io/terraform-aws-server/tree/v0.13.7/modules/single-server</a></p>\n</blockquote>","answer":{"body":"Let's first start by understanding how user data is currently configured and passed in the module.\r\n\r\nIn [the ec2-instance service catalog module](https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/master/modules/services/ec2-instance/main.tf#L97-L114) you indicated, the user-data script is specified in the user-data.sh file here (in the root of the same module).\r\n\r\nYou will notice that user-data.sh file is a template that has values expecting to be interpolated later, such as the following:\r\n```bash\r\nreadonly users_for_ip_lockdown=(${ip_lockdown_users})\r\nstart_ec2_baseline \\\r\n  \"${enable_cloudwatch_log_aggregation}\" \\\r\n  \"${enable_ssh_grunt}\" \\\r\n  \"${enable_fail2ban}\" \\\r\n  \"${enable_ip_lockdown}\" \\\r\n  \"${ssh_grunt_iam_group}\" \\\r\n  \"${ssh_grunt_iam_group_sudo}\" \\\r\n  \"${log_group_name}\" \\\r\n  \"${external_account_ssh_grunt_role_arn}\" \\\r\n  \"$${users_for_ip_lockdown[@]}\"  # Need a double dollar-sign here to avoid Terraform interpolation\r\n\r\n\r\nvolume_json=$(echo ${ebs_volumes} | base64 -d)\r\nfor name in $(echo $${volume_json} | jq -r 'keys[]') ; do\r\n    mount_point=$(echo $${volume_json} | jq -r \".\\\"$${name}\\\".mount_point\")\r\n    device_name=$(echo $${volume_json} | jq -r \".\\\"$${name}\\\".device_name\")\r\n    owner=$(echo $${volume_json} | jq -r \".\\\"$${name}\\\".owner\")\r\n    id=$(echo ${ebs_volume_data} | base64 -d | jq -r \"[.\\\"$${name}\\\"][0].id\")\r\n    mount-ebs-volume \\\r\n        --aws-region \"${ebs_aws_region}\" \\\r\n        --volume-id \"$${id}\" \\\r\n        --device-name \"$${device_name}\" \\\r\n        --mount-point \"$${mount_point}\" \\\r\n        --owner \"$${owner}\"\r\ndone\r\n```\r\n\r\nOn [lines 97 to 114 of the main.tf](https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/c5dd04e93dff43d00b54faac44f77c0afb0a2018/modules/services/ec2-instance/main.tf#L97-L114) file in that module, a local variable called `base_user_data` is created by making a call to the terraform function `templatefile` to load the above ^ user-data.sh template into memory after passing in the variables expected by the script.\r\n\r\nWith that done, a new local map is created in[ lines 77 to 81 here](https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/c5dd04e93dff43d00b54faac44f77c0afb0a2018/modules/services/ec2-instance/main.tf#L77-L81) which represents the structure expected by the variable cloud_init_parts  which is defined [here on lines 154 to 162 of variables.tf](https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/c5dd04e93d/modules/services/ec2-instance/variables.tf#L154-L162). As noted in a comment there, [this doc ](https://registry.terraform.io/providers/hashicorp/template/latest/docs/data-sources/cloudinit_config)explains the use of `template_cloudinit_config` which is a generic definition for cloud-specific user data mechanisms such as AWS user-data.\r\n\r\nAll that said, [here's the official guide](https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/master/modules/services/ec2-instance/core-concepts.md#how-do-i-use-user-data) to configuring user data within your own terraform / terragrunt config.","bodyHTML":"<p dir=\"auto\">Let's first start by understanding how user data is currently configured and passed in the module.</p>\n<p dir=\"auto\">In <a href=\"https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/master/modules/services/ec2-instance/main.tf#L97-L114\">the ec2-instance service catalog module</a> you indicated, the user-data script is specified in the user-data.sh file here (in the root of the same module).</p>\n<p dir=\"auto\">You will notice that user-data.sh file is a template that has values expecting to be interpolated later, such as the following:</p>\n<div class=\"highlight highlight-source-shell notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"readonly users_for_ip_lockdown=(${ip_lockdown_users})\nstart_ec2_baseline \\\n  &quot;${enable_cloudwatch_log_aggregation}&quot; \\\n  &quot;${enable_ssh_grunt}&quot; \\\n  &quot;${enable_fail2ban}&quot; \\\n  &quot;${enable_ip_lockdown}&quot; \\\n  &quot;${ssh_grunt_iam_group}&quot; \\\n  &quot;${ssh_grunt_iam_group_sudo}&quot; \\\n  &quot;${log_group_name}&quot; \\\n  &quot;${external_account_ssh_grunt_role_arn}&quot; \\\n  &quot;$${users_for_ip_lockdown[@]}&quot;  # Need a double dollar-sign here to avoid Terraform interpolation\n\n\nvolume_json=$(echo ${ebs_volumes} | base64 -d)\nfor name in $(echo $${volume_json} | jq -r 'keys[]') ; do\n    mount_point=$(echo $${volume_json} | jq -r &quot;.\\&quot;$${name}\\&quot;.mount_point&quot;)\n    device_name=$(echo $${volume_json} | jq -r &quot;.\\&quot;$${name}\\&quot;.device_name&quot;)\n    owner=$(echo $${volume_json} | jq -r &quot;.\\&quot;$${name}\\&quot;.owner&quot;)\n    id=$(echo ${ebs_volume_data} | base64 -d | jq -r &quot;[.\\&quot;$${name}\\&quot;][0].id&quot;)\n    mount-ebs-volume \\\n        --aws-region &quot;${ebs_aws_region}&quot; \\\n        --volume-id &quot;$${id}&quot; \\\n        --device-name &quot;$${device_name}&quot; \\\n        --mount-point &quot;$${mount_point}&quot; \\\n        --owner &quot;$${owner}&quot;\ndone\"><pre class=\"notranslate\"><span class=\"pl-k\">readonly</span> users_for_ip_lockdown=(<span class=\"pl-smi\">${ip_lockdown_users}</span>)\nstart_ec2_baseline \\\n  <span class=\"pl-s\"><span class=\"pl-pds\">\"</span><span class=\"pl-smi\">${enable_cloudwatch_log_aggregation}</span><span class=\"pl-pds\">\"</span></span> \\\n  <span class=\"pl-s\"><span class=\"pl-pds\">\"</span><span class=\"pl-smi\">${enable_ssh_grunt}</span><span class=\"pl-pds\">\"</span></span> \\\n  <span class=\"pl-s\"><span class=\"pl-pds\">\"</span><span class=\"pl-smi\">${enable_fail2ban}</span><span class=\"pl-pds\">\"</span></span> \\\n  <span class=\"pl-s\"><span class=\"pl-pds\">\"</span><span class=\"pl-smi\">${enable_ip_lockdown}</span><span class=\"pl-pds\">\"</span></span> \\\n  <span class=\"pl-s\"><span class=\"pl-pds\">\"</span><span class=\"pl-smi\">${ssh_grunt_iam_group}</span><span class=\"pl-pds\">\"</span></span> \\\n  <span class=\"pl-s\"><span class=\"pl-pds\">\"</span><span class=\"pl-smi\">${ssh_grunt_iam_group_sudo}</span><span class=\"pl-pds\">\"</span></span> \\\n  <span class=\"pl-s\"><span class=\"pl-pds\">\"</span><span class=\"pl-smi\">${log_group_name}</span><span class=\"pl-pds\">\"</span></span> \\\n  <span class=\"pl-s\"><span class=\"pl-pds\">\"</span><span class=\"pl-smi\">${external_account_ssh_grunt_role_arn}</span><span class=\"pl-pds\">\"</span></span> \\\n  <span class=\"pl-s\"><span class=\"pl-pds\">\"</span><span class=\"pl-smi\">$$</span>{users_for_ip_lockdown[@]}<span class=\"pl-pds\">\"</span></span>  <span class=\"pl-c\"><span class=\"pl-c\">#</span> Need a double dollar-sign here to avoid Terraform interpolation</span>\n\n\nvolume_json=<span class=\"pl-s\"><span class=\"pl-pds\">$(</span>echo <span class=\"pl-smi\">${ebs_volumes}</span> <span class=\"pl-k\">|</span> base64 -d<span class=\"pl-pds\">)</span></span>\n<span class=\"pl-k\">for</span> <span class=\"pl-smi\">name</span> <span class=\"pl-k\">in</span> <span class=\"pl-s\"><span class=\"pl-pds\">$(</span>echo <span class=\"pl-smi\">$$</span>{volume_json} <span class=\"pl-k\">|</span> jq -r <span class=\"pl-s\"><span class=\"pl-pds\">'</span>keys[]<span class=\"pl-pds\">'</span></span><span class=\"pl-pds\">)</span></span> <span class=\"pl-k\">;</span> <span class=\"pl-k\">do</span>\n    mount_point=<span class=\"pl-s\"><span class=\"pl-pds\">$(</span>echo <span class=\"pl-smi\">$$</span>{volume_json} <span class=\"pl-k\">|</span> jq -r <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>.<span class=\"pl-cce\">\\\"</span><span class=\"pl-smi\">$$</span>{name}<span class=\"pl-cce\">\\\"</span>.mount_point<span class=\"pl-pds\">\"</span></span><span class=\"pl-pds\">)</span></span>\n    device_name=<span class=\"pl-s\"><span class=\"pl-pds\">$(</span>echo <span class=\"pl-smi\">$$</span>{volume_json} <span class=\"pl-k\">|</span> jq -r <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>.<span class=\"pl-cce\">\\\"</span><span class=\"pl-smi\">$$</span>{name}<span class=\"pl-cce\">\\\"</span>.device_name<span class=\"pl-pds\">\"</span></span><span class=\"pl-pds\">)</span></span>\n    owner=<span class=\"pl-s\"><span class=\"pl-pds\">$(</span>echo <span class=\"pl-smi\">$$</span>{volume_json} <span class=\"pl-k\">|</span> jq -r <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>.<span class=\"pl-cce\">\\\"</span><span class=\"pl-smi\">$$</span>{name}<span class=\"pl-cce\">\\\"</span>.owner<span class=\"pl-pds\">\"</span></span><span class=\"pl-pds\">)</span></span>\n    id=<span class=\"pl-s\"><span class=\"pl-pds\">$(</span>echo <span class=\"pl-smi\">${ebs_volume_data}</span> <span class=\"pl-k\">|</span> base64 -d <span class=\"pl-k\">|</span> jq -r <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>[.<span class=\"pl-cce\">\\\"</span><span class=\"pl-smi\">$$</span>{name}<span class=\"pl-cce\">\\\"</span>][0].id<span class=\"pl-pds\">\"</span></span><span class=\"pl-pds\">)</span></span>\n    mount-ebs-volume \\\n        --aws-region <span class=\"pl-s\"><span class=\"pl-pds\">\"</span><span class=\"pl-smi\">${ebs_aws_region}</span><span class=\"pl-pds\">\"</span></span> \\\n        --volume-id <span class=\"pl-s\"><span class=\"pl-pds\">\"</span><span class=\"pl-smi\">$$</span>{id}<span class=\"pl-pds\">\"</span></span> \\\n        --device-name <span class=\"pl-s\"><span class=\"pl-pds\">\"</span><span class=\"pl-smi\">$$</span>{device_name}<span class=\"pl-pds\">\"</span></span> \\\n        --mount-point <span class=\"pl-s\"><span class=\"pl-pds\">\"</span><span class=\"pl-smi\">$$</span>{mount_point}<span class=\"pl-pds\">\"</span></span> \\\n        --owner <span class=\"pl-s\"><span class=\"pl-pds\">\"</span><span class=\"pl-smi\">$$</span>{owner}<span class=\"pl-pds\">\"</span></span>\n<span class=\"pl-k\">done</span></pre></div>\n<p dir=\"auto\">On <a href=\"https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/c5dd04e93dff43d00b54faac44f77c0afb0a2018/modules/services/ec2-instance/main.tf#L97-L114\">lines 97 to 114 of the main.tf</a> file in that module, a local variable called <code class=\"notranslate\">base_user_data</code> is created by making a call to the terraform function <code class=\"notranslate\">templatefile</code> to load the above ^ user-data.sh template into memory after passing in the variables expected by the script.</p>\n<p dir=\"auto\">With that done, a new local map is created in<a href=\"https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/c5dd04e93dff43d00b54faac44f77c0afb0a2018/modules/services/ec2-instance/main.tf#L77-L81\"> lines 77 to 81 here</a> which represents the structure expected by the variable cloud_init_parts  which is defined <a href=\"https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/c5dd04e93d/modules/services/ec2-instance/variables.tf#L154-L162\">here on lines 154 to 162 of variables.tf</a>. As noted in a comment there, <a href=\"https://registry.terraform.io/providers/hashicorp/template/latest/docs/data-sources/cloudinit_config\" rel=\"nofollow\">this doc </a>explains the use of <code class=\"notranslate\">template_cloudinit_config</code> which is a generic definition for cloud-specific user data mechanisms such as AWS user-data.</p>\n<p dir=\"auto\">All that said, <a href=\"https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/master/modules/services/ec2-instance/core-concepts.md#how-do-i-use-user-data\">here's the official guide</a> to configuring user data within your own terraform / terragrunt config.</p>"}}} />

</CenterLayout>

<!-- ##DOCS-SOURCER-START
{
  "sourcePlugin": "github-discussions",
  "hash": "fa66342e080cc40b500525850530d7f5"
}
##DOCS-SOURCER-END -->

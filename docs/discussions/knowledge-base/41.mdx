---
hide_table_of_contents: true
hide_title: true
custom_edit_url: null
---

import CenterLayout from "/src/components/CenterLayout"
import GitHub from "/src/components/GitHub"

<head>
  <link rel="canonical" href="https://github.com/gruntwork-io/knowledge-base/discussions/41" />
</head>

<CenterLayout>
<span className="searchCategory">Knowledge Base</span>
<h1>Terragrunt, assume_role and multi-region modules: NoCredentialProviders</h1>
<GitHub discussion={{"id":"D_kwDOF8slf84AN5ZL","number":41,"author":{"login":"zackproser"},"title":"Terragrunt, assume_role and multi-region modules: NoCredentialProviders","body":"A customer asked: \r\n\r\n> I am using your iam_access_analyzer module, that is multiregion, creating and passing the different aws alias providers, one for each region. It was working until we had to use assume_role for authentication:\r\n```\r\ngenerate \"providers\" {\r\n  path      = \"providers.tf\"\r\n  if_exists = \"overwrite\"\r\n  contents = <<EOF\r\n%{for region in local.all_aws_regions}\r\nprovider \"aws\" {\r\n  region = \"${region}\"\r\n  alias  = \"${replace(region, \"-\", \"_\")}\"\r\n  assume_role {\r\n    role_arn = \"${local.aws_role_arn}\"\r\n  }\r\n  # Skip credential validation and account ID retrieval for disabled or restricted regions\r\n  skip_credentials_validation = contains(coalesce(var.iam_access_analyzer_opt_in_regions, []), \"${region}\") ? false : true\r\n  skip_requesting_account_id  = contains(coalesce(var.iam_access_analyzer_opt_in_regions, []), \"${region}\") ? false : true\r\n}\r\n%{endfor}\r\nEOF\r\n}\r\n```\r\nWe have only two opt-in regions:\r\n```\r\nopt_in_regions = [\"eu-west-1\", \"eu-central-1\"]\r\n```\r\nThe error occuring for each region: \r\n```\r\nError: error configuring Terraform AWS Provider: IAM Role (arn:aws:iam::<xxxxxx>:role/<xxxxxx>) cannot be assumed.\r\n\r\nThere are a number of possible causes of this - the most common are:\r\n  * The credentials used in order to assume the role are invalid\r\n  * The credentials do not have appropriate permission to assume the role\r\n  * The role ARN is not valid\r\n\r\nError: NoCredentialProviders: no valid providers in chain. Deprecated.\r\n\tFor verbose messaging see aws.Config.CredentialsChainVerboseErrors\r\n\r\n\r\n  with provider[\"registry.terraform.io/hashicorp/aws\"].af_south_1,\r\n  on providers.tf line 3, in provider \"aws\":\r\n   3: provider \"aws\" {\r\n```","bodyHTML":"<p dir=\"auto\">A customer asked:</p>\n<blockquote>\n<p dir=\"auto\">I am using your iam_access_analyzer module, that is multiregion, creating and passing the different aws alias providers, one for each region. It was working until we had to use assume_role for authentication:</p>\n</blockquote>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"generate &quot;providers&quot; {\n  path      = &quot;providers.tf&quot;\n  if_exists = &quot;overwrite&quot;\n  contents = &lt;&lt;EOF\n%{for region in local.all_aws_regions}\nprovider &quot;aws&quot; {\n  region = &quot;${region}&quot;\n  alias  = &quot;${replace(region, &quot;-&quot;, &quot;_&quot;)}&quot;\n  assume_role {\n    role_arn = &quot;${local.aws_role_arn}&quot;\n  }\n  # Skip credential validation and account ID retrieval for disabled or restricted regions\n  skip_credentials_validation = contains(coalesce(var.iam_access_analyzer_opt_in_regions, []), &quot;${region}&quot;) ? false : true\n  skip_requesting_account_id  = contains(coalesce(var.iam_access_analyzer_opt_in_regions, []), &quot;${region}&quot;) ? false : true\n}\n%{endfor}\nEOF\n}\"><pre class=\"notranslate\"><code class=\"notranslate\">generate \"providers\" {\n  path      = \"providers.tf\"\n  if_exists = \"overwrite\"\n  contents = &lt;&lt;EOF\n%{for region in local.all_aws_regions}\nprovider \"aws\" {\n  region = \"${region}\"\n  alias  = \"${replace(region, \"-\", \"_\")}\"\n  assume_role {\n    role_arn = \"${local.aws_role_arn}\"\n  }\n  # Skip credential validation and account ID retrieval for disabled or restricted regions\n  skip_credentials_validation = contains(coalesce(var.iam_access_analyzer_opt_in_regions, []), \"${region}\") ? false : true\n  skip_requesting_account_id  = contains(coalesce(var.iam_access_analyzer_opt_in_regions, []), \"${region}\") ? false : true\n}\n%{endfor}\nEOF\n}\n</code></pre></div>\n<p dir=\"auto\">We have only two opt-in regions:</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"opt_in_regions = [&quot;eu-west-1&quot;, &quot;eu-central-1&quot;]\"><pre class=\"notranslate\"><code class=\"notranslate\">opt_in_regions = [\"eu-west-1\", \"eu-central-1\"]\n</code></pre></div>\n<p dir=\"auto\">The error occuring for each region:</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"Error: error configuring Terraform AWS Provider: IAM Role (arn:aws:iam::&lt;xxxxxx&gt;:role/&lt;xxxxxx&gt;) cannot be assumed.\n\nThere are a number of possible causes of this - the most common are:\n  * The credentials used in order to assume the role are invalid\n  * The credentials do not have appropriate permission to assume the role\n  * The role ARN is not valid\n\nError: NoCredentialProviders: no valid providers in chain. Deprecated.\n\tFor verbose messaging see aws.Config.CredentialsChainVerboseErrors\n\n\n  with provider[&quot;registry.terraform.io/hashicorp/aws&quot;].af_south_1,\n  on providers.tf line 3, in provider &quot;aws&quot;:\n   3: provider &quot;aws&quot; {\"><pre class=\"notranslate\"><code class=\"notranslate\">Error: error configuring Terraform AWS Provider: IAM Role (arn:aws:iam::&lt;xxxxxx&gt;:role/&lt;xxxxxx&gt;) cannot be assumed.\n\nThere are a number of possible causes of this - the most common are:\n  * The credentials used in order to assume the role are invalid\n  * The credentials do not have appropriate permission to assume the role\n  * The role ARN is not valid\n\nError: NoCredentialProviders: no valid providers in chain. Deprecated.\n\tFor verbose messaging see aws.Config.CredentialsChainVerboseErrors\n\n\n  with provider[\"registry.terraform.io/hashicorp/aws\"].af_south_1,\n  on providers.tf line 3, in provider \"aws\":\n   3: provider \"aws\" {\n</code></pre></div>","answer":{"body":"The issue here is that the assume_role block will always be processed on the provider even when the region is disabled. This is indicated by the error arising for the provider block for af_south_1, which is not in your opt in list.\r\n\r\n`af-south-1` is one of those regions you must also \"opt-in\" to within AWS. You probably have that disabled in your account and the provider is failing the assume role.\r\n\r\nTo fix this, you need to update that generate block to use the if directive (https://www.terraform.io/docs/language/expressions/strings.html#directives) to only render out the assume_role block for the opt in regions.\r\n\r\n```\r\ngenerate \"providers\" {\r\n  path      = \"providers.tf\"\r\n  if_exists = \"overwrite\"\r\n  contents = <<EOF\r\n%{for region in local.all_aws_regions}\r\nprovider \"aws\" {\r\n  region = \"${region}\"\r\n  alias  = \"${replace(region, \"-\", \"_\")}\"\r\n%{ if contains(local.opt_in_regions, region) }\r\n  assume_role {\r\n    role_arn = \"${local.aws_role_arn}\"\r\n  }\r\n%{ endif }\r\n  # Skip credential validation and account ID retrieval for disabled or restricted regions\r\n  skip_credentials_validation = contains(coalesce(var.iam_access_analyzer_opt_in_regions, []), \"${region}\") ? false : true\r\n  skip_requesting_account_id  = contains(coalesce(var.iam_access_analyzer_opt_in_regions, []), \"${region}\") ? false : true\r\n}\r\n%{endfor}\r\nEOF\r\n}\r\n```\r\n","bodyHTML":"<p dir=\"auto\">The issue here is that the assume_role block will always be processed on the provider even when the region is disabled. This is indicated by the error arising for the provider block for af_south_1, which is not in your opt in list.</p>\n<p dir=\"auto\"><code class=\"notranslate\">af-south-1</code> is one of those regions you must also \"opt-in\" to within AWS. You probably have that disabled in your account and the provider is failing the assume role.</p>\n<p dir=\"auto\">To fix this, you need to update that generate block to use the if directive (<a href=\"https://www.terraform.io/docs/language/expressions/strings.html#directives\" rel=\"nofollow\">https://www.terraform.io/docs/language/expressions/strings.html#directives</a>) to only render out the assume_role block for the opt in regions.</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"generate &quot;providers&quot; {\n  path      = &quot;providers.tf&quot;\n  if_exists = &quot;overwrite&quot;\n  contents = &lt;&lt;EOF\n%{for region in local.all_aws_regions}\nprovider &quot;aws&quot; {\n  region = &quot;${region}&quot;\n  alias  = &quot;${replace(region, &quot;-&quot;, &quot;_&quot;)}&quot;\n%{ if contains(local.opt_in_regions, region) }\n  assume_role {\n    role_arn = &quot;${local.aws_role_arn}&quot;\n  }\n%{ endif }\n  # Skip credential validation and account ID retrieval for disabled or restricted regions\n  skip_credentials_validation = contains(coalesce(var.iam_access_analyzer_opt_in_regions, []), &quot;${region}&quot;) ? false : true\n  skip_requesting_account_id  = contains(coalesce(var.iam_access_analyzer_opt_in_regions, []), &quot;${region}&quot;) ? false : true\n}\n%{endfor}\nEOF\n}\"><pre class=\"notranslate\"><code class=\"notranslate\">generate \"providers\" {\n  path      = \"providers.tf\"\n  if_exists = \"overwrite\"\n  contents = &lt;&lt;EOF\n%{for region in local.all_aws_regions}\nprovider \"aws\" {\n  region = \"${region}\"\n  alias  = \"${replace(region, \"-\", \"_\")}\"\n%{ if contains(local.opt_in_regions, region) }\n  assume_role {\n    role_arn = \"${local.aws_role_arn}\"\n  }\n%{ endif }\n  # Skip credential validation and account ID retrieval for disabled or restricted regions\n  skip_credentials_validation = contains(coalesce(var.iam_access_analyzer_opt_in_regions, []), \"${region}\") ? false : true\n  skip_requesting_account_id  = contains(coalesce(var.iam_access_analyzer_opt_in_regions, []), \"${region}\") ? false : true\n}\n%{endfor}\nEOF\n}\n</code></pre></div>"}}} />

</CenterLayout>

<!-- ##DOCS-SOURCER-START
{
  "sourcePlugin": "github-discussions",
  "hash": "2d25b2355a9ce5462edea4ba4d862e78"
}
##DOCS-SOURCER-END -->

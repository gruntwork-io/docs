---
hide_table_of_contents: true
hide_title: true
custom_edit_url: null
---

import CenterLayout from "/src/components/CenterLayout"
import GitHub from "/src/components/GitHub"

<head>
  <link rel="canonical" href="https://github.com/gruntwork-io/knowledge-base/discussions/492" />
</head>

<CenterLayout>
<span className="searchCategory">Knowledge Base</span>
<h1>terraform-aws-ecs v0.25.0 upgrade issues</h1>
<GitHub discussion={{"id":"D_kwDOF8slf84AQBEJ","number":492,"author":{"login":"erictompkins"},"title":"terraform-aws-ecs v0.25.0 upgrade issues","body":"\r\nWe are upgrading [r:terraform-aws-ecs](https://github.com/gruntwork-io/terraform-aws-ecs) `terraform-aws-ecs.git//modules/ecs-service` from version 0.23.4 to 0.25.0 (we can't use 0.24.0 due to the bug with `service_autoscaling_iam_role_arn` output). We when update the version with no other changes in our Terraform file it wants to remove our autoscaling role. \r\n\r\nWe have `use_auto_scaling` set to `true`. Why is the autoscaling getting removed? Is there a way to prevent this or is the autoscaling role supposed to get removed?\r\n\r\n`terraform plan` gives this output:\r\n```\r\nAn execution plan has been generated and is shown below.\r\nResource actions are indicated with the following symbols:\r\n  ~ update in-place\r\n  - destroy\r\n-/+ destroy and then create replacement\r\n\r\nTerraform will perform the following actions:\r\n\r\n  # module.ecs_service.aws_ecs_service.service_with_auto_scaling[0] will be updated in-place\r\n  ~ resource \"aws_ecs_service\" \"service_with_auto_scaling\" {\r\n        cluster                            = \"arn:aws:ecs:us-east-1:XXXX:cluster/xxxx-stage\"\r\n        deployment_maximum_percent         = 200\r\n        deployment_minimum_healthy_percent = 100\r\n        desired_count                      = 1\r\n        enable_ecs_managed_tags            = false\r\n        enable_execute_command             = false\r\n        health_check_grace_period_seconds  = 15\r\n        iam_role                           = \"aws-service-role\"\r\n        id                                 = \"arn:aws:ecs:us-east-1:XXXXX:service/XXXXX-stage\"\r\n        launch_type                        = \"FARGATE\"\r\n        name                               = \"XXXXX-stage\"\r\n        platform_version                   = \"1.4.0\"\r\n        propagate_tags                     = \"NONE\"\r\n        scheduling_strategy                = \"REPLICA\"\r\n        tags                               = {}\r\n        tags_all                           = {}\r\n      ~ task_definition                    = \"arn:aws:ecs:us-east-1:XXXXX:task-definition/XXXXX-stage:1220\" -> (known after apply)\r\n        wait_for_steady_state              = false\r\n\r\n        deployment_circuit_breaker {\r\n            enable   = false\r\n            rollback = false\r\n        }\r\n\r\n        deployment_controller {\r\n            type = \"ECS\"\r\n        }\r\n\r\n        load_balancer {\r\n            container_name   = \"branchcms-stage\"\r\n            container_port   = 3000\r\n            target_group_arn = \"arn:aws:elasticloadbalancing:us-east-1:XXXXX:targetgroup/branchcms-stage/XXXXX\"\r\n        }\r\n\r\n        network_configuration {\r\n            assign_public_ip = true\r\n            security_groups  = [\r\n                \"sg-XXXXXX\",\r\n            ]\r\n            subnets          = [\r\n                \"subnet-XXXXX\",\r\n                \"subnet-XXXXX\",\r\n                \"subnet-XXXXX\",\r\n                \"subnet-XXXXX\",\r\n                \"subnet-XXXXX\",\r\n                \"subnet-XXXXX\",\r\n            ]\r\n        }\r\n    }\r\n\r\n  # module.ecs_service.aws_ecs_task_definition.task must be replaced\r\n-/+ resource \"aws_ecs_task_definition\" \"task\" {\r\n      ~ arn                      = \"arn:aws:ecs:us-east-1:XXXXX:task-definition/XXXXX-stage:1220\" -> (known after apply)\r\n      ~ container_definitions    = jsonencode(\r\n          ~ [ # forces replacement\r\n              ~ {\r\n                    cpu              = 1024\r\n                    environment      = [\r\n                        {\r\n                            name  = \"AWS_REGION\"\r\n                            value = \"us-east-1\"\r\n                        },\r\n                        {\r\n                            name  = \"BACKEND_PORT\"\r\n                            value = \"80\"\r\n                        },\r\n                        {\r\n                            name  = \"DB_URL\"\r\n                            value = \"aurora-stage.cluster-XXXXX.us-east-1.rds.amazonaws.com\"\r\n                        },\r\n                        {\r\n                            name  = \"DEPLOY_ENV\"\r\n                            value = \"stage\"\r\n                        },\r\n                        {\r\n                            name  = \"FTP_DB_URL\"\r\n                            value = \"site-files-ftp-user-db.cluster-XXXXX.us-east-1.rds.amazonaws.com\"\r\n                        },\r\n                        {\r\n                            name  = \"REDIS_URL\"\r\n                            value = \"redis-stage.XXXX.ng.0001.use1.cache.amazonaws.com\"\r\n                        },\r\n                        {\r\n                            name  = \"SITE_FILES_DYNAMODB_META\"\r\n                            value = \"branchms-files-stage\"\r\n                        },\r\n                        {\r\n                            name  = \"SITE_FILES_LAMBDA_IMAGE_PROCESS\"\r\n                            value = \"BranchCMS-Files-S3-Image-Process\"\r\n                        },\r\n                        {\r\n                            name  = \"SITE_FILES_S3_BUCKET\"\r\n                            value = \"fcms-stage\"\r\n                        },\r\n                        {\r\n                            name  = \"SSL_S3_BUCKET\"\r\n                            value = \"branchcms-stage-ssl-certificates\"\r\n                        },\r\n                        {\r\n                            name  = \"TASK_ROLE_ARN\"\r\n                            value = \"arn:aws:iam::XXXXX:role/branchcms-stage-stage-task\"\r\n                        },\r\n                    ]\r\n                    essential        = true\r\n                  ~ image            = \"826252675753.dkr.ecr.us-east-1.amazonaws.com/XXXXXXX\" -> \"826252675753.dkr.ecr.us-east-1.amazonaws.com/branchcms:XXXXXXX\"\r\n                    logConfiguration = {\r\n                        logDriver = \"awslogs\"\r\n                        options   = {\r\n                            awslogs-group         = \"branchcms-stage\"\r\n                            awslogs-region        = \"us-east-1\"\r\n                            awslogs-stream-prefix = \"branchcms-stage-ecs-fargate\"\r\n                        }\r\n                    }\r\n                    memory           = 2048\r\n                    mountPoints      = []\r\n                    name             = \"branchcms-stage\"\r\n                    portMappings     = [\r\n                        {\r\n                            containerPort = 3000\r\n                            hostPort      = 3000\r\n                            protocol      = \"tcp\"\r\n                        },\r\n                    ]\r\n                    volumesFrom      = []\r\n                } # forces replacement,\r\n            ]\r\n        )\r\n        cpu                      = \"1024\"\r\n        execution_role_arn       = \"arn:aws:iam::XXXXXX:role/branchcms-stage-stage-task-execution-role\"\r\n        family                   = \"branchcms-stage\"\r\n      ~ id                       = \"branchcms-stage\" -> (known after apply)\r\n        memory                   = \"2048\"\r\n        network_mode             = \"awsvpc\"\r\n        requires_compatibilities = [\r\n            \"FARGATE\",\r\n        ]\r\n      ~ revision                 = 1220 -> (known after apply)\r\n        skip_destroy             = false\r\n      - tags                     = {} -> null\r\n      ~ tags_all                 = {} -> (known after apply)\r\n        task_role_arn            = \"arn:aws:iam::XXXXXXX:role/branchcms-stage-stage-task\"\r\n    }\r\n\r\n  # module.ecs_service.aws_iam_role.ecs_service_autoscaling_role[0] will be destroyed\r\n  - resource \"aws_iam_role\" \"ecs_service_autoscaling_role\" {\r\n      - arn                   = \"arn:aws:iam::XXXXX:role/branchcms-stage-stage-autoscaling\" -> null\r\n      - assume_role_policy    = jsonencode(\r\n            {\r\n              - Statement = [\r\n                  - {\r\n                      - Action    = \"sts:AssumeRole\"\r\n                      - Effect    = \"Allow\"\r\n                      - Principal = {\r\n                          - Service = \"application-autoscaling.amazonaws.com\"\r\n                        }\r\n                      - Sid       = \"\"\r\n                    },\r\n                ]\r\n              - Version   = \"2012-10-17\"\r\n            }\r\n        ) -> null\r\n      - create_date           = \"2020-07-08T11:27:16Z\" -> null\r\n      - force_detach_policies = false -> null\r\n      - id                    = \"branchcms-stage-stage-autoscaling\" -> null\r\n      - managed_policy_arns   = [] -> null\r\n      - max_session_duration  = 3600 -> null\r\n      - name                  = \"branchcms-stage-stage-autoscaling\" -> null\r\n      - path                  = \"/\" -> null\r\n      - tags                  = {} -> null\r\n      - tags_all              = {} -> null\r\n      - unique_id             = \"AROAWMHU6GFAHMLXERNTM\" -> null\r\n\r\n      - inline_policy {\r\n          - name   = \"branchcms-stage-ecs-service-autoscaling-policy\" -> null\r\n          - policy = jsonencode(\r\n                {\r\n                  - Statement = [\r\n                      - {\r\n                          - Action   = [\r\n                              - \"ecs:UpdateService\",\r\n                              - \"ecs:DescribeServices\",\r\n                            ]\r\n                          - Effect   = \"Allow\"\r\n                          - Resource = \"*\"\r\n                          - Sid      = \"\"\r\n                        },\r\n                      - {\r\n                          - Action   = \"cloudwatch:DescribeAlarms\"\r\n                          - Effect   = \"Allow\"\r\n                          - Resource = \"*\"\r\n                          - Sid      = \"\"\r\n                        },\r\n                    ]\r\n                  - Version   = \"2012-10-17\"\r\n                }\r\n            ) -> null\r\n        }\r\n    }\r\n\r\n  # module.ecs_service.aws_iam_role_policy.ecs_service_autoscaling_policy[0] will be destroyed\r\n  - resource \"aws_iam_role_policy\" \"ecs_service_autoscaling_policy\" {\r\n      - id     = \"branchcms-stage-stage-autoscaling:branchcms-stage-ecs-service-autoscaling-policy\" -> null\r\n      - name   = \"branchcms-stage-ecs-service-autoscaling-policy\" -> null\r\n      - policy = jsonencode(\r\n            {\r\n              - Statement = [\r\n                  - {\r\n                      - Action   = [\r\n                          - \"ecs:UpdateService\",\r\n                          - \"ecs:DescribeServices\",\r\n                        ]\r\n                      - Effect   = \"Allow\"\r\n                      - Resource = \"*\"\r\n                      - Sid      = \"\"\r\n                    },\r\n                  - {\r\n                      - Action   = \"cloudwatch:DescribeAlarms\"\r\n                      - Effect   = \"Allow\"\r\n                      - Resource = \"*\"\r\n                      - Sid      = \"\"\r\n                    },\r\n                ]\r\n              - Version   = \"2012-10-17\"\r\n            }\r\n        ) -> null\r\n      - role   = \"branchcms-stage-stage-autoscaling\" -> null\r\n    }\r\n\r\n  # module.ecs_service.null_resource.ecs_deployment_check[0] must be replaced\r\n-/+ resource \"null_resource\" \"ecs_deployment_check\" {\r\n      ~ id       = \"5496600579459245589\" -> (known after apply)\r\n      ~ triggers = {\r\n          - \"desired_count\"           = \"1\"\r\n          - \"ecs_service_arn\"         = \"arn:aws:ecs:us-east-1:XXXXX:service/branchcms-stage\"\r\n          - \"ecs_task_definition_arn\" = \"arn:aws:ecs:us-east-1:XXXXXX:task-definition/branchcms-stage:1220\"\r\n        } -> (known after apply) # forces replacement\r\n    }\r\n\r\nPlan: 2 to add, 1 to change, 4 to destroy.\r\n\r\nChanges to Outputs:\r\n  ~ aws_ecs_task_definition_arn = \"arn:aws:ecs:us-east-1:XXXXXX:task-definition/branchcms-stage:1220\" -> (known after apply)\r\n```\r\n\r\n---\r\n\r\n<ins datetime=\"2022-07-06T21:24:27Z\">\r\n  <p><a href=\"https://support.gruntwork.io/hc/requests/108932\">Tracked in ticket #108932</a></p>\r\n</ins>\r\n","bodyHTML":"<p dir=\"auto\">We are upgrading <a href=\"https://github.com/gruntwork-io/terraform-aws-ecs\">r:terraform-aws-ecs</a> <code class=\"notranslate\">terraform-aws-ecs.git//modules/ecs-service</code> from version 0.23.4 to 0.25.0 (we can't use 0.24.0 due to the bug with <code class=\"notranslate\">service_autoscaling_iam_role_arn</code> output). We when update the version with no other changes in our Terraform file it wants to remove our autoscaling role.</p>\n<p dir=\"auto\">We have <code class=\"notranslate\">use_auto_scaling</code> set to <code class=\"notranslate\">true</code>. Why is the autoscaling getting removed? Is there a way to prevent this or is the autoscaling role supposed to get removed?</p>\n<p dir=\"auto\"><code class=\"notranslate\">terraform plan</code> gives this output:</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"An execution plan has been generated and is shown below.\nResource actions are indicated with the following symbols:\n  ~ update in-place\n  - destroy\n-/+ destroy and then create replacement\n\nTerraform will perform the following actions:\n\n  # module.ecs_service.aws_ecs_service.service_with_auto_scaling[0] will be updated in-place\n  ~ resource &quot;aws_ecs_service&quot; &quot;service_with_auto_scaling&quot; {\n        cluster                            = &quot;arn:aws:ecs:us-east-1:XXXX:cluster/xxxx-stage&quot;\n        deployment_maximum_percent         = 200\n        deployment_minimum_healthy_percent = 100\n        desired_count                      = 1\n        enable_ecs_managed_tags            = false\n        enable_execute_command             = false\n        health_check_grace_period_seconds  = 15\n        iam_role                           = &quot;aws-service-role&quot;\n        id                                 = &quot;arn:aws:ecs:us-east-1:XXXXX:service/XXXXX-stage&quot;\n        launch_type                        = &quot;FARGATE&quot;\n        name                               = &quot;XXXXX-stage&quot;\n        platform_version                   = &quot;1.4.0&quot;\n        propagate_tags                     = &quot;NONE&quot;\n        scheduling_strategy                = &quot;REPLICA&quot;\n        tags                               = {}\n        tags_all                           = {}\n      ~ task_definition                    = &quot;arn:aws:ecs:us-east-1:XXXXX:task-definition/XXXXX-stage:1220&quot; -&gt; (known after apply)\n        wait_for_steady_state              = false\n\n        deployment_circuit_breaker {\n            enable   = false\n            rollback = false\n        }\n\n        deployment_controller {\n            type = &quot;ECS&quot;\n        }\n\n        load_balancer {\n            container_name   = &quot;branchcms-stage&quot;\n            container_port   = 3000\n            target_group_arn = &quot;arn:aws:elasticloadbalancing:us-east-1:XXXXX:targetgroup/branchcms-stage/XXXXX&quot;\n        }\n\n        network_configuration {\n            assign_public_ip = true\n            security_groups  = [\n                &quot;sg-XXXXXX&quot;,\n            ]\n            subnets          = [\n                &quot;subnet-XXXXX&quot;,\n                &quot;subnet-XXXXX&quot;,\n                &quot;subnet-XXXXX&quot;,\n                &quot;subnet-XXXXX&quot;,\n                &quot;subnet-XXXXX&quot;,\n                &quot;subnet-XXXXX&quot;,\n            ]\n        }\n    }\n\n  # module.ecs_service.aws_ecs_task_definition.task must be replaced\n-/+ resource &quot;aws_ecs_task_definition&quot; &quot;task&quot; {\n      ~ arn                      = &quot;arn:aws:ecs:us-east-1:XXXXX:task-definition/XXXXX-stage:1220&quot; -&gt; (known after apply)\n      ~ container_definitions    = jsonencode(\n          ~ [ # forces replacement\n              ~ {\n                    cpu              = 1024\n                    environment      = [\n                        {\n                            name  = &quot;AWS_REGION&quot;\n                            value = &quot;us-east-1&quot;\n                        },\n                        {\n                            name  = &quot;BACKEND_PORT&quot;\n                            value = &quot;80&quot;\n                        },\n                        {\n                            name  = &quot;DB_URL&quot;\n                            value = &quot;aurora-stage.cluster-XXXXX.us-east-1.rds.amazonaws.com&quot;\n                        },\n                        {\n                            name  = &quot;DEPLOY_ENV&quot;\n                            value = &quot;stage&quot;\n                        },\n                        {\n                            name  = &quot;FTP_DB_URL&quot;\n                            value = &quot;site-files-ftp-user-db.cluster-XXXXX.us-east-1.rds.amazonaws.com&quot;\n                        },\n                        {\n                            name  = &quot;REDIS_URL&quot;\n                            value = &quot;redis-stage.XXXX.ng.0001.use1.cache.amazonaws.com&quot;\n                        },\n                        {\n                            name  = &quot;SITE_FILES_DYNAMODB_META&quot;\n                            value = &quot;branchms-files-stage&quot;\n                        },\n                        {\n                            name  = &quot;SITE_FILES_LAMBDA_IMAGE_PROCESS&quot;\n                            value = &quot;BranchCMS-Files-S3-Image-Process&quot;\n                        },\n                        {\n                            name  = &quot;SITE_FILES_S3_BUCKET&quot;\n                            value = &quot;fcms-stage&quot;\n                        },\n                        {\n                            name  = &quot;SSL_S3_BUCKET&quot;\n                            value = &quot;branchcms-stage-ssl-certificates&quot;\n                        },\n                        {\n                            name  = &quot;TASK_ROLE_ARN&quot;\n                            value = &quot;arn:aws:iam::XXXXX:role/branchcms-stage-stage-task&quot;\n                        },\n                    ]\n                    essential        = true\n                  ~ image            = &quot;826252675753.dkr.ecr.us-east-1.amazonaws.com/XXXXXXX&quot; -&gt; &quot;826252675753.dkr.ecr.us-east-1.amazonaws.com/branchcms:XXXXXXX&quot;\n                    logConfiguration = {\n                        logDriver = &quot;awslogs&quot;\n                        options   = {\n                            awslogs-group         = &quot;branchcms-stage&quot;\n                            awslogs-region        = &quot;us-east-1&quot;\n                            awslogs-stream-prefix = &quot;branchcms-stage-ecs-fargate&quot;\n                        }\n                    }\n                    memory           = 2048\n                    mountPoints      = []\n                    name             = &quot;branchcms-stage&quot;\n                    portMappings     = [\n                        {\n                            containerPort = 3000\n                            hostPort      = 3000\n                            protocol      = &quot;tcp&quot;\n                        },\n                    ]\n                    volumesFrom      = []\n                } # forces replacement,\n            ]\n        )\n        cpu                      = &quot;1024&quot;\n        execution_role_arn       = &quot;arn:aws:iam::XXXXXX:role/branchcms-stage-stage-task-execution-role&quot;\n        family                   = &quot;branchcms-stage&quot;\n      ~ id                       = &quot;branchcms-stage&quot; -&gt; (known after apply)\n        memory                   = &quot;2048&quot;\n        network_mode             = &quot;awsvpc&quot;\n        requires_compatibilities = [\n            &quot;FARGATE&quot;,\n        ]\n      ~ revision                 = 1220 -&gt; (known after apply)\n        skip_destroy             = false\n      - tags                     = {} -&gt; null\n      ~ tags_all                 = {} -&gt; (known after apply)\n        task_role_arn            = &quot;arn:aws:iam::XXXXXXX:role/branchcms-stage-stage-task&quot;\n    }\n\n  # module.ecs_service.aws_iam_role.ecs_service_autoscaling_role[0] will be destroyed\n  - resource &quot;aws_iam_role&quot; &quot;ecs_service_autoscaling_role&quot; {\n      - arn                   = &quot;arn:aws:iam::XXXXX:role/branchcms-stage-stage-autoscaling&quot; -&gt; null\n      - assume_role_policy    = jsonencode(\n            {\n              - Statement = [\n                  - {\n                      - Action    = &quot;sts:AssumeRole&quot;\n                      - Effect    = &quot;Allow&quot;\n                      - Principal = {\n                          - Service = &quot;application-autoscaling.amazonaws.com&quot;\n                        }\n                      - Sid       = &quot;&quot;\n                    },\n                ]\n              - Version   = &quot;2012-10-17&quot;\n            }\n        ) -&gt; null\n      - create_date           = &quot;2020-07-08T11:27:16Z&quot; -&gt; null\n      - force_detach_policies = false -&gt; null\n      - id                    = &quot;branchcms-stage-stage-autoscaling&quot; -&gt; null\n      - managed_policy_arns   = [] -&gt; null\n      - max_session_duration  = 3600 -&gt; null\n      - name                  = &quot;branchcms-stage-stage-autoscaling&quot; -&gt; null\n      - path                  = &quot;/&quot; -&gt; null\n      - tags                  = {} -&gt; null\n      - tags_all              = {} -&gt; null\n      - unique_id             = &quot;AROAWMHU6GFAHMLXERNTM&quot; -&gt; null\n\n      - inline_policy {\n          - name   = &quot;branchcms-stage-ecs-service-autoscaling-policy&quot; -&gt; null\n          - policy = jsonencode(\n                {\n                  - Statement = [\n                      - {\n                          - Action   = [\n                              - &quot;ecs:UpdateService&quot;,\n                              - &quot;ecs:DescribeServices&quot;,\n                            ]\n                          - Effect   = &quot;Allow&quot;\n                          - Resource = &quot;*&quot;\n                          - Sid      = &quot;&quot;\n                        },\n                      - {\n                          - Action   = &quot;cloudwatch:DescribeAlarms&quot;\n                          - Effect   = &quot;Allow&quot;\n                          - Resource = &quot;*&quot;\n                          - Sid      = &quot;&quot;\n                        },\n                    ]\n                  - Version   = &quot;2012-10-17&quot;\n                }\n            ) -&gt; null\n        }\n    }\n\n  # module.ecs_service.aws_iam_role_policy.ecs_service_autoscaling_policy[0] will be destroyed\n  - resource &quot;aws_iam_role_policy&quot; &quot;ecs_service_autoscaling_policy&quot; {\n      - id     = &quot;branchcms-stage-stage-autoscaling:branchcms-stage-ecs-service-autoscaling-policy&quot; -&gt; null\n      - name   = &quot;branchcms-stage-ecs-service-autoscaling-policy&quot; -&gt; null\n      - policy = jsonencode(\n            {\n              - Statement = [\n                  - {\n                      - Action   = [\n                          - &quot;ecs:UpdateService&quot;,\n                          - &quot;ecs:DescribeServices&quot;,\n                        ]\n                      - Effect   = &quot;Allow&quot;\n                      - Resource = &quot;*&quot;\n                      - Sid      = &quot;&quot;\n                    },\n                  - {\n                      - Action   = &quot;cloudwatch:DescribeAlarms&quot;\n                      - Effect   = &quot;Allow&quot;\n                      - Resource = &quot;*&quot;\n                      - Sid      = &quot;&quot;\n                    },\n                ]\n              - Version   = &quot;2012-10-17&quot;\n            }\n        ) -&gt; null\n      - role   = &quot;branchcms-stage-stage-autoscaling&quot; -&gt; null\n    }\n\n  # module.ecs_service.null_resource.ecs_deployment_check[0] must be replaced\n-/+ resource &quot;null_resource&quot; &quot;ecs_deployment_check&quot; {\n      ~ id       = &quot;5496600579459245589&quot; -&gt; (known after apply)\n      ~ triggers = {\n          - &quot;desired_count&quot;           = &quot;1&quot;\n          - &quot;ecs_service_arn&quot;         = &quot;arn:aws:ecs:us-east-1:XXXXX:service/branchcms-stage&quot;\n          - &quot;ecs_task_definition_arn&quot; = &quot;arn:aws:ecs:us-east-1:XXXXXX:task-definition/branchcms-stage:1220&quot;\n        } -&gt; (known after apply) # forces replacement\n    }\n\nPlan: 2 to add, 1 to change, 4 to destroy.\n\nChanges to Outputs:\n  ~ aws_ecs_task_definition_arn = &quot;arn:aws:ecs:us-east-1:XXXXXX:task-definition/branchcms-stage:1220&quot; -&gt; (known after apply)\"><pre class=\"notranslate\"><code>An execution plan has been generated and is shown below.\nResource actions are indicated with the following symbols:\n  ~ update in-place\n  - destroy\n-/+ destroy and then create replacement\n\nTerraform will perform the following actions:\n\n  # module.ecs_service.aws_ecs_service.service_with_auto_scaling[0] will be updated in-place\n  ~ resource \"aws_ecs_service\" \"service_with_auto_scaling\" {\n        cluster                            = \"arn:aws:ecs:us-east-1:XXXX:cluster/xxxx-stage\"\n        deployment_maximum_percent         = 200\n        deployment_minimum_healthy_percent = 100\n        desired_count                      = 1\n        enable_ecs_managed_tags            = false\n        enable_execute_command             = false\n        health_check_grace_period_seconds  = 15\n        iam_role                           = \"aws-service-role\"\n        id                                 = \"arn:aws:ecs:us-east-1:XXXXX:service/XXXXX-stage\"\n        launch_type                        = \"FARGATE\"\n        name                               = \"XXXXX-stage\"\n        platform_version                   = \"1.4.0\"\n        propagate_tags                     = \"NONE\"\n        scheduling_strategy                = \"REPLICA\"\n        tags                               = {}\n        tags_all                           = {}\n      ~ task_definition                    = \"arn:aws:ecs:us-east-1:XXXXX:task-definition/XXXXX-stage:1220\" -&gt; (known after apply)\n        wait_for_steady_state              = false\n\n        deployment_circuit_breaker {\n            enable   = false\n            rollback = false\n        }\n\n        deployment_controller {\n            type = \"ECS\"\n        }\n\n        load_balancer {\n            container_name   = \"branchcms-stage\"\n            container_port   = 3000\n            target_group_arn = \"arn:aws:elasticloadbalancing:us-east-1:XXXXX:targetgroup/branchcms-stage/XXXXX\"\n        }\n\n        network_configuration {\n            assign_public_ip = true\n            security_groups  = [\n                \"sg-XXXXXX\",\n            ]\n            subnets          = [\n                \"subnet-XXXXX\",\n                \"subnet-XXXXX\",\n                \"subnet-XXXXX\",\n                \"subnet-XXXXX\",\n                \"subnet-XXXXX\",\n                \"subnet-XXXXX\",\n            ]\n        }\n    }\n\n  # module.ecs_service.aws_ecs_task_definition.task must be replaced\n-/+ resource \"aws_ecs_task_definition\" \"task\" {\n      ~ arn                      = \"arn:aws:ecs:us-east-1:XXXXX:task-definition/XXXXX-stage:1220\" -&gt; (known after apply)\n      ~ container_definitions    = jsonencode(\n          ~ [ # forces replacement\n              ~ {\n                    cpu              = 1024\n                    environment      = [\n                        {\n                            name  = \"AWS_REGION\"\n                            value = \"us-east-1\"\n                        },\n                        {\n                            name  = \"BACKEND_PORT\"\n                            value = \"80\"\n                        },\n                        {\n                            name  = \"DB_URL\"\n                            value = \"aurora-stage.cluster-XXXXX.us-east-1.rds.amazonaws.com\"\n                        },\n                        {\n                            name  = \"DEPLOY_ENV\"\n                            value = \"stage\"\n                        },\n                        {\n                            name  = \"FTP_DB_URL\"\n                            value = \"site-files-ftp-user-db.cluster-XXXXX.us-east-1.rds.amazonaws.com\"\n                        },\n                        {\n                            name  = \"REDIS_URL\"\n                            value = \"redis-stage.XXXX.ng.0001.use1.cache.amazonaws.com\"\n                        },\n                        {\n                            name  = \"SITE_FILES_DYNAMODB_META\"\n                            value = \"branchms-files-stage\"\n                        },\n                        {\n                            name  = \"SITE_FILES_LAMBDA_IMAGE_PROCESS\"\n                            value = \"BranchCMS-Files-S3-Image-Process\"\n                        },\n                        {\n                            name  = \"SITE_FILES_S3_BUCKET\"\n                            value = \"fcms-stage\"\n                        },\n                        {\n                            name  = \"SSL_S3_BUCKET\"\n                            value = \"branchcms-stage-ssl-certificates\"\n                        },\n                        {\n                            name  = \"TASK_ROLE_ARN\"\n                            value = \"arn:aws:iam::XXXXX:role/branchcms-stage-stage-task\"\n                        },\n                    ]\n                    essential        = true\n                  ~ image            = \"826252675753.dkr.ecr.us-east-1.amazonaws.com/XXXXXXX\" -&gt; \"826252675753.dkr.ecr.us-east-1.amazonaws.com/branchcms:XXXXXXX\"\n                    logConfiguration = {\n                        logDriver = \"awslogs\"\n                        options   = {\n                            awslogs-group         = \"branchcms-stage\"\n                            awslogs-region        = \"us-east-1\"\n                            awslogs-stream-prefix = \"branchcms-stage-ecs-fargate\"\n                        }\n                    }\n                    memory           = 2048\n                    mountPoints      = []\n                    name             = \"branchcms-stage\"\n                    portMappings     = [\n                        {\n                            containerPort = 3000\n                            hostPort      = 3000\n                            protocol      = \"tcp\"\n                        },\n                    ]\n                    volumesFrom      = []\n                } # forces replacement,\n            ]\n        )\n        cpu                      = \"1024\"\n        execution_role_arn       = \"arn:aws:iam::XXXXXX:role/branchcms-stage-stage-task-execution-role\"\n        family                   = \"branchcms-stage\"\n      ~ id                       = \"branchcms-stage\" -&gt; (known after apply)\n        memory                   = \"2048\"\n        network_mode             = \"awsvpc\"\n        requires_compatibilities = [\n            \"FARGATE\",\n        ]\n      ~ revision                 = 1220 -&gt; (known after apply)\n        skip_destroy             = false\n      - tags                     = {} -&gt; null\n      ~ tags_all                 = {} -&gt; (known after apply)\n        task_role_arn            = \"arn:aws:iam::XXXXXXX:role/branchcms-stage-stage-task\"\n    }\n\n  # module.ecs_service.aws_iam_role.ecs_service_autoscaling_role[0] will be destroyed\n  - resource \"aws_iam_role\" \"ecs_service_autoscaling_role\" {\n      - arn                   = \"arn:aws:iam::XXXXX:role/branchcms-stage-stage-autoscaling\" -&gt; null\n      - assume_role_policy    = jsonencode(\n            {\n              - Statement = [\n                  - {\n                      - Action    = \"sts:AssumeRole\"\n                      - Effect    = \"Allow\"\n                      - Principal = {\n                          - Service = \"application-autoscaling.amazonaws.com\"\n                        }\n                      - Sid       = \"\"\n                    },\n                ]\n              - Version   = \"2012-10-17\"\n            }\n        ) -&gt; null\n      - create_date           = \"2020-07-08T11:27:16Z\" -&gt; null\n      - force_detach_policies = false -&gt; null\n      - id                    = \"branchcms-stage-stage-autoscaling\" -&gt; null\n      - managed_policy_arns   = [] -&gt; null\n      - max_session_duration  = 3600 -&gt; null\n      - name                  = \"branchcms-stage-stage-autoscaling\" -&gt; null\n      - path                  = \"/\" -&gt; null\n      - tags                  = {} -&gt; null\n      - tags_all              = {} -&gt; null\n      - unique_id             = \"AROAWMHU6GFAHMLXERNTM\" -&gt; null\n\n      - inline_policy {\n          - name   = \"branchcms-stage-ecs-service-autoscaling-policy\" -&gt; null\n          - policy = jsonencode(\n                {\n                  - Statement = [\n                      - {\n                          - Action   = [\n                              - \"ecs:UpdateService\",\n                              - \"ecs:DescribeServices\",\n                            ]\n                          - Effect   = \"Allow\"\n                          - Resource = \"*\"\n                          - Sid      = \"\"\n                        },\n                      - {\n                          - Action   = \"cloudwatch:DescribeAlarms\"\n                          - Effect   = \"Allow\"\n                          - Resource = \"*\"\n                          - Sid      = \"\"\n                        },\n                    ]\n                  - Version   = \"2012-10-17\"\n                }\n            ) -&gt; null\n        }\n    }\n\n  # module.ecs_service.aws_iam_role_policy.ecs_service_autoscaling_policy[0] will be destroyed\n  - resource \"aws_iam_role_policy\" \"ecs_service_autoscaling_policy\" {\n      - id     = \"branchcms-stage-stage-autoscaling:branchcms-stage-ecs-service-autoscaling-policy\" -&gt; null\n      - name   = \"branchcms-stage-ecs-service-autoscaling-policy\" -&gt; null\n      - policy = jsonencode(\n            {\n              - Statement = [\n                  - {\n                      - Action   = [\n                          - \"ecs:UpdateService\",\n                          - \"ecs:DescribeServices\",\n                        ]\n                      - Effect   = \"Allow\"\n                      - Resource = \"*\"\n                      - Sid      = \"\"\n                    },\n                  - {\n                      - Action   = \"cloudwatch:DescribeAlarms\"\n                      - Effect   = \"Allow\"\n                      - Resource = \"*\"\n                      - Sid      = \"\"\n                    },\n                ]\n              - Version   = \"2012-10-17\"\n            }\n        ) -&gt; null\n      - role   = \"branchcms-stage-stage-autoscaling\" -&gt; null\n    }\n\n  # module.ecs_service.null_resource.ecs_deployment_check[0] must be replaced\n-/+ resource \"null_resource\" \"ecs_deployment_check\" {\n      ~ id       = \"5496600579459245589\" -&gt; (known after apply)\n      ~ triggers = {\n          - \"desired_count\"           = \"1\"\n          - \"ecs_service_arn\"         = \"arn:aws:ecs:us-east-1:XXXXX:service/branchcms-stage\"\n          - \"ecs_task_definition_arn\" = \"arn:aws:ecs:us-east-1:XXXXXX:task-definition/branchcms-stage:1220\"\n        } -&gt; (known after apply) # forces replacement\n    }\n\nPlan: 2 to add, 1 to change, 4 to destroy.\n\nChanges to Outputs:\n  ~ aws_ecs_task_definition_arn = \"arn:aws:ecs:us-east-1:XXXXXX:task-definition/branchcms-stage:1220\" -&gt; (known after apply)\n</code></pre></div>\n<hr>\n<ins datetime=\"2022-07-06T21:24:27Z\">\n  <p dir=\"auto\"><a href=\"https://support.gruntwork.io/hc/requests/108932\" rel=\"nofollow\">Tracked in ticket #108932</a></p>\n</ins>","answer":{"body":"Hi Eric!\r\n\r\nFirst, to get on the same page, here are the release notes for [v0.24.0](https://github.com/gruntwork-io/terraform-aws-ecs/releases/tag/v0.24.0), and those for [v0.25.0](https://github.com/gruntwork-io/terraform-aws-ecs/releases/tag/v0.25.0). Within these changes:\r\n1. you no longer need to set `autoscaling_role_permissions_boundary_arn`, \r\n2. and if you were using the output `service_autoscaling_iam_role_arn`, you can now use `arn:aws:iam::<accountID>:role/aws-service-role/ecs.amazonaws.com/AWSServiceRoleForECS` instead.\r\n\r\nThe main gist of the change is \r\n> This release replaces the [legacy custom IAM role for ECS Auto Scaling](https://docs.aws.amazon.com/AmazonECS/latest/developerguide/ecs-legacy-iam-roles.html) with a [service-linked role](https://docs.aws.amazon.com/AmazonECS/latest/developerguide/using-service-linked-roles.html) that is managed by AWS.\r\n\r\nNow, to interpret your plan output (which, thank you for providing!):\r\n1. `module.ecs_service.aws_ecs_service.service_with_auto_scaling[0]` updated in-place because of a task_definition arn change.\r\n2. `module.ecs_service.aws_ecs_task_definition.task` destroyed and recreated because the container_definition image is changing.\r\n3. `module.ecs_service.aws_iam_role.ecs_service_autoscaling_role[0]` destroyed because it is being replaced with the AWS-managed service linked role.\r\n4. `module.ecs_service.aws_iam_role_policy.ecs_service_autoscaling_policy[0]` destroyed also due to the previous item.\r\n5. `module.ecs_service.null_resource.ecs_deployment_check[0]` destroyed and recreated because the triggers changed.\r\n\r\nBased on that, the auto-scaling on your ECS service will remain, unaffected. A legacy role and its policy will be destroyed. And the rest are getting updated (or destroyed/recreated), so that the auto-scaling can use the service-linked role instead. I think this will be a safe upgrade for you!","bodyHTML":"<p dir=\"auto\">Hi Eric!</p>\n<p dir=\"auto\">First, to get on the same page, here are the release notes for <a href=\"https://github.com/gruntwork-io/terraform-aws-ecs/releases/tag/v0.24.0\">v0.24.0</a>, and those for <a href=\"https://github.com/gruntwork-io/terraform-aws-ecs/releases/tag/v0.25.0\">v0.25.0</a>. Within these changes:</p>\n<ol dir=\"auto\">\n<li>you no longer need to set <code class=\"notranslate\">autoscaling_role_permissions_boundary_arn</code>,</li>\n<li>and if you were using the output <code class=\"notranslate\">service_autoscaling_iam_role_arn</code>, you can now use <code class=\"notranslate\">arn:aws:iam::&lt;accountID&gt;:role/aws-service-role/ecs.amazonaws.com/AWSServiceRoleForECS</code> instead.</li>\n</ol>\n<p dir=\"auto\">The main gist of the change is</p>\n<blockquote>\n<p dir=\"auto\">This release replaces the <a href=\"https://docs.aws.amazon.com/AmazonECS/latest/developerguide/ecs-legacy-iam-roles.html\" rel=\"nofollow\">legacy custom IAM role for ECS Auto Scaling</a> with a <a href=\"https://docs.aws.amazon.com/AmazonECS/latest/developerguide/using-service-linked-roles.html\" rel=\"nofollow\">service-linked role</a> that is managed by AWS.</p>\n</blockquote>\n<p dir=\"auto\">Now, to interpret your plan output (which, thank you for providing!):</p>\n<ol dir=\"auto\">\n<li><code class=\"notranslate\">module.ecs_service.aws_ecs_service.service_with_auto_scaling[0]</code> updated in-place because of a task_definition arn change.</li>\n<li><code class=\"notranslate\">module.ecs_service.aws_ecs_task_definition.task</code> destroyed and recreated because the container_definition image is changing.</li>\n<li><code class=\"notranslate\">module.ecs_service.aws_iam_role.ecs_service_autoscaling_role[0]</code> destroyed because it is being replaced with the AWS-managed service linked role.</li>\n<li><code class=\"notranslate\">module.ecs_service.aws_iam_role_policy.ecs_service_autoscaling_policy[0]</code> destroyed also due to the previous item.</li>\n<li><code class=\"notranslate\">module.ecs_service.null_resource.ecs_deployment_check[0]</code> destroyed and recreated because the triggers changed.</li>\n</ol>\n<p dir=\"auto\">Based on that, the auto-scaling on your ECS service will remain, unaffected. A legacy role and its policy will be destroyed. And the rest are getting updated (or destroyed/recreated), so that the auto-scaling can use the service-linked role instead. I think this will be a safe upgrade for you!</p>"}}} />

</CenterLayout>
  

<!-- ##DOCS-SOURCER-START
{
  "sourcePlugin": "github-discussions",
  "hash": "8936ae957ff91914e786bbe90d1ef0c4"
}
##DOCS-SOURCER-END -->

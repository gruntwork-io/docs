---
hide_table_of_contents: true
hide_title: true
custom_edit_url: null
---

import CenterLayout from "/src/components/CenterLayout"
import GitHub from "/src/components/GitHub"

<head>
  <link rel="canonical" href="https://github.com/gruntwork-io/knowledge-base/discussions/697" />
</head>

<CenterLayout>
<span className="searchCategory">Knowledge Base</span>
<h1>Issues using the CloudTrail module with a connect SNS topic.</h1>
<GitHub discussion={{"id":"D_kwDOF8slf84ATfDh","number":697,"author":{"login":"rsmets"},"title":"Issues using the CloudTrail module with a connect SNS topic.","body":"\nUpon trying to connect the SNS networking module with the security CloudTrail module I met with the error:\r\n\r\n```\r\nError: updating CloudTrail Trail (main-all-regions-trail): InsufficientSnsTopicPolicyException: The customer-managed key (CMK) associated with this SNS topic either does not exist or does not allow access to CloudTrail. Edit the key policy to allow access to CloudTrail.\r\n```\r\n\r\nIt is worth noting that I am using a CMK KMS key, which is created along side the other module listed above via the KMS master key module. My value for the SNS module's `allow_published_services` is:\r\n\r\n```\r\n\r\n  allow_publish_services = [\r\n    \"events.amazonaws.com\",\r\n    \"cloudwatch.amazonaws.com\",\r\n    \"cloudtrail.amazonaws.com\"\r\n  ]\r\n```\r\n\r\nAs well as the KMS key has the following policy:\r\n\r\n```\r\nmodule \"kms_master_key\" {\r\n  source = \"git::git@github.com:gruntwork-io/terraform-aws-security.git//modules/kms-master-key?ref=v0.67.5\"\r\n\r\n  customer_master_keys = {\r\n    (var.cloudtrail_trail_name) = {\r\n      deletion_window_in_days    = 7\r\n      cmk_administrator_iam_arns = var.kms_key_administrator_iam_arns\r\n      cmk_user_iam_arns          = var.kms_key_user_iam_arns\r\n      cmk_service_principals = [\r\n        {\r\n          name    = \"cloudtrail.amazonaws.com\"\r\n          actions = [\"kms:GenerateDataKey*\", \"kms:Decrypt\"]\r\n          conditions = [{\r\n            test     = \"StringLike\"\r\n            variable = \"kms:EncryptionContext:aws:cloudtrail:arn\"\r\n            values   = [\"arn:${data.aws_partition.current.partition}:cloudtrail:${var.aws_region}:${data.aws_caller_identity.current.account_id}:trail/${var.cloudtrail_trail_name}\"]\r\n          }]\r\n        },\r\n        {\r\n          name    = \"cloudtrail.amazonaws.com\"\r\n          actions = [\"kms:DescribeKey\"]\r\n        },\r\n      ]\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n\r\nWhich leads to believe the SNS KMS key policy ought to allow access to CloudTrail. I am miss understanding the error message? Anyone else run into this issue?\n\n---\n\n<ins datetime=\"2023-04-20T00:11:09Z\">\n  <p><a href=\"https://support.gruntwork.io/hc/requests/110099\">Tracked in ticket #110099</a></p>\n</ins>\n","bodyHTML":"<p dir=\"auto\">Upon trying to connect the SNS networking module with the security CloudTrail module I met with the error:</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"Error: updating CloudTrail Trail (main-all-regions-trail): InsufficientSnsTopicPolicyException: The customer-managed key (CMK) associated with this SNS topic either does not exist or does not allow access to CloudTrail. Edit the key policy to allow access to CloudTrail.\"><pre class=\"notranslate\"><code class=\"notranslate\">Error: updating CloudTrail Trail (main-all-regions-trail): InsufficientSnsTopicPolicyException: The customer-managed key (CMK) associated with this SNS topic either does not exist or does not allow access to CloudTrail. Edit the key policy to allow access to CloudTrail.\n</code></pre></div>\n<p dir=\"auto\">It is worth noting that I am using a CMK KMS key, which is created along side the other module listed above via the KMS master key module. My value for the SNS module's <code class=\"notranslate\">allow_published_services</code> is:</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"\n  allow_publish_services = [\n    &quot;events.amazonaws.com&quot;,\n    &quot;cloudwatch.amazonaws.com&quot;,\n    &quot;cloudtrail.amazonaws.com&quot;\n  ]\"><pre class=\"notranslate\"><code class=\"notranslate\">\n  allow_publish_services = [\n    \"events.amazonaws.com\",\n    \"cloudwatch.amazonaws.com\",\n    \"cloudtrail.amazonaws.com\"\n  ]\n</code></pre></div>\n<p dir=\"auto\">As well as the KMS key has the following policy:</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"module &quot;kms_master_key&quot; {\n  source = &quot;git::git@github.com:gruntwork-io/terraform-aws-security.git//modules/kms-master-key?ref=v0.67.5&quot;\n\n  customer_master_keys = {\n    (var.cloudtrail_trail_name) = {\n      deletion_window_in_days    = 7\n      cmk_administrator_iam_arns = var.kms_key_administrator_iam_arns\n      cmk_user_iam_arns          = var.kms_key_user_iam_arns\n      cmk_service_principals = [\n        {\n          name    = &quot;cloudtrail.amazonaws.com&quot;\n          actions = [&quot;kms:GenerateDataKey*&quot;, &quot;kms:Decrypt&quot;]\n          conditions = [{\n            test     = &quot;StringLike&quot;\n            variable = &quot;kms:EncryptionContext:aws:cloudtrail:arn&quot;\n            values   = [&quot;arn:${data.aws_partition.current.partition}:cloudtrail:${var.aws_region}:${data.aws_caller_identity.current.account_id}:trail/${var.cloudtrail_trail_name}&quot;]\n          }]\n        },\n        {\n          name    = &quot;cloudtrail.amazonaws.com&quot;\n          actions = [&quot;kms:DescribeKey&quot;]\n        },\n      ]\n    }\n  }\n}\"><pre class=\"notranslate\"><code class=\"notranslate\">module \"kms_master_key\" {\n  source = \"git::git@github.com:gruntwork-io/terraform-aws-security.git//modules/kms-master-key?ref=v0.67.5\"\n\n  customer_master_keys = {\n    (var.cloudtrail_trail_name) = {\n      deletion_window_in_days    = 7\n      cmk_administrator_iam_arns = var.kms_key_administrator_iam_arns\n      cmk_user_iam_arns          = var.kms_key_user_iam_arns\n      cmk_service_principals = [\n        {\n          name    = \"cloudtrail.amazonaws.com\"\n          actions = [\"kms:GenerateDataKey*\", \"kms:Decrypt\"]\n          conditions = [{\n            test     = \"StringLike\"\n            variable = \"kms:EncryptionContext:aws:cloudtrail:arn\"\n            values   = [\"arn:${data.aws_partition.current.partition}:cloudtrail:${var.aws_region}:${data.aws_caller_identity.current.account_id}:trail/${var.cloudtrail_trail_name}\"]\n          }]\n        },\n        {\n          name    = \"cloudtrail.amazonaws.com\"\n          actions = [\"kms:DescribeKey\"]\n        },\n      ]\n    }\n  }\n}\n</code></pre></div>\n<p dir=\"auto\">Which leads to believe the SNS KMS key policy ought to allow access to CloudTrail. I am miss understanding the error message? Anyone else run into this issue?</p>\n<hr>\n<ins datetime=\"2023-04-20T00:11:09Z\">\n  <p dir=\"auto\"><a href=\"https://support.gruntwork.io/hc/requests/110099\" rel=\"nofollow\">Tracked in ticket #110099</a></p>\n</ins>","answer":{"body":"Hey @rsmets, are you using the SNS module in the `terraform-aws-messaging` repo to create an SNS topic? When using the module, you can pass in the `kms_master_key_id` variable. If you believe it's related to the key policy issue, you can grant the appropriate permission and see if that fixes the problem. \r\n\r\nYou can use the `aws_kms_key` resource to create a CMK and use the `aws_iam_policy_document` to configure key policy. FOr instance, the terraform code would look something like this: \r\n\r\n```\r\nresource \"aws_kms_key\" \"..\" {\r\n  description = ...\r\n  policy      = data.aws_iam_policy_document.example.json\r\n}\r\n\r\ndata \"aws_iam_policy_document\" \"db_kms_key_policy\" {\r\n  statement {\r\n    ...\r\n  }\r\n  statement {\r\n    effect = \"Allow\"\r\n    actions = [\r\n      \"kms:*\",\r\n    ]\r\n\r\n    principals {\r\n       ...\r\n    }\r\n    resources = [\"*\"]\r\n  }\r\n}\r\n```\r\n","bodyHTML":"<p dir=\"auto\">Hey <a class=\"user-mention notranslate\" data-hovercard-type=\"user\" data-hovercard-url=\"/users/rsmets/hovercard\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/rsmets\">@rsmets</a>, are you using the SNS module in the <code class=\"notranslate\">terraform-aws-messaging</code> repo to create an SNS topic? When using the module, you can pass in the <code class=\"notranslate\">kms_master_key_id</code> variable. If you believe it's related to the key policy issue, you can grant the appropriate permission and see if that fixes the problem.</p>\n<p dir=\"auto\">You can use the <code class=\"notranslate\">aws_kms_key</code> resource to create a CMK and use the <code class=\"notranslate\">aws_iam_policy_document</code> to configure key policy. FOr instance, the terraform code would look something like this:</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"resource &quot;aws_kms_key&quot; &quot;..&quot; {\n  description = ...\n  policy      = data.aws_iam_policy_document.example.json\n}\n\ndata &quot;aws_iam_policy_document&quot; &quot;db_kms_key_policy&quot; {\n  statement {\n    ...\n  }\n  statement {\n    effect = &quot;Allow&quot;\n    actions = [\n      &quot;kms:*&quot;,\n    ]\n\n    principals {\n       ...\n    }\n    resources = [&quot;*&quot;]\n  }\n}\"><pre class=\"notranslate\"><code class=\"notranslate\">resource \"aws_kms_key\" \"..\" {\n  description = ...\n  policy      = data.aws_iam_policy_document.example.json\n}\n\ndata \"aws_iam_policy_document\" \"db_kms_key_policy\" {\n  statement {\n    ...\n  }\n  statement {\n    effect = \"Allow\"\n    actions = [\n      \"kms:*\",\n    ]\n\n    principals {\n       ...\n    }\n    resources = [\"*\"]\n  }\n}\n</code></pre></div>"}}} />

</CenterLayout>

<!-- ##DOCS-SOURCER-START
{
  "sourcePlugin": "github-discussions",
  "hash": "b08d09c0800ac922e7dad03e1e23cbda"
}
##DOCS-SOURCER-END -->

---
hide_table_of_contents: true
hide_title: true
custom_edit_url: null
---

import CenterLayout from "/src/components/CenterLayout"
import GitHub from "/src/components/GitHub"

<head>
  <link rel="canonical" href="https://github.com/gruntwork-io/knowledge-base/discussions/731" />
</head>

<CenterLayout>
<span className="searchCategory">Knowledge Base</span>
<h1>Issue with upgrading to terraform-aws-service-catalog to v.100.0 for eks-core-components through pipeline - upgrade from k8s 1.23 to 1.24.</h1>
<GitHub discussion={{"id":"D_kwDOF8slf84AUHiE","number":731,"author":{"login":"sewmiuraj"},"title":"Issue with upgrading to terraform-aws-service-catalog to v.100.0 for eks-core-components through pipeline - upgrade from k8s 1.23 to 1.24.","body":"\nHello,\r\n\r\nI am starting to upgrade our eks cluster from k8s 1.23 to k8s 1.24. We are currently in the version v0.95.1 for repository -  terraform-aws-service-catalog. My understanding is that i need to upgrade eks-core-components first and then upgrade eks-cluster.\r\n\r\nI was able to upgrade the core components from my local pc without any issues. I also upgraded my local kubergrunt version to v.10.0 to support the upgrade.\r\n\r\nThis is how the plan looked like (locally):\r\n\r\n```\r\n # module.fargate_fluent_bit[\"enable\"].kubernetes_config_map.logging will be updated in-place\r\n  ~ resource \"kubernetes_config_map\" \"logging\" {\r\n      ~ data        = {\r\n          + \"filters.conf\" = <<-EOT\r\n                [FILTER]\r\n                  Name kubernetes\r\n                  Match *\r\n                  Merge_Log Off\r\n                  Buffer_Size 0\r\n                  Kube_Meta_Cache_TTL 300s\r\n            EOT\r\n            # (1 unchanged element hidden)\r\n        }\r\n        id          = \"aws-observability/aws-logging\"\r\n        # (2 unchanged attributes hidden)\r\n\r\n        # (1 unchanged block hidden)\r\n    }\r\n\r\n  # module.k8s_external_dns[\"enable\"].helm_release.k8s_external_dns will be updated in-place\r\n  ~ resource \"helm_release\" \"k8s_external_dns\" {\r\n        id                         = \"external-dns\"\r\n        name                       = \"external-dns\"\r\n      ~ version                    = \"6.2.4\" -> \"6.12.2\"\r\n        # (26 unchanged attributes hidden)\r\n    }\r\n\r\nPlan: 0 to add, 2 to change, 0 to destroy.\r\n```\r\nThis was applied locally successfully, but I never could run **even the plan from the pipeline**. It would throw the error:\r\n\r\n`Error: Get \"https://a219bdea5fe77ddb324de47fa9153a05.yl4.eu-central-1.eks.amazonaws.com/api/v1/namespaces/aws-observability\": getting credentials: decoding stdout: no kind \"ExecCredential\" is registered for version \"client.authentication.k8s.io/v1alpha1\" in scheme \"pkg/runtime/scheme.go:100\"`\r\n\r\nAm I correct to understand that this is an issue with kubergrunt versions, or is this something else? \r\n(I can see the ability to add the url of the kubergrunt version is introduced only to the eks-cluster and not eks-core-components).\r\n\r\n\r\n\r\n\n\n---\n\n<ins datetime=\"2023-06-07T11:27:37Z\">\n  <p><a href=\"https://support.gruntwork.io/hc/requests/110238\">Tracked in ticket #110238</a></p>\n</ins>\n","bodyHTML":"<p dir=\"auto\">Hello,</p>\n<p dir=\"auto\">I am starting to upgrade our eks cluster from k8s 1.23 to k8s 1.24. We are currently in the version v0.95.1 for repository -  terraform-aws-service-catalog. My understanding is that i need to upgrade eks-core-components first and then upgrade eks-cluster.</p>\n<p dir=\"auto\">I was able to upgrade the core components from my local pc without any issues. I also upgraded my local kubergrunt version to v.10.0 to support the upgrade.</p>\n<p dir=\"auto\">This is how the plan looked like (locally):</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\" # module.fargate_fluent_bit[&quot;enable&quot;].kubernetes_config_map.logging will be updated in-place\n  ~ resource &quot;kubernetes_config_map&quot; &quot;logging&quot; {\n      ~ data        = {\n          + &quot;filters.conf&quot; = &lt;&lt;-EOT\n                [FILTER]\n                  Name kubernetes\n                  Match *\n                  Merge_Log Off\n                  Buffer_Size 0\n                  Kube_Meta_Cache_TTL 300s\n            EOT\n            # (1 unchanged element hidden)\n        }\n        id          = &quot;aws-observability/aws-logging&quot;\n        # (2 unchanged attributes hidden)\n\n        # (1 unchanged block hidden)\n    }\n\n  # module.k8s_external_dns[&quot;enable&quot;].helm_release.k8s_external_dns will be updated in-place\n  ~ resource &quot;helm_release&quot; &quot;k8s_external_dns&quot; {\n        id                         = &quot;external-dns&quot;\n        name                       = &quot;external-dns&quot;\n      ~ version                    = &quot;6.2.4&quot; -&gt; &quot;6.12.2&quot;\n        # (26 unchanged attributes hidden)\n    }\n\nPlan: 0 to add, 2 to change, 0 to destroy.\"><pre class=\"notranslate\"><code class=\"notranslate\"> # module.fargate_fluent_bit[\"enable\"].kubernetes_config_map.logging will be updated in-place\n  ~ resource \"kubernetes_config_map\" \"logging\" {\n      ~ data        = {\n          + \"filters.conf\" = &lt;&lt;-EOT\n                [FILTER]\n                  Name kubernetes\n                  Match *\n                  Merge_Log Off\n                  Buffer_Size 0\n                  Kube_Meta_Cache_TTL 300s\n            EOT\n            # (1 unchanged element hidden)\n        }\n        id          = \"aws-observability/aws-logging\"\n        # (2 unchanged attributes hidden)\n\n        # (1 unchanged block hidden)\n    }\n\n  # module.k8s_external_dns[\"enable\"].helm_release.k8s_external_dns will be updated in-place\n  ~ resource \"helm_release\" \"k8s_external_dns\" {\n        id                         = \"external-dns\"\n        name                       = \"external-dns\"\n      ~ version                    = \"6.2.4\" -&gt; \"6.12.2\"\n        # (26 unchanged attributes hidden)\n    }\n\nPlan: 0 to add, 2 to change, 0 to destroy.\n</code></pre></div>\n<p dir=\"auto\">This was applied locally successfully, but I never could run <strong>even the plan from the pipeline</strong>. It would throw the error:</p>\n<p dir=\"auto\"><code class=\"notranslate\">Error: Get \"https://a219bdea5fe77ddb324de47fa9153a05.yl4.eu-central-1.eks.amazonaws.com/api/v1/namespaces/aws-observability\": getting credentials: decoding stdout: no kind \"ExecCredential\" is registered for version \"client.authentication.k8s.io/v1alpha1\" in scheme \"pkg/runtime/scheme.go:100\"</code></p>\n<p dir=\"auto\">Am I correct to understand that this is an issue with kubergrunt versions, or is this something else?<br>\n(I can see the ability to add the url of the kubergrunt version is introduced only to the eks-cluster and not eks-core-components).</p>\n<hr>\n<ins datetime=\"2023-06-07T11:27:37Z\">\n  <p dir=\"auto\"><a href=\"https://support.gruntwork.io/hc/requests/110238\" rel=\"nofollow\">Tracked in ticket #110238</a></p>\n</ins>","answer":{"body":"Hi @sewmiuraj, \r\n\r\nYou are correct with rebuilding the Docker images as you described, and I think I see the root cause of the issue. If the ecs-deploy-runner image was built with the default configuration (no build args changed), then an incompatible version of `kubergrunt` will be used (and thus the `client.authentication.k8s.io/v1alpha1` API error). \r\n\r\nHere is the offending [line](https://github.com/gruntwork-io/terraform-aws-ci/blob/v0.50.7/modules/ecs-deploy-runner/docker/deploy-runner/Dockerfile#L46).\r\n\r\nThe dependency (`kubergrunt` version) looks like it wasn't updated to `v0.10.0` which is where support for EKS `1.24` was added. Updating to `v0.100.0` of the Service Catalog _should have_ provided the proper support by default, but this looks like it was missed. So version `0.8.0` of `kubergrunt` is still being used by default which does not support EKS `1.24`. \r\n\r\nCan you try rebuilding the `ecs-deploy-runner` Docker image as you were planning to do, and provide a build arg to override the default `kubergrunt` version and instead use `v0.10.0`? \r\n\r\nSomething like: `--build-arg kubergrunt_version=v0.10.0`","bodyHTML":"<p dir=\"auto\">Hi <a class=\"user-mention notranslate\" data-hovercard-type=\"user\" data-hovercard-url=\"/users/sewmiuraj/hovercard\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/sewmiuraj\">@sewmiuraj</a>,</p>\n<p dir=\"auto\">You are correct with rebuilding the Docker images as you described, and I think I see the root cause of the issue. If the ecs-deploy-runner image was built with the default configuration (no build args changed), then an incompatible version of <code class=\"notranslate\">kubergrunt</code> will be used (and thus the <code class=\"notranslate\">client.authentication.k8s.io/v1alpha1</code> API error).</p>\n<p dir=\"auto\">Here is the offending <a href=\"https://github.com/gruntwork-io/terraform-aws-ci/blob/v0.50.7/modules/ecs-deploy-runner/docker/deploy-runner/Dockerfile#L46\">line</a>.</p>\n<p dir=\"auto\">The dependency (<code class=\"notranslate\">kubergrunt</code> version) looks like it wasn't updated to <code class=\"notranslate\">v0.10.0</code> which is where support for EKS <code class=\"notranslate\">1.24</code> was added. Updating to <code class=\"notranslate\">v0.100.0</code> of the Service Catalog <em>should have</em> provided the proper support by default, but this looks like it was missed. So version <code class=\"notranslate\">0.8.0</code> of <code class=\"notranslate\">kubergrunt</code> is still being used by default which does not support EKS <code class=\"notranslate\">1.24</code>.</p>\n<p dir=\"auto\">Can you try rebuilding the <code class=\"notranslate\">ecs-deploy-runner</code> Docker image as you were planning to do, and provide a build arg to override the default <code class=\"notranslate\">kubergrunt</code> version and instead use <code class=\"notranslate\">v0.10.0</code>?</p>\n<p dir=\"auto\">Something like: <code class=\"notranslate\">--build-arg kubergrunt_version=v0.10.0</code></p>"}}} />

</CenterLayout>
  

<!-- ##DOCS-SOURCER-START
{
  "sourcePlugin": "github-discussions",
  "hash": "2b7d8781310486d75ccd075a86a4ea59"
}
##DOCS-SOURCER-END -->

---
hide_table_of_contents: true
hide_title: true
custom_edit_url: null
---

import CenterLayout from "/src/components/CenterLayout"
import GitHub from "/src/components/GitHub"

<head>
  <link rel="canonical" href="https://github.com/gruntwork-io/knowledge-base/discussions/600" />
</head>

<CenterLayout>
<span className="searchCategory">Knowledge Base</span>
<h1>Running ref-arch CIDR change impact</h1>
<GitHub discussion={{"id":"D_kwDOF8slf84ARie2","number":600,"author":{"login":"ivishalvarshney"},"title":"Running ref-arch CIDR change impact","body":"\nHello Gruntwork Team,\r\n\r\nWhen reference architecture is being setup by first time we have configured the below IP  :-\r\n\r\n\r\n```\r\n# Map of account name to VPC CIDR blocks to use for the mgmt VPC.\r\nmgmt_vpc_cidrs = {\r\n    logs     = \"172.31.80.0/20\"\r\n    prod     = \"172.31.80.0/20\"\r\n    security = \"172.31.80.0/20\"\r\n    shared   = \"172.31.80.0/20\"\r\n    sit      = \"172.31.80.0/20\"\r\n    stage    = \"172.31.80.0/20\"\r\n    uat      = \"172.31.80.0/20\"\r\n  }\r\n\r\n# Map of account name to VPC CIDR blocks to use for the app VPC.\r\n  app_vpc_cidrs = {\r\n    prod  = \"10.6.0.0/16\"\r\n    sit   = \"10.0.0.0/16\"\r\n    stage = \"10.4.0.0/16\"\r\n    uat   = \"10.2.0.0/16\"\r\n}\r\n\r\n```\r\nNow we want to change the IP as below :- \r\n\r\n```\r\nmgmt_vpc_cidrs = {\r\n    logs     = \"11.250.0.0/20\"\r\n    prod     = \"11.250.0.0/20\"\r\n    security = \"11.250.0.0/20\"\r\n    shared   = \"11.250.0.0/20\"\r\n    sit      = \"11.250.0.0/20\"\r\n    stage    = \"11.250.0.0/20\"\r\n    uat      = \"11.250.0.0/20\"\r\n  }\r\n\r\n# Map of account name to VPC CIDR blocks to use for the app VPC.\r\n  app_vpc_cidrs = {\r\n    prod  = \"11.260.0.0/16\"\r\n    sit   = \"11.260.0.0/16\"\r\n    stage = \"11.260.0.0/16\"\r\n    uat   = \"11.260.0.0/16\"\r\n}\r\n```\r\n\r\nQuestions:- \r\n\r\n•\tTo implement this, what I guess we need to make change in common.hcl file.\r\n•\tBut how we are going to make this change in reference architecture ?\r\n•\tDo we need to run gruntwork cli wizard?\r\n•\tWhat are the step we need to take, to make this change. ?\r\n•\tIs there any impact on current / existing ref arch setup. ?\r\n•\tWe also have reserve pool of IP addresses, how do we extent CIDR ranges, please suggest.\r\n\r\n\r\nPlease respond on the above questions, if required, please suggest suitable time to schedule call. ?\r\n\n\n---\n\n<ins datetime=\"2022-11-24T12:51:51Z\">\n  <p><a href=\"https://support.gruntwork.io/hc/requests/109647\">Tracked in ticket #109647</a></p>\n</ins>\n","bodyHTML":"<p dir=\"auto\">Hello Gruntwork Team,</p>\n<p dir=\"auto\">When reference architecture is being setup by first time we have configured the below IP  :-</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"# Map of account name to VPC CIDR blocks to use for the mgmt VPC.\nmgmt_vpc_cidrs = {\n    logs     = &quot;172.31.80.0/20&quot;\n    prod     = &quot;172.31.80.0/20&quot;\n    security = &quot;172.31.80.0/20&quot;\n    shared   = &quot;172.31.80.0/20&quot;\n    sit      = &quot;172.31.80.0/20&quot;\n    stage    = &quot;172.31.80.0/20&quot;\n    uat      = &quot;172.31.80.0/20&quot;\n  }\n\n# Map of account name to VPC CIDR blocks to use for the app VPC.\n  app_vpc_cidrs = {\n    prod  = &quot;10.6.0.0/16&quot;\n    sit   = &quot;10.0.0.0/16&quot;\n    stage = &quot;10.4.0.0/16&quot;\n    uat   = &quot;10.2.0.0/16&quot;\n}\n\"><pre class=\"notranslate\"><code class=\"notranslate\"># Map of account name to VPC CIDR blocks to use for the mgmt VPC.\nmgmt_vpc_cidrs = {\n    logs     = \"172.31.80.0/20\"\n    prod     = \"172.31.80.0/20\"\n    security = \"172.31.80.0/20\"\n    shared   = \"172.31.80.0/20\"\n    sit      = \"172.31.80.0/20\"\n    stage    = \"172.31.80.0/20\"\n    uat      = \"172.31.80.0/20\"\n  }\n\n# Map of account name to VPC CIDR blocks to use for the app VPC.\n  app_vpc_cidrs = {\n    prod  = \"10.6.0.0/16\"\n    sit   = \"10.0.0.0/16\"\n    stage = \"10.4.0.0/16\"\n    uat   = \"10.2.0.0/16\"\n}\n\n</code></pre></div>\n<p dir=\"auto\">Now we want to change the IP as below :-</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"mgmt_vpc_cidrs = {\n    logs     = &quot;11.250.0.0/20&quot;\n    prod     = &quot;11.250.0.0/20&quot;\n    security = &quot;11.250.0.0/20&quot;\n    shared   = &quot;11.250.0.0/20&quot;\n    sit      = &quot;11.250.0.0/20&quot;\n    stage    = &quot;11.250.0.0/20&quot;\n    uat      = &quot;11.250.0.0/20&quot;\n  }\n\n# Map of account name to VPC CIDR blocks to use for the app VPC.\n  app_vpc_cidrs = {\n    prod  = &quot;11.260.0.0/16&quot;\n    sit   = &quot;11.260.0.0/16&quot;\n    stage = &quot;11.260.0.0/16&quot;\n    uat   = &quot;11.260.0.0/16&quot;\n}\"><pre class=\"notranslate\"><code class=\"notranslate\">mgmt_vpc_cidrs = {\n    logs     = \"11.250.0.0/20\"\n    prod     = \"11.250.0.0/20\"\n    security = \"11.250.0.0/20\"\n    shared   = \"11.250.0.0/20\"\n    sit      = \"11.250.0.0/20\"\n    stage    = \"11.250.0.0/20\"\n    uat      = \"11.250.0.0/20\"\n  }\n\n# Map of account name to VPC CIDR blocks to use for the app VPC.\n  app_vpc_cidrs = {\n    prod  = \"11.260.0.0/16\"\n    sit   = \"11.260.0.0/16\"\n    stage = \"11.260.0.0/16\"\n    uat   = \"11.260.0.0/16\"\n}\n</code></pre></div>\n<p dir=\"auto\">Questions:-</p>\n<p dir=\"auto\">•\tTo implement this, what I guess we need to make change in common.hcl file.<br>\n•\tBut how we are going to make this change in reference architecture ?<br>\n•\tDo we need to run gruntwork cli wizard?<br>\n•\tWhat are the step we need to take, to make this change. ?<br>\n•\tIs there any impact on current / existing ref arch setup. ?<br>\n•\tWe also have reserve pool of IP addresses, how do we extent CIDR ranges, please suggest.</p>\n<p dir=\"auto\">Please respond on the above questions, if required, please suggest suitable time to schedule call. ?</p>\n<hr>\n<ins datetime=\"2022-11-24T12:51:51Z\">\n  <p dir=\"auto\"><a href=\"https://support.gruntwork.io/hc/requests/109647\" rel=\"nofollow\">Tracked in ticket #109647</a></p>\n</ins>","answer":{"body":"Hey @ivishalvarshney, we've discussed about these questions internally and here are the responses to your questions above: \r\n\r\n> To implement this, what I guess we need to make change in common.hcl file.\r\n\r\nYes, CIDR blocks are managed by default in `common.hcl` You can find an example [here](https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/master/examples/for-production/infrastructure-live/common.hcl#L59-L73)\r\n\r\n>  But how we are going to make this change in reference architecture ?\r\n\r\nIf a VPC has already been created, you cannot change its CIDR block. This is an [AWS limitation](https://aws.amazon.com/premiumsupport/knowledge-center/vpc-ip-address-range/) and has nothing to do with our modules. So if they change the values in `common.hcl` and run `terraform/terragrunt apply`, it won’t do what they want! So there are really two paths:\r\n* Extend the CIDR block of the existing VPC. We don’t natively support this within our vpc-app module. However, a customer can [extend the module](https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/master/core-concepts.md#extend-gruntwork-services) and add the additional CIDR block from “outside” the module via the [aws_vpc_ipv4_cidr_block_association](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/vpc_ipv4_cidr_block_association) resource.\r\n* Recreate the existing VPC. To do this, the customer would first need to run destroy on everything deployed into that VPC: every EC2 instance, RDS DB, ECS Task, etc. After that, you can run destroy on the old VPC, change the CIDR block, and run apply. I think the destroy/recreate will also happen automatically if you change cidr_block and run apply, but you can potentially face some issues with this. \r\n\r\n> Do we need to run gruntwork cli wizard?\r\n\r\nNo. You do not need to run gruntwork CLI wizard for this change. \r\n\r\n> What are the step we need to take, to make this change?\r\n\r\nExplained the overall approach above. You would have to make changes in the `commonh.hcl` file and run `terragrunt/terraform apply`.\r\n\r\n> Is there any impact on current / existing ref arch setup. ?\r\n\r\nExplained in one of the previous question. It would destroy the entire ref arch setup and try to recreate it.\r\n\r\n> We also have reserve pool of IP addresses, how do we extent CIDR ranges, please suggest.\r\n\r\nYou can extend an existing vpc module to provide support for this. Here is the [instruction of extending an existing module](https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/master/core-concepts.md#extend-gruntwork-services). \r\n\r\n---\r\n\r\nAside from the questions you raised, here are additional questions/thoughts that would be worth thinking about: \r\n* We recommend using private CIDR blocks from [RFC 1918](https://docs.aws.amazon.com/vpc/latest/userguide/configure-your-vpc.html#vpc-sizing-ipv4). Why do you want to change the IP addresses from private to public? \r\n* We believe you are not allowed to have number greater than 255 in your IP address. Is `11.260.0.0/16` a typo? \r\n","bodyHTML":"<p dir=\"auto\">Hey <a class=\"user-mention notranslate\" data-hovercard-type=\"user\" data-hovercard-url=\"/users/ivishalvarshney/hovercard\" data-octo-click=\"hovercard-link-click\" data-octo-dimensions=\"link_type:self\" href=\"https://github.com/ivishalvarshney\">@ivishalvarshney</a>, we've discussed about these questions internally and here are the responses to your questions above:</p>\n<blockquote>\n<p dir=\"auto\">To implement this, what I guess we need to make change in common.hcl file.</p>\n</blockquote>\n<p dir=\"auto\">Yes, CIDR blocks are managed by default in <code class=\"notranslate\">common.hcl</code> You can find an example <a href=\"https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/master/examples/for-production/infrastructure-live/common.hcl#L59-L73\">here</a></p>\n<blockquote>\n<p dir=\"auto\">But how we are going to make this change in reference architecture ?</p>\n</blockquote>\n<p dir=\"auto\">If a VPC has already been created, you cannot change its CIDR block. This is an <a href=\"https://aws.amazon.com/premiumsupport/knowledge-center/vpc-ip-address-range/\" rel=\"nofollow\">AWS limitation</a> and has nothing to do with our modules. So if they change the values in <code class=\"notranslate\">common.hcl</code> and run <code class=\"notranslate\">terraform/terragrunt apply</code>, it won’t do what they want! So there are really two paths:</p>\n<ul dir=\"auto\">\n<li>Extend the CIDR block of the existing VPC. We don’t natively support this within our vpc-app module. However, a customer can <a href=\"https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/master/core-concepts.md#extend-gruntwork-services\">extend the module</a> and add the additional CIDR block from “outside” the module via the <a href=\"https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/vpc_ipv4_cidr_block_association\" rel=\"nofollow\">aws_vpc_ipv4_cidr_block_association</a> resource.</li>\n<li>Recreate the existing VPC. To do this, the customer would first need to run destroy on everything deployed into that VPC: every EC2 instance, RDS DB, ECS Task, etc. After that, you can run destroy on the old VPC, change the CIDR block, and run apply. I think the destroy/recreate will also happen automatically if you change cidr_block and run apply, but you can potentially face some issues with this.</li>\n</ul>\n<blockquote>\n<p dir=\"auto\">Do we need to run gruntwork cli wizard?</p>\n</blockquote>\n<p dir=\"auto\">No. You do not need to run gruntwork CLI wizard for this change.</p>\n<blockquote>\n<p dir=\"auto\">What are the step we need to take, to make this change?</p>\n</blockquote>\n<p dir=\"auto\">Explained the overall approach above. You would have to make changes in the <code class=\"notranslate\">commonh.hcl</code> file and run <code class=\"notranslate\">terragrunt/terraform apply</code>.</p>\n<blockquote>\n<p dir=\"auto\">Is there any impact on current / existing ref arch setup. ?</p>\n</blockquote>\n<p dir=\"auto\">Explained in one of the previous question. It would destroy the entire ref arch setup and try to recreate it.</p>\n<blockquote>\n<p dir=\"auto\">We also have reserve pool of IP addresses, how do we extent CIDR ranges, please suggest.</p>\n</blockquote>\n<p dir=\"auto\">You can extend an existing vpc module to provide support for this. Here is the <a href=\"https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/master/core-concepts.md#extend-gruntwork-services\">instruction of extending an existing module</a>.</p>\n<hr>\n<p dir=\"auto\">Aside from the questions you raised, here are additional questions/thoughts that would be worth thinking about:</p>\n<ul dir=\"auto\">\n<li>We recommend using private CIDR blocks from <a href=\"https://docs.aws.amazon.com/vpc/latest/userguide/configure-your-vpc.html#vpc-sizing-ipv4\" rel=\"nofollow\">RFC 1918</a>. Why do you want to change the IP addresses from private to public?</li>\n<li>We believe you are not allowed to have number greater than 255 in your IP address. Is <code class=\"notranslate\">11.260.0.0/16</code> a typo?</li>\n</ul>"}}} />

</CenterLayout>

<!-- ##DOCS-SOURCER-START
{
  "sourcePlugin": "github-discussions",
  "hash": "2430afb3a83209188f3464a84ff1853e"
}
##DOCS-SOURCER-END -->

---
hide_table_of_contents: true
hide_title: true
custom_edit_url: null
---

import CenterLayout from "/src/components/CenterLayout"
import GitHub from "/src/components/GitHub"

<head>
  <link rel="canonical" href="https://github.com/gruntwork-io/knowledge-base/discussions/542" />
</head>

<CenterLayout>
<span className="searchCategory">Knowledge Base</span>
<h1>Kubernetes_namespace module and terragrunt recreate</h1>
<GitHub discussion={{"id":"D_kwDOF8slf84AQhAx","number":542,"author":{"login":"Eweol"},"title":"Kubernetes_namespace module and terragrunt recreate","body":"\n## Terraform version, Kubernetes provider version and Kubernetes version\r\n```\r\nTerraform version: v1.0.5\r\nKubernetes Provider version: v2.8.0\r\nKubernetes version: v1.23.9\r\nTerragtunt version: v0.37.1\r\n```\r\n## Terraform configuration\r\nmain.tf\r\n```\r\nresource \"kubernetes_namespace\" \"namespace\" {\r\n  metadata {\r\n    name = var.name\r\n    labels = var.labels\r\n    annotations = {\r\n      name = var.name\r\n    }\r\n  }\r\n}\r\n```\r\nnamespace.hcl\r\n```\r\nterraform {\r\n  source = \"${dirname(find_in_parent_folders())}/modules//namespace\"\r\n}\r\n\r\nlocals {\r\n  domain_vars           = read_terragrunt_config(find_in_parent_folders(\"domain_var.hcl\"))\r\n  domain                = local.domain_vars.locals.domain\r\n}\r\n\r\ninputs = {\r\n  domain = local.domain\r\n}\r\n```\r\nterragrunt.hcl\r\n```\r\ninclude \"root\"{\r\n    path = find_in_parent_folders()\r\n}\r\n\r\ninclude \"envcommon\"{\r\n    path = \"${dirname(find_in_parent_folders())}/_envcommon//namespace.hcl\"\r\n}\r\n\r\nlocals {\r\n    domain_vars   = read_terragrunt_config(find_in_parent_folders(\"domain_var.hcl\"))\r\n    domain        = local.domain_vars.locals.domain\r\n    domain_labels = local.domain_vars.locals.labels\r\n    type          = \"application\"\r\n    labels = merge(\r\n    local.domain_labels,\r\n    {type = local.type}\r\n  )\r\n}\r\n\r\ninputs = {\r\n    name = \"${local.domain}-${local.type}\"\r\n    labels = local.labels\r\n}\r\n```\r\n\r\n## Question\r\n```\r\nHi,\r\n\r\nI use the kubernetes_namespace in my terragrunt structure.\r\nI created an namespace module to be as flexible as I can and create the namespace properties out of variables, which will be filled by terragrunt.hcl files and variables.\r\n\r\nNow I have the problem, that only the 1 namespace will be created, the second one will destroy the first one and create the second one as well as the third.\r\n\r\nI have different names, different lables and different annotations for every namespace but it doesn't work.\r\n\r\nHave somebody an idea why this is the case?\r\n```\r\n-----------------------------------------------------------------------------------------------------------------------------------------------\r\n\r\nDon't know why but figured out, that it seems to be a problem with remote_state\r\n\r\nIf I User Kubernetes Backend, I have the problem above.\r\n\r\nIf I use Local Backend I cannot reproduce this problem anymore\r\n\r\n```\r\nremote_state {\r\n\r\n  backend = \"kubernetes\"\r\n\r\n  generate = {\r\n\r\n    path      = \"backend.tf\"\r\n\r\n    if_exists = \"overwrite_terragrunt\"\r\n\r\n  }\r\n\r\n  config = {\r\n\r\n    config_path      = \"~/.kube/config\"\r\n\r\n    secret_suffix    = \"state\"\r\n\r\n  }\r\n\r\n}\r\n```\r\n```\r\nremote_state {\r\n\r\n  backend = \"local\"\r\n\r\n  generate = {\r\n\r\n    path      = \"backend.tf\"\r\n\r\n    if_exists = \"overwrite_terragrunt\"\r\n\r\n  }\r\n\r\n  config = {\r\n\r\n    path = \"${get_original_terragrunt_dir()}/terraform.tfstate\"\r\n\r\n  }\r\n\r\n}\r\n```\r\n\r\nAny ideas?\n\n---\n\n<ins datetime=\"2022-08-24T09:10:26Z\">\n  <p><a href=\"https://support.gruntwork.io/hc/requests/109162\">Tracked in ticket #109162</a></p>\n</ins>\n","bodyHTML":"<h2 dir=\"auto\">Terraform version, Kubernetes provider version and Kubernetes version</h2>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"Terraform version: v1.0.5\nKubernetes Provider version: v2.8.0\nKubernetes version: v1.23.9\nTerragtunt version: v0.37.1\"><pre class=\"notranslate\"><code class=\"notranslate\">Terraform version: v1.0.5\nKubernetes Provider version: v2.8.0\nKubernetes version: v1.23.9\nTerragtunt version: v0.37.1\n</code></pre></div>\n<h2 dir=\"auto\">Terraform configuration</h2>\n<p dir=\"auto\">main.tf</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"resource &quot;kubernetes_namespace&quot; &quot;namespace&quot; {\n  metadata {\n    name = var.name\n    labels = var.labels\n    annotations = {\n      name = var.name\n    }\n  }\n}\"><pre class=\"notranslate\"><code class=\"notranslate\">resource \"kubernetes_namespace\" \"namespace\" {\n  metadata {\n    name = var.name\n    labels = var.labels\n    annotations = {\n      name = var.name\n    }\n  }\n}\n</code></pre></div>\n<p dir=\"auto\">namespace.hcl</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"terraform {\n  source = &quot;${dirname(find_in_parent_folders())}/modules//namespace&quot;\n}\n\nlocals {\n  domain_vars           = read_terragrunt_config(find_in_parent_folders(&quot;domain_var.hcl&quot;))\n  domain                = local.domain_vars.locals.domain\n}\n\ninputs = {\n  domain = local.domain\n}\"><pre class=\"notranslate\"><code class=\"notranslate\">terraform {\n  source = \"${dirname(find_in_parent_folders())}/modules//namespace\"\n}\n\nlocals {\n  domain_vars           = read_terragrunt_config(find_in_parent_folders(\"domain_var.hcl\"))\n  domain                = local.domain_vars.locals.domain\n}\n\ninputs = {\n  domain = local.domain\n}\n</code></pre></div>\n<p dir=\"auto\">terragrunt.hcl</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"include &quot;root&quot;{\n    path = find_in_parent_folders()\n}\n\ninclude &quot;envcommon&quot;{\n    path = &quot;${dirname(find_in_parent_folders())}/_envcommon//namespace.hcl&quot;\n}\n\nlocals {\n    domain_vars   = read_terragrunt_config(find_in_parent_folders(&quot;domain_var.hcl&quot;))\n    domain        = local.domain_vars.locals.domain\n    domain_labels = local.domain_vars.locals.labels\n    type          = &quot;application&quot;\n    labels = merge(\n    local.domain_labels,\n    {type = local.type}\n  )\n}\n\ninputs = {\n    name = &quot;${local.domain}-${local.type}&quot;\n    labels = local.labels\n}\"><pre class=\"notranslate\"><code class=\"notranslate\">include \"root\"{\n    path = find_in_parent_folders()\n}\n\ninclude \"envcommon\"{\n    path = \"${dirname(find_in_parent_folders())}/_envcommon//namespace.hcl\"\n}\n\nlocals {\n    domain_vars   = read_terragrunt_config(find_in_parent_folders(\"domain_var.hcl\"))\n    domain        = local.domain_vars.locals.domain\n    domain_labels = local.domain_vars.locals.labels\n    type          = \"application\"\n    labels = merge(\n    local.domain_labels,\n    {type = local.type}\n  )\n}\n\ninputs = {\n    name = \"${local.domain}-${local.type}\"\n    labels = local.labels\n}\n</code></pre></div>\n<h2 dir=\"auto\">Question</h2>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"Hi,\n\nI use the kubernetes_namespace in my terragrunt structure.\nI created an namespace module to be as flexible as I can and create the namespace properties out of variables, which will be filled by terragrunt.hcl files and variables.\n\nNow I have the problem, that only the 1 namespace will be created, the second one will destroy the first one and create the second one as well as the third.\n\nI have different names, different lables and different annotations for every namespace but it doesn't work.\n\nHave somebody an idea why this is the case?\"><pre class=\"notranslate\"><code class=\"notranslate\">Hi,\n\nI use the kubernetes_namespace in my terragrunt structure.\nI created an namespace module to be as flexible as I can and create the namespace properties out of variables, which will be filled by terragrunt.hcl files and variables.\n\nNow I have the problem, that only the 1 namespace will be created, the second one will destroy the first one and create the second one as well as the third.\n\nI have different names, different lables and different annotations for every namespace but it doesn't work.\n\nHave somebody an idea why this is the case?\n</code></pre></div>\n<hr>\n<p dir=\"auto\">Don't know why but figured out, that it seems to be a problem with remote_state</p>\n<p dir=\"auto\">If I User Kubernetes Backend, I have the problem above.</p>\n<p dir=\"auto\">If I use Local Backend I cannot reproduce this problem anymore</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"remote_state {\n\n  backend = &quot;kubernetes&quot;\n\n  generate = {\n\n    path      = &quot;backend.tf&quot;\n\n    if_exists = &quot;overwrite_terragrunt&quot;\n\n  }\n\n  config = {\n\n    config_path      = &quot;~/.kube/config&quot;\n\n    secret_suffix    = &quot;state&quot;\n\n  }\n\n}\"><pre class=\"notranslate\"><code class=\"notranslate\">remote_state {\n\n  backend = \"kubernetes\"\n\n  generate = {\n\n    path      = \"backend.tf\"\n\n    if_exists = \"overwrite_terragrunt\"\n\n  }\n\n  config = {\n\n    config_path      = \"~/.kube/config\"\n\n    secret_suffix    = \"state\"\n\n  }\n\n}\n</code></pre></div>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"remote_state {\n\n  backend = &quot;local&quot;\n\n  generate = {\n\n    path      = &quot;backend.tf&quot;\n\n    if_exists = &quot;overwrite_terragrunt&quot;\n\n  }\n\n  config = {\n\n    path = &quot;${get_original_terragrunt_dir()}/terraform.tfstate&quot;\n\n  }\n\n}\"><pre class=\"notranslate\"><code class=\"notranslate\">remote_state {\n\n  backend = \"local\"\n\n  generate = {\n\n    path      = \"backend.tf\"\n\n    if_exists = \"overwrite_terragrunt\"\n\n  }\n\n  config = {\n\n    path = \"${get_original_terragrunt_dir()}/terraform.tfstate\"\n\n  }\n\n}\n</code></pre></div>\n<p dir=\"auto\">Any ideas?</p>\n<hr>\n<ins datetime=\"2022-08-24T09:10:26Z\">\n  <p dir=\"auto\"><a href=\"https://support.gruntwork.io/hc/requests/109162\" rel=\"nofollow\">Tracked in ticket #109162</a></p>\n</ins>","answer":{"body":"When using the `kubernetes` backend, you aren't dynamically adjusting the `secret_suffix` based on the module, which is causing all the terragrunt configurations to write to the same state object. Because they are all sharing the state file, Terraform is viewing the differences across the modules as a diff in the deployment.\r\n\r\nYou should set `secret_suffix` to dynamically change based on the importing config, which you should be able to accomplish with:\r\n\r\n```hcl\r\nremote_state {\r\n  backend = \"kubernetes\"\r\n\r\n  generate = {\r\n    path      = \"backend.tf\"\r\n    if_exists = \"overwrite_terragrunt\"\r\n  }\r\n\r\n  config = {\r\n    config_path      = \"~/.kube/config\"\r\n    secret_suffix    = \"${replace(path_relative_to_include(), \"/\", \"-\")}-state\"\r\n  }\r\n}\r\n```","bodyHTML":"<p dir=\"auto\">When using the <code class=\"notranslate\">kubernetes</code> backend, you aren't dynamically adjusting the <code class=\"notranslate\">secret_suffix</code> based on the module, which is causing all the terragrunt configurations to write to the same state object. Because they are all sharing the state file, Terraform is viewing the differences across the modules as a diff in the deployment.</p>\n<p dir=\"auto\">You should set <code class=\"notranslate\">secret_suffix</code> to dynamically change based on the importing config, which you should be able to accomplish with:</p>\n<div class=\"highlight highlight-source-terraform notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"remote_state {\n  backend = &quot;kubernetes&quot;\n\n  generate = {\n    path      = &quot;backend.tf&quot;\n    if_exists = &quot;overwrite_terragrunt&quot;\n  }\n\n  config = {\n    config_path      = &quot;~/.kube/config&quot;\n    secret_suffix    = &quot;${replace(path_relative_to_include(), &quot;/&quot;, &quot;-&quot;)}-state&quot;\n  }\n}\"><pre class=\"notranslate\"><span class=\"pl-en\">remote_state</span> {\n  backend <span class=\"pl-k\">=</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>kubernetes<span class=\"pl-pds\">\"</span></span>\n\n  generate <span class=\"pl-k\">=</span> {\n    path      <span class=\"pl-k\">=</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>backend.tf<span class=\"pl-pds\">\"</span></span>\n    if_exists <span class=\"pl-k\">=</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>overwrite_terragrunt<span class=\"pl-pds\">\"</span></span>\n  }\n\n  config <span class=\"pl-k\">=</span> {\n    config_path      <span class=\"pl-k\">=</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>~/.kube/config<span class=\"pl-pds\">\"</span></span>\n    secret_suffix    <span class=\"pl-k\">=</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span><span class=\"pl-k\">${</span><span class=\"pl-c1\">replace</span>(<span class=\"pl-v\">path_relative_to_include</span>(), <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>/<span class=\"pl-pds\">\"</span></span>, <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>-<span class=\"pl-pds\">\"</span></span>)<span class=\"pl-k\">}</span>-state<span class=\"pl-pds\">\"</span></span>\n  }\n}</pre></div>"}}} />

</CenterLayout>
  

<!-- ##DOCS-SOURCER-START
{
  "sourcePlugin": "github-discussions",
  "hash": "43d66f2354921f22b0e166a80da7d1db"
}
##DOCS-SOURCER-END -->

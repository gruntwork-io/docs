---
hide_table_of_contents: true
hide_title: true
custom_edit_url: null
---

import CenterLayout from "/src/components/CenterLayout"
import GitHub from "/src/components/GitHub"

<head>
  <link rel="canonical" href="https://github.com/gruntwork-io/knowledge-base/discussions/729" />
</head>

<CenterLayout>
<span className="searchCategory">Knowledge Base</span>
<h1>S3 backend (terraform state file), versioning disabled</h1>
<GitHub discussion={{"id":"D_kwDOF8slf84AUG6J","number":729,"author":{"login":"gberlot-luna"},"title":"S3 backend (terraform state file), versioning disabled","body":"\nIs there any specific reason why all S3 buckets that stores terraform state files in Ref Arch got versioning disabling ? \r\nGot versioning enabling is part of the best practices to prevent accidental data loss and keep history.\r\n\r\nPlaning to run an aws-vault command that enable versioning in all S3 buckets that stores terraform state files, Is there any other approach ? Couldn't find a way to enable it directly from the backend.tf file.\r\n\r\nThanks!!!!\n\n---\n\n<ins datetime=\"2023-06-06T16:22:01Z\">\n  <p><a href=\"https://support.gruntwork.io/hc/requests/110233\">Tracked in ticket #110233</a></p>\n</ins>\n","bodyHTML":"<p dir=\"auto\">Is there any specific reason why all S3 buckets that stores terraform state files in Ref Arch got versioning disabling ?<br>\nGot versioning enabling is part of the best practices to prevent accidental data loss and keep history.</p>\n<p dir=\"auto\">Planing to run an aws-vault command that enable versioning in all S3 buckets that stores terraform state files, Is there any other approach ? Couldn't find a way to enable it directly from the backend.tf file.</p>\n<p dir=\"auto\">Thanks!!!!</p>\n<hr>\n<ins datetime=\"2023-06-06T16:22:01Z\">\n  <p dir=\"auto\"><a href=\"https://support.gruntwork.io/hc/requests/110233\" rel=\"nofollow\">Tracked in ticket #110233</a></p>\n</ins>","answer":{"body":"Separating terragrunt from the Reference Architecture for a moment, I did this test:\r\n\r\n```\r\nterragrunt_s3_versioning $ cat terragrunt.hcl\r\nremote_state {\r\n  backend = \"s3\"\r\n  generate = {\r\n    path      = \"backend.tf\"\r\n    if_exists = \"overwrite_terragrunt\"\r\n  }\r\n  config = {\r\n    bucket = \"pete-tf-state\"\r\n    # skip_bucket_versioning = true\r\n    key = \"${path_relative_to_include()}/terraform.tfstate\"\r\n    region         = \"us-west-2\"\r\n    encrypt        = true\r\n    dynamodb_table = \"pete-tf-lock-table\"\r\n  }\r\n}\r\n\r\nterragrunt_s3_versioning $ cat main.tf\r\nresource \"null_resource\" \"test\" {\r\n  provisioner \"local-exec\" {\r\n    command = \"date\"\r\n  }\r\n}\r\n```\r\n\r\nAfter running `terragrunt plan`, my `backend.tf` file got created, and the S3 bucket got created with versioning enabled:\r\n\r\n```\r\n terragrunt_s3_versioning $ aws-vault exec sand -- aws s3api get-bucket-versioning --bucket pete-tf-state | cat\r\n{\r\n    \"Status\": \"Enabled\"\r\n}\r\n```\r\n\r\nThis leads me to think a couple of possibilities:\r\n\r\n**A newer version of terragrunt might be enabling versioning, but older ones do not (at least, not by default).**\r\n\r\nThe function `EnableVersioningForS3Bucket` was added back in 2016, so I think this leads us down the wrong path.\r\n\r\n**The Reference Architecture is explicitly turning off versioning for some reason (valid or not).**\r\n\r\nSkipping Bucket Versioning was added in [`v0.38.8`](https://github.com/gruntwork-io/terragrunt/releases/tag/v0.38.8), so if you have a terragrunt version older than this in your reference architecture, this won't apply.\r\n\r\nIn your reference architecture, the version of terragrunt is pinned in `/shared/REGION/_regional/container_images/build_deploy_runner_image.sh` on roughly line 47.\r\n\r\nI was able to turn off S3 bucket versioning by adding `skip_bucket_versioning = true` to the `config` section (see above). It worked as anticipated. Internally, it looks like a lot of reference architectures have been delivered with a terragrunt version of `v0.38.6`, so I suspect you may fall into this category, however, I do not see that `skip_bucket_versioning` configuration in our reference architectures at all.\r\n\r\n**S3 bucket versioning turned off by some other mechanism**\r\n\r\nI'm not seeing a way to set the default at an account level or via AWS organizations, although that may be possible. Of course, internal scripting to explicitly turn versioning off is possible, but that feels like a stretch to me and is unlikely.\r\n\r\n**Recommendation**\r\n\r\nAt any rate, I do think your best course of action is to leverage aws-vault and some shell scripting to turn on bucket versioning.","bodyHTML":"<p dir=\"auto\">Separating terragrunt from the Reference Architecture for a moment, I did this test:</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"terragrunt_s3_versioning $ cat terragrunt.hcl\nremote_state {\n  backend = &quot;s3&quot;\n  generate = {\n    path      = &quot;backend.tf&quot;\n    if_exists = &quot;overwrite_terragrunt&quot;\n  }\n  config = {\n    bucket = &quot;pete-tf-state&quot;\n    # skip_bucket_versioning = true\n    key = &quot;${path_relative_to_include()}/terraform.tfstate&quot;\n    region         = &quot;us-west-2&quot;\n    encrypt        = true\n    dynamodb_table = &quot;pete-tf-lock-table&quot;\n  }\n}\n\nterragrunt_s3_versioning $ cat main.tf\nresource &quot;null_resource&quot; &quot;test&quot; {\n  provisioner &quot;local-exec&quot; {\n    command = &quot;date&quot;\n  }\n}\"><pre class=\"notranslate\"><code class=\"notranslate\">terragrunt_s3_versioning $ cat terragrunt.hcl\nremote_state {\n  backend = \"s3\"\n  generate = {\n    path      = \"backend.tf\"\n    if_exists = \"overwrite_terragrunt\"\n  }\n  config = {\n    bucket = \"pete-tf-state\"\n    # skip_bucket_versioning = true\n    key = \"${path_relative_to_include()}/terraform.tfstate\"\n    region         = \"us-west-2\"\n    encrypt        = true\n    dynamodb_table = \"pete-tf-lock-table\"\n  }\n}\n\nterragrunt_s3_versioning $ cat main.tf\nresource \"null_resource\" \"test\" {\n  provisioner \"local-exec\" {\n    command = \"date\"\n  }\n}\n</code></pre></div>\n<p dir=\"auto\">After running <code class=\"notranslate\">terragrunt plan</code>, my <code class=\"notranslate\">backend.tf</code> file got created, and the S3 bucket got created with versioning enabled:</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\" terragrunt_s3_versioning $ aws-vault exec sand -- aws s3api get-bucket-versioning --bucket pete-tf-state | cat\n{\n    &quot;Status&quot;: &quot;Enabled&quot;\n}\"><pre class=\"notranslate\"><code class=\"notranslate\"> terragrunt_s3_versioning $ aws-vault exec sand -- aws s3api get-bucket-versioning --bucket pete-tf-state | cat\n{\n    \"Status\": \"Enabled\"\n}\n</code></pre></div>\n<p dir=\"auto\">This leads me to think a couple of possibilities:</p>\n<p dir=\"auto\"><strong>A newer version of terragrunt might be enabling versioning, but older ones do not (at least, not by default).</strong></p>\n<p dir=\"auto\">The function <code class=\"notranslate\">EnableVersioningForS3Bucket</code> was added back in 2016, so I think this leads us down the wrong path.</p>\n<p dir=\"auto\"><strong>The Reference Architecture is explicitly turning off versioning for some reason (valid or not).</strong></p>\n<p dir=\"auto\">Skipping Bucket Versioning was added in <a href=\"https://github.com/gruntwork-io/terragrunt/releases/tag/v0.38.8\"><code class=\"notranslate\">v0.38.8</code></a>, so if you have a terragrunt version older than this in your reference architecture, this won't apply.</p>\n<p dir=\"auto\">In your reference architecture, the version of terragrunt is pinned in <code class=\"notranslate\">/shared/REGION/_regional/container_images/build_deploy_runner_image.sh</code> on roughly line 47.</p>\n<p dir=\"auto\">I was able to turn off S3 bucket versioning by adding <code class=\"notranslate\">skip_bucket_versioning = true</code> to the <code class=\"notranslate\">config</code> section (see above). It worked as anticipated. Internally, it looks like a lot of reference architectures have been delivered with a terragrunt version of <code class=\"notranslate\">v0.38.6</code>, so I suspect you may fall into this category, however, I do not see that <code class=\"notranslate\">skip_bucket_versioning</code> configuration in our reference architectures at all.</p>\n<p dir=\"auto\"><strong>S3 bucket versioning turned off by some other mechanism</strong></p>\n<p dir=\"auto\">I'm not seeing a way to set the default at an account level or via AWS organizations, although that may be possible. Of course, internal scripting to explicitly turn versioning off is possible, but that feels like a stretch to me and is unlikely.</p>\n<p dir=\"auto\"><strong>Recommendation</strong></p>\n<p dir=\"auto\">At any rate, I do think your best course of action is to leverage aws-vault and some shell scripting to turn on bucket versioning.</p>"}}} />

</CenterLayout>

<!-- ##DOCS-SOURCER-START
{
  "sourcePlugin": "github-discussions",
  "hash": "d75e0c5365ede8c2c545172b79ddcc8c"
}
##DOCS-SOURCER-END -->

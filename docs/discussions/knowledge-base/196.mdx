---
hide_table_of_contents: true
hide_title: true
custom_edit_url: null
---

import CenterLayout from "/src/components/CenterLayout"
import GitHub from "/src/components/GitHub"

<CenterLayout>
<span className="searchCategory">Knowledge Base</span>
<h1>AWS CNI Prefix not propagated to nodes</h1>
<GitHub discussion={{"id":"D_kwDOF8slf84AOyYo","number":196,"author":{"login":"ina-stoyanova"},"title":"AWS CNI Prefix not propagated to nodes","body":"**_Issue as reported by user:_** \r\n- having issue with aws cni prefix support.\r\n- Created new ami based on service catalog 0.75.0\r\n- updated eks-cluster terragrunt.hcl to 07.50 (terragrunt apply)  (using MacOS and default python version\r\n\r\n```\r\n$ python -V\r\nPython 2.7.18\r\n```\r\n- issued kubergrunt eks sync-core-components\r\n\r\n```\r\n$ kubergrunt -v\r\nkubergrunt version v0.8.0\r\n```\r\n- I see that EKS worker supports 110 node\r\n- but it seems prefix delagation is not set true in  aws-node. \r\n- created nginx deployment with 80 replicas and all are failed:\r\n```\r\n  Warning  FailedCreatePodSandBox  2m14s (x239 over 11m)  kubelet            (combined from similar events): Failed to create pod sandbox: rpc error: code = Unknown desc = failed to set up sandbox container \"96bee0c11c960eab5b6de6d881d9e092ffef9cd07c7c4a3b02de256902e375b0\" network for pod \"nginx-deployment-6c8f99b66f-79rlj\": networkPlugin cni failed to set up pod \"nginx-deployment-6c8f99b66f-79rlj_default\" network: add cmd: failed to assign an IP address to container \r\n\r\n$ kubectl describe pod -n kube-system aws-node\r\nReadiness:  exec [/app/grpc-health-probe -addr=:50051] delay=1s timeout=1s period=10s #success=1 #failure=3\r\n    Environment:\r\n      ADDITIONAL_ENI_TAGS:                 {}\r\n      AWS_VPC_CNI_NODE_PORT_SUPPORT:       true\r\n      AWS_VPC_ENI_MTU:                     9001\r\n      AWS_VPC_K8S_CNI_CONFIGURE_RPFILTER:  false\r\n      AWS_VPC_K8S_CNI_CUSTOM_NETWORK_CFG:  false\r\n      AWS_VPC_K8S_CNI_EXTERNALSNAT:        false\r\n      AWS_VPC_K8S_CNI_LOGLEVEL:            DEBUG\r\n      AWS_VPC_K8S_CNI_LOG_FILE:            /host/var/log/aws-routed-eni/ipamd.log\r\n      AWS_VPC_K8S_CNI_RANDOMIZESNAT:       prng\r\n      AWS_VPC_K8S_CNI_VETHPREFIX:          eni\r\n      AWS_VPC_K8S_PLUGIN_LOG_FILE:         /var/log/aws-routed-eni/plugin.log\r\n      AWS_VPC_K8S_PLUGIN_LOG_LEVEL:        DEBUG\r\n      DISABLE_INTROSPECTION:               false\r\n      DISABLE_METRICS:                     false\r\n      ENABLE_POD_ENI:                      false\r\n      ENABLE_PREFIX_DELEGATION:            false\r\n      MY_NODE_NAME:                         (v1:spec.nodeName)\r\n      WARM_ENI_TARGET:                     1\r\n      WARM_PREFIX_TARGET:                  1\r\n    Mounts:\r\n```\r\n```\r\n # module.eks_cluster.null_resource.customize_aws_vpc_cni[0] will be created\r\n  + resource \"null_resource\" \"customize_aws_vpc_cni\" {\r\n      + id       = (known after apply)\r\n      + triggers = {\r\n          + \"eks_cluster_endpoint\"           = \"https://xyz.gr7.eu-west-1.eks.amazonaws.com/\"\r\n          + \"enable_prefix_delegation\"       = \"true\"\r\n          + \"sync_core_components_action_id\" = \"1670507111626965214\"\r\n        }\r\n    }\r\n```\r\n    \r\n- It seems user-data updated but not aws-node deployment.\r\n \r\n ``` From: https://alestic.com/2010/12/ec2-user-data-output/\r\n exec > >(tee /var/log/user-data.log|logger -t user-data -s 2>/dev/console) 2>&1\r\n\r\n # Include common functions\r\n source /etc/user-data/user-data-common.sh\r\n\r\nfunction configure_eks_instance {\r\n  local -r aws_region=\"$1\"\r\n  local -r eks_cluster_name=\"$2\"\r\n  local -r eks_endpoint=\"$3\"\r\n  local -r eks_certificate_authority=\"$4\"\r\n\r\n  local -r node_labels=\"$(map-ec2-tags-to-node-labels)\"\r\n\r\n  start_fail2ban\r\n\r\n  \r\n  local max_pods\r\n  max_pods=\"$(/etc/eks/max-pods-calculator.sh --instance-type-from-imds --cni-version 1.9.0-eksbuild.1 --cni-prefix-delegation-enabled)\"\r\n  \r\n\r\n  echo \"Running eks bootstrap script to register instance to cluster\"\r\n  /etc/eks/bootstrap.sh \\\r\n    --apiserver-endpoint \"$eks_endpoint\" \\\r\n    --b64-cluster-ca \"$eks_certificate_authority\" \\\r\n    --kubelet-extra-args \"--node-labels=\\\"$node_labels\\\" --max-pods=$max_pods \" \\\r\n        --use-max-pods false \\\r\n         \"$eks_cluster_name\"\r\n}\r\n```\r\n```\r\n$ kubectl describe node ip-10-4-90-172.eu-west-1.compute.internal\r\nAllocatable:\r\n  attachable-volumes-aws-ebs:  25\r\n  cpu:                         1930m\r\n  ephemeral-storage:           37569620724\r\n  hugepages-1Gi:               0\r\n  hugepages-2Mi:               0\r\n  memory:                      3412448Ki\r\n  pods:                        110\r\n```","bodyHTML":"<p dir=\"auto\"><strong><em>Issue as reported by user:</em></strong></p>\n<ul dir=\"auto\">\n<li>having issue with aws cni prefix support.</li>\n<li>Created new ami based on service catalog 0.75.0</li>\n<li>updated eks-cluster terragrunt.hcl to 07.50 (terragrunt apply)  (using MacOS and default python version</li>\n</ul>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"$ python -V\nPython 2.7.18\"><pre class=\"notranslate\"><code>$ python -V\nPython 2.7.18\n</code></pre></div>\n<ul dir=\"auto\">\n<li>issued kubergrunt eks sync-core-components</li>\n</ul>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"$ kubergrunt -v\nkubergrunt version v0.8.0\"><pre class=\"notranslate\"><code>$ kubergrunt -v\nkubergrunt version v0.8.0\n</code></pre></div>\n<ul dir=\"auto\">\n<li>I see that EKS worker supports 110 node</li>\n<li>but it seems prefix delagation is not set true in  aws-node.</li>\n<li>created nginx deployment with 80 replicas and all are failed:</li>\n</ul>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"  Warning  FailedCreatePodSandBox  2m14s (x239 over 11m)  kubelet            (combined from similar events): Failed to create pod sandbox: rpc error: code = Unknown desc = failed to set up sandbox container &quot;96bee0c11c960eab5b6de6d881d9e092ffef9cd07c7c4a3b02de256902e375b0&quot; network for pod &quot;nginx-deployment-6c8f99b66f-79rlj&quot;: networkPlugin cni failed to set up pod &quot;nginx-deployment-6c8f99b66f-79rlj_default&quot; network: add cmd: failed to assign an IP address to container \n\n$ kubectl describe pod -n kube-system aws-node\nReadiness:  exec [/app/grpc-health-probe -addr=:50051] delay=1s timeout=1s period=10s #success=1 #failure=3\n    Environment:\n      ADDITIONAL_ENI_TAGS:                 {}\n      AWS_VPC_CNI_NODE_PORT_SUPPORT:       true\n      AWS_VPC_ENI_MTU:                     9001\n      AWS_VPC_K8S_CNI_CONFIGURE_RPFILTER:  false\n      AWS_VPC_K8S_CNI_CUSTOM_NETWORK_CFG:  false\n      AWS_VPC_K8S_CNI_EXTERNALSNAT:        false\n      AWS_VPC_K8S_CNI_LOGLEVEL:            DEBUG\n      AWS_VPC_K8S_CNI_LOG_FILE:            /host/var/log/aws-routed-eni/ipamd.log\n      AWS_VPC_K8S_CNI_RANDOMIZESNAT:       prng\n      AWS_VPC_K8S_CNI_VETHPREFIX:          eni\n      AWS_VPC_K8S_PLUGIN_LOG_FILE:         /var/log/aws-routed-eni/plugin.log\n      AWS_VPC_K8S_PLUGIN_LOG_LEVEL:        DEBUG\n      DISABLE_INTROSPECTION:               false\n      DISABLE_METRICS:                     false\n      ENABLE_POD_ENI:                      false\n      ENABLE_PREFIX_DELEGATION:            false\n      MY_NODE_NAME:                         (v1:spec.nodeName)\n      WARM_ENI_TARGET:                     1\n      WARM_PREFIX_TARGET:                  1\n    Mounts:\"><pre class=\"notranslate\"><code>  Warning  FailedCreatePodSandBox  2m14s (x239 over 11m)  kubelet            (combined from similar events): Failed to create pod sandbox: rpc error: code = Unknown desc = failed to set up sandbox container \"96bee0c11c960eab5b6de6d881d9e092ffef9cd07c7c4a3b02de256902e375b0\" network for pod \"nginx-deployment-6c8f99b66f-79rlj\": networkPlugin cni failed to set up pod \"nginx-deployment-6c8f99b66f-79rlj_default\" network: add cmd: failed to assign an IP address to container \n\n$ kubectl describe pod -n kube-system aws-node\nReadiness:  exec [/app/grpc-health-probe -addr=:50051] delay=1s timeout=1s period=10s #success=1 #failure=3\n    Environment:\n      ADDITIONAL_ENI_TAGS:                 {}\n      AWS_VPC_CNI_NODE_PORT_SUPPORT:       true\n      AWS_VPC_ENI_MTU:                     9001\n      AWS_VPC_K8S_CNI_CONFIGURE_RPFILTER:  false\n      AWS_VPC_K8S_CNI_CUSTOM_NETWORK_CFG:  false\n      AWS_VPC_K8S_CNI_EXTERNALSNAT:        false\n      AWS_VPC_K8S_CNI_LOGLEVEL:            DEBUG\n      AWS_VPC_K8S_CNI_LOG_FILE:            /host/var/log/aws-routed-eni/ipamd.log\n      AWS_VPC_K8S_CNI_RANDOMIZESNAT:       prng\n      AWS_VPC_K8S_CNI_VETHPREFIX:          eni\n      AWS_VPC_K8S_PLUGIN_LOG_FILE:         /var/log/aws-routed-eni/plugin.log\n      AWS_VPC_K8S_PLUGIN_LOG_LEVEL:        DEBUG\n      DISABLE_INTROSPECTION:               false\n      DISABLE_METRICS:                     false\n      ENABLE_POD_ENI:                      false\n      ENABLE_PREFIX_DELEGATION:            false\n      MY_NODE_NAME:                         (v1:spec.nodeName)\n      WARM_ENI_TARGET:                     1\n      WARM_PREFIX_TARGET:                  1\n    Mounts:\n</code></pre></div>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\" # module.eks_cluster.null_resource.customize_aws_vpc_cni[0] will be created\n  + resource &quot;null_resource&quot; &quot;customize_aws_vpc_cni&quot; {\n      + id       = (known after apply)\n      + triggers = {\n          + &quot;eks_cluster_endpoint&quot;           = &quot;https://xyz.gr7.eu-west-1.eks.amazonaws.com/&quot;\n          + &quot;enable_prefix_delegation&quot;       = &quot;true&quot;\n          + &quot;sync_core_components_action_id&quot; = &quot;1670507111626965214&quot;\n        }\n    }\"><pre class=\"notranslate\"><code> # module.eks_cluster.null_resource.customize_aws_vpc_cni[0] will be created\n  + resource \"null_resource\" \"customize_aws_vpc_cni\" {\n      + id       = (known after apply)\n      + triggers = {\n          + \"eks_cluster_endpoint\"           = \"https://xyz.gr7.eu-west-1.eks.amazonaws.com/\"\n          + \"enable_prefix_delegation\"       = \"true\"\n          + \"sync_core_components_action_id\" = \"1670507111626965214\"\n        }\n    }\n</code></pre></div>\n<ul dir=\"auto\">\n<li>It seems user-data updated but not aws-node deployment.</li>\n</ul>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"exec &gt; &gt;(tee /var/log/user-data.log|logger -t user-data -s 2&gt;/dev/console) 2&gt;&amp;1\n\n# Include common functions\nsource /etc/user-data/user-data-common.sh\n\nfunction configure_eks_instance {\n local -r aws_region=&quot;$1&quot;\n local -r eks_cluster_name=&quot;$2&quot;\n local -r eks_endpoint=&quot;$3&quot;\n local -r eks_certificate_authority=&quot;$4&quot;\n\n local -r node_labels=&quot;$(map-ec2-tags-to-node-labels)&quot;\n\n start_fail2ban\n\n \n local max_pods\n max_pods=&quot;$(/etc/eks/max-pods-calculator.sh --instance-type-from-imds --cni-version 1.9.0-eksbuild.1 --cni-prefix-delegation-enabled)&quot;\n \n\n echo &quot;Running eks bootstrap script to register instance to cluster&quot;\n /etc/eks/bootstrap.sh \\\n   --apiserver-endpoint &quot;$eks_endpoint&quot; \\\n   --b64-cluster-ca &quot;$eks_certificate_authority&quot; \\\n   --kubelet-extra-args &quot;--node-labels=\\&quot;$node_labels\\&quot; --max-pods=$max_pods &quot; \\\n       --use-max-pods false \\\n        &quot;$eks_cluster_name&quot;\n}\"><pre lang=\"From:\" class=\"notranslate\"><code>exec &gt; &gt;(tee /var/log/user-data.log|logger -t user-data -s 2&gt;/dev/console) 2&gt;&amp;1\n\n# Include common functions\nsource /etc/user-data/user-data-common.sh\n\nfunction configure_eks_instance {\n local -r aws_region=\"$1\"\n local -r eks_cluster_name=\"$2\"\n local -r eks_endpoint=\"$3\"\n local -r eks_certificate_authority=\"$4\"\n\n local -r node_labels=\"$(map-ec2-tags-to-node-labels)\"\n\n start_fail2ban\n\n \n local max_pods\n max_pods=\"$(/etc/eks/max-pods-calculator.sh --instance-type-from-imds --cni-version 1.9.0-eksbuild.1 --cni-prefix-delegation-enabled)\"\n \n\n echo \"Running eks bootstrap script to register instance to cluster\"\n /etc/eks/bootstrap.sh \\\n   --apiserver-endpoint \"$eks_endpoint\" \\\n   --b64-cluster-ca \"$eks_certificate_authority\" \\\n   --kubelet-extra-args \"--node-labels=\\\"$node_labels\\\" --max-pods=$max_pods \" \\\n       --use-max-pods false \\\n        \"$eks_cluster_name\"\n}\n</code></pre></div>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"$ kubectl describe node ip-10-4-90-172.eu-west-1.compute.internal\nAllocatable:\n  attachable-volumes-aws-ebs:  25\n  cpu:                         1930m\n  ephemeral-storage:           37569620724\n  hugepages-1Gi:               0\n  hugepages-2Mi:               0\n  memory:                      3412448Ki\n  pods:                        110\"><pre class=\"notranslate\"><code>$ kubectl describe node ip-10-4-90-172.eu-west-1.compute.internal\nAllocatable:\n  attachable-volumes-aws-ebs:  25\n  cpu:                         1930m\n  ephemeral-storage:           37569620724\n  hugepages-1Gi:               0\n  hugepages-2Mi:               0\n  memory:                      3412448Ki\n  pods:                        110\n</code></pre></div>","answer":{"body":"The issue here is that you ran `kubergrunt eks sync-core-components` manually, instead of relying on the module. Due to the way the `aws-vpc-cni` is managed and how the prefix delegation is enabled, each run of `kubergrunt eks sync-core-components` ends up resetting the `aws-vpc-cni` daemonset to the default initial settings (where prefix delegation is not enabled). So when you manually ran the command, it reset the settings to disable it.\r\n\r\nIn the module, we work around this by running `kubergrunt eks sync-core-components` first, and then updating the daemonset with the relevant environment variables.\r\n\r\nYou can reset this back by doing the following:\r\n\r\n- First, run `terragrunt apply` or `terraform apply` with the variable `vpc_cni_enable_prefix_delegation = false`. This will reset the terraform state to ensure that it is in sync with the current state where prefix delegation is disabled.\r\n- Next, run `terragrunt apply` or `terraform apply` again with the variable `vpc_cni_enable_prefix_delegation = true`. This will trigger the terraform `local-exec` call to set the environment variables to prefix delegation mode turned on.","bodyHTML":"<p dir=\"auto\">The issue here is that you ran <code class=\"notranslate\">kubergrunt eks sync-core-components</code> manually, instead of relying on the module. Due to the way the <code class=\"notranslate\">aws-vpc-cni</code> is managed and how the prefix delegation is enabled, each run of <code class=\"notranslate\">kubergrunt eks sync-core-components</code> ends up resetting the <code class=\"notranslate\">aws-vpc-cni</code> daemonset to the default initial settings (where prefix delegation is not enabled). So when you manually ran the command, it reset the settings to disable it.</p>\n<p dir=\"auto\">In the module, we work around this by running <code class=\"notranslate\">kubergrunt eks sync-core-components</code> first, and then updating the daemonset with the relevant environment variables.</p>\n<p dir=\"auto\">You can reset this back by doing the following:</p>\n<ul dir=\"auto\">\n<li>First, run <code class=\"notranslate\">terragrunt apply</code> or <code class=\"notranslate\">terraform apply</code> with the variable <code class=\"notranslate\">vpc_cni_enable_prefix_delegation = false</code>. This will reset the terraform state to ensure that it is in sync with the current state where prefix delegation is disabled.</li>\n<li>Next, run <code class=\"notranslate\">terragrunt apply</code> or <code class=\"notranslate\">terraform apply</code> again with the variable <code class=\"notranslate\">vpc_cni_enable_prefix_delegation = true</code>. This will trigger the terraform <code class=\"notranslate\">local-exec</code> call to set the environment variables to prefix delegation mode turned on.</li>\n</ul>"}}} />

</CenterLayout>
  

<!-- ##DOCS-SOURCER-START
{
  "sourcePlugin": "github-discussions",
  "hash": "150f6d661eec45ce7b8a62974f0eaaf3"
}
##DOCS-SOURCER-END -->

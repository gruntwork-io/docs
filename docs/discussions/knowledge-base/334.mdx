---
hide_table_of_contents: true
hide_title: true
custom_edit_url: null
---

import CenterLayout from "/src/components/CenterLayout"
import GitHub from "/src/components/GitHub"

<CenterLayout>
<span className="searchCategory">Knowledge Base</span>
<h1>ECS Deploy Runner: How to update the regex that guards against unauthorized repositories</h1>
<GitHub discussion={{"id":"D_kwDOF8slf84APNv6","number":334,"author":{"login":"zackproser"},"title":"ECS Deploy Runner: How to update the regex that guards against unauthorized repositories","body":"A customer asked: \r\n> I'm encountering the following error when attempting to run a plan or apply job through Gruntwork Pipelines: \r\n\r\n```\r\nERROR: OptionRegexRestrictedError: Provided value for option repo (<repo>) does not match regex (regex). \r\n```","bodyHTML":"<p dir=\"auto\">A customer asked:</p>\n<blockquote>\n<p dir=\"auto\">I'm encountering the following error when attempting to run a plan or apply job through Gruntwork Pipelines:</p>\n</blockquote>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"ERROR: OptionRegexRestrictedError: Provided value for option repo (&lt;repo&gt;) does not match regex (regex). \"><pre class=\"notranslate\"><code>ERROR: OptionRegexRestrictedError: Provided value for option repo (&lt;repo&gt;) does not match regex (regex). \n</code></pre></div>","answer":{"body":"## Overview\r\n\r\nThe Gruntwork Reference Architecture version 2.0 and above comes with Gruntwork Pipelines configured for use. In the following diagram, the box labeled `Deployment Lambda Function` refers to a Lambda that ensures only pre-authorized repositories are being used as inputs to Terraform plan and apply jobs in your CI/CD pipeline. \r\n\r\n![gw-pipelines-schematic](https://user-images.githubusercontent.com/1769996/161820180-1f86a490-ce62-46c9-b381-b69b75d47c14.png)\r\n\r\nThis Lambda function determines which repositories are allowed as sources by way of a Regular Expression that can be optionally passed into the Lambda when deploying Gruntwork Pipelines. To learn more about the security mitigations that Gruntwork Pipelines implements, [see this guide](https://docs.gruntwork.io/guides/build-it-yourself/pipelines/production-grade-design/summary-of-mitigations).\r\n\r\nOccasionally, depending on  your current and intended VCS hosting platform for your infrastructure-live repository, you may find it necessary to update this regex in order to allow new repositories to function as authorized sources for your CI/CD pipeline. \r\n\r\n## Finding the configuration\r\n\r\nThe configuration that determines which repositories are allowed to initiate ECS Deploy Runner plan or apply jobs is managed [here](https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/master/examples/for-production/infrastructure-live/_envcommon/mgmt/ecs-deploy-runner.hcl), in the ECS Deploy Runner configuration under `_envcommon`. \r\n\r\nSpecifically, there are two inputs to the `ecs-deploy-runner.hcl` file to be aware of when attempting to modify which repositories the ECS Deploy Runner is authorized to operate on: \r\n\r\n* [`infrastructure_live_repositories`](https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/master/examples/for-production/infrastructure-live/_envcommon/mgmt/ecs-deploy-runner.hcl#L146)\r\n* [`infrastructure_live_repositories_regex`](https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/master/examples/for-production/infrastructure-live/_envcommon/mgmt/ecs-deploy-runner.hcl#L147)\r\n\r\nThese inputs correspond to the service catalog's ecs-deploy-runner module's variables: \r\n\r\n[`terraform_planner_config`](https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/443161f292/modules/mgmt/ecs-deploy-runner/variables.tf#L170)\r\n  * [`infrastructure_live_repositories`](https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/443161f292/modules/mgmt/ecs-deploy-runner/variables.tf#L207)\r\n  * [`infrastructure_live_repositories_regex`](https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/443161f292/modules/mgmt/ecs-deploy-runner/variables.tf#L213)\r\n\r\nand \r\n\r\n[`terraform_applier_config`](https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/443161f292/modules/mgmt/ecs-deploy-runner/variables.tf#L248)\r\n  * [`infrastructure_live_repositories`](https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/443161f292/modules/mgmt/ecs-deploy-runner/variables.tf#L285)\r\n  * [`infrastructure_live_repositories_regex`](https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/443161f292/modules/mgmt/ecs-deploy-runner/variables.tf#L291)\r\n\r\nThese variables in turn are fed into the service catalog's ECS Deploy Runner module's `standard_config` module, which sets up the ECS Deploy Runner's configuration:\r\n* [`terraform_planner`](https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/443161f2922c5376183777686fdf18e712e634e6/modules/mgmt/ecs-deploy-runner/main.tf#L158-L159)\r\n* [`terraform_applier`](https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/443161f2922c5376183777686fdf18e712e634e6/modules/mgmt/ecs-deploy-runner/main.tf#L213-L214)\r\n\r\nWithin the [`terraform-aws-ci`'s `ecs-deploy-runner-standard-configuration` module](), these inputs are then [combined here](https://github.com/gruntwork-io/terraform-aws-ci/blob/5f2b4e46b7a7b122b70cc7adc6933cfd2429f3f4/modules/ecs-deploy-runner-standard-configuration/main.tf#L198-L393) into one single merged regex twice. \r\n- Once for the terraform plan job's configuration and lambda regex [here](https://github.com/gruntwork-io/terraform-aws-ci/blob/5f2b4e46b7a7b122b70cc7adc6933cfd2429f3f4/modules/ecs-deploy-runner-standard-configuration/main.tf#L198-L291),\r\n- and once for the terraform apply job's configuration and lambda regex [here](https://github.com/gruntwork-io/terraform-aws-ci/blob/5f2b4e46b7a7b122b70cc7adc6933cfd2429f3f4/modules/ecs-deploy-runner-standard-configuration/main.tf#L293-L393)\r\n\r\nTherefore, if you wanted to add a regex, which all repositories that match will be allowed as a source for a Terragrunt plan job, you would do so [here](https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/443161f2922c5376183777686fdf18e712e634e6/examples/for-production/infrastructure-live/_envcommon/mgmt/ecs-deploy-runner.hcl#L147), in the `terraform_planner_config's` `infrastructure_live_repositories_regex` list. \r\n\r\nLikewise, if you wanted to add a regex, which all repositories that match will be allowed as a source for a Terragrunt apply job, you would do so [here](https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/443161f2922c5376183777686fdf18e712e634e6/examples/for-production/infrastructure-live/_envcommon/mgmt/ecs-deploy-runner.hcl#L165) in the `terraform_applier_config's` `infrastructure_live_repositories_regex` list.\r\n\r\nWith those changes in place, either running a `terragrunt plan` when authenticated to any child environment in your infrastructure-live will result in a similar update to the following: \r\n\r\n```\r\nTerraform used the selected providers to generate the following execution\r\nplan. Resource actions are indicated with the following symbols:\r\n  ~ update in-place\r\n\r\nTerraform will perform the following actions:\r\n\r\n  # module.ecs_deploy_runner.module.deploy_runner_invoker_lambda.aws_lambda_function.function[0] will be updated in-place\r\n  ~ resource \"aws_lambda_function\" \"function\" {\r\n        id                             = \"ecs-deploy-runner-invoker\"\r\n      ~ last_modified                  = \"2022-03-31T14:19:30.000+0000\" -> (known after apply)\r\n      ~ source_code_hash               = \"OFt3Jd0Eb6Ii+XGS23s98+rPc=\" -> \"E5IInM2OFEjQoaImSF51FogZzdY+bQYCCs=\"\r\n        tags                           = {}\r\n        # (19 unchanged attributes hidden)\r\n\r\n```\r\n\r\nThe reason we expect to see the deploy runner invoker lambda's `source_code_hash` planned to be updated in place, is that this lamdba function is a component of the ECS Deploy Runner system, which guards against unauthorized or malicious CI/CD runs by using its regex, which we've now just re-configured, to reject any requests associated with unauthorized repositories.\r\n\r\n*N.B*:  there is an ECS Deploy Runner in each of your accounts, so be sure to run `terragrunt apply` in your local `ecs-deploy-runner` folder, for every account in your Reference Architecture. Be sure to authenticate to the correct account when applying your changes.\r\n\r\n## How do I view the source code of the Lambda being used to guard against unauthorized repositories?\r\n\r\nLog into one of the accounts in your Ref Arch and visit the Lambda UI. Ensure you are viewing the correct Primary Region in AWS where you requested that your Ref Arch be deployed. \r\n\r\nFind the Lambda named `ecs-deploy-runner-invoker-lambda`, then click Configuration -> Environment variables in the UI. Find the Environment variable named `BASE64GZ_CONFIG_DATA_JSON` and copy its entire value to your clipboard. \r\n\r\nNext, run the following command. Note that you will first need the following tools installed on your system: \r\n* base64\r\n* gzip\r\n* jq\r\n* \r\n\r\n`echo \"<the contents of BASE64GZ_CONFIG_DATA_JSON that you copied>\" | base64 --decode | gzip -d | jq` ","bodyHTML":"<h2 dir=\"auto\">Overview</h2>\n<p dir=\"auto\">The Gruntwork Reference Architecture version 2.0 and above comes with Gruntwork Pipelines configured for use. In the following diagram, the box labeled <code class=\"notranslate\">Deployment Lambda Function</code> refers to a Lambda that ensures only pre-authorized repositories are being used as inputs to Terraform plan and apply jobs in your CI/CD pipeline.</p>\n<p dir=\"auto\"><a target=\"_blank\" rel=\"noopener noreferrer nofollow\" href=\"https://user-images.githubusercontent.com/1769996/161820180-1f86a490-ce62-46c9-b381-b69b75d47c14.png\"><img src=\"https://user-images.githubusercontent.com/1769996/161820180-1f86a490-ce62-46c9-b381-b69b75d47c14.png\" alt=\"gw-pipelines-schematic\" style=\"max-width: 100%;\"></a></p>\n<p dir=\"auto\">This Lambda function determines which repositories are allowed as sources by way of a Regular Expression that can be optionally passed into the Lambda when deploying Gruntwork Pipelines. To learn more about the security mitigations that Gruntwork Pipelines implements, <a href=\"https://docs.gruntwork.io/guides/build-it-yourself/pipelines/production-grade-design/summary-of-mitigations\" rel=\"nofollow\">see this guide</a>.</p>\n<p dir=\"auto\">Occasionally, depending on  your current and intended VCS hosting platform for your infrastructure-live repository, you may find it necessary to update this regex in order to allow new repositories to function as authorized sources for your CI/CD pipeline.</p>\n<h2 dir=\"auto\">Finding the configuration</h2>\n<p dir=\"auto\">The configuration that determines which repositories are allowed to initiate ECS Deploy Runner plan or apply jobs is managed <a href=\"https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/master/examples/for-production/infrastructure-live/_envcommon/mgmt/ecs-deploy-runner.hcl\">here</a>, in the ECS Deploy Runner configuration under <code class=\"notranslate\">_envcommon</code>.</p>\n<p dir=\"auto\">Specifically, there are two inputs to the <code class=\"notranslate\">ecs-deploy-runner.hcl</code> file to be aware of when attempting to modify which repositories the ECS Deploy Runner is authorized to operate on:</p>\n<ul dir=\"auto\">\n<li><a href=\"https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/master/examples/for-production/infrastructure-live/_envcommon/mgmt/ecs-deploy-runner.hcl#L146\"><code class=\"notranslate\">infrastructure_live_repositories</code></a></li>\n<li><a href=\"https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/master/examples/for-production/infrastructure-live/_envcommon/mgmt/ecs-deploy-runner.hcl#L147\"><code class=\"notranslate\">infrastructure_live_repositories_regex</code></a></li>\n</ul>\n<p dir=\"auto\">These inputs correspond to the service catalog's ecs-deploy-runner module's variables:</p>\n<p dir=\"auto\"><a href=\"https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/443161f292/modules/mgmt/ecs-deploy-runner/variables.tf#L170\"><code class=\"notranslate\">terraform_planner_config</code></a></p>\n<ul dir=\"auto\">\n<li><a href=\"https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/443161f292/modules/mgmt/ecs-deploy-runner/variables.tf#L207\"><code class=\"notranslate\">infrastructure_live_repositories</code></a></li>\n<li><a href=\"https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/443161f292/modules/mgmt/ecs-deploy-runner/variables.tf#L213\"><code class=\"notranslate\">infrastructure_live_repositories_regex</code></a></li>\n</ul>\n<p dir=\"auto\">and</p>\n<p dir=\"auto\"><a href=\"https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/443161f292/modules/mgmt/ecs-deploy-runner/variables.tf#L248\"><code class=\"notranslate\">terraform_applier_config</code></a></p>\n<ul dir=\"auto\">\n<li><a href=\"https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/443161f292/modules/mgmt/ecs-deploy-runner/variables.tf#L285\"><code class=\"notranslate\">infrastructure_live_repositories</code></a></li>\n<li><a href=\"https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/443161f292/modules/mgmt/ecs-deploy-runner/variables.tf#L291\"><code class=\"notranslate\">infrastructure_live_repositories_regex</code></a></li>\n</ul>\n<p dir=\"auto\">These variables in turn are fed into the service catalog's ECS Deploy Runner module's <code class=\"notranslate\">standard_config</code> module, which sets up the ECS Deploy Runner's configuration:</p>\n<ul dir=\"auto\">\n<li><a href=\"https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/443161f2922c5376183777686fdf18e712e634e6/modules/mgmt/ecs-deploy-runner/main.tf#L158-L159\"><code class=\"notranslate\">terraform_planner</code></a></li>\n<li><a href=\"https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/443161f2922c5376183777686fdf18e712e634e6/modules/mgmt/ecs-deploy-runner/main.tf#L213-L214\"><code class=\"notranslate\">terraform_applier</code></a></li>\n</ul>\n<p dir=\"auto\">Within the <a href=\"\"><code class=\"notranslate\">terraform-aws-ci</code>'s <code class=\"notranslate\">ecs-deploy-runner-standard-configuration</code> module</a>, these inputs are then <a href=\"https://github.com/gruntwork-io/terraform-aws-ci/blob/5f2b4e46b7a7b122b70cc7adc6933cfd2429f3f4/modules/ecs-deploy-runner-standard-configuration/main.tf#L198-L393\">combined here</a> into one single merged regex twice.</p>\n<ul dir=\"auto\">\n<li>Once for the terraform plan job's configuration and lambda regex <a href=\"https://github.com/gruntwork-io/terraform-aws-ci/blob/5f2b4e46b7a7b122b70cc7adc6933cfd2429f3f4/modules/ecs-deploy-runner-standard-configuration/main.tf#L198-L291\">here</a>,</li>\n<li>and once for the terraform apply job's configuration and lambda regex <a href=\"https://github.com/gruntwork-io/terraform-aws-ci/blob/5f2b4e46b7a7b122b70cc7adc6933cfd2429f3f4/modules/ecs-deploy-runner-standard-configuration/main.tf#L293-L393\">here</a></li>\n</ul>\n<p dir=\"auto\">Therefore, if you wanted to add a regex, which all repositories that match will be allowed as a source for a Terragrunt plan job, you would do so <a href=\"https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/443161f2922c5376183777686fdf18e712e634e6/examples/for-production/infrastructure-live/_envcommon/mgmt/ecs-deploy-runner.hcl#L147\">here</a>, in the <code class=\"notranslate\">terraform_planner_config's</code> <code class=\"notranslate\">infrastructure_live_repositories_regex</code> list.</p>\n<p dir=\"auto\">Likewise, if you wanted to add a regex, which all repositories that match will be allowed as a source for a Terragrunt apply job, you would do so <a href=\"https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/443161f2922c5376183777686fdf18e712e634e6/examples/for-production/infrastructure-live/_envcommon/mgmt/ecs-deploy-runner.hcl#L165\">here</a> in the <code class=\"notranslate\">terraform_applier_config's</code> <code class=\"notranslate\">infrastructure_live_repositories_regex</code> list.</p>\n<p dir=\"auto\">With those changes in place, either running a <code class=\"notranslate\">terragrunt plan</code> when authenticated to any child environment in your infrastructure-live will result in a similar update to the following:</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"Terraform used the selected providers to generate the following execution\nplan. Resource actions are indicated with the following symbols:\n  ~ update in-place\n\nTerraform will perform the following actions:\n\n  # module.ecs_deploy_runner.module.deploy_runner_invoker_lambda.aws_lambda_function.function[0] will be updated in-place\n  ~ resource &quot;aws_lambda_function&quot; &quot;function&quot; {\n        id                             = &quot;ecs-deploy-runner-invoker&quot;\n      ~ last_modified                  = &quot;2022-03-31T14:19:30.000+0000&quot; -&gt; (known after apply)\n      ~ source_code_hash               = &quot;OFt3Jd0Eb6Ii+XGS23s98+rPc=&quot; -&gt; &quot;E5IInM2OFEjQoaImSF51FogZzdY+bQYCCs=&quot;\n        tags                           = {}\n        # (19 unchanged attributes hidden)\n\"><pre class=\"notranslate\"><code>Terraform used the selected providers to generate the following execution\nplan. Resource actions are indicated with the following symbols:\n  ~ update in-place\n\nTerraform will perform the following actions:\n\n  # module.ecs_deploy_runner.module.deploy_runner_invoker_lambda.aws_lambda_function.function[0] will be updated in-place\n  ~ resource \"aws_lambda_function\" \"function\" {\n        id                             = \"ecs-deploy-runner-invoker\"\n      ~ last_modified                  = \"2022-03-31T14:19:30.000+0000\" -&gt; (known after apply)\n      ~ source_code_hash               = \"OFt3Jd0Eb6Ii+XGS23s98+rPc=\" -&gt; \"E5IInM2OFEjQoaImSF51FogZzdY+bQYCCs=\"\n        tags                           = {}\n        # (19 unchanged attributes hidden)\n\n</code></pre></div>\n<p dir=\"auto\">The reason we expect to see the deploy runner invoker lambda's <code class=\"notranslate\">source_code_hash</code> planned to be updated in place, is that this lamdba function is a component of the ECS Deploy Runner system, which guards against unauthorized or malicious CI/CD runs by using its regex, which we've now just re-configured, to reject any requests associated with unauthorized repositories.</p>\n<p dir=\"auto\"><em>N.B</em>:  there is an ECS Deploy Runner in each of your accounts, so be sure to run <code class=\"notranslate\">terragrunt apply</code> in your local <code class=\"notranslate\">ecs-deploy-runner</code> folder, for every account in your Reference Architecture. Be sure to authenticate to the correct account when applying your changes.</p>\n<h2 dir=\"auto\">How do I view the source code of the Lambda being used to guard against unauthorized repositories?</h2>\n<p dir=\"auto\">Log into one of the accounts in your Ref Arch and visit the Lambda UI. Ensure you are viewing the correct Primary Region in AWS where you requested that your Ref Arch be deployed.</p>\n<p dir=\"auto\">Find the Lambda named <code class=\"notranslate\">ecs-deploy-runner-invoker-lambda</code>, then click Configuration -&gt; Environment variables in the UI. Find the Environment variable named <code class=\"notranslate\">BASE64GZ_CONFIG_DATA_JSON</code> and copy its entire value to your clipboard.</p>\n<p dir=\"auto\">Next, run the following command. Note that you will first need the following tools installed on your system:</p>\n<ul dir=\"auto\">\n<li>base64</li>\n<li>gzip</li>\n<li>jq</li>\n<li></li>\n</ul>\n<p dir=\"auto\"><code class=\"notranslate\">echo \"&lt;the contents of BASE64GZ_CONFIG_DATA_JSON that you copied&gt;\" | base64 --decode | gzip -d | jq</code></p>"}}} />

</CenterLayout>
  

<!-- ##DOCS-SOURCER-START
{
  "sourcePlugin": "github-discussions",
  "hash": "bcbe64a34f3ec19639f8fc851f69760f"
}
##DOCS-SOURCER-END -->

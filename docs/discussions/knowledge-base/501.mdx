---
hide_table_of_contents: true
hide_title: true
custom_edit_url: null
---

import CenterLayout from "/src/components/CenterLayout"
import GitHub from "/src/components/GitHub"

<head>
  <link rel="canonical" href="https://github.com/gruntwork-io/knowledge-base/discussions/501" />
</head>

<CenterLayout>
<span className="searchCategory">Knowledge Base</span>
<h1>How to convert template_file to local variable</h1>
<GitHub discussion={{"id":"D_kwDOF8slf84AQE9c","number":501,"author":{"login":"erictompkins"},"title":"How to convert template_file to local variable","body":"\nI have a related question to #350. \r\n\r\nWe have the following `template_file` code that we are trying to convert to a local variable.\r\n\r\n```\r\ndata \"template_file\" \"port_mappings\" {\r\n  template = <<EOF\r\n  {\r\n    \"containerPort\": ${var.container_port},\r\n    \"hostPort\": ${var.container_port},\r\n    \"protocol\": \"tcp\"\r\n  }\r\n  EOF\r\n}\r\n```\r\n\r\nIt's used later on in \r\n```\r\nlocals {\r\n  ecs_task_container_definitions = templatefile(\r\n    \"${path.module}/container-definition/container-definition.json\",\r\n    {\r\n      container_name = var.service_name\r\n\r\n      image             = var.image\r\n      version           = var.image_version\r\n      cpu               = var.cpu\r\n      memory            = var.memory\r\n      port_mappings     = \"[${join(\",\", data.template_file.port_mappings.*.rendered)}]\"\r\n      env_vars          = \"[${join(\",\", data.template_file.all_env_vars.*.rendered)}]\"\r\n      log_group         = aws_cloudwatch_log_group.ecs_task_log_group.name\r\n      region            = var.aws_region\r\n      log_stream_prefix = \"${var.service_name}-ecs-fargate\"\r\n    }\r\n  )\r\n}\r\n```\r\n\r\nI tried changing it to a local variable as a map and as a string but I keep getting an error when running `terragrunt apply`.\r\n\r\n```\r\nError: Invalid function argument on main.tf line 225, in locals:\r\n  225:       port_mappings     = \"[${join(\",\", local.port_mappings)}]\"\r\n     ├────────────────\r\n     │ local.port_mappings is object with 3 attributes\r\n \r\n Invalid value for \"lists\" parameter: list of string required.\r\n```\r\n\r\nWe also have:\r\n\r\n```\r\ndata \"template_file\" \"all_env_vars\" {\r\n  count    = length(local.all_env_vars)\r\n  template = <<EOF\r\n{\r\n  \"name\": \"${element(keys(local.all_env_vars), count.index)}\",\r\n  \"value\": \"${lookup(local.all_env_vars, element(keys(local.all_env_vars), count.index))}\"\r\n}\r\nEOF\r\n}\r\n```\r\n\r\n`local.all_env_vars` comes from another local variable:\r\n\r\n```\r\nlocals {\r\n   all_env_vars = merge(local.default_env_vars, var.extra_env_vars)\r\n}\r\n```\r\n\r\nThis gets used in a similar way as the other template file in `\"[${join(\",\", data.template_file.all_env_vars.*.rendered)}]\"` as referenced in the `ecs_task_container_definitions` local variable in the above code.\r\n\r\nDo you have a suggestion on how best to convert the`template_file` instances to local variables?  We've been successful in all of our other conversions but are stumped with this one.\n\n---\n\n<ins datetime=\"2022-07-13T21:16:40Z\">\n  <p><a href=\"https://support.gruntwork.io/hc/requests/108979\">Tracked in ticket #108979</a></p>\n</ins>\n","bodyHTML":"<p dir=\"auto\">I have a related question to <a class=\"issue-link js-issue-link\" data-error-text=\"Failed to load title\" data-id=\"4004432\" data-permission-text=\"Title is private\" data-url=\"https://github.com/gruntwork-io/knowledge-base/discussions/350\" data-hovercard-type=\"discussion\" data-hovercard-url=\"/gruntwork-io/knowledge-base/discussions/350/hovercard\" href=\"https://github.com/orgs/gruntwork-io/discussions/350\">#350</a>.</p>\n<p dir=\"auto\">We have the following <code class=\"notranslate\">template_file</code> code that we are trying to convert to a local variable.</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"data &quot;template_file&quot; &quot;port_mappings&quot; {\n  template = &lt;&lt;EOF\n  {\n    &quot;containerPort&quot;: ${var.container_port},\n    &quot;hostPort&quot;: ${var.container_port},\n    &quot;protocol&quot;: &quot;tcp&quot;\n  }\n  EOF\n}\"><pre class=\"notranslate\"><code class=\"notranslate\">data \"template_file\" \"port_mappings\" {\n  template = &lt;&lt;EOF\n  {\n    \"containerPort\": ${var.container_port},\n    \"hostPort\": ${var.container_port},\n    \"protocol\": \"tcp\"\n  }\n  EOF\n}\n</code></pre></div>\n<p dir=\"auto\">It's used later on in</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"locals {\n  ecs_task_container_definitions = templatefile(\n    &quot;${path.module}/container-definition/container-definition.json&quot;,\n    {\n      container_name = var.service_name\n\n      image             = var.image\n      version           = var.image_version\n      cpu               = var.cpu\n      memory            = var.memory\n      port_mappings     = &quot;[${join(&quot;,&quot;, data.template_file.port_mappings.*.rendered)}]&quot;\n      env_vars          = &quot;[${join(&quot;,&quot;, data.template_file.all_env_vars.*.rendered)}]&quot;\n      log_group         = aws_cloudwatch_log_group.ecs_task_log_group.name\n      region            = var.aws_region\n      log_stream_prefix = &quot;${var.service_name}-ecs-fargate&quot;\n    }\n  )\n}\"><pre class=\"notranslate\"><code class=\"notranslate\">locals {\n  ecs_task_container_definitions = templatefile(\n    \"${path.module}/container-definition/container-definition.json\",\n    {\n      container_name = var.service_name\n\n      image             = var.image\n      version           = var.image_version\n      cpu               = var.cpu\n      memory            = var.memory\n      port_mappings     = \"[${join(\",\", data.template_file.port_mappings.*.rendered)}]\"\n      env_vars          = \"[${join(\",\", data.template_file.all_env_vars.*.rendered)}]\"\n      log_group         = aws_cloudwatch_log_group.ecs_task_log_group.name\n      region            = var.aws_region\n      log_stream_prefix = \"${var.service_name}-ecs-fargate\"\n    }\n  )\n}\n</code></pre></div>\n<p dir=\"auto\">I tried changing it to a local variable as a map and as a string but I keep getting an error when running <code class=\"notranslate\">terragrunt apply</code>.</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"Error: Invalid function argument on main.tf line 225, in locals:\n  225:       port_mappings     = &quot;[${join(&quot;,&quot;, local.port_mappings)}]&quot;\n     ├────────────────\n     │ local.port_mappings is object with 3 attributes\n \n Invalid value for &quot;lists&quot; parameter: list of string required.\"><pre class=\"notranslate\"><code class=\"notranslate\">Error: Invalid function argument on main.tf line 225, in locals:\n  225:       port_mappings     = \"[${join(\",\", local.port_mappings)}]\"\n     ├────────────────\n     │ local.port_mappings is object with 3 attributes\n \n Invalid value for \"lists\" parameter: list of string required.\n</code></pre></div>\n<p dir=\"auto\">We also have:</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"data &quot;template_file&quot; &quot;all_env_vars&quot; {\n  count    = length(local.all_env_vars)\n  template = &lt;&lt;EOF\n{\n  &quot;name&quot;: &quot;${element(keys(local.all_env_vars), count.index)}&quot;,\n  &quot;value&quot;: &quot;${lookup(local.all_env_vars, element(keys(local.all_env_vars), count.index))}&quot;\n}\nEOF\n}\"><pre class=\"notranslate\"><code class=\"notranslate\">data \"template_file\" \"all_env_vars\" {\n  count    = length(local.all_env_vars)\n  template = &lt;&lt;EOF\n{\n  \"name\": \"${element(keys(local.all_env_vars), count.index)}\",\n  \"value\": \"${lookup(local.all_env_vars, element(keys(local.all_env_vars), count.index))}\"\n}\nEOF\n}\n</code></pre></div>\n<p dir=\"auto\"><code class=\"notranslate\">local.all_env_vars</code> comes from another local variable:</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"locals {\n   all_env_vars = merge(local.default_env_vars, var.extra_env_vars)\n}\"><pre class=\"notranslate\"><code class=\"notranslate\">locals {\n   all_env_vars = merge(local.default_env_vars, var.extra_env_vars)\n}\n</code></pre></div>\n<p dir=\"auto\">This gets used in a similar way as the other template file in <code class=\"notranslate\">\"[${join(\",\", data.template_file.all_env_vars.*.rendered)}]\"</code> as referenced in the <code class=\"notranslate\">ecs_task_container_definitions</code> local variable in the above code.</p>\n<p dir=\"auto\">Do you have a suggestion on how best to convert the<code class=\"notranslate\">template_file</code> instances to local variables?  We've been successful in all of our other conversions but are stumped with this one.</p>\n<hr>\n<ins datetime=\"2022-07-13T21:16:40Z\">\n  <p dir=\"auto\"><a href=\"https://support.gruntwork.io/hc/requests/108979\" rel=\"nofollow\">Tracked in ticket #108979</a></p>\n</ins>","answer":{"body":"Did you set port_mappings to the raw object? E.g.\r\n\r\n```hcl\r\n  port_mappings = {\r\n    \"containerPort\": ${var.container_port},\r\n    \"hostPort\": ${var.container_port},\r\n    \"protocol\": \"tcp\"\r\n  }\r\n```\r\n\r\nIf so, the main issue is because port_mappings is now an object instead of a string. My best recommendation for addressing this is to do the following:\r\n\r\n```hcl\r\nlocals {\r\n  # Convert to list of objects\r\n  port_mappings = [{\r\n    containerPort = var.container_port\r\n    hostPort = var.container_port\r\n    protocol = \"tcp\"\r\n  }]\r\n\r\n  ecs_task_container_definitions = templatefile(\r\n    \"${path.module}/container-definition/container-definition.json\",\r\n    {\r\n      # ... other args omitted for brevity ...\r\n      # Turn port_mappings into a json string\r\n      port_mappings     = jsonencode(local.port_mappings)\r\n    }\r\n  )\r\n}\r\n```\r\n\r\nYou can do a similar thing (use HCL object to construct the data, and then `jsonencode` to pass it to the template) for the env vars:\r\n\r\n```hcl\r\nlocals {\r\n  all_env_vars_encoded = [\r\n    for key, val in local.all_env_vars :\r\n    {\r\n      name = key\r\n      value = val\r\n    }\r\n  ]\r\n  \r\n  ecs_task_container_definitions = templatefile(\r\n    \"${path.module}/container-definition/container-definition.json\",\r\n    {\r\n      # ... other args omitted for brevity ...\r\n      # Turn env_vars into a json string\r\n      env_vars      = jsonencode(local.all_env_vars_encoded)\r\n    }\r\n  )\r\n}\r\n```","bodyHTML":"<p dir=\"auto\">Did you set port_mappings to the raw object? E.g.</p>\n<div class=\"highlight highlight-source-hcl notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"  port_mappings = {\n    &quot;containerPort&quot;: ${var.container_port},\n    &quot;hostPort&quot;: ${var.container_port},\n    &quot;protocol&quot;: &quot;tcp&quot;\n  }\"><pre class=\"notranslate\">  <span class=\"pl-v\"><span class=\"pl-smi\">port_mappings</span> <span class=\"pl-k\">=</span> </span>{\n    <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>containerPort<span class=\"pl-pds\">\"</span></span><span class=\"pl-k\">:</span> ${var.container_port},\n    <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>hostPort<span class=\"pl-pds\">\"</span></span><span class=\"pl-k\">:</span> ${var.container_port},\n    <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>protocol<span class=\"pl-pds\">\"</span></span><span class=\"pl-k\">:</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>tcp<span class=\"pl-pds\">\"</span></span>\n  }</pre></div>\n<p dir=\"auto\">If so, the main issue is because port_mappings is now an object instead of a string. My best recommendation for addressing this is to do the following:</p>\n<div class=\"highlight highlight-source-hcl notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"locals {\n  # Convert to list of objects\n  port_mappings = [{\n    containerPort = var.container_port\n    hostPort = var.container_port\n    protocol = &quot;tcp&quot;\n  }]\n\n  ecs_task_container_definitions = templatefile(\n    &quot;${path.module}/container-definition/container-definition.json&quot;,\n    {\n      # ... other args omitted for brevity ...\n      # Turn port_mappings into a json string\n      port_mappings     = jsonencode(local.port_mappings)\n    }\n  )\n}\"><pre class=\"notranslate\"><span class=\"pl-en\">locals</span> {\n  <span class=\"pl-c\"><span class=\"pl-c\">#</span> Convert to list of objects<span class=\"pl-c\"></span></span>\n  <span class=\"pl-v\"><span class=\"pl-smi\">port_mappings</span> <span class=\"pl-k\">=</span> </span>[{\n    containerPort <span class=\"pl-k\">=</span> var.container_port\n    hostPort <span class=\"pl-k\">=</span> var.container_port\n    protocol <span class=\"pl-k\">=</span> <span class=\"pl-s\"><span class=\"pl-pds\">\"</span>tcp<span class=\"pl-pds\">\"</span></span>\n  }]\n\n  <span class=\"pl-v\"><span class=\"pl-smi\">ecs_task_container_definitions</span> <span class=\"pl-k\">=</span> </span><span class=\"pl-c1\">templatefile</span>(\n    <span class=\"pl-s\"><span class=\"pl-pds\">\"</span><span class=\"pl-k\">${</span><span class=\"pl-smi\">path</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">module</span><span class=\"pl-k\">}</span>/container-definition/container-definition.json<span class=\"pl-pds\">\"</span></span>,\n    {\n      <span class=\"pl-c\"><span class=\"pl-c\">#</span> ... other args omitted for brevity ...<span class=\"pl-c\"></span></span>\n      <span class=\"pl-c\"><span class=\"pl-c\">#</span> Turn port_mappings into a json string<span class=\"pl-c\"></span></span>\n      port_mappings     <span class=\"pl-k\">=</span> <span class=\"pl-c1\">jsonencode</span>(local<span class=\"pl-k\">.</span><span class=\"pl-smi\">port_mappings</span>)\n    }\n  )\n}</pre></div>\n<p dir=\"auto\">You can do a similar thing (use HCL object to construct the data, and then <code class=\"notranslate\">jsonencode</code> to pass it to the template) for the env vars:</p>\n<div class=\"highlight highlight-source-hcl notranslate position-relative overflow-auto\" dir=\"auto\" data-snippet-clipboard-copy-content=\"locals {\n  all_env_vars_encoded = [\n    for key, val in local.all_env_vars :\n    {\n      name = key\n      value = val\n    }\n  ]\n  \n  ecs_task_container_definitions = templatefile(\n    &quot;${path.module}/container-definition/container-definition.json&quot;,\n    {\n      # ... other args omitted for brevity ...\n      # Turn env_vars into a json string\n      env_vars      = jsonencode(local.all_env_vars_encoded)\n    }\n  )\n}\"><pre class=\"notranslate\"><span class=\"pl-en\">locals</span> {\n  <span class=\"pl-v\"><span class=\"pl-smi\">all_env_vars_encoded</span> <span class=\"pl-k\">=</span> </span>[\n    <span class=\"pl-k\">for</span> <span class=\"pl-smi\">key</span>, <span class=\"pl-smi\">val</span> <span class=\"pl-k\">in</span> <span class=\"pl-smi\">local</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">all_env_vars</span> <span class=\"pl-k\">:</span>\n    {\n      name <span class=\"pl-k\">=</span> key\n      value <span class=\"pl-k\">=</span> val\n    }\n  ]\n  \n  <span class=\"pl-v\"><span class=\"pl-smi\">ecs_task_container_definitions</span> <span class=\"pl-k\">=</span> </span><span class=\"pl-c1\">templatefile</span>(\n    <span class=\"pl-s\"><span class=\"pl-pds\">\"</span><span class=\"pl-k\">${</span><span class=\"pl-smi\">path</span><span class=\"pl-k\">.</span><span class=\"pl-smi\">module</span><span class=\"pl-k\">}</span>/container-definition/container-definition.json<span class=\"pl-pds\">\"</span></span>,\n    {\n      <span class=\"pl-c\"><span class=\"pl-c\">#</span> ... other args omitted for brevity ...<span class=\"pl-c\"></span></span>\n      <span class=\"pl-c\"><span class=\"pl-c\">#</span> Turn env_vars into a json string<span class=\"pl-c\"></span></span>\n      env_vars      <span class=\"pl-k\">=</span> <span class=\"pl-c1\">jsonencode</span>(local<span class=\"pl-k\">.</span><span class=\"pl-smi\">all_env_vars_encoded</span>)\n    }\n  )\n}</pre></div>"}}} />

</CenterLayout>

<!-- ##DOCS-SOURCER-START
{
  "sourcePlugin": "github-discussions",
  "hash": "7d09d3644b7cd487ba703d2662d3acbc"
}
##DOCS-SOURCER-END -->

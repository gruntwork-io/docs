---
hide_table_of_contents: true
hide_title: true
custom_edit_url: null
---

import CenterLayout from "/src/components/CenterLayout"
import GitHub from "/src/components/GitHub"

<head>
  <link rel="canonical" href="https://github.com/gruntwork-io/knowledge-base/discussions/22" />
</head>

<CenterLayout>
<span className="searchCategory">Knowledge Base</span>
<h1>How to use aws-auth in CI/CD pipeline</h1>
<GitHub discussion={{"id":"MDEwOkRpc2N1c3Npb24zNTUzMjA2","number":22,"author":{"login":"gruntwork-support"},"title":"How to use aws-auth in CI/CD pipeline","body":"_This message was extracted from a discussion that originally took place in Gruntwork Community Slack. Names and URLs have been removed where appropriate_\n\n**From a customer**\n\nHi, I am trying to execute `infrastructure-deployer`  in our CI server, but I am struggling with assuming the correct role (and hence running in the correct destination account). Locally I am using `aws-vault`, and everything works (I can invoke the lambda) but on Jenkins I set `AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY`, and `AWS_PROFILE`. The `~/.aws/config` contains a profile defining the arn.\n\n\n```\n[profile development]\ncredential_source = Environment\nrole_arn = arn:aws:iam::$DEVELOPMENT_ACCOUNT:role/allow-auto-deploy-from-other-accounts\n```\n\nThis is what executing `infrastrucure-deployer` gives me:\n\n```\nAccessDeniedException: User arn:aws:iam::$SECURITY_ACCOUNT:user/jenkins is not authorized to perform lambda:InvokeFunction on resource arn:aws:lambda:eu-central-1:$SECURITY_ACCOUNT:function:ecs-deploy-runner\n```\n\nSo it seems like the `role_arn` is ignored, and it also tries to call the lambda in the security account, where it does not exist. How can I tell `infrastructure-deployer` to assume a role first, before invoking the lambda?\n\n\n\nI might have found the trick — that’s what `aws-auth` is for, isn’t it?","bodyHTML":"<p dir=\"auto\"><em>This message was extracted from a discussion that originally took place in Gruntwork Community Slack. Names and URLs have been removed where appropriate</em></p>\n<p dir=\"auto\"><strong>From a customer</strong></p>\n<p dir=\"auto\">Hi, I am trying to execute <code class=\"notranslate\">infrastructure-deployer</code>  in our CI server, but I am struggling with assuming the correct role (and hence running in the correct destination account). Locally I am using <code class=\"notranslate\">aws-vault</code>, and everything works (I can invoke the lambda) but on Jenkins I set <code class=\"notranslate\">AWS_ACCESS_KEY_ID</code>, <code class=\"notranslate\">AWS_SECRET_ACCESS_KEY</code>, and <code class=\"notranslate\">AWS_PROFILE</code>. The <code class=\"notranslate\">~/.aws/config</code> contains a profile defining the arn.</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"[profile development]\ncredential_source = Environment\nrole_arn = arn:aws:iam::$DEVELOPMENT_ACCOUNT:role/allow-auto-deploy-from-other-accounts\"><pre class=\"notranslate\"><code class=\"notranslate\">[profile development]\ncredential_source = Environment\nrole_arn = arn:aws:iam::$DEVELOPMENT_ACCOUNT:role/allow-auto-deploy-from-other-accounts\n</code></pre></div>\n<p dir=\"auto\">This is what executing <code class=\"notranslate\">infrastrucure-deployer</code> gives me:</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"AccessDeniedException: User arn:aws:iam::$SECURITY_ACCOUNT:user/jenkins is not authorized to perform lambda:InvokeFunction on resource arn:aws:lambda:eu-central-1:$SECURITY_ACCOUNT:function:ecs-deploy-runner\"><pre class=\"notranslate\"><code class=\"notranslate\">AccessDeniedException: User arn:aws:iam::$SECURITY_ACCOUNT:user/jenkins is not authorized to perform lambda:InvokeFunction on resource arn:aws:lambda:eu-central-1:$SECURITY_ACCOUNT:function:ecs-deploy-runner\n</code></pre></div>\n<p dir=\"auto\">So it seems like the <code class=\"notranslate\">role_arn</code> is ignored, and it also tries to call the lambda in the security account, where it does not exist. How can I tell <code class=\"notranslate\">infrastructure-deployer</code> to assume a role first, before invoking the lambda?</p>\n<p dir=\"auto\">I might have found the trick — that’s what <code class=\"notranslate\">aws-auth</code> is for, isn’t it?</p>","answer":{"body":"**From a grunt**\n\nYup that is correct! The idea is to use `aws-auth` to assume the role you want to use for deploying. You can take a look at our pipeline example from the reference architecture:\n\n- Reference architecture infra live: https://github.com/gruntwork-io/terraform-aws-service-catalog/tree/master/examples/for-production/infrastructure-live\n- Helper function to assume role using aws-auth: https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/master/examples/for-production/infrastructure-live/_ci/scripts/helpers.sh#L15\n- Section of pipeline CI script where we take advantage of that: [https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/master/examples[…]/for-production/infrastructure-live/_ci/scripts/deploy-infra.sh](https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/master/examples/for-production/infrastructure-live/_ci/scripts/deploy-infra.sh#L57)","bodyHTML":"<p dir=\"auto\"><strong>From a grunt</strong></p>\n<p dir=\"auto\">Yup that is correct! The idea is to use <code class=\"notranslate\">aws-auth</code> to assume the role you want to use for deploying. You can take a look at our pipeline example from the reference architecture:</p>\n<ul dir=\"auto\">\n<li>Reference architecture infra live: <a href=\"https://github.com/gruntwork-io/terraform-aws-service-catalog/tree/master/examples/for-production/infrastructure-live\">https://github.com/gruntwork-io/terraform-aws-service-catalog/tree/master/examples/for-production/infrastructure-live</a></li>\n<li>Helper function to assume role using aws-auth: <a href=\"https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/master/examples/for-production/infrastructure-live/_ci/scripts/helpers.sh#L15\">https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/master/examples/for-production/infrastructure-live/_ci/scripts/helpers.sh#L15</a></li>\n<li>Section of pipeline CI script where we take advantage of that: <a href=\"https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/master/examples/for-production/infrastructure-live/_ci/scripts/deploy-infra.sh#L57\">https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/master/examples[…]/for-production/infrastructure-live/_ci/scripts/deploy-infra.sh</a></li>\n</ul>"}}} />

</CenterLayout>

<!-- ##DOCS-SOURCER-START
{
  "sourcePlugin": "github-discussions",
  "hash": "6d221413dae1ad5eeeea879896289d76"
}
##DOCS-SOURCER-END -->

---
hide_table_of_contents: true
hide_title: true
custom_edit_url: null
---

import CenterLayout from "/src/components/CenterLayout"
import GitHub from "/src/components/GitHub"

<head>
  <link rel="canonical" href="https://github.com/gruntwork-io/knowledge-base/discussions/240" />
</head>

<CenterLayout>
<span className="searchCategory">Knowledge Base</span>
<h1>Why limit parallelism for account-baseline?</h1>
<GitHub discussion={{"id":"D_kwDOF8slf84AO68M","number":240,"author":{"login":"yorinasub17"},"title":"Why limit parallelism for account-baseline?","body":"The production example for the `account-baseline` modules in `terraform-aws-service-catalog` contain the following code snippet (in [this file](https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/master/examples/for-production/infrastructure-live/_envcommon/landingzone/account-baseline-app-base.hcl)):\r\n\r\n```\r\n  # This module deploys some resources (e.g., AWS Config) across all AWS regions, each of which needs its own provider,\r\n  # which in Terraform means a separate process. To avoid all these processes thrashing the CPU, which leads to network\r\n  # connectivity issues, we limit the parallelism here.\r\n  extra_arguments \"parallelism\" {\r\n    commands  = get_terraform_commands_that_need_parallelism()\r\n    arguments = get_env(\"TG_DISABLE_PARALLELISM_LIMIT\", \"false\") == \"true\" ? [] : [\"-parallelism=2\"]\r\n  }\r\n```\r\n\r\nThis seems to contradict the release notes for [v0.53.0](https://github.com/gruntwork-io/terraform-aws-service-catalog/releases/tag/v0.53.0) where it saids:\r\n\r\n> Note that you no longer need to limit parallelism (with the -parallelism flag) or set ulimit to run these modules!\r\n\r\nIs the parallelism still necessary?","bodyHTML":"<p dir=\"auto\">The production example for the <code class=\"notranslate\">account-baseline</code> modules in <code class=\"notranslate\">terraform-aws-service-catalog</code> contain the following code snippet (in <a href=\"https://github.com/gruntwork-io/terraform-aws-service-catalog/blob/master/examples/for-production/infrastructure-live/_envcommon/landingzone/account-baseline-app-base.hcl\">this file</a>):</p>\n<div class=\"snippet-clipboard-content notranslate position-relative overflow-auto\" data-snippet-clipboard-copy-content=\"  # This module deploys some resources (e.g., AWS Config) across all AWS regions, each of which needs its own provider,\n  # which in Terraform means a separate process. To avoid all these processes thrashing the CPU, which leads to network\n  # connectivity issues, we limit the parallelism here.\n  extra_arguments &quot;parallelism&quot; {\n    commands  = get_terraform_commands_that_need_parallelism()\n    arguments = get_env(&quot;TG_DISABLE_PARALLELISM_LIMIT&quot;, &quot;false&quot;) == &quot;true&quot; ? [] : [&quot;-parallelism=2&quot;]\n  }\"><pre class=\"notranslate\"><code class=\"notranslate\">  # This module deploys some resources (e.g., AWS Config) across all AWS regions, each of which needs its own provider,\n  # which in Terraform means a separate process. To avoid all these processes thrashing the CPU, which leads to network\n  # connectivity issues, we limit the parallelism here.\n  extra_arguments \"parallelism\" {\n    commands  = get_terraform_commands_that_need_parallelism()\n    arguments = get_env(\"TG_DISABLE_PARALLELISM_LIMIT\", \"false\") == \"true\" ? [] : [\"-parallelism=2\"]\n  }\n</code></pre></div>\n<p dir=\"auto\">This seems to contradict the release notes for <a href=\"https://github.com/gruntwork-io/terraform-aws-service-catalog/releases/tag/v0.53.0\">v0.53.0</a> where it saids:</p>\n<blockquote>\n<p dir=\"auto\">Note that you no longer need to limit parallelism (with the -parallelism flag) or set ulimit to run these modules!</p>\n</blockquote>\n<p dir=\"auto\">Is the parallelism still necessary?</p>","answer":{"body":"When we released this update initially, we did observe that the parallelism flag was no longer necessary, leading us to mention this fact in the notes.\r\n\r\nSince the release, we have learned that the `ulimit` setting is indeed no longer necessary, but there are certain deployment modes where it is recommended to continue to use the limited parallelism. Specifically, we have found that `account-baseline` still struggles to deploy without parallelism when either of the following conditions are true:\r\n\r\n- Any machine that has less than 4 cores, or less than 4 effective cores (e.g., if you are running a lot of things on your machine like Docker that prevents availability of cores to Terraform).\r\n- When running many other modules concurrently with `run-all plan` or `run-all apply`.\r\n\r\nOur recommendation is to try without parallelism first, and then turn it on if you find that the system struggles to manage the `account-baseline` modules.\r\n\r\n---\r\n\r\nNote that the `for-production` example is generated from our Reference Architecture, and our reference architecture deployment includes the parallelism limitation because one of these conditions ends up true for deployment:\r\n\r\n- In the initial deployment, we deploy all modules at once including `account-baseline`, which triggers the second condition.\r\n- For updates, the `ecs-deploy-runner` uses a 2-core 4GB machine due to account limits for Fargate, which triggers the first condition.","bodyHTML":"<p dir=\"auto\">When we released this update initially, we did observe that the parallelism flag was no longer necessary, leading us to mention this fact in the notes.</p>\n<p dir=\"auto\">Since the release, we have learned that the <code class=\"notranslate\">ulimit</code> setting is indeed no longer necessary, but there are certain deployment modes where it is recommended to continue to use the limited parallelism. Specifically, we have found that <code class=\"notranslate\">account-baseline</code> still struggles to deploy without parallelism when either of the following conditions are true:</p>\n<ul dir=\"auto\">\n<li>Any machine that has less than 4 cores, or less than 4 effective cores (e.g., if you are running a lot of things on your machine like Docker that prevents availability of cores to Terraform).</li>\n<li>When running many other modules concurrently with <code class=\"notranslate\">run-all plan</code> or <code class=\"notranslate\">run-all apply</code>.</li>\n</ul>\n<p dir=\"auto\">Our recommendation is to try without parallelism first, and then turn it on if you find that the system struggles to manage the <code class=\"notranslate\">account-baseline</code> modules.</p>\n<hr>\n<p dir=\"auto\">Note that the <code class=\"notranslate\">for-production</code> example is generated from our Reference Architecture, and our reference architecture deployment includes the parallelism limitation because one of these conditions ends up true for deployment:</p>\n<ul dir=\"auto\">\n<li>In the initial deployment, we deploy all modules at once including <code class=\"notranslate\">account-baseline</code>, which triggers the second condition.</li>\n<li>For updates, the <code class=\"notranslate\">ecs-deploy-runner</code> uses a 2-core 4GB machine due to account limits for Fargate, which triggers the first condition.</li>\n</ul>"}}} />

</CenterLayout>

<!-- ##DOCS-SOURCER-START
{
  "sourcePlugin": "github-discussions",
  "hash": "0a6fb07fee389e36e91c40e2a45dbe2d"
}
##DOCS-SOURCER-END -->

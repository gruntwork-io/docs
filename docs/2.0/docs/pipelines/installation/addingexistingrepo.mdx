# Bootstrap Pipelines in an Existing Repository

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import PersistentCheckbox from '/src/components/PersistentCheckbox';

This guide provides comprehensive instructions for integrating [Gruntwork Pipelines](https://gruntwork.io/products/pipelines/) into an existing repository with Infrastructure as Code (IaC). This is designed for Gruntwork customers who want to add Pipelines to their current infrastructure repositories for streamlined CI/CD management.

To configure Gruntwork Pipelines in an existing repository, complete the following steps (which are explained in detail below):

1. **Plan your Pipelines setup** by identifying all environments and cloud accounts/subscriptions you need to manage.
2. **Bootstrap core infrastructure** in accounts/subscriptions that don't already have the required OIDC and state management resources.
3. **Configure SCM access** using either the [Gruntwork.io GitHub App](https://github.com/apps/gruntwork-io) or [machine users](https://docs.github.com/en/get-started/learning-about-github/types-of-github-accounts#user-accounts).
4. **Create `.gruntwork` HCL configurations** to tell Pipelines how to authenticate and organize your environments.
5. **Create `.github/workflows/pipelines.yml`** to configure your GitHub Actions workflow.
6. **Commit and push** your changes to activate Pipelines.

## Prerequisites

Before starting, ensure you have:

- **An active Gruntwork subscription** with Pipelines access. Verify by checking the [Gruntwork Developer Portal](https://app.gruntwork.io/account) and confirming access to "pipelines" repositories in your GitHub team.
- **Cloud provider credentials** with permissions to create OIDC providers and IAM roles in accounts where Pipelines will manage infrastructure.
- **Git installed** locally for cloning and managing your repository.
- **Existing IaC repository** with Terragrunt configurations you want to manage with Pipelines (if you are using OpenTofu/Terraform, and want to start using Terragrunt, read the [Quickstart Guide](https://terragrunt.gruntwork.io/docs/getting-started/quick-start)).

## Planning Your Pipelines Setup

Before implementing Pipelines, it's crucial to plan your setup by identifying all the environments and cloud resources you need to manage.

### Identify Your Environments

Review your existing repository structure and identify:

1. **All environments** you want to manage with Pipelines (e.g., `dev`, `staging`, `prod`)
2. **Cloud accounts/subscriptions** associated with each environment
3. **Directory paths** in your repository that contain Terragrunt units for each environment
4. **Existing OIDC resources** that may already be provisioned in your accounts

:::note Progress Checklist

<PersistentCheckbox id="inventory-environments" label="Create an inventory of all environments you want to manage with Pipelines." />
<PersistentCheckbox id="map-cloud-accounts" label="Map each environment to its corresponding AWS Account / Azure Subscription." />
<PersistentCheckbox id="identify-directory-paths" label="Identify the directory paths in your repository for each environment's Terragrunt units." />
<PersistentCheckbox id="check-existing-oidc" label="Check if OIDC providers and IAM roles already exist in your cloud accounts." />

:::

### Determine Required OIDC Roles

For each AWS Account / Azure Subscription you want to manage, you might already have some or all of the following resources provisioned.

<Tabs>
<TabItem value="aws" label="AWS" default>

**Required AWS Resources:**

- An OIDC provider for GitHub Actions
- An IAM role for Pipelines to assume when running Terragrunt plan commands
- An IAM role for Pipelines to assume when running Terragrunt apply commands

</TabItem>
<TabItem value="azure" label="Azure">

**Required Azure Resources:**

- Entra ID Application for plans with Federated Identity Credential
- Entra ID Application for applies with Federated Identity Credential
- Service Principals with appropriate role assignments
- Storage Account and Container for Terragrunt state storage (if not already existing)

</TabItem>
</Tabs>

:::note Progress Checklist

<PersistentCheckbox id="list-required-oidc-roles" label="Create a list of all OIDC roles and resources needed for each AWS Account / Azure Subscription." />
<PersistentCheckbox id="identify-existing-resources" label="Identify which resources already exist and which need to be created." />

:::

## Configuring SCM Access

Pipelines needs the ability to interact with Source Control Management (SCM) platforms to fetch resources (e.g. IaC code, reusable CI/CD code and the Pipelines binary itself).

There are two ways to configure SCM access for Pipelines:

1. Using the [Gruntwork.io GitHub App](/2.0/docs/pipelines/installation/viagithubapp#configuration) (recommended for most GitHub users).
2. Using a [machine user](/2.0/docs/pipelines/installation/viamachineusers.md) (recommended for GitHub users who cannot use the GitHub App).

:::note Progress Checklist

<PersistentCheckbox id="configure-scm-access" label="Configure SCM access for Pipelines using the documentation above." />

:::

## Bootstrapping Core Infrastructure

If your cloud accounts/subscriptions don't already have all the required OIDC and state management resources, you'll need to bootstrap them. This section provides the infrastructure code needed to set up these resources.

:::tip

If you already have all the resources listed, you can skip this section.

If you have some of them provisioned, but not all, you can decide to either destroy the resources you already have provisioned and recreate them or import them into state. If you are not sure, please contact [Gruntwork support](/support).

:::

<Tabs>
<TabItem value="aws" label="AWS" default>

### AWS Bootstrap Resources

The resources you need provisioned in AWS to start managing resources with Pipelines are:

1. An OpenID Connect (OIDC) provider
2. An IAM role for Pipelines to assume when running Terragrunt plan commands
3. An IAM role for Pipelines to assume when running Terragrunt apply commands

For every account you want Pipelines to manage infrastructure in.

:::tip Don't Panic!

This may seem like a lot to set up, but the content you need to add to your repository is minimal. The majority of the work will be pulled from a reusable catalog that you'll reference in your repository.

If you want to peruse the catalog that's used in the bootstrap process, you can take a look at the [terragrunt-scale-catalog](https://github.com/gruntwork-io/terragrunt-scale-catalog) repository.

:::

### Bootstrap Your Repository for AWS

First, confirm that you have a `root.hcl` file in the root of your repository that looks something like this:

```hcl title="root.hcl"
locals {
  account_hcl       = read_terragrunt_config(find_in_parent_folders("account.hcl"))
  state_bucket_name = local.account_hcl.locals.state_bucket_name

  region_hcl = read_terragrunt_config(find_in_parent_folders("region.hcl"))
  aws_region = local.region_hcl.locals.aws_region
}

remote_state {
  backend = "s3"
  generate = {
    path      = "backend.tf"
    if_exists = "overwrite"
  }
  config = {
    bucket       = local.state_bucket_name
    region       = local.aws_region
    key          = "${path_relative_to_include()}/tofu.tfstate"
    encrypt      = true
    use_lockfile = true
  }
}

generate "provider" {
  path      = "provider.tf"
  if_exists = "overwrite_terragrunt"
  contents  = <<EOF
provider "aws" {
  region = "${local.aws_region}"
}
EOF
}
```

If you don't have a `root.hcl` file, you might need to customize the bootstrapping process, as the Terragrunt scale catalog expects a `root.hcl` file in the root of the repository. Please contact [Gruntwork support](/support) for assistance if you need help.

For each AWS account that needs bootstrapping, create the following structure in your repository:

```hcl title="<account-name>/_global/bootstrap/terragrunt.stack.hcl"
locals {
  # You may need to adjust this path based on your repository structure
  account_vars = read_terragrunt_config(find_in_parent_folders("account.hcl", "terragrunt.hcl"))
}

stack "bootstrap" {
  source = "github.com/gruntwork-io/terragrunt-scale-catalog//stacks/aws/github/pipelines-bootstrap?ref=v1.0.0"
  path   = "bootstrap"

  values = {
    # Set the OIDC resource prefix you want to use for your account.
    # This is used to determine the names of the OIDC resources like the IAM roles that are created.
    # e.g. `pipelines-plan`, `pipelines-apply`, etc.
    oidc_resource_prefix = "pipelines"

    # Set the organization name you want AWS to trust for OIDC.
    github_org_name = "your-github-org"

    # Set the repository name you want AWS to trust for OIDC.
    github_repo_name = "your-repo-name"

    # Set the name of the S3 bucket you want to use for state storage (must be globally unique)
    state_bucket_name = "your-unique-state-bucket-name"
  }
}
```

:::note Progress Checklist

<PersistentCheckbox id="create-aws-bootstrap-configs" label="Create bootstrap configurations for each AWS account that needs OIDC resources." />
<PersistentCheckbox id="set-aws-github-org-repo" label="Set the correct GitHub organization and repository names in each bootstrap configuration." />
<PersistentCheckbox id="set-aws-unique-bucket-names" label="Set globally unique S3 bucket names for state storage in each account." />

:::

### Provision AWS Bootstrap Resources

For each account that needs bootstrapping:

1. Navigate to the bootstrap directory:

   ```bash
   cd <account-name>/_global/bootstrap
   ```

2. Plan the bootstrap resources:

   ```bash
   terragrunt run --all --non-interactive plan
   ```

3. Apply the bootstrap resources:

   ```bash
   terragrunt run --all --non-interactive apply
   ```

:::note Progress Checklist

<PersistentCheckbox id="run-aws-plan" label="Run a plan in the bootstrap directory to make sure that everything is set up correctly." />
<PersistentCheckbox id="run-aws-apply" label="Run an apply in the bootstrap directory to provision the resources in your AWS account." />

:::

</TabItem>
<TabItem value="azure" label="Azure">

### Azure Bootstrap Resources

The resources you need provisioned in Azure to start managing resources with Pipelines are:

1. An Azure Resource Group for OpenTofu state resources
2. An Azure Storage Account and Container for OpenTofu state storage
3. Entra ID Applications for plan and apply operations
4. Federated Identity Credentials for OIDC authentication
5. Service Principals with appropriate role assignments

:::tip Don't Panic!

This may seem like a lot to set up, but the content you need to add to your repository is minimal. The majority of the work will be pulled from a reusable catalog that you'll reference in your repository.

If you want to peruse the catalog that's used in the bootstrap process, you can take a look at the [terragrunt-scale-catalog](https://github.com/gruntwork-io/terragrunt-scale-catalog) repository.

:::

### Bootstrap Your Repository for Azure

For each Azure subscription that needs bootstrapping, create the following structure:

```hcl title="<subscription-name>/bootstrap/terragrunt.stack.hcl"
stack "bootstrap" {
  source = "github.com/gruntwork-io/terragrunt-scale-catalog//stacks/azure/github/pipelines-bootstrap?ref=v1.0.0"
  path   = "bootstrap"

  values = {
    # Set the location for your resources
    location = "East US"

    # State storage configuration
    state_resource_group_name    = "pipelines-rg"
    state_storage_account_name   = "your-unique-storage-account"
    state_storage_container_name = "tfstate"

    # OIDC configuration
    github_org_name = "your-github-org"
    github_repo_name = "your-repo-name"
    oidc_resource_prefix = "pipelines"
  }
}
```

:::note Progress Checklist

<PersistentCheckbox id="create-azure-bootstrap-configs" label="Create bootstrap configurations for each Azure subscription that needs OIDC resources." />
<PersistentCheckbox id="set-azure-github-org-repo" label="Set the correct GitHub organization and repository names in each bootstrap configuration." />
<PersistentCheckbox id="set-azure-unique-storage-names" label="Set unique storage account names for state storage in each subscription." />

:::

### Provision Azure Bootstrap Resources

For each subscription that needs bootstrapping:

1. Set environment variables:

   ```bash
   export ARM_TENANT_ID="your-tenant-id"
   export ARM_SUBSCRIPTION_ID="your-subscription-id"
   ```

2. Navigate to the bootstrap directory:

   ```bash
   cd <subscription-name>/bootstrap
   ```

3. Plan the bootstrap resources:

   ```bash
   terragrunt run --all --non-interactive --provider-cache plan
   ```

4. Apply the bootstrap resources:

   ```bash
   terragrunt run --all --non-interactive --provider-cache apply
   ```

5. Migrate state to remote storage:

   ```bash
   terragrunt run --all --non-interactive --provider-cache -- init -migrate-state -force-copy
   ```

:::note Progress Checklist

<PersistentCheckbox id="set-azure-env-vars" label="Set ARM_TENANT_ID and ARM_SUBSCRIPTION_ID environment variables for each subscription." />
<PersistentCheckbox id="run-azure-bootstrap-plan" label="Run plan for bootstrap resources in each Azure subscription." />
<PersistentCheckbox id="run-azure-bootstrap-apply" label="Apply bootstrap resources in each Azure subscription." />
<PersistentCheckbox id="migrate-azure-state" label="Migrate state to remote storage for each Azure subscription." />

:::

</TabItem>
</Tabs>

## Creating `.gruntwork` HCL Configurations

Create [HCL configurations](/2.0/reference/pipelines/configurations-as-code/) in the `.gruntwork` directory in the root of your repository to tell Pipelines how you plan to organize your infrastructure, and how you plan to have Pipelines authenticate with your cloud provider(s).

### The `repository` block

The core configuration that you'll want to start with is the `repository` block. This block tells Pipelines which branch has the "live" infrastructure you want provisioned. When you merge IaC to this branch, Pipelines will be triggered to update your infrastructure accordingly.

```hcl title=".gruntwork/repository.hcl"
repository {
  deploy_branch_name = "main"
}
```

:::note Progress Checklist

<PersistentCheckbox id="create-repository-hcl" label="Create a new `.gruntwork/repository.hcl` file in the root of your repository with the contents above." />
<PersistentCheckbox id="edit-repository-deploy-branch-name" label="Edit the value of `deploy_branch_name` in `.gruntwork/repository.hcl` if necessary." />

:::

### The `environment` block

Next, you'll want to define the environments you want to manage with Pipelines using the [`environment` block](/2.0/reference/pipelines/configurations-as-code/api#environment-block).

For each environment, you'll want to define a [`filter` block](/2.0/reference/pipelines/configurations-as-code/api#filter-block) that tells Pipelines which units are part of that environment. You'll also want to define an [`authentication` block](/2.0/reference/pipelines/configurations-as-code/api#authentication-block) that tells Pipelines how to authenticate with your cloud provider(s) for that environment.

<Tabs>
<TabItem value="aws" label="AWS" default>

```hcl title=".gruntwork/environment-production.hcl"
environment "production" {
  filter {
    paths = ["prod/*"]
  }

  authentication {
    aws_oidc {
      account_id = "123456789012"
      plan_iam_role_arn = "arn:aws:iam::123456789012:role/pipelines-plan"
      apply_iam_role_arn = "arn:aws:iam::123456789012:role/pipelines-apply"
    }
  }
}
```

:::tip

Learn more about how Pipelines authenticates to AWS in the [Authenticating to AWS](/2.0/docs/pipelines/concepts/cloud-auth/aws) page.

:::

:::note Progress Checklist

<PersistentCheckbox id="create-aws-environment-hcl" label="Create environment HCL files for each AWS account you want to manage with Pipelines." />
<PersistentCheckbox id="edit-aws-environment-labels" label="Edit the labels of the `environment` blocks to match your environment names." />
<PersistentCheckbox id="edit-aws-filter-paths" label="Edit the `paths` values in the `filter` blocks to match your repository structure." />
<PersistentCheckbox id="edit-aws-account-ids" label="Edit the `account_id` values to match your AWS account IDs." />
<PersistentCheckbox id="edit-aws-iam-role-arns" label="Edit the IAM role ARNs to match the roles created during bootstrapping." />

:::

</TabItem>
<TabItem value="azure" label="Azure">

```hcl title=".gruntwork/environment-production.hcl"
environment "production" {
  filter {
    paths = ["prod/*"]
  }

  authentication {
    azure_oidc {
      tenant_id       = "00000000-0000-0000-0000-000000000000"
      subscription_id = "11111111-1111-1111-1111-111111111111"

      plan_client_id  = "33333333-3333-3333-3333-333333333333"
      apply_client_id = "44444444-4444-4444-4444-444444444444"
    }
  }
}
```

:::tip

Learn more about how Pipelines authenticates to Azure in the [Authenticating to Azure](/2.0/docs/pipelines/concepts/cloud-auth/azure) page.

:::

:::note Progress Checklist

<PersistentCheckbox id="create-azure-environment-hcl" label="Create environment HCL files for each Azure subscription you want to manage with Pipelines." />
<PersistentCheckbox id="edit-azure-environment-labels" label="Edit the labels of the `environment` blocks to match your environment names." />
<PersistentCheckbox id="edit-azure-filter-paths" label="Edit the `paths` values in the `filter` blocks to match your repository structure." />
<PersistentCheckbox id="edit-azure-tenant-ids" label="Edit the `tenant_id` values to match your Azure tenant IDs." />
<PersistentCheckbox id="edit-azure-subscription-ids" label="Edit the `subscription_id` values to match your Azure subscription IDs." />
<PersistentCheckbox id="edit-azure-client-ids" label="Edit the client IDs to match the applications created during bootstrapping." />

:::

</TabItem>
<TabItem value="custom" label="Custom">

```hcl title=".gruntwork/environment-production.hcl"
environment "production" {
  filter {
    paths = ["prod/*"]
  }

  authentication {
    custom {
      auth_provider_cmd = "./scripts/custom-auth-prod.sh"
    }
  }
}
```

:::tip

Learn more about how Pipelines can authenticate with custom authentication in the [Custom Authentication](/2.0/docs/pipelines/concepts/cloud-auth/custom) page.

:::

:::note Progress Checklist

<PersistentCheckbox id="create-custom-environment-hcl" label="Create environment HCL files for each environment using custom authentication." />
<PersistentCheckbox id="edit-custom-environment-labels" label="Edit the labels of the `environment` blocks to match your environment names." />
<PersistentCheckbox id="edit-custom-filter-paths" label="Edit the `paths` values in the `filter` blocks to match your repository structure." />
<PersistentCheckbox id="create-custom-auth-scripts" label="Create custom authentication scripts for each environment." />
<PersistentCheckbox id="edit-custom-auth-provider-cmd" label="Edit the `auth_provider_cmd` values to point to your custom authentication scripts." />

:::

</TabItem>
</Tabs>

## Creating `.github/workflows/pipelines.yml`

Create a `.github/workflows/pipelines.yml` file in the root of your repository with the following content:

```yaml title=".github/workflows/pipelines.yml"
name: Pipelines
run-name: "[GWP]: ${{ github.event.commits[0].message || github.event.pull_request.title || 'No commit message' }}"
on:
  push:
    branches:
      - main
    paths-ignore:
      - ".github/**"
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
    paths-ignore:
      - ".github/**"

# Permissions to assume roles and create pull requests
permissions:
  id-token: write
  contents: write
  pull-requests: write

jobs:
  GruntworkPipelines:
    uses: gruntwork-io/pipelines-workflows/.github/workflows/pipelines.yml@v4
```

:::tip

You can read the [Pipelines GitHub Actions Workflow](https://github.com/gruntwork-io/pipelines-workflows/blob/main/.github/workflows/pipelines.yml) to learn how this GitHub Actions workflow calls the Pipelines CLI to run your pipelines.

:::

:::note Progress Checklist

<PersistentCheckbox id="create-pipelines-yml" label="Create a new `.github/workflows/pipelines.yml` file in the root of your repository with the contents above." />
<PersistentCheckbox id="edit-pipelines-yml-branch-name" label="Edit the value of `branches` in `.github/workflows/pipelines.yml` to match the `deploy_branch_name` in `.gruntwork/repository.hcl`." />

:::

## Commit and Push Your Changes

Commit and push your changes to your repository.

:::note

You should include `[skip ci]` in your commit message here to prevent triggering the Pipelines workflow before everything is properly configured.

:::

```bash
git add .
git commit -m "Add Pipelines configurations and GitHub Actions workflow [skip ci]"
git push
```

:::note Progress Checklist

<PersistentCheckbox id="commit-and-push-changes" label="Commit the changes to your repository (using `[skip ci]` in the commit message)." />
<PersistentCheckbox id="push-changes-to-repository" label="Push the changes to your repository." />

:::

ðŸš€ You've successfully added Gruntwork Pipelines to your existing repository!

## Next Steps

You have successfully completed the installation of Gruntwork Pipelines in an existing repository. Proceed to [Deploying your first infrastructure change](/2.0/docs/pipelines/tutorials/deploying-your-first-infrastructure-change.md) to begin deploying changes.

## Troubleshooting Tips

If you encounter issues during the setup process, here are some common troubleshooting steps:

### Bootstrap Resources Failure

If your bootstrap resource provisioning fails:

<PersistentCheckbox id="troubleshoot-check-credentials" label="Confirm that you have the correct cloud provider credentials and permissions to create resources in your accounts/subscriptions." />
<PersistentCheckbox id="troubleshoot-check-unique-names" label="Confirm that your S3 bucket names (AWS) or storage account names (Azure) are globally unique and follow naming requirements." />
<PersistentCheckbox id="troubleshoot-check-github-org-repo" label="Ensure your GitHub organization and repository names in the bootstrap configurations match your actual GitHub organization and repository." />
<PersistentCheckbox id="troubleshoot-check-environment-variables" label="For Azure: Confirm that you have exported the ARM_TENANT_ID and ARM_SUBSCRIPTION_ID environment variables." />

### HCL Configuration Issues

If your HCL configurations aren't working as expected:

<PersistentCheckbox id="troubleshoot-check-paths" label="Verify that the paths in your filter blocks correctly match your repository structure." />
<PersistentCheckbox id="troubleshoot-check-account-ids" label="Confirm that all account IDs, subscription IDs, and client IDs are correct." />
<PersistentCheckbox id="troubleshoot-check-role-arns" label="Ensure that IAM role ARNs match the roles created during bootstrapping." />

### GitHub Actions Workflow Issues

If your GitHub Actions workflow isn't triggering correctly:

<PersistentCheckbox id="troubleshoot-check-branch-names" label="Verify that the branch name in your workflow file matches your deploy branch name." />
<PersistentCheckbox id="troubleshoot-check-scm-access" label="Confirm that SCM access is properly configured (GitHub App or machine users)." />
<PersistentCheckbox id="troubleshoot-check-permissions" label="Ensure that the workflow has the necessary permissions (id-token: write, contents: write, pull-requests: write)." />
